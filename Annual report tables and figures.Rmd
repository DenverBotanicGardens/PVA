---
title: "AsMi_annual report"
author: "Michelle DePrenger-Levin"
date: "Tuesday, October 27, 2015"
output: pdf_document
---

AsMiPVA

```{r}
library(reshape2)
library(ggplot2)
library(psych)
library(popbio)
library(devtools)
library(sciplot)
library(plotrix)
library(scales)
library(plyr)
library(lattice)
library(latticeExtra)
library(devtools)
library(digest)
#source_url("http://cran.r-project.org/bin/windows/Rtools/") #and then run find_rtools()
source_url("https://raw.github.com/JoFrhwld/FAAV/master/r/stat-ellipse.R")
```


```{r}
asmi.raw <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/2015_asmi/RawData_20yrsdormant_111115.csv"), na.strings = "na")

head(asmi.raw)
table(asmi.raw$year, asmi.raw$AsMi_site_id)
table(asmi.raw$Browsing...Status)
#asmi.raw <- transform(asmi.raw, year = as.numeric(year))
str(asmi.raw)
table(asmi.raw$AsMi_plot_id,asmi.raw$AsMi_site_id)

# one blank row at the end of the csv download
asmi.raw[asmi.raw$status == "",]
asmi.raw <- asmi.raw[asmi.raw$status != "",]

#reset factors of browsing to eliminate " "
asmi.raw$Browsing...Status <- factor(asmi.raw$Browsing...Status)

```



Table 1:Demographic data of Astragalus microcymbus within the South Beaver Creek and Cebolla Creek drainages near Gunnison, Colorado. (a) Average number of individuals with above ground growth (AGG) followed by total individuals (AGG and dormant) per plot. (b) Percent of reproductive individuals followed by average reproductive individuals per plot. Site 1 is Cebolla Creek Mid and site 2 is Cebolla Creek north. Standard errors are shown in parentheses.
```{r}
#alive <- lapply(split(asmi.raw, list(asmi.raw$AsMi_plot_id, asmi.raw$year)),function(x){
#  nrow(x[x$length>0,])
#})

#AGG
alive <-aggregate(length ~ AsMi_plot_id + year + AsMi_site_id + fence, 
                  data = asmi.raw, function(x) length(x[x>0]))

#AGG and dormant
aggdorm <- aggregate(status ~ AsMi_plot_id +year + AsMi_site_id + fence,
                     data = asmi.raw, function(x) length(x[x != "dead"]))

ggplot(alive, aes(year, length, colour=as.factor(AsMi_site_id)))+
  geom_point()+
  stat_smooth(size=1)+
  theme_bw()+
  scale_color_manual("Sites/n",labels = c("Cebolla Mid", 
                                          "Cebolla South",
                                          "5","15","19","26"),
                     values = c("cyan", "darkblue",
                                "olivedrab","olivedrab1",
                                "mediumseagreen","mistyrose3"))

tbl1a.1 <- summarySE(alive, measurevar="length", groupvars=c("AsMi_site_id", "year"))
tbl1a.1[tbl1a.1$year == 2015,]

tbl1a.2 <- summarySE(aggdorm, measurevar="status", groupvars=c("AsMi_site_id", "year"))

sites <- unique(tbl1a.1$AsMi_site_id)
tbl1.1 <- lapply(sites, function(x){
  paste(round(tbl1a.1[tbl1a.1$AsMi_site_id == x,"length"],2)," (",
        round(tbl1a.1[tbl1a.1$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1.2 <- lapply(sites, function(x){
  paste(round(tbl1a.2[tbl1a.2$AsMi_site_id == x,"status"],2)," (",
        round(tbl1a.2[tbl1a.2$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1a <- lapply(1:6, function(x){
  data.frame(tbl1.1[[x]],tbl1.2[[x]])
  })

#Cebolla Mid, Site 1
tbl1a[[1]]

#Cebolla North, Site 2
tbl1a[[2]]

#South Beaver Creek, Site 5
tbl1a[[3]]
#South Beaver Creek, Site 15
tbl1a[[4]]
#South Beaver Creek, Site 19
tbl1a[[5]]
#South Beaver Creek, Site 26
tbl1a[[6]]
```

Percent and total preproductive
```{r}
# Percent and average reproductive

#precent reproductive
prep <- aggregate(flower~AsMi_plot_id+year+AsMi_site_id,
                  data = asmi.raw[asmi$length > 0,],
                  function(x){
                    sum(x,na.rm = TRUE)/length(x)
                  })
head(prep)
str(prep)
tbl1b.1 <- summarySE(prep, measurevar="flower", groupvars=c("AsMi_site_id","year"))
head(tbl1b.1)

#sites above
#percent reproductive 
tbl1.3 <- lapply(sites, function(x){
  paste(round(tbl1b.1[tbl1b.1$AsMi_site_id == x,"flower"],3)*100,"% (",
        round(tbl1b.1[tbl1b.1$AsMi_site_id == x,"se"],3)*100, "%)", sep="")
})

tbl1.3[[3]]

#total reproductive
totrep <- aggregate(flower ~ AsMi_plot_id +year + AsMi_site_id + fence,
                    data = asmi.raw[asmi$length > 0,], 
                    function(x) sum(x, na.rm = TRUE))

head(totrep)
tbl1b.2 <- summarySE(totrep, measurevar="flower",groupvars=c("AsMi_site_id","year"))

tbl1.4 <- lapply(sites, function(x){
  paste(round(tbl1b.2[tbl1b.2$AsMi_site_id == x,"flower"],2)," (",
        round(tbl1b.2[tbl1b.2$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1b <- lapply(1:6, function(x){
  data.frame(tbl1.3[[x]], tbl1.4[[x]])
  })

#Cebolla Mid, 1
tbl1b[[1]]

#Cebolla North, 2
tbl1b[[2]]

#South Beaver Creek, 5
tbl1b[[3]]

#South Beaver Creek, 15
tbl1b[[4]]

#South Beaver Creek, 19
tbl1b[[5]]

#South Beaver Creek, 26
tbl1b[[6]]


```

Table 2: Biotic factors correlated among the percent browsed individuals in the current year, density of reproductive individuals in the current year, fruit production in the current year, and the percent of reproductive individuals and above ground growth (AGG) in the current and previous year of Astragalus microcymbus per year (1995 – 2014) within the South Beaver Creek drainage ....Significant PCC are indicated with an asterisk (p-value < 0.05).  

Plot Summary (weather data is prev. Aug through currrent Jul)   
Total.Plants are AGG and dormant    
Total.Alive is AGG   
X..Flowered must be percent flowered and    
X..Flowered.1 is number flowered
```{r}
ps.asmi <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/2015_asmi/PlotSummary_2015.csv"))

head(ps.asmi)

ps.asmi.t <- ps.asmi

#log transform
logtrans <- c("X..Flowered.1","Total.Alive","X..Dormant","Total.Fruit",
              "X..Flowered")
intersect(names(ps.asmi.t),logtrans) #Check that names are right
ps.asmi.t[,logtrans] <- lapply(ps.asmi.t[,logtrans], 
                                     function(x) log(x + 1)) #NA in num flowered
ps.asmi.t$X..Flowered.1[is.na(ps.asmi.t$X..Flowered.1)] <- 0

#arcsine square root transformed  asin(sqrt(x/100))
ps.asmi.t["X..Browsed"] <- lapply(ps.asmi.t["X..Browsed"],
                                  function(x) asin(sqrt(x/100)))


ps.cor <- subset(merge(ps.asmi.t, ps.asmi.t, 
                       by = c("Site","Plot")), Year.x == Year.y - 1)
head(ps.cor[,c("Year.x","Year.y")])

head(ps.cor)
cor.plot(cor(ps.cor[,names(ps.cor) %in% 
                      unique(grep(paste(cors,collapse="|"),
                                  names(ps.cor), value=TRUE))]),
         numbers = TRUE)

cor(ps.cor[,names(ps.cor) %in% 
                      unique(grep(paste(cors,collapse="|"),
                                  names(ps.cor), value=TRUE))])

#If errors:
#dev.off()
cors <- c("Total.Alive","X..Browsed","X..Flowered","X..Dormant","Total.Fruit")
cor(ps.cor[,names(ps.cor) %in% 
             unique(grep(paste(cors,collapse="|"),names(ps.cor), value=TRUE))])

cor.plot(cor(ps.cor[,names(ps.cor) %in% 
                      unique(grep(paste(cors,collapse="|"),
                                  names(ps.cor), value=TRUE))]),
         numbers = TRUE)

```


```{r}
cortests <- lapply(ps.cor[,names(ps.cor) %in% 
                            unique(grep(paste(cors,collapse="|"),
                                        names(ps.cor), value=TRUE))],
                   function(x){
                     sapply(ps.cor[,names(ps.cor) %in% 
                                     unique(grep(paste(cors,collapse="|"),
                                                 names(ps.cor), value=TRUE))],
                            function(y){
                              ct <- cor.test(x,y)
                              cbind(ct$p.value,ct$estimate)
                              })
                     })


t(cortests[[1]]) # Total.Alive.x to all
tst <- lapply(cortests, function(x) data.frame(t(x)))
df.c <- do.call(rbind,tst)

cortests[[2]] # X..Browsed.x to all

head(df.c)
nrow(df.c)

#All significant
df.c[df.c$X1 > 0.001,]

```



```{r}
#get rid of the number of reproductive individuals, only percent reproductive
ps.cor <- ps.cor[,grep("Flowered.1.", names(ps.cor), invert=TRUE)]

cors <- c("Total.Alive","X..Browsed","X..Flowered","X..Dormant","Total.Fruit")

cor.plot(cor(ps.cor[,names(ps.cor) %in% unique(grep(paste(cors,collapse="|"),
                                           names(ps.cor), value = TRUE))]),
         numbers = TRUE)
```

Table 3: Average Astragalus microcymbus fruit per plot within the South Beaver Creek Drainage near Gunnison, CO and Cebolla Creek drainage. Site 1 is Cebolla Creek Mid and site 2 is Cebolla Creek North. Standard errors are given in parentheses. 
```{r}
fruit <- aggregate(fruit ~ AsMi_plot_id + year + AsMi_site_id + fence, 
                  data = asmi.raw, function(x) sum(x,na.rm = TRUE))
head(fruit)


tbl3.1 <- summarySE(fruit, measurevar="fruit",groupvars=c("AsMi_site_id","year"))

sites <- unique(tbl3.1$AsMi_site_id)
tbl3 <- lapply(sites, function(x){
  paste(round(tbl3.1[tbl3.1$AsMi_site_id == x,"fruit"],2)," (",
        round(tbl3.1[tbl3.1$AsMi_site_id == x,"se"],1), ")", sep="")
})

#Cebolla Creek
data.frame(tbl3[[1]],tbl3[[2]])
#South Beaver Creek
data.frame(tbl3[[3]],tbl3[[4]],tbl3[[5]],tbl3[[6]])

```


Table 4: Growth rate (λ) and standard deviation within treatment (fenced or open plots) of Astragalus microcymbus individuals within the South Beaver Creek drainage near Gunnison, CO. Plot 598 in site 26, added in 2004, is excluded.   

```{r}
table(asmi.raw$Browsing...Status)
asmi.raw$Browsing...Status[asmi.raw$Browsing...Status == "mammal"] <- "Mammal"

asmi.raw$Browsing...Status <- factor(asmi.raw$Browsing...Status)

table(asmi.raw$browsing)
table(asmi.raw$Browsing...Status) #lots of missing -1 and one row with nothing
nrow(asmi.raw)
table(asmi.raw$AsMi_site_id,asmi.raw$year)

cebolla <- asmi.raw[asmi.raw$AsMi_site_id %in% c(1,2),]
table(cebolla$AsMi_site_id,cebolla$year)

sbc <- asmi.raw[asmi.raw$AsMi_site_id %in% c(5,15,19,26),]
table(sbc$AsMi_site_id,sbc$year)

#remove plot 598 from SBC, it was added so late.. or do all plots on their own instead of by sites? 
sbc <- sbc[sbc$AsMi_plot_id != 598,]

asmi.1 <- sbc[order(sbc$AsMi_site_id, sbc$AsMi_tag_id, sbc$year),]
cebolla <- cebolla[order(cebolla$AsMi_site_id, cebolla$AsMi_tag_id, cebolla$year),]

asmi.1$status <- factor(asmi.1$status)
table(asmi.1$status)
```

Set order of classes
```{r}
# Later work in seeds
# stages <- c("seed", "seedling", "vegetative", "reproductive", "dormant","dead") 

stages <- c("seedling", "vegetative", "reproductive", "dormant","dead") 

asmi.1$status <- ordered(asmi.1$status, levels = stages)
cebolla$status <- ordered(cebolla$status, levels = stages)


```

check errors
```{r}
table(asmi.1$status)
table(asmi.1$year,asmi.1$status)
table(asmi.1$year, asmi.1$AsMi_site_id)
table(asmi.1$length) # looks like tag numbers got recorded as length

asmi.1[is.na(asmi.1$length),]
asmi.1[asmi.1$length > 100,]

# One length that was recorded crazy
asmi.1$length[asmi.1$length == 921] <- NA

asmi.1$browsed[asmi.1$browsing==0]<-FALSE  	
asmi.1$browsed[asmi.1$browsing==1]<-TRUE
table(asmi.1$browsed)
table(asmi.1$browsing)

# Same for cebolla plots
cebolla$browsed[cebolla$browsing==0]<-FALSE    
cebolla$browsed[cebolla$browsing==1]<-TRUE
table(cebolla$browsed)
table(cebolla$browsing)
```

Merge year to year, year.x is year t, year.y is year t+1   
remove dead from stages, just fate   
```{r}
asmi.2 <- subset(merge(asmi.1, asmi.1, by = "AsMi_tag_id", sort = FALSE), year.x == year.y - 1)   
cebolla <- subset(merge(cebolla, cebolla, by = "AsMi_tag_id", sort = FALSE), year.x == year.y - 1)   
names(asmi.2)
head(asmi.2[,grep("year", names(asmi.2), )])
```

Want    
Narrow down to      
[1] "AsMi_site_id.x" "AsMi_tag_id"    "year.x"             
[4] "length.x"       "fruit.x"        "browsed.x"           
[7] "fence.x"        "status.x"       "status.y"     
```{r}
cols <- c("AsMi_site_id.x","AsMi_tag_id","year.x","length.x",
          "fruit.x","browsed.x","fence.x","status.x","status.y","AsMi_plot_id.x")
asmi.2 <- asmi.2[, names(asmi.2) %in% unique(grep(paste(cols,collapse="|"),
                                                  names(asmi.2), value = TRUE))]
colnames(asmi.2) <- c( "tag","year","length","fruits","stage","plot",
                       "site","fenced","browse","fate")
## re-number
rownames(asmi.2) <- 1:nrow(asmi.2)
# Get rid of stage 'dead'
asmi.2$stage <- ordered(asmi.2$stage, levels = stages[-length(stages)])
# check transitions
#fate down and stage across the top; These are the raw numbers combined for all years 
table(Fate = asmi.2$fate, Stage = asmi.2$stage)
table(asmi.2$site, asmi.2$year)
table(asmi.2$plot, asmi.2$year)
table(asmi.2$stage)
```

bootstrap distributions of population growth rates (lambda), stage vectors, and projection matrix elements by randomly sampling with replacement from a stage-fate data frame of observed transitions   

Doesn't make sense... shouldn't be so high...

```{r}
boottrans <- lapply(unique(asmi.2$site), function(x){
  data.frame(cbind(Site = x,
                   Boot = boot.transitions(asmi.2[asmi.2$site == x & asmi.2$fenced == "n",], 
                                           1000,
                                           fertility = "fruits")$lambda))
  })

bt <- do.call(rbind, boottrans)
head(bt)
ggplot(bt, aes(as.factor(Site), Boot, colour = as.factor(Site)))+
  geom_boxplot()
```

Dormancy    
repeat lengths   
```{r}
dorms <- rle(as.numeric(asmi.2$stage))$lengths[rle(as.numeric(asmi.2$stage))$values ==4]
max(dorms)
ggplot(data.frame(Dormant = dorms), aes(Dormant))+
  geom_histogram()+
  theme_bw()+
  ylab("Frequency")+
  xlab("Consecutive years dormant")


median(dorms) #2
length(dorms[dorms==1]) #296
length(dorms) #725
length(dorms[dorms > 5]) #237
length(dorms[dorms > 15]) #20
```

Reproductive lengths   
```{r}
repros <- rle(as.numeric(asmi.2$stage))$lengths[rle(as.numeric(asmi.2$stage))$values ==3]
max(repros)
ggplot(data.frame(Repro = repros), aes(Repro))+
  geom_histogram()+
  theme_bw()+
  ylab("Frequency")+
  xlab("Consecutive years reproductive")

```

Dormancy can be set to 0-1   
```{r}
load(path.expand("P:/hackathon/GitPVA/StagePVAFunction.R"))

asmi.pva <- StagePVA(asmi.2)

```


By plot
```{r}
site <- sapply(unique(asmi.2$site), function(x){
  as.character(unique(asmi.2$plot[asmi.2$site == x]))
  }, simplify = FALSE)
names(site)<-unique(asmi.2$site)
site

asmi.pva$plot.matrix[site$'15'[1]]



```

### Function for lambda and 
requires library(popbio)
x is the list of matrices, i.e. notfenced.Site.matrix$"26", 
					or fenced.Site.matrix$"19"[2:17])
y is the start year
z is the start of the last transition
```{r}
lmdSD <- function(x,y,z){

	yrs <- 1995:z
	st <- match(c(y,z),yrs)
	
	lambdaAll <- c()
	for(i in c(y:z)){
		lambdaAll <- cbind(lambdaAll,eigen.analysis(x[[as.character(i)]])$lambda)
	}	
	StandDev <- sqrt(var(c(lambdaAll)))	#Standard Deviation
	cbind(lmda = lambda(mean(x[st[1]:st[2]])),SD = StandDev)
}	
```


```{r}
lmdSD(asmi.pva$pro.matrix, 1996, 2014)
#         lmda        SD
#[1,] 0.916556 0.1715709  
paste(round(lmdSD(asmi.pva$pro.matrix, 1996, 2004)[1],2)," (",
      round(lmdSD(asmi.pva$pro.matrix, 1996, 2004)[2],2), ")", sep ="")

mats.list <- list(asmi.pva$pro.matrix,asmi.pva$fenced.pro.matrix,asmi.pva$notfenced.pro.matrix)
tbl4.all <- sapply(mats.list, function(x){
   paste(round(lmdSD(x, 1996, 2004)[1],2)," (",
         round(lmdSD(x, 1996, 2004)[2],2),")", sep="")
    })

tbl4.allpost <- sapply(mats.list[-1], function(x){
  paste(round(lmdSD(x, 2005,2013)[1],2)," (",
        round(lmdSD(x, 2005,2013)[2],2),")", sep="")
})

tbl4.allopen <- paste(round(lmdSD(asmi.pva$notfenced.pro.matrix, 1996,2013)[1],2)," (",
                      round(lmdSD(asmi.pva$notfenced.pro.matrix, 1996,2013)[2],2),")", sep="")
```

# Table 4
pattern is:          

All pre-fence  1996-2004        |All post-fence 2005-2013       |Open plots 1996-2013       
--------------------------------|--------------------------------|----------------------    
asmi.pva$pro.matrix             |                                |  
asmi.pva$fenced.pro.matrix      | asmi.pva$fenced.pro.matrix     |           
asmi.pva$notfenced.pro.matrix   | asmi.pva$notfenced.pro.matrix  | asmi.pva$notfenced         
      
      
Sites 5,19,26,  1996-2004       
(which is through 2005 but starting transition of 2004)   

1996-2005               |   2005-2014            |   1996-2014
------------------------|------------------------|---------------------          
asmi.pva$Site$"5"       |                        |       
asmi.pva$fenced$"5"     | asmi.pva$fenced$"5"    |                
asmi.pva$notfenced$"5"  | asmi.pva$notfenced$"5" |  asmi.pva$notfenced$"5"             

Site 15
`asmi.pva$Site$"15"` ...        

```{r}
matord.list <- list(asmi.pva$Site, asmi.pva$fenced,asmi.pva$notfenced)

# yarggg, won't work!!
tbl4.96.04 <- 
  lapply(as.character(unique(asmi.2$site)), function(x){
    lapply(matord.list, function(y){
      paste(round(lmdSD(y[[factor(x)]],1996,2004)[1],2)," (",
            round(lmdSD(y[[factor(x)]],1996,2004)[2],2),")", sep="")
    })
  })

#site 5
paste(round(lmdSD(asmi.pva$Site$'5',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'5',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$fenced$'5',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'5',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'5',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'5',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$fenced$'5',2005,2013)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'5',2005,2013)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'5',2005,2013)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'5',2005,2013)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'5',1996,2013)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'5',1996,2013)[2],2),")", sep="")

#Site 15
paste(round(lmdSD(asmi.pva$Site$'15',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'15',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$Site$'15',2005,2013)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'15',2005,2013)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$Site$'15',1996,2013)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'15',1996,2013)[2],2),")", sep="")

#site 19
paste(round(lmdSD(asmi.pva$Site$'19',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'19',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$fenced$'19',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'19',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'19',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'19',1996,2004)[2],2),")", sep="")


paste(round(lmdSD(asmi.pva$fenced$'19',2005,2013)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'19',2005,2013)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'19',2005,2013)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'19',2005,2013)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'19',1996,2013)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'19',1996,2013)[2],2),")", sep="")

#site 26
paste(round(lmdSD(asmi.pva$Site$'26',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'26',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$fenced$'26',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'26',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'26',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'26',1996,2004)[2],2),")", sep="")


paste(round(lmdSD(asmi.pva$fenced$'26',2005,2013)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'26',2005,2013)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'26',2005,2013)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'26',2005,2013)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'26',1996,2013)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'26',1996,2013)[2],2),")", sep="")


```

Figure 3: Life cycle diagram of Astragalus microcymbus, 1996-2014 mean transition rates (solid lines) and fecundity rates (dashed lines), and resulting sensitivities and elasticities. Individuals that become reproductive in the first year are classified as seedlings.    
```{r}
eigen.analysis(mean(asmi.pva$notfenced.pro.matrix))
mean(asmi.pva$notfenced.pro.matrix)
```




summarySE function borrowed from http://www.cookbook-r.com/Manipulating_data/Summarizing_data/    
```{r}
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
    library(plyr)

    # New version of length which can handle NA's: if na.rm==T, don't count them
    length2 <- function (x, na.rm=FALSE) {
        if (na.rm) sum(!is.na(x))
        else       length(x)
    }

    # This does the summary. For each group's data frame, return a vector with
    # N, mean, and sd
    datac <- ddply(data, groupvars, .drop=.drop,
      .fun = function(xx, col) {
        c(N    = length2(xx[[col]], na.rm=na.rm),
          mean = mean   (xx[[col]], na.rm=na.rm),
          sd   = sd     (xx[[col]], na.rm=na.rm)
        )
      },
      measurevar
    )

    # Rename the "mean" column    
    datac <- rename(datac, c("mean" = measurevar))

    datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean

    # Confidence interval multiplier for standard error
    # Calculate t-statistic for confidence interval: 
    # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
    ciMult <- qt(conf.interval/2 + .5, datac$N-1)
    datac$ci <- datac$se * ciMult

    return(datac)
}
```


###Environmental Data from PRISM:   
<http://prism.oregonstate.edu/explorer/>   


```{r}
asmi.climate <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/2015_asmi/prism_data_csv.csv"),skip=6)
head(asmi.climate)

asmi.climate$Year <- substr(asmi.climate$Date,1,4)
asmi.climate$Month <- substr(asmi.climate$Date,6,7)

asmi.c <- asmi.climate[,c(1,3,5,7:9)]
names(asmi.c) <- c("Creek","Precip","tmin","tmax","Year","Month")
head(asmi.c)

#Label Prev12 as 08 through 12 of the previous year and give it the year for 01-07 (of the previous year (the next year) 
asmi.c$Month <- as.numeric(asmi.c$Month)
asmi.c$Year <- as.numeric(asmi.c$Year)
asmi.c$Prev12 <- asmi.c$Year
asmi.c$Prev12[asmi.c$Month > 7] <- asmi.c$Year[asmi.c$Month > 7]+1
```

Seasons    
Winter: December-March (12-3)    
Spring/summer: April-July (4-7)    
Fall: August-November (8-11)   
```{r}
asmi.c$season <- "winter"
asmi.c[asmi.c$Month>3 & asmi.c$Month<8, "season"] <- "spring/summer"
asmi.c[asmi.c$Month>7 & asmi.c$Month<12, "season"] <- "fall"

asmi.c.summary <- aggregate(asmi.c[,2:4], asmi.c[,c("season","Creek","Prev12")],
                            FUN = function(x) mean(x, na.rm = TRUE))

head(asmi.c.summary)

season <- reshape(asmi.c.summary[asmi.c.summary$Prev12 < 2016 & asmi.c.summary$Prev12 > 1994,],
                  idvar=c("Creek","Prev12"),
                  timevar = "season",
                  direction="wide")
head(season)

cor.plot(cor(season[,-(1:2)]), numbers=TRUE)

cor.table<-cor(season[,-(1:2)])
data <- as.data.frame(as.table(cor.table))
combins <- combn(colnames(cor.table),2,FUN=function(x) paste(x,collapse="_"))
cor.data <- data[data$Var1 != data$Var2, ]
data <- cor.data[paste(cor.data$Var1, cor.data$Var2, sep="_") %in% combins,]
exclude <- paste(data$Var2[abs(data$Freq)>0.49],sep=",")
tomatch <- c("Creek","Prev12",exclude)

forpca <- season[,c(grep(paste(tomatch, collapse="|"),
                            names(season), value=TRUE, invert=TRUE))]
names(forpca)
```

```{r}

source_url("https://raw.github.com/JoFrhwld/FAAV/master/r/stat-ellipse.R")

```


T-tests for Creek from Figure 7
```{r}
asmi.pca <- princomp(forpca,cor=TRUE)
summary(asmi.pca)
asmi.load <- loadings(asmi.pca)
asmi.pc <- predict(asmi.pca)

asmi.pc <- data.frame(asmi.pc,season)

t.test(Comp.1~Creek, data=asmi.pc)
t.test(Comp.2~Creek, data=asmi.pc)

```

Figure 7a
```{r}
ggplot(asmi.pc, aes(Comp.1,Comp.2, colour = Creek))+
  geom_point()+
  stat_ellipse()+
  theme_bw()+
  xlab("PC1 (36%)")+
  ylab("PC2 (23%)")+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.justification=c(0,0), legend.position=c(0,0))+
  scale_color_manual("Drainage", 
                     labels = c("Cebolla Creek","South Beaver Creek"), 
                     values = c("grey50","black")) 
  

```





```{r}
ps.asmi$Creek[ps.asmi$Site > 4] <- "South Beaver Creek"
ps.asmi$Creek[ps.asmi$Site < 3] <- "Cebolla Creek"
asmi.m <- merge(ps.asmi[,-c(12:(length(ps.asmi)-1))], asmi.c.summary, 
                by.x=c("Year","Creek"), by.y = c("Prev12","Creek"))

str(asmi.m)

#Total.Plants - AGG and dormant
AGGDorm <- summarySE(ps.asmi, measurevar="Total.Plants", groupvars=c("Fence","Year"))
#Total.Alive - AGG
AGG <- summarySE(ps.asmi, measurevar="Total.Alive", groupvars=c("Fence","Year","Site"))

#Total.Fruit
Fruit <- summarySE(ps.asmi, measurevar="Total.Fruit", groupvars=c("Fence","Year","Site"))

#X..Flowered - %flowered
Repro <- summarySE(ps.asmi, measurevar="X..Flowered", groupvars=c("Fence","Year","Site"))

```


 Figure 8    
AGG and Dormant  
  
```{r}
ggplot(ps.asmi[ps.asmi$Total.Plants>0 & ps.asmi$Year > 1995 & ps.asmi$Year < 2015,], 
       aes(Year, Total.Plants, shape = Fence, colour = Fence))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("Average AGG and dormant per Site")+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75)+
  geom_vline(xintercept = 2006.75, lty = 4)+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1)) #upper right
  
```


AGG
```{r}
ggplot(ps.asmi[ps.asmi$Total.Alive>0,], aes(Year, Total.Alive, shape = Fence, colour = Fence))+
#  geom_point(fun = mean)+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("Average AGG per Site")+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75)+
  geom_vline(xintercept = 2006.75, lty = 4)+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1)) #upper right

```


Fruit
```{r}
ggplot(ps.asmi[ps.asmi$Total.Plants>0,], 
       aes(Year, Total.Fruit, shape = Fence, colour = Fence))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("Total Fruit per Site")+
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75)+
  geom_vline(xintercept = 2006.75, lty = 4)+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1)) #upper right
```
  
X..Flowered - Percent Reproductive
```{r}
ggplot(ps.asmi[ps.asmi$Total.Plants>0,], 
       aes(Year, X..Flowered, shape = Fence, colour = Fence))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("% Reproductive per Site")+
  ggtitle("d)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75)+
  geom_vline(xintercept = 2006.75, lty = 4)+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1)) #upper right
```
  

Table 6: PCA climatic loadings for the first two principal component axes for yearly demographic data of Astragalus microcymbus from four sites within the South Beaver Creek drainage near Gunnison, CO. 
```{r}



```



Figure 3: Life cycle diagram of Astragalus microcymbus, 1996-2014 mean transition rates (solid lines) and fecundity rates (dashed lines), and resulting sensitivities and elasticities. Individuals that become reproductive in the first year are classified as seedlings.    

```{r}
asmi.pva$notfenced.pro.matrix$'2012'


```




### Years alive    

```{r}
path <- "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/2015_asmi/"

yrsalive <- lapply(1:20, function(x){ 
  path2 <- paste(path, "YrsAlive_dormant", x, ".csv", sep = "")
  ysal <- read.csv(path.expand(path2), na.strings="na")
  cbind(ysal, YrsD = x)
  })

head(yrsalive[[20]])
str(yrsalive[[1]])

yrsalive[[1]][is.na(yrsalive[[1]]$Yearsalive),]

yrsalive[[3]][is.na(yrsalive[[3]]$AsMi_plot_id),]


#eliminate na or make them zeros?
# complete.cases will eliminate any that aren't yet dead or are new in 2015 sinece they've only been seen one year. 
```
sumYrsAlive <- lapply(yrsalive, function(x){
  summarySE(x[complete.cases(x),], measurevar="Yearsalive",groupvars=c("AsMi_plot_id","AsMi_site_id","YrsD"))
})
```{r}
sumYrsAlive <- lapply(yrsalive, function(x){
  summarySE(x[complete.cases(x),], measurevar="Yearsalive",groupvars="YrsD")
})

sumYrsAlive

smya <- do.call(rbind, sumYrsAlive)
```

Figure 2(a) Average life span of Astragalus microcymbus (with one standard error from the mean) given consecutive assumptions on length of possible whole plant dormancy. (b) Distribution of consecutive years of dormancy when dormancy is not limited.   
```{r}
ggplot(smya, aes(YrsD, Yearsalive))+
#  stat_smooth()+
  geom_errorbar(aes(ymin=Yearsalive-se, ymax=Yearsalive+se), 
                width=1, position=position_dodge(0.1)) +
  theme_bw()+
  xlab("Maximum years dormant")+
  ylab("Life length")

```


Ignore making NA to zeros
```{r}
#try making them zeros
yrsalivezero <- lapply(yrsalive, function(x){
  replace(x, is.na(x), 0)
})

head(yrsalivezero[[5]])
yrsalivezero[[5]][yrsalivezero[[5]]$AsMi_plot_id == 0,]

sumyrsalivezero <- lapply(yrsalivezero, function(x){
  summarySE(x[complete.cases(x),], measurevar="Yearsalive",groupvars=c("AsMi_plot_id","AsMi_site_id"))
})

smzero <- do.call(rbind,sumyrsalivezero)
head(sumyrsalivezero[[5]])  # Why is there 1 row of no data? In the download there is one row of blank

#Wait, want to know how many years allowed dormant and want years before cbind, but this is the summary...
smzero <- smzero[smzero$AsMi_plot_id != 0,]
head(smzero)


```




### Intraannual visits    
Will want to ignore sites that were not visited - deal with differently than plants that were not seen but are also NA    


```{r}
intra <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Raw Data/2015 datasheets/2015_intrayear_asmi.csv"), na.strings="")

head(intra)
names(intra)
str(intra)

intra[intra$Plot == 8,"LnJune22.24"]

intra <- transform(intra, LnJune22.24 = as.numeric(as.character(LnJune22.24)))
table(intra$LnJune22.24)

demo.only <- intra[,-c(1:7,13,99)]
names(demo.only)

# need to name the same before binding...
surname <- names(demo.only[,grep("Ln",names(demo.only))])

demo.only.bydate <- lapply(1:18, function(x){
  df <- data.frame(intra[,c(1:7,13,99)], demo.only[,((5*x-4):(5*x))],Survey = surname[x])
  names(df) <- c(names(intra[,c(1:7,13,99)]), "Ln","Fl","Fr","Br","Comment","Survey")
  df[!is.na(df$Ln),]
})

head(demo.only.bydate[[15]])

dm <- do.call(rbind, demo.only.bydate)
names(Filter(is.character, dm))
dm[,names(Filter(is.character, dm))] <- apply(dm[,names(Filter(is.character, dm))], 
                                              2, as.numeric)
str(dm)

dm$Site[dm$Plot <= 610 & dm$Plot >= 606] <- "5"
dm$Site[dm$Plot == 8 | dm$Plot == 578 | dm$Plot == 581 | dm$Plot == 799] <- "15"
dm$Site[dm$Plot == 300 | dm$Plot <= 515 & dm$Plot >= 512] <- "19"
dm$Site[dm$Plot == 238 | dm$Plot == 480 |
          dm$Plot == 598 | dm$Plot == 611 | dm$Plot == 614] <- "26"
dm$Site[dm$Plot == 22 | dm$Plot == 1 | dm$Plot == 32 | dm$Plot == 42
        | dm$Plot == 52 ] <- "Cebolla Mid"

dm$Site[dm$Plot == 16 | dm$Plot == 96 | dm$Plot == 58
        | dm$Plot == 89 | dm$Plot == 98 | dm$Plot == 90 ] <- "Cebolla North"

sites <- c("5","15","19","26","Cebolla Mid","Cebolla North")
dm$Site <- ordered(dm$Site, levels = sites)

#May1 moved to 2014 order from 2015
levels(dm$Survey) <- c(sapply(c(substr(levels(dm$Survey)[1:5],3,6),
                       substr(levels(dm$Survey)[6],3,7),
                       substr(levels(dm$Survey)[7:9],3,6)),paste0, "_2014"),
                       sapply(c(substr(levels(dm$Survey)[10],3,6),
                       substr(levels(dm$Survey)[11],3,7),
                       substr(levels(dm$Survey)[12:13],3,6),
                       substr(levels(dm$Survey)[14],3,7),
                       substr(levels(dm$Survey)[15:18],3,6)),paste0, "_2015"))

```



```{r}

ggplot(dm, aes(Survey, Ln, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', mult=1)+
  facet_grid(~Site)+
  theme_bw()+
  xlab("Average Length")+
	theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5)) 

```


Total AGG per plot
```{r}

#levels(dm$Site) <- gsub("Cebolla Mid", "1", levels(dm$Site))
#levels(dm$Site) <- gsub("Cebolla North", "2",levels(dm$Site))

sum.agg <- aggregate(dm$X, dm[,c("Plot","Site","Survey")],
          FUN = function(x){
            length(x)
          })

plotnum <- aggregate(dm$Plot, dm[,c("Site","Survey")],
                     FUN = function(x){
                       length(unique(x))
                     })

# Some Site 5 plot have no plants
plotnum$x[plotnum$Site == "5"] <- 5

# One Site 15 plot has no plants
plotnum$x[plotnum$Site == "15"] <- 4
```

```{r}
ggplot(sum.agg, aes(Survey, x, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', mult=1)+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Average AGG per plot")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
  geom_text(data=plotnum, aes(label=x, y=-1, x=Survey, size = 0.9))+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")
  
```

```{r}

## Need percent of total indivduals seen each survey period (per year)
AGG14 <- dm[grep("2014",dm$Survey),]
# reset factor levels
AGG14$Survey <- factor(AGG14$Survey)

AGG15 <- dm[grep("2015",dm$Survey),]
AGG15$Survey <- factor(AGG15$Survey)


#or should it be the number that match? 
intersect(unique(AGG14$X[AGG14$Ln>0 & AGG14$Plot == "606" & AGG14$Survey == "Aprl_2014"]),
unique(AGG14$X[AGG14$Ln>0 & 
       AGG14$Plot == "606"]))/length(unique(AGG14$X[AGG14$Ln>0 & AGG14$Plot == "606"]))

AGGpersurvey.14 <- lapply(unique(AGG14$Plot), function(x){
  sapply(unique(AGG14$Survey), function(y){
    length(intersect(unique(AGG14$X[AGG14$Ln>0 & AGG14$Plot == x &AGG14$Survey == y]),
    unique(AGG14$X[AGG14$Ln>0 & 
                   AGG14$Plot == x])))/length(unique(AGG14$X[AGG14$Ln>0&AGG14$Plot == x]))
  })
})

AGGpersurvey.14[2]
```

```{r}

names(AGGpersurvey.14) <- unique(AGG14$Plot)

AGGper <- do.call(rbind,AGGpersurvey.14)
AGGper <- data.frame(AGGper)
names(AGGper) <- unique(AGG14$Survey)
AGGper <- data.frame(Plot=rownames(AGGper),AGGper)
AGGpSurvey <- reshape(AGGper, direction="long", varying = list(names(AGGper)[-1]),
                      v.names="AGG",
                      idvar="Plot",
                      timevar="Survey",
                      times=names(AGGper)[-1])


AGGpSurvey <- merge(AGGpSurvey,AGG14[,c("Plot","Site")],by = "Plot")
AGGpSurvey$Survey <- factor(AGGpSurvey$Survey, levels = unique(AGG14$Survey))
names(AGGpSurvey)
str(AGGpSurvey)
AGGpSurvey <- AGGpSurvey[AGGpSurvey$AGG!=0,]
```


Figure 6:  (b) The percent of Astragalus microcymbus individuals with AGG at each survey from the total individuals with AGG during the 2014 season. (c) Total number of Astragalus microcymbus individuals per stage class as a percent of the total observed throughout the season.  
```{r}
ggplot(AGGpSurvey, aes(Survey, AGG, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', mult=1)+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Percent of total AGG over the year per survey")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")+
  scale_y_continuous(labels = percent)


```


```{r}
rm(AGGpersurvey.15)
AGGpersurvey.15 <- lapply(unique(AGG15$Plot), function(x){
  sapply(unique(AGG15$Survey), function(y){
    length(intersect(unique(AGG15$X[AGG15$Ln>0 & 
                         AGG15$Plot == x & 
                         AGG15$Survey == y]),
           unique(AGG15$X[AGG15$Ln>0 & AGG15$Plot == x])))/length(unique(AGG15$X[AGG15$Ln>0 & 
                                                               AGG15$Plot == x]))
  })
})

names(AGGpersurvey.15) <- unique(AGG15$Plot)


AGGper15 <- do.call(rbind,AGGpersurvey.15)
AGGper15 <- data.frame(AGGper15)
names(AGGper15) <- grep("2015", unique(dm$Survey), value = TRUE)
AGGper15 <- data.frame(Plot=rownames(AGGper15),AGGper15)
AGGpSurvey15 <- reshape(AGGper15, direction="long", varying = list(names(AGGper15)[-1]),
                      v.names="AGG",
                      idvar="Plot",
                      timevar="Survey",
                      times=names(AGGper15)[-1])

AGGpSurvey15 <- merge(AGGpSurvey15,dm[,c("Plot","Site")], by = "Plot")
tail(AGGpSurvey15)
```

```{r}
ggplot(AGGpSurvey15[AGGpSurvey15$AGG>0,], aes(Survey, AGG, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', mult=1)+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Percent of total AGG over the year per survey")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
#  geom_text(data=plotnum, aes(label=x, y=1, x=Survey, size = 0.9))+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")+
  scale_y_continuous(labels = percent)


```


```{r intraanual seedlings}
head(dm)
dm.15 <- dm[grep("2015",dm$Survey),]
dm.15$Survey <- factor(dm.15$Survey)

coty.seeds <- ddply(dm.15[grep("coty", dm.15$Comment),],
                   .(Plot, Site), summarise,
                   tag = unique(tag))

head(coty.seeds)
tags.seed <- merge(dm.15, coty.seeds, by = c("Site","Plot","tag"))
```

```{r}
ggplot(tags.seed, aes(Survey, Ln, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', mult=1)+
  facet_grid(~Site)+
  theme_bw()+
  xlab("Average Length")+
    theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5)) 


```


```{r}
AGG14$Ln[grep("Basal", AGG14$Comment)] <- 0.25
AGG14 <- AGG14[AGG14$Ln != 0,]
split

agg14 <- lapply(split(AGG14, list(AGG14$Plot,AGG14$Site)),
                   function(x){
                     sapply(unique(x$Survey), function(y){
                       nrow(x[x$Survey == y,])/nrow(x)
                       })
                   })

length(agg14[23][[1]])

length(agg14[23]$"607.5")
agg14[vapply(agg14, function(x) dim(x)[1] > 1, NA)]
Filter(function(x) dim(x)[1] > 1, agg14)
agg14[!unlist(lapply(agg14, is.null))]

names(agg14) <- 
do.call(rbind,agg14[agg14[[1]] > 1])
                     
                     
```


##Figure 6    
Don't worry about the same plant being up, when are the most plants with AGG
```{r}
rm(AGGpersurvey.14)
AGGpersurvey.14 <- lapply(unique(AGG14$Plot), function(x){
  sapply(unique(AGG14$Survey), function(y){
    length(AGG14$X[AGG14$Ln>0 & 
                     AGG14$Plot == x & 
                     AGG14$Survey == y])/length(AGG14$X[AGG14$Ln>0 &
                                                          AGG14$Plot == x])
           })
  })

names(AGGpersurvey.14) <- unique(AGG14$Plot)
AGGper <- do.call(rbind,AGGpersurvey.14)
AGGper <- data.frame(AGGper)
names(AGGper) <- unique(AGG14$Survey)
AGGper <- data.frame(Plot=rownames(AGGper),AGGper)
siteplot <- data.frame(table(AGG14$Plot, AGG14$Site))
siteplot <- siteplot[siteplot$Freq > 0,]
names(siteplot) <- c("Plot","Site","Freq")

AGGpSurvey <- reshape(AGGper, direction="long", varying = list(names(AGGper)[-1]),
                      v.names="AGG",
                      idvar="Plot",
                      timevar="Survey",
                      times=names(AGGper)[-1])

AGGpSurvey <- merge(AGGpSurvey,siteplot,by = "Plot")
AGGpSurvey$Survey <- factor(AGGpSurvey$Survey, levels = unique(AGG14$Survey))
```

```{r}
ggplot(AGGpSurvey[AGGpSurvey$AGG > 0,], aes(Survey, AGG, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', mult=1)+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Percent of total AGG over the year per survey")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
#  geom_text(data=plotnum, aes(label=x, y=1, x=Survey, size = 0.9))+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")+
  scale_y_continuous(labels = percent)


```

```{r}
rm(AGGpersurvey.15)
AGGpersurvey.15 <- lapply(unique(AGG15$Plot), function(x){
  sapply(unique(AGG15$Survey), function(y){
    length(AGG15$X[AGG15$Ln>0 & 
                     AGG15$Plot == x & 
                     AGG15$Survey == y])/length(AGG15$X[AGG15$Ln>0 &
                                                          AGG15$Plot == x])
           })
  })

names(AGGpersurvey.15) <- unique(AGG15$Plot)
AGGper.15 <- do.call(rbind,AGGpersurvey.15)
AGGper.15 <- data.frame(AGGper.15)
names(AGGper.15) <- unique(AGG15$Survey)
AGGper.15 <- data.frame(Plot=rownames(AGGper.15),AGGper.15)

AGGpSurvey.15 <- reshape(AGGper.15, direction="long", varying = list(names(AGGper.15)[-1]),
                      v.names="AGG",
                      idvar="Plot",
                      timevar="Survey",
                      times=names(AGGper.15)[-1])

AGGpSurvey.15 <- merge(AGGpSurvey.15,siteplot,by = "Plot")
AGGpSurvey.15$Survey <- factor(AGGpSurvey.15$Survey, levels = unique(AGG15$Survey))
```

```{r}
ggplot(AGGpSurvey.15[AGGpSurvey.15$AGG > 0,], aes(Survey, AGG, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', mult=1)+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Percent of total AGG over the year per survey")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
#  geom_text(data=plotnum, aes(label=x, y=1, x=Survey, size = 0.9))+
#  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")+
  scale_y_continuous(labels = percent)


```

figure 6c
```{r}
# set status
head(dm)
dm$status <- "dead"
dm$status[dm$Ln > 0 & dm$Fl == 1] <- "reproductive"
dm$status[dm$Ln > 0 & dm$Fl == 0] <- "vegetative"

table(dm$status,dm$Survey)

#One case says 'no cotyledons'
table(dm$Comment)
unique(dm$Comment[grep("coty", dm$Comment)])
dm$Comment[grep("no coty", dm$Comment)] <- "Cotyledons "
seedlings <- dm[grep("coty", dm$Comment),] 
seedlings$Comment <- factor(seedlings$Comment)
table(seedlings$Comment, seedlings$Ln)

dm$status[grep("coty", dm$Comment)] <- "seedling" 

#dormant would have an existing tag and length at a later time
length(unique(dm$tag[dm$status == "dead"]))

dm$status <- factor(dm$status, levels = c("seedling","vegetative","reproductive","dormant","dead"))


unique.season <- ddply(dm, .(Site, Plot, status), summarise,
                       UniqueNumAGG = length(unique(X[Ln >0])))

#unique.season <- lapply(split(dm, dm[,c("Site","Plot","status")]), function(x){
#  if(nrow(x) > 0){
#    cbind(x[1,c("Site","Plot","status")], num = nrow(x))
#    }
#})
# Filter(function(x) dim(x)[1] > 0, unique.season)

unique.season

number.time <- ddply(dm, .(Site, Plot, Survey, status), summarise,
                     NumAGG = length(unique(X[Ln >0])))

merge.num.season <- merge(unique.season, number.time, by = c("Site","Plot","status"))

merge.num.season$Percent <- merge.num.season$NumAGG/merge.num.season$UniqueNumAGG

ggplot(merge.num.season, aes(status, Percent, colour = status)) +
  geom_boxplot() +
  theme_bw() +
	facet_grid(~ Survey)+
	ylab("Percent of total") +
	theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust = 0))+
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))+
  scale_y_continuous(labels = percent)

```

```{r learned from intra}
dm$SurveyNum <- as.numeric(dm$Survey)
dm$tag[dm$status == "seedling"]

tags <- ddply(dm, .(status), summarise,
              Tags = unique(tag))

tags.plot <- tags$Tags[tags$status == "seedling"]

tags.seed <- merge(dm, data.frame(tag = tags.plot), by = "tag")

# For the most part stayed under 10cm if saw cotyledons
ggplot(tags.seed, aes(Survey, Ln, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', mult=1)+
  facet_grid(~Site)+
  theme_bw()+
  xlab("Average Length")+
    theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5)) 

ggplot(tags.seed, aes(Survey, Ln, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', mult=1)+
  facet_grid(~status)+
  theme_bw()+
  xlab("Average Length")+
    theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5)) 


dm.pva <- subset(merge(dm, dm, by = c("Site","Plot","X")), SurveyNum.x == SurveyNum.y - 1)


```

Figure 7: Principal component analysis of nine environmental factors separating yearly demographic data on Astragalus microcymbus within the South Beaver Creek drainage near Gunnison, CO. Blue points are mast seeding years (top left), years with greater than the average reproductive individuals per plot (17%; top right), and years with greater than 28% dormant plants per plot (bottom) excluding the first and last years of the study, 1995 and 2015 (shown in gray). 
```{r}
#Plot summary for demographic data per year

# fruit above a SE above
avgfruit <- aggregate(Total.Fruit ~ Creek, data = ps.asmi, mean)
SEfruit <- aggregate(Total.Fruit ~ Creek, data = ps.asmi, std.error)
avgfruit[,2]+SEfruit[,2]
pcafruit <- aggregate(Total.Fruit ~ Year + Creek, data = ps.asmi, function(x){
  if(mean(x) > 321.75){
    }else{
      0
      }
  })

# percent reproductive
avgfl <- aggregate(X..Flowered ~ Creek, data = ps.asmi, mean)
SEfl <- aggregate(X..Flowered ~ Creek, data = ps.asmi, std.error)
avgfl[,2]+SEfl[,2]
pcarepro <- aggregate(X..Flowered ~ Year + Creek, data = ps.asmi, function(x){
  if(mean(x) > .267){
    1
    }else{
      0
      }
  })

# percent dormant
avgdorm <- aggregate(((Total.Plants-Total.Alive)/Total.Plants) ~ Creek, data = ps.asmi, mean)
SEdorm <- aggregate(((Total.Plants-Total.Alive)/Total.Plants) ~ Creek, data = ps.asmi, std.error)
avgdorm[,2]+SEdorm[,2]
pcadorm <- aggregate(((Total.Plants-Total.Alive)/Total.Plants) ~ Year + Creek, data = ps.asmi, function(x){
  if(mean(x) > .454){
    1
    }else{
      0
      }
  })
pcadorm[pcadorm$Year == 1995 | pcadorm$Year == 2015,3] <- 2


ps.pc <- data.frame(asmi.pc[asmi.pc$Creek == "South Beaver Creek",], 
                    Fruit = pcafruit[pcafruit$Creek == "South Beaver Creek","Total.Fruit"],
                    Repro = pcarepro[pcarepro$Creek == "South Beaver Creek","X..Flowered"],
                    PerDorm = pcadorm[pcadorm$Creek == "South Beaver Creek",3])


ps.pc.2 <- merge(ps.asmi[,c(grep(paste(c("Rain","Temp"), collapse="|"),names(ps.asmi), 
                               value = TRUE, invert=TRUE))], 
               asmi.pc, by.x = c("Creek","Year"), by.y = c("Creek","Prev12"))

```

```{r t-tests Figure 6}
# Reproductive not signficantly different
t.test(Comp.1 ~ as.factor(Repro), data = ps.pc)
t.test(Comp.2 ~ as.factor(Repro), data = ps.pc)

# Fruit
t.test(Comp.1 ~ as.factor(Fruit), data = ps.pc)
t.test(Comp.2 ~ as.factor(Fruit), data = ps.pc)

# Fruit
t.test(Comp.1 ~ as.factor(PerDorm), data = ps.pc[ps.pc$Prev12 > 1995 & ps.pc$Prev12 < 2015,])
t.test(Comp.2 ~ as.factor(PerDorm), data = ps.pc[ps.pc$Prev12 > 1995 & ps.pc$Prev12 < 2015,])
```



Percent reproductive
```{r fruit}
ggplot(ps.pc, aes(Comp.1, Comp.2, colour = as.factor(Repro), label = Prev12))+
  geom_text(alpha = 0.75, angle = 45, size = 3) +
  stat_ellipse()+
  xlab("PC1 (36%)")+
  ylab("PC2 (23%)")+
  theme_bw()+
  ggtitle("c)")+
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Percent Reproductive", 
                     labels = c("<=26.7%",">26.7%"), 
                     values = c("grey50","black"))+
  theme(legend.justification=c(0,0), legend.position=c(0,0))
```

Mast seeding
```{r}
ggplot(ps.pc, aes(Comp.1, Comp.2, colour = as.factor(Fruit), label = Prev12))+
  geom_text(alpha = 0.75, angle = 45, size = 3) +
  stat_ellipse()+
  xlab("PC1 (36%)")+
  ylab("PC2 (23%)")+
  theme_bw()+
  ggtitle("b)")+
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Mast Seeding", labels = c("Low/No Seed","Mast"), values = c("grey50","black"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1)) 
  
```

Percent dormant
```{r}
ggplot(ps.pc, aes(Comp.1, Comp.2, colour = as.factor(PerDorm), label = Prev12))+
  geom_text(alpha = 0.75, angle = 45, size = 3) +
  stat_ellipse()+
  xlab("PC1 (36%)")+
  ylab("PC2 (23%)")+
  theme_bw()+
  ggtitle("d)")+
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Percent Dormant", 
                     labels = c("<=45.4%",">45.4%","First and Last Year"), 
                     values = c("grey50","black","red"))+
  theme(legend.justification=c(0,0), legend.position=c(0,0))
```

