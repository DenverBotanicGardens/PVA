---
title: "AsMi_annual report"
author: "Michelle DePrenger-Levin"
date: "Tuesday, October 27, 2015"
output: pdf_document
---

AsMiPVA

Table 1:Demographic data of Astragalus microcymbus within the South Beaver Creek and Cebolla Creek drainages near Gunnison, Colorado. (a) Average number of individuals with above ground growth (AGG) followed by total individuals (AGG and dormant) per plot. (b) Percent of reproductive individuals followed by average reproductive individuals per plot. Site 1 is Cebolla Creek Mid and site 2 is Cebolla Creek north. Standard errors are shown in parentheses.


```{r}
library(reshape2)
library(ggplot2)
```


```{r}
asmi.raw <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/2015_asmi/RawData_20yrsdormant_110615.csv"))

head(asmi.raw)
table(asmi.raw$year, asmi.raw$AsMi_site_id)
#asmi.raw <- transform(asmi.raw, year = as.numeric(year))
str(asmi.raw)
table(asmi.raw$AsMi_plot_id,asmi.raw$AsMi_site_id)

```


summarySE function borrowed from http://www.cookbook-r.com/Manipulating_data/Summarizing_data/    
```{r}
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
    library(plyr)

    # New version of length which can handle NA's: if na.rm==T, don't count them
    length2 <- function (x, na.rm=FALSE) {
        if (na.rm) sum(!is.na(x))
        else       length(x)
    }

    # This does the summary. For each group's data frame, return a vector with
    # N, mean, and sd
    datac <- ddply(data, groupvars, .drop=.drop,
      .fun = function(xx, col) {
        c(N    = length2(xx[[col]], na.rm=na.rm),
          mean = mean   (xx[[col]], na.rm=na.rm),
          sd   = sd     (xx[[col]], na.rm=na.rm)
        )
      },
      measurevar
    )

    # Rename the "mean" column    
    datac <- rename(datac, c("mean" = measurevar))

    datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean

    # Confidence interval multiplier for standard error
    # Calculate t-statistic for confidence interval: 
    # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
    ciMult <- qt(conf.interval/2 + .5, datac$N-1)
    datac$ci <- datac$se * ciMult

    return(datac)
}
```


### Years alive    

```{r}
path <- "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/2015_asmi/"

yrsalive <- lapply(1:10, function(x){ 
  path2 <- paste(path, "YrsAlive_dormant", x, ".csv", sep = "")
  ysal <- read.csv(path.expand(path2), na.strings="na")
  cbind(ysal, YrsD = x)
  })

head(yrsalive[[4]])
str(yrsalive[[1]])

yrsalive[[1]][is.na(yrsalive[[1]]$Yearsalive),]

yrsalive[[3]][is.na(yrsalive[[3]]$AsMi_plot_id),]


#eliminate na or make them zeros?
# complete.cases will eliminate any that aren't yet dead or are new in 2015 sinece they've only been seen one year. 
sumYrsAlive <- lapply(yrsalive, function(x){
  summarySE(x[complete.cases(x),], measurevar="Yearsalive",groupvars=c("AsMi_plot_id","AsMi_site_id","YrsD"))
})

tail(sumYrsAlive[[5]])

smya <- do.call()
```


Ignore making NA to zeros
```{r}
#try making them zeros
yrsalivezero <- lapply(yrsalive, function(x){
  replace(x, is.na(x), 0)
})

head(yrsalivezero[[5]])
yrsalivezero[[5]][yrsalivezero[[5]]$AsMi_plot_id == 0,]

sumyrsalivezero <- lapply(yrsalivezero, function(x){
  summarySE(x[complete.cases(x),], measurevar="Yearsalive",groupvars=c("AsMi_plot_id","AsMi_site_id"))
})

smzero <- do.call(rbind,sumyrsalivezero)
head(sumyrsalivezero[[5]])  # Why is there 1 row of no data? In the download there is one row of blank

#Wait, want to know how many years allowed dormant and want years before cbind, but this is the summary...
smzero <- smzero[smzero$AsMi_plot_id != 0,]
head(smzero)


```




###Environmental Data from PRISM:   
<http://prism.oregonstate.edu/explorer/>   


```{r}
asmi.climate <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/2015_asmi/prism_data_csv.csv"),skip=6)
head(asmi.climate)

asmi.climate$Year <- substr(asmi.climate$Date,1,4)
asmi.climate$Month <- substr(asmi.climate$Date,6,7)
asmi.climate <- data.frame(Site = "South Beaver Creek", asmi.climate)

asmi.c <- asmi.climate[,c(1,3,5,7:9)]
names(asmi.c) <- c("Site","Precip","tmin","tmax","Year","Month")
head(asmi.c)
```

Seasons    
Winter: December-March (12-3)    
Spring/summer: April-July (4-7)    
Fall: August-November (8-11)   
```{r}
asmi.c$season <- "winter"
asmi.c[asmi.c$Month>3 & asmi.c$Month<8, "season"] <- "spring/summer"
asmi.c[asmi.c$Month>7 & asmi.c$Month<12, "season"] <- "fall"

asmi.c.summary <- aggregate(asmi.c[,2:4])

```


### Intraannual visits    
Will want to ignore sites that were not visited - deal with differently than plants that were not seen but are also NA    


```{r}
intra <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Raw Data/2015 datasheets/2015_intrayear_asmi.csv"), na.strings="")

head(intra)
names(intra)
str(intra)

intra[intra$Plot == 8,"LnJune22.24"]
head(intra[intra$Plot == 8,])

intra <- transform(intra, LnJune22.24 = as.numeric(LnJune22.24))

sur.plots <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/2015_asmi/IntraYearsurveys_tomerge.csv"), na.strings="")

# More helpful to swap
#colnames(intra)[grep("Ln",names(intra))] <- c("Ln13",colnames(tsur.plots))
#colnames(intra)

nms <- colnames(intra[grep("Ln",names(intra))])
row.names(sur.plots) <- nms[-1]

sur.plots
tsur.plots <- t(sur.plots[,-1])
head(tsur.plots)
colnames(tsur.plots) <- sur.plots[,1]

sp <- melt(tsur.plots)
surveyed <- sp[sp$value==1,]
notsurveyed <- sp[is.na(sp$value),]

foo <- lapply(split(intra, intra$Plot), 
              function(x){
                cbind(colSums(x[,grep("Ln", names(x))], na.rm = TRUE),unique(x$Plot))
                })
foo[[2]]
sumln <- do.call(rbind, foo)
rownames(sumln)
plotswithdata <- sumln[sumln[,1] > 0,]
plotsmissingdata <- sumln[sumln[,1] == 0,]



str(intra)


```

Reformat intra data    
```{r}
head(intra)

melt(intra[grep("")])
```





