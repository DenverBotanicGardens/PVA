---
title: "AsMi_annual report"
author: "Michelle DePrenger-Levin"
date: "Tuesday, October 27, 2015"
output: html_document
---
The git remote is "AsMiPVA"
AsMiPVA

```{r}
library(reshape2)
library(ggplot2)
library(psych)
library(popbio)
library(devtools)
library(sciplot)
library(plotrix)
library(scales)
library(plyr)
library(devtools)
library(digest)
library(RCurl)
# install_github(repo = "prism", username = "ropensci")
library(prism)
library(rgdal)
library(raster)
library(Rmisc)
# library(data.table)
# install.packages('survminer')
library(survminer)

library(car) # line 381

# AIC
require(AICcmodavg)
library(lme4)
library(lattice)


# A ggplot plot layout function 
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  numPlots = length(plots)
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }
 if (numPlots==1) {
    print(plots[[1]])
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

Remove all variables, keep functions
```{r reset values, eval = FALSE}
rm(list = setdiff(ls(), lsf.str()))
```

summarySE function borrowed from http://www.cookbook-r.com/Manipulating_data/Summarizing_data/  
Function for t.tests, for annual lambdas
```{r}

# StagePVA_Function.R
script <- getURL("https://raw.githubusercontent.com/DenverBotanicGardens/PVA/master/StagePVA_Function.R",ssl.verifypeer = FALSE)
eval(parse(text = script))


# ### Function for lambda and 
# requires library(popbio)    
# x is the list of matrices, i.e. notfenced.Site.matrix$"26",     
# 					or fenced.Site.matrix$"19"[2:17])    
# y is the start year    
# z is the start of the last transition

lmdSD <- function(x,y,z){
  
  startyr <- min(as.numeric(names(x)))
	yrs <- startyr:z
	st <- match(c(y,z),yrs)
	
	lambdaAll <- c()
	for(i in c(y:z)){
		lambdaAll <- cbind(lambdaAll,eigen.analysis(x[[as.character(i)]])$lambda)
	}	
	StandDev <- sqrt(var(c(lambdaAll)))	#Standard Deviation
	cbind(lmda = lambda(mean(x[st[1]:st[2]])),SD = StandDev)
}	

lmdAn <- function(x,y,z){
	lambdaAll <- c()
	for(i in c(y:z)){
		lambdaAll <- cbind(lambdaAll,eigen.analysis(x[[as.character(i)]])$lambda)
	}	
	lambdaAll
}
```


# Download raw_data 
<https://research.botanicgardens.org/admin/demographics/asmi/reports/raw_data.php>   
Save all sites, all data, and set to 20 years allowed dormant (or all possible years)    
Put the new data in folder currentyr_asmi and name it RawData_currentyr 
```{r}
currentyr <- as.numeric(format(as.Date(Sys.Date(),format="%Y-%m-%d"), "%Y"))
rawdatapath <- paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/", 
                     currentyr,"_asmi/RawData_",
                     currentyr, ".csv", collapse = '', sep = '')

asmi.raw <- read.csv(path.expand(rawdatapath), na.strings = "na")

asmi.raw$length[is.na(asmi.raw$length)] <- 0

# For plots that didn't start in 1995 !!! All new plants are listed as seedlings in 2014 and none should
table(asmi.raw$AsMi_plot_id[asmi.raw$AsMi_site_id==1], 
      asmi.raw$status[asmi.raw$AsMi_site_id==1], 
      asmi.raw$year[asmi.raw$AsMi_site_id==1])

table(asmi.raw$AsMi_plot_id[asmi.raw$AsMi_site_id==2], 
      asmi.raw$status[asmi.raw$AsMi_site_id==2], 
      asmi.raw$year[asmi.raw$AsMi_site_id==2])

# Site 26 had two plots added later; Plots 238 and 300 were added in 1996 with no seedlings! good!;  plot 598 was added in 2004, no seedlings, good!  
table(asmi.raw$AsMi_plot_id[asmi.raw$AsMi_plot_id %in% c(238,300,598)], 
      asmi.raw$status[asmi.raw$AsMi_plot_id %in% c(238,300,598)],
      asmi.raw$year[asmi.raw$AsMi_plot_id %in% c(238,300,598)])

# Need to change all the seedling in 2014 for sites 1 and 2 to approraite other thing
asmi.raw$status[asmi.raw$AsMi_site_id<3 & asmi.raw$year == 2014 & asmi.raw$flower == 0] <- "vegetative"
asmi.raw$status[asmi.raw$AsMi_site_id<3 & asmi.raw$year == 2014 & asmi.raw$flower == 1] <- "reproductive"

# No longer adding climate data to the database
asmi.raw <- asmi.raw[,grep(paste(c("Temp","Rain","Snow","Aug.Jul"),collapse="|"), names(asmi.raw),
                           value = TRUE, invert = TRUE)]

table(asmi.raw$year, asmi.raw$AsMi_site_id)
table(asmi.raw$year, asmi.raw$AsMi_plot_id)
table(asmi.raw$Browsing...Status)
#asmi.raw <- transform(asmi.raw, year = as.numeric(year))

table(asmi.raw$AsMi_plot_id,asmi.raw$AsMi_site_id)

# one blank row at the end of the csv download
asmi.raw[asmi.raw$status == "",]
asmi.raw <- asmi.raw[asmi.raw$status != "",]
asmi.raw$status <- factor(asmi.raw$status)
table(asmi.raw$status)

#reset factors of browsing to eliminate " "
asmi.raw$Browsing...Status[asmi.raw$Browsing...Status == "mammal"] <- "Mammal"
asmi.raw$Browsing...Status <- factor(asmi.raw$Browsing...Status)

#reset factors for fence
asmi.raw$fence <- factor(asmi.raw$fence)
table(asmi.raw$fence)

asmi.raw[asmi.raw$length>90 & !is.na(asmi.raw$length),] 
asmi.raw$length[asmi.raw$length == 921] <- 21

asmi.raw[asmi.raw$status=="vegetative" & asmi.raw$fruit>0,]
wrongAsMidataid <- asmi.raw$AsMi_data_id[asmi.raw$status=="vegetative" & asmi.raw$fruit>0]
asmi.raw$flower[asmi.raw$AsMi_data_id %in% wrongAsMidataid] <- 1
asmi.raw$status[asmi.raw$AsMi_data_id %in% wrongAsMidataid] <- "reproductive"
asmi.raw[asmi.raw$AsMi_data_id %in% wrongAsMidataid,]

# Years of study
length(1995:2019)
```

Table 1:Demographic data of Astragalus microcymbus within the South Beaver Creek and Cebolla Creek drainages near Gunnison, Colorado. (a) Average number of individuals with above ground growth (AGG) followed by total individuals (AGG and dormant) per plot. (b) Percent of reproductive individuals followed by average reproductive individuals per plot. Site 1 is Cebolla Creek Mid and site 2 is Cebolla Creek north. Standard errors are shown in parentheses.
```{r}
#AGG
alive <-aggregate(length ~ AsMi_plot_id + year + AsMi_site_id + fence, 
                  data = asmi.raw, function(x) length(x[x>0 & !is.na(x)])) #length of group when the plant had a length greater than zero


alive2 <- do.call(rbind, lapply(split(asmi.raw, list(asmi.raw$AsMi_plot_id,asmi.raw$year)), 
                                function(x){
                                  if(nrow(x)==0){
                                    out <- c(Plot=NA,Year=NA,Site=NA,Fence=NA,AGG=NA,Alive=NA)
                                    out
                                  } else {
                                  AGG <- nrow(x[x$length>0,])
                                  Alive <- length(x$status[x$status!="dead"])
                                  out <- data.frame(Plot = unique(x$AsMi_plot_id),
                                                    Year = unique(x$year),
                                                    Site = unique(x$AsMi_site_id),
                                                    Fence = unique(x$fence),
                                                    AGG, Alive)
                                  out}
                                  }))

alive2<- alive2[complete.cases(alive2),]

totalyr <- aggregate(length~AsMi_site_id, data = alive[alive$year == currentyr,], sum)
sum(totalyr$length[1:2])
sum(totalyr$length[3:6])

# What percent of original size are all plots?
totalPerOriginal <- lapply(split(alive2,alive2$Plot),
                                  function(plot){
                                    first <- plot$AGG[plot$Year==min(plot$Year)]
                                    last <- plot$AGG[plot$Year==max(plot$Year)]
                                    percent <- last/first
                                    out <- data.frame(plot[plot$Year==min(plot$Year),],
                                                      plot[plot$Year==max(plot$Year),
                                                           c("Year","AGG","Alive")],
                                                      percent)
                                    out
                                    })
totPOrig <- do.call(rbind,totalPerOriginal)

outdata <- (aggregate(percent~Site+Fence, data=totPOrig, mean))
outdata[with(outdata, order(percent,Site,Fence)),]


#AGG and dormant
aggdorm <- aggregate(status ~ AsMi_plot_id +year + AsMi_site_id  + fence,
                     data = asmi.raw, function(x) length(x[x != "dead" & !is.na(x)]))


ggplot(alive, aes(year, length, colour=as.factor(AsMi_site_id)))+
#  geom_point()+
  stat_smooth(se=FALSE)+
  ylab("Individuals per plot")+
  xlab("Year")+
  theme_bw()+
  scale_color_manual("Sites",labels = c("Cebolla Mid", 
                                          "Cebolla North",
                                          "5","15","19","26"),
                     values = c("cyan", "darkblue",
                                "olivedrab","olivedrab1",
                                "mediumseagreen","mistyrose3"))


table(alive$AsMi_site_id, alive$length)
asmi.raw[asmi.raw$length>90 & !is.na(asmi.raw$length),] # Plot 238, tag 925, Ln '921' -> 21??



table(alive$AsMi_site_id, alive$year) # 2 is cebolla north, 1 is mid
```

#Fluctuations  
```{r}

#AGG
alive.site <-aggregate(length ~ year + AsMi_site_id + fence, 
                  data = asmi.raw, function(x) length(x[x>0 & !is.na(x)]))


#AGG and dormant
aggdorm.site <- aggregate(status ~ year + AsMi_site_id  + fence,
                     data = asmi.raw, function(x) length(x[x != "dead" & !is.na(x)]))


PercentAlive <- lapply(split(alive.site, alive.site$AsMi_site_id), function(x){
  nofence <- x$length[x$year == max(x$year)&
                        x$fence=="n"]/x$length[x$year==min(x$year)&x$fence=="n"]
  fence <- x$length[x$year == max(x$year)&
                      x$fence=="y"]/x$length[x$year==min(x$year)&x$fence=="y"]
  cbind(nofence,fence)

  })

tbl1a.1 <- summarySE(alive, measurevar="length", groupvars=c("AsMi_site_id", "year"))

tbl1a.2 <- summarySE(aggdorm, measurevar="status", groupvars=c("AsMi_site_id", "year"))

sites <- unique(tbl1a.1$AsMi_site_id)

tbl1.1 <- lapply(sites, function(x){
  paste(round(tbl1a.1[tbl1a.1$AsMi_site_id == x,"length"],2)," (",
        round(tbl1a.1[tbl1a.1$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1.2 <- lapply(sites, function(x){
  paste(round(tbl1a.2[tbl1a.2$AsMi_site_id == x,"status"],2)," (",
        round(tbl1a.2[tbl1a.2$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1a <- lapply(1:6, function(x){
  data.frame(tbl1.1[[x]],tbl1.2[[x]])
  })

savepath <- paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/", 
                     currentyr,"_asmi/", collapse = '', sep = '')

Table1 <- data.frame(tbl1a[[3]],tbl1a[[4]],tbl1a[[5]],tbl1a[[6]])
names(Table1) <- c("Site 05 (5 plots)"," ","Site 15 (4 plots)"," ",
                   "Site 19 (5 plots)"," ","Site 26 (5 plots)"," ")

write.table(Table1, file=paste(savepath,"Table1a_SouthBeaverCreek.csv"), sep=",", row.names=FALSE, col.names = TRUE)

Table1_Cebolla <- data.frame(tbl1a[[1]],tbl1a[[2]])
names(Table1_Cebolla) <- c("Site 1 (5 plots)"," ","Site 2 (6 plots)"," ")

write.table(Table1_Cebolla, file=paste(savepath,"Table1a_CebollaCreek.csv"), sep=",", row.names=FALSE, col.names = TRUE)


# Percent and total preproductive
# precent reproductive, return 0 if no 
prep <- aggregate(flower~AsMi_plot_id+year+AsMi_site_id +fence,
                  data = asmi.raw[asmi.raw$length > 0 & !is.na(asmi.raw$length),],
                  function(x){
                    if(length(x)>0){
                      sum(x,na.rm = TRUE)/length(x)
                    } else {
                        0
                      }
                  })
tbl1b.1 <- summarySE(prep, measurevar="flower", groupvars=c("AsMi_site_id","year"))

# Years when there were no reproductive individuals  
# Episodic fruit production paragraph
prep[prep$flower==0,]
annual_SBC <- aggregate(flower~year, data=prep[prep$AsMi_site_id>3,], sum)
zero_annual <- data.frame(num = nrow(annual_SBC[annual_SBC$flower == 0,]),
                          percent = nrow(annual_SBC[annual_SBC$flower == 0,])/nrow(annual_SBC))


do.call(rbind,zero_annual)

annual_site <- aggregate(flower~AsMi_site_id+year, data=prep, sum)
zero_site <- lapply(split(annual_site, annual_site$AsMi_site_id), function(x){
  numberof <- nrow(x[x$flower == 0,])
  percent <- nrow(x[x$flower == 0,])/nrow(x)
  data.frame(numberof,percent)
})
zero_all <- do.call(rbind,zero_site)
mean(zero_all$numberof[3:6]) # average number of years with no reproduction

```


```{r}
#sites above
#percent reproductive 
tbl1.3 <- lapply(sites, function(x){
  paste(round(tbl1b.1[tbl1b.1$AsMi_site_id == x,"flower"],3)*100,"% (",
        round(tbl1b.1[tbl1b.1$AsMi_site_id == x,"se"],3)*100, "%)", sep="")
})

tbl1.3[[3]]

#total reproductive
totrep <- aggregate(flower ~ AsMi_plot_id +year + AsMi_site_id  + fence,
                    data = asmi.raw[asmi.raw$length > 0 & !is.na(asmi.raw$length),], 
                    function(x) sum(x, na.rm = TRUE))


tbl1b.2 <- summarySE(totrep, measurevar="flower",groupvars=c("AsMi_site_id","year"))

tbl1.4 <- lapply(sites, function(x){
  paste(round(tbl1b.2[tbl1b.2$AsMi_site_id == x,"flower"],2)," (",
        round(tbl1b.2[tbl1b.2$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1b <- lapply(1:6, function(x){
  data.frame(tbl1.3[[x]], tbl1.4[[x]])
  })

Table1b <- data.frame(tbl1b[[3]],tbl1b[[4]],tbl1b[[5]],tbl1b[[6]])
names(Table1b) <- c("Site 05 (5 plots)"," ","Site 15 (4 plots)"," ",
                   "Site 19 (5 plots)"," ","Site 26 (5 plots)"," ")

write.table(Table1b, file=paste(savepath,"Table1b_SouthBeaverCreek.csv"), sep=",", row.names=FALSE, col.names = TRUE)

Table1b_Cebolla <- data.frame(tbl1b[[1]],tbl1b[[2]])
names(Table1b_Cebolla) <- c("Site 1 (5 plots)"," ","Site 2 (6 plots)"," ")

write.table(Table1b_Cebolla, file=paste(savepath,"Table1b_CebollaCreek.csv"), sep=",", row.names=FALSE, col.names = TRUE)
```

#Correlated biotic factors

Table 3: Biotic factors correlated among the percent browsed individuals in the current year, density of reproductive individuals in the current year, fruit production in the current year, and the percent of reproductive individuals and above ground growth (AGG) in the current and previous year of Astragalus microcymbus per year (1995-2014) within the South Beaver Creek drainage ....Significant PCC are indicated with an asterisk (p-value < 0.05).  

Plot Summary (weather data is prev. Aug through currrent Jul)   
Total.Plants are AGG and dormant    
Total.Alive is AGG   
X..Flowered must be percent flowered and    
X..Flowered.1 is number flowered

#Save new annual data in folder titled "<current year>_asmi" and name the file "PlotSummary_<current year>"
```{r}
plotdatapath <- paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",currentyr,
                      "_asmi/PlotSummary_",currentyr,".csv",
                      collapse = '', sep = '')
ps.asmi <- read.csv(path.expand(plotdatapath))

# remove the moniker of 'y' from fenced plots before they are fenced. 
ps.asmi$Fence[ps.asmi$Year<2006] <- 'n'


ps.asmi$Creek <- "SouthBeaver"
ps.asmi$Creek[ps.asmi$Site < 3] <- "Cebolla" 
ps.asmi$Creek <- as.factor(ps.asmi$Creek)

ps.asmi$Total.Alive[ps.asmi$Site <3 & ps.asmi$Year<2014] <- NA
ps.asmi$Total.Plants[ps.asmi$Site <3 & ps.asmi$Year<2014] <- NA

ps.asmi$Total.Alive[ps.asmi$Plot %in%  c(238,300) & ps.asmi$Year < 1996] <- NA
ps.asmi$Total.Plants[ps.asmi$Plot %in%  c(238,300) & ps.asmi$Year < 1996] <- NA

ps.asmi$Total.Alive[ps.asmi$Plot %in%  c(598) & ps.asmi$Year < 2004] <- NA
ps.asmi$Total.Plants[ps.asmi$Plot %in%  c(598) & ps.asmi$Year < 2004] <- NA




# Don't need the climate data from database, will download from PRISM
ps.asmi <- ps.asmi[,grep(paste(c("Temp","Rain","Snow","Aug.Jul"),collapse="|"), names(ps.asmi),
                           value = TRUE, invert = TRUE)]


cors <- c("Total.Alive","X..Browsed","X..Flowered","X..Dormant","Total.Fruit")

```

#log transform
```{r}
#t for transformations!
ps.asmi.t <- ps.asmi


ps.asmi.t <- ps.asmi.t[ps.asmi.t$Site<3 & ps.asmi.t$Year>2013 | ps.asmi.t$Site>4,]

# added plots 238 (site 26) and 300 (site 19) in 1996
# added 598 (site 26) in 2004 
ps.asmi.t <- ps.asmi.t[!(ps.asmi.t$Plot == 238 & ps.asmi.t$Year < 1996),]
ps.asmi.t <- ps.asmi.t[!(ps.asmi.t$Plot == 300 & ps.asmi.t$Year < 1996),]
ps.asmi.t <- ps.asmi.t[!(ps.asmi.t$Plot == 598 & ps.asmi.t$Year < 2004),]

table(ps.asmi.t$Year,ps.asmi.t$Site) #no rows for years when some plots weren't in yet


hist(ps.asmi.t$Total.Alive)
ks.test(ps.asmi.t$Total.Alive, plnorm)

hist(log(ps.asmi.t$Total.Alive+1))
ks.test(log(ps.asmi.t$Total.Alive+1), pnorm)

#log(ps.asmi.t$Total.Alive+1) right skew
scatterplotMatrix(~Total.Alive+log(ps.asmi.t$Total.Alive+1), 
                 diagonal = "qqplot",
                 data=ps.asmi.t) 
# ,
#                  reg.line=FALSE,
#                  smoother="")

#Want percent herbivory
ps.asmi.t$Percent..Browsing <- ps.asmi.t$X..Browsed/ps.asmi.t$Total.Alive

ps.asmi.t$Percent..Dormant <-
  (ps.asmi.t$Total.Plants-ps.asmi.t$Total.Alive)/ps.asmi.t$Total.Plants


logtrans <- c("Total.Alive", "Percent..Browsing",
              "X..Flowered.1","X..Flowered","Percent..Dormant","Total.Fruit")
intersect(names(ps.asmi.t),logtrans) #Check that names are right


log.t.cols <- do.call(data.frame,lapply(ps.asmi.t[,logtrans], function(x){ 
  log(x + 1)})) 
  #NA in num flowered
transformed <- sapply(logtrans,function(x) paste(x,"logtransformed",sep=""))

names(log.t.cols) <- transformed
ps.asmi.t <- data.frame(ps.asmi.t,log.t.cols)


#Arcsin sq rt transform percent browsing
assqrt <- do.call(data.frame,lapply(ps.asmi.t["Percent..Browsing"],
                                  function(x) asin(sqrt(x/100))))

names(assqrt) <- "X..Browsedarcsinsqrttransformed"
ps.asmi.t <- data.frame(ps.asmi.t, assqrt)

#Arcsin sq rt transform percent reproductive
assqrt.repro <- do.call(data.frame,lapply(ps.asmi.t["X..Flowered"],
                                  function(x) asin(sqrt(x/100))))

names(assqrt.repro) <- "X..Floweredarcsinsqrttransformed"
ps.asmi.t <- data.frame(ps.asmi.t, assqrt.repro)

# Don't need to transform browsed
scatterplotMatrix(~X..Floweredarcsinsqrttransformed+X..Flowered.1logtransformed+
                    Percent..Dormantlogtransformed+X..Browsedarcsinsqrttransformed+
                    X..Browsed, 
                 diagonal = "qqplot",
                 data=ps.asmi.t) #,
                 # reg.line=FALSE) #,
                 # smoother="")

ps.asmi.t$X..Flowered.1logtransformed[is.na(ps.asmi.t$X..Flowered.1logtransformed)] <- 0
ps.asmi.t$Percent..Dormantlogtransformed[is.na(ps.asmi.t$Percent..Dormantlogtransformed)] <- 0
ps.asmi.t$Percent..Browsinglogtransformed[is.na(ps.asmi.t$Percent..Browsinglogtransformed)] <- 0
ps.asmi.t$X..Floweredarcsinsqrttransformed[is.na(ps.asmi.t$X..Floweredarcsinsqrttransformed)] <- 0
ps.asmi.t$X..Browsedarcsinsqrttransformed[is.na(ps.asmi.t$X..Browsedarcsinsqrttransformed)] <- 0

ps.cor <- subset(merge(ps.asmi.t, ps.asmi.t, 
                       by = c("Site","Plot")), Year.x == Year.y - 1)

```

cors =  "Total.Alive" "X..Browsed"  "X..Flowered" "X..Dormant"  "Total.Fruit"    
ps.cor has both previous (.x) = t      
and following year (.y) = t+1
```{r}

forcor <- names(ps.cor[,grep("transformed",names(ps.cor))])[c(1,7:8,3,5:6,
                                                              9,15:16,11,13:14)]
cor.vars <- length(forcor)

cortests <- apply(combn(1:cor.vars,2), 2, function(x){
  cor.df <- ps.cor[,forcor]
  ct <- cor.test(cor.df[,x[1]], cor.df[,x[2]])
  out <- data.frame(Var.1 = names(cor.df)[x[1]], Var.2 = names(cor.df)[x[2]],
                    P.val = ct$p.value, Cor.est = ct$estimate)
})

df.c <- do.call(rbind,cortests)

write.csv(df.c, file=paste(savepath,"Table2_PCC.csv"), row.names=TRUE)

#significant - don't worry about signficant alone or don't report at all
df.c[df.c$P.val > 0.04,]

```



#AIC  Information Criteria   
Table 2: linear regression model performance 
AIC = -2L + 2k   
  L is loglikelihood   
  k is number of parameters     
Compare all models at the same time, instead of stepping through pairwise comparisons of tests. 
Flawed still, too many factors/parameters, not enough data. 

Just look at differences separating site and not, separate plot or not. 
Can look at these and then work forward to test predictive on new data (like the BLM or sites we visit this year)

AGG 
```{r}

lm1 <- lm(Total.Alivelogtransformed ~ Year, ps.asmi.t)
lm2 <- lm(Total.Alivelogtransformed ~ Year*as.factor(Site), ps.asmi.t)
lm3 <- lm(Total.Alivelogtransformed ~ Year*Creek, ps.asmi.t) #Need add creek!
lm4 <- lm(Total.Alivelogtransformed ~ Year*Fence, ps.asmi.t)
lm5 <- lm(Total.Alivelogtransformed ~ 1, ps.asmi.t)
lm6 <- lm(Total.Alivelogtransformed ~ as.factor(Site), ps.asmi.t)
lm7 <- lm(Total.Alivelogtransformed ~ Creek, ps.asmi.t) 
lm8 <- lm(Total.Alivelogtransformed ~ Fence, ps.asmi.t)

lm.list <- list(lm1,lm2,lm3,lm4,lm5,lm6,lm7,lm8)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))

#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}


lmer(Total.Alivelogtransformed ~ Year|Site, ps.asmi.t)  #random intercept
lmer(Total.Alivelogtransformed ~ Year|Creek, ps.asmi.t)  #random intercept
xyplot(Total.Alive ~ Year|as.factor(Site), ps.asmi.t,
       type = c("g","p","r"),
       index = function(x,y) coef(lm(y~x))[1],
       xlab = "Year", 
       ylab = "Individuals with AGG", aspect = "xy")

xyplot(Total.Alive ~ Year|as.factor(Creek), ps.asmi.t,
       type = c("g","p","r"),
       index = function(x,y) coef(lm(y~x))[1],
       xlab = "Year", 
       ylab = "Individuals with AGG", aspect = "xy")

```

Only during censuses at both drainages
```{r}
lm1 <- lm(Total.Alivelogtransformed ~ Year, ps.asmi.t[ps.asmi.t$Year > 2013,])
lm2 <- lm(Total.Alivelogtransformed ~ Year*as.factor(Site), ps.asmi.t[ps.asmi.t$Year > 2013,])
lm3 <- lm(Total.Alivelogtransformed ~ Year*Creek, ps.asmi.t[ps.asmi.t$Year > 2013,])
lm4 <- lm(Total.Alivelogtransformed ~ Year*Fence, ps.asmi.t[ps.asmi.t$Year > 2013,])
lm5 <- lm(Total.Alivelogtransformed ~ 1, ps.asmi.t[ps.asmi.t$Year > 2013,])
lm6 <- lm(Total.Alivelogtransformed ~ as.factor(Site), ps.asmi.t[ps.asmi.t$Year > 2013,])
lm7 <- lm(Total.Alivelogtransformed ~ Creek, ps.asmi.t[ps.asmi.t$Year > 2013,]) 
lm8 <- lm(Total.Alivelogtransformed ~ Fence, ps.asmi.t[ps.asmi.t$Year > 2013,])

lm.list <- list(lm1,lm2,lm3,lm4,lm5,lm6,lm7,lm8)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))

#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}
```

# don't have first or last year when using ps.cor    
shoud use ps.asmi.t instead
```{r}
lmer(Total.Alivelogtransformed ~ Fence|Creek, ps.asmi.t)  #random intercept
xyplot(Total.Alivelogtransformed ~ Fence|as.factor(Site), ps.asmi.t,
       type = c("g","p"),
       xlab = "Year", 
       ylab = "Individuals with AGG", aspect = "xy")

```

```{r}
ps.asmi.t$Site <- factor(as.factor(ps.asmi.t$Site), levels = levels(as.factor(ps.asmi.t$Site)))

jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/","Fig2-latticeplot_6Sites_after2013.jpg", sep = ""),
         units = "mm", res = 300, height = 200, width = 150)


xyplot(Total.Alive ~ Year|as.factor(Site), ps.asmi.t[ps.asmi.t$Year > 2013,],
       type = c("g","p","r"),
       layout = c(2, 3),
       index.cond = list(1:6),
       as.table = TRUE,
       index = function(x,y) coef(lm(y~x))[1],
                  panel = function(x, y) {
        panel.grid(v=2)
        panel.xyplot(x, y)
        panel.loess(x, y, span = .8, degree = 1, family="gaussian")
        panel.abline(lm(y~x))
           },
       xlab = "Year", 
       ylab = "Individuals with AGG", aspect = "xy")

dev.off()

```

```{r}

jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",currentyr,"_asmi/",
           "Fig2-latticeplot_6Sites.jpg", sep = ""),
         units = "mm", res = 300, height = 200, width = 200)

xyplot(Total.Alive ~ Year|as.factor(Site), ps.asmi.t,
       type = c("g","p","r"),
       layout = c(2, 3),
       index.cond = list(1:6),
       as.table = TRUE,
       index = function(x,y) coef(lm(y~x))[1],
           panel = function(x, y) {
        panel.grid(v=2)
        panel.xyplot(x, y)
        panel.loess(x, y, span = .8, degree = 1, family="gaussian")
        panel.abline(lm(y~x))
           },
       xlab = "Year", 
       ylab = "Individuals with AGG", aspect = "xy")
dev.off()


```


```{r}

#Since fencing put in, just beaver creek
xyplot(Total.Alive ~ Year|Fence, 
       ps.asmi.t[ps.asmi.t$Creek == "SouthBeaver" & ps.asmi.t$Year > 2005,],
       type = c("g","p","r"),
       index = function(x,y) coef(lm(y~x))[1],
       xlab = "Year", 
       ylab = "Individuals with AGG", aspect = "xy")

#both sites since started Cebolla
xyplot(Total.Alive ~ Year|Creek, ps.asmi.t[ps.asmi.t$Year > 2013,],
       type = c("g","p","r"),
       index = function(x,y) coef(lm(y~x))[1],
       xlab = "Year", 
       ylab = "Individuals with AGG", aspect = "xy")


```


#AIC for fruit
```{r}

#Candidate models  
lm1 <- lm(Total.Fruitlogtransformed ~  Year, ps.asmi.t)
lm2 <- lm(Total.Fruitlogtransformed ~ Year*as.factor(Site), ps.asmi.t)
lm3 <- lm(Total.Fruitlogtransformed ~ Year*Creek, ps.asmi.t) #Need add creek!
lm4 <- lm(Total.Fruitlogtransformed ~ Year*Fence, ps.asmi.t)
 lm5 <- lm(Total.Fruitlogtransformed ~ 1, ps.asmi.t)
lm6 <- lm(Total.Fruitlogtransformed ~ as.factor(Site), ps.asmi.t)
lm7 <- lm(Total.Fruitlogtransformed ~ Creek, ps.asmi.t) #Need add creek!
lm8 <- lm(Total.Fruitlogtransformed ~ Fence, ps.asmi.t)

lm.list <- list(lm1,lm2,lm3,lm4,lm5,lm6,lm7,lm8)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))

#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}
```

Only during the time both creeks were monitored? 
```{r}

#Candidate models  
lm1 <- lm(Total.Fruitlogtransformed ~  Year, ps.asmi.t[ps.asmi.t$Year>2013,])
lm2 <- lm(Total.Fruitlogtransformed ~ Year*as.factor(Site), ps.asmi.t[ps.asmi.t$Year>2013,])
lm3 <- lm(Total.Fruitlogtransformed ~ Year*Creek, ps.asmi.t[ps.asmi.t$Year>2013,]) #Need add creek!
lm4 <- lm(Total.Fruitlogtransformed ~ Year*Fence, ps.asmi.t[ps.asmi.t$Year>2013,])
 lm5 <- lm(Total.Fruitlogtransformed ~ 1, ps.asmi.t[ps.asmi.t$Year>2013,])
lm6 <- lm(Total.Fruitlogtransformed ~ as.factor(Site), ps.asmi.t[ps.asmi.t$Year>2013,])
lm7 <- lm(Total.Fruitlogtransformed ~ Creek, ps.asmi.t[ps.asmi.t$Year>2013,]) #Need add creek!
lm8 <- lm(Total.Fruitlogtransformed ~ Fence, ps.asmi.t[ps.asmi.t$Year>2013,])

lm.list <- list(lm1,lm2,lm3,lm4,lm5,lm6,lm7,lm8)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))

#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}
```


#AIC for reproductive
```{r}

#Candidate models  
lm1 <- lm(X..Flowered.1logtransformed ~  Year, ps.asmi.t)
lm2 <- lm(X..Flowered.1logtransformed ~ Year*as.factor(Site), ps.asmi.t)
lm3 <- lm(X..Flowered.1logtransformed ~ Year*Creek, ps.asmi.t) #Need add creek!
lm4 <- lm(X..Flowered.1logtransformed ~ Year*Fence, ps.asmi.t)
lm5 <- lm(X..Flowered.1logtransformed ~ 1, ps.asmi.t)
lm6 <- lm(X..Flowered.1logtransformed ~ as.factor(Site), ps.asmi.t)
lm7 <- lm(X..Flowered.1logtransformed ~ Creek, ps.asmi.t) #Need add creek!
lm8 <- lm(X..Flowered.1logtransformed ~ Fence, ps.asmi.t)

lm.list <- list(lm1,lm2,lm3,lm4,lm5,lm6,lm7,lm8)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))

#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}
```

```{r}

#Candidate models  
lm1 <- lm(X..Flowered.1logtransformed ~  Year, ps.asmi.t[ps.asmi.t$Year>2013,])
lm2 <- lm(X..Flowered.1logtransformed ~ Year*as.factor(Site), ps.asmi.t[ps.asmi.t$Year>2013,])
lm3 <- lm(X..Flowered.1logtransformed ~ Year*Creek, ps.asmi.t[ps.asmi.t$Year>2013,]) 
lm4 <- lm(X..Flowered.1logtransformed ~ Year*Fence, ps.asmi.t[ps.asmi.t$Year>2013,])
lm5 <- lm(X..Flowered.1logtransformed ~ 1, ps.asmi.t[ps.asmi.t$Year>2013,])
lm6 <- lm(X..Flowered.1logtransformed ~ as.factor(Site), ps.asmi.t[ps.asmi.t$Year>2013,])
lm7 <- lm(X..Flowered.1logtransformed ~ Creek, ps.asmi.t[ps.asmi.t$Year>2013,]) #Need add creek!
lm8 <- lm(X..Flowered.1logtransformed ~ Fence, ps.asmi.t[ps.asmi.t$Year>2013,])

lm.list <- list(lm1,lm2,lm3,lm4,lm5,lm6,lm7,lm8)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))

#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}
```


Table 2: Biotic factors correlated among the percent dormant individuals, percent browsed individuals, density of reproductive individuals, fruit production, and the percent of reproductive individuals and above ground growth (AGG) of Astragalus microcymbus per year (1995 - 2017	) within the South Beaver Creek drainage (38? 27' 39.8" N, 106? 57' 37.6" W). 
```{r}

cor.out <- round(cor(ps.cor[,forcor]),2)

notsig <- df.c[df.c$P.val > 0.04,]

cor.sign <- apply(notsig,1,function(x){
  row1 <- which(dimnames(cor.out)[[1]] == x[1]) #row
  column2 <- which(dimnames(cor.out)[[2]] == x[2]) #column
  c(row1,column2)
})

pairs(ps.cor[,names(ps.cor) %in% 
             unique(grep(paste(cors,collapse="|"),names(ps.cor), value=TRUE))][1:5])

pairs(ps.cor[,grep("transformed",names(ps.cor))][1:6])


```




# Herbivory section
```{r}

fencedplots <- unique(ps.asmi$Plot[ps.asmi$Fence=='y'])

table(asmi.raw$Browsing...Status)
nrow(asmi.raw[grep("Mammal",asmi.raw$Browsing...Status),])
nrow(asmi.raw[grep("Insect",asmi.raw$Browsing...Status),])
nrow(asmi.raw[!(asmi.raw$status %in% c("dead","dormant")) ,])

nrow(asmi.raw[grep("Mammal",asmi.raw$Browsing...Status),])/
  nrow(asmi.raw[!(asmi.raw$status %in% c("dead","dormant")) ,])

nrow(asmi.raw[grep("Insect",asmi.raw$Browsing...Status),])/
  nrow(asmi.raw[!(asmi.raw$status %in% c("dead","dormant")) ,])


summary(lm(Total.Alivelogtransformed.y ~ X..Browsed.x, 
           data = ps.cor)) #previous year
summary(lm(Total.Alivelogtransformed.y ~ X..Browsed.y, 
           data = ps.cor)) #current year

summary(lm(Total.Alivelogtransformed.y ~ X..Floweredlogtransformed.x, data = ps.cor))
summary(lm(Total.Alivelogtransformed.y ~ X..Floweredlogtransformed.y, data = ps.cor))


'%ni%' <- Negate('%in%')

#Fencing put in for browsing
# t.test(X..Browsedarcsinsqrttransformed~Fence, data = ps.asmi.t)
t.test(X..Browsed~Fence, data = ps.asmi.t)

for(i in 2006:currentyr){
  print(i)
  print(t.test(X..Browsed~Fence, data = ps.asmi.t[ps.asmi.t$Year == i,]))
}

t.test(ps.asmi.t$X..Browsed[ps.asmi.t$Plot %in% fencedplots],
       ps.asmi.t$X..Browsed[ps.asmi.t$Plot %ni% fencedplots],
       data = ps.asmi.t[ps.asmi.t$Year<2006,])

# t.test for fenced plots compared to open plots after installation
#Fencing for plots after 2006
t.test(X..Browsed~Fence, data = ps.asmi.t[ps.asmi.t$Year>2006,])

#fenced plots compared before and after, open too
t.test(ps.asmi.t$X..Browsed[ps.asmi.t$Year<2007 & ps.asmi.t$Plot %in% fencedplots],
       ps.asmi.t$X..Browsed[ps.asmi.t$Year>=2007& ps.asmi.t$Plot %in% fencedplots])

#AGG 
t.test(Total.Alivelogtransformed~Fence, data = ps.asmi.t[ps.asmi.t$Year>2006,])
t.test(Total.Alive~Fence, data = ps.asmi.t[ps.asmi.t$Year>2006,])


t.test(Total.Alivelogtransformed~Fence, data =
         ps.asmi.t[ps.asmi.t$Year>2006&ps.asmi.t$Year<2009,])
t.test(Total.Alive~Fence, data = ps.asmi.t[ps.asmi.t$Year>2006&ps.asmi.t$Year<2009,])

#Fencing for plots after 2006
t.test(Total.Alivelogtransformed~Fence, data = ps.asmi.t)
t.test(Total.Alive~Fence, data = ps.asmi.t)


#AGG and dormant
t.test(Total.Plants~Fence, data = ps.asmi.t[ps.asmi.t$Year>2006,])

#Fencing for plots after 2006
t.test(Total.Alivelogtransformed~Fence, data = ps.asmi.t)
t.test(Total.Alive~Fence, data = ps.asmi.t)

# Fruit and fencing
t.test(ps.asmi.t$Total.Fruitlogtransformed[ps.asmi.t$Plot %in% fencedplots],
       ps.asmi.t$Total.Fruitlogtransformed[ps.asmi.t$Plot %ni% fencedplots])

t.test(ps.asmi.t$Total.Fruitlogtransformed[ps.asmi.t$Plot %in% fencedplots & ps.asmi.t$Year<2006],
       ps.asmi.t$Total.Fruitlogtransformed[ps.asmi.t$Plot %ni% fencedplots & ps.asmi.t$Year<2006])


t.test(ps.asmi.t$Total.Fruitlogtransformed[ps.asmi.t$Plot %in% fencedplots & ps.asmi.t$Year>2005],
       ps.asmi.t$Total.Fruitlogtransformed[ps.asmi.t$Plot %ni% fencedplots & ps.asmi.t$Year>2005])

# Fruit not transofrmed
t.test(ps.asmi.t$Total.Fruit[ps.asmi.t$Plot %in% fencedplots],
       ps.asmi.t$Total.Fruit[ps.asmi.t$Plot %ni% fencedplots])

t.test(ps.asmi.t$Total.Fruit[ps.asmi.t$Plot %in% fencedplots & ps.asmi.t$Year<2006],
       ps.asmi.t$Total.Fruit[ps.asmi.t$Plot %ni% fencedplots & ps.asmi.t$Year<2006])


t.test(ps.asmi.t$Total.Fruit[ps.asmi.t$Plot %in% fencedplots & ps.asmi.t$Year>2005],
       ps.asmi.t$Total.Fruit[ps.asmi.t$Plot %ni% fencedplots & ps.asmi.t$Year>2005])



# Percent reproductive and fencing

t.test(X..Floweredlogtransformed~Fence, data=ps.asmi.t)

t.test(ps.asmi.t$X..Floweredlogtransformed[ps.asmi.t$Plot %in% fencedplots],
       ps.asmi.t$X..Floweredlogtransformed[ps.asmi.t$Plot %ni% fencedplots])

t.test(ps.asmi.t$X..Floweredlogtransformed[ps.asmi.t$Plot %in% fencedplots & ps.asmi.t$Year<2006],
       ps.asmi.t$X..Floweredlogtransformed[ps.asmi.t$Plot %ni% fencedplots & ps.asmi.t$Year<2006])


t.test(ps.asmi.t$X..Floweredlogtransformed[ps.asmi.t$Plot %in% fencedplots & ps.asmi.t$Year>2005],
       ps.asmi.t$X..Floweredlogtransformed[ps.asmi.t$Plot %ni% fencedplots & ps.asmi.t$Year>2005])


#In all years after fence installation
t.test(Total.Fruitlogtransformed~Fence, data = ps.asmi.t[ps.asmi.t$Year > 2005,])
t.test(X..Floweredlogtransformed~Fence, data = ps.asmi.t[ps.asmi.t$Year > 2005,])
t.test(X..Browsed~Fence, data = ps.asmi.t[ps.asmi.t$Year > 2005,])



t.test(X..Flowered.y~Fence.y, data = ps.cor[ps.cor$Year.x > 2005,])

#individuals with AGG after fencing
t.test(Total.Alive.y~Fence.y, data = ps.cor[ps.cor$Year.x > 2005,])

#individuals with AGG and dormant after fencing
t.test(Total.Plants~Fence, data = ps.asmi.t[ps.asmi$Year > 2005,])
t.test(Total.Plants~Fence, data = ps.asmi.t)


t.test(ps.asmi.t$Total.Plants[ps.asmi.t$Year<2006&
                                ps.asmi.t$Plot %in% fencedplots],
       ps.asmi.t$Total.Plants[ps.asmi.t$Year>=2006&
                                ps.asmi.t$Plot %in% fencedplots])


#herbivory
t.test(X..Browsed~Fence, data = ps.asmi.t[ps.asmi.t$Year > 2005,]) #not signficantly different
allttestherb <- lapply(1995:currentyr, function(x){
  t.test(ps.asmi.t$X..Browsed[ps.asmi.t$Year == x & ps.asmi.t$Plot  %in% fencedplots],
         ps.asmi.t$X..Browsed[ps.asmi.t$Year == x & ps.asmi.t$Plot  %ni% fencedplots])
  })

allttestherb[[length(1995:currentyr)]]
allttestherb[[length(1995:2006)]] #Reduced fenced
allttestherb[[length(1995:2007)]] #Reduced fenced 10% browsed in fenced plots to 70% browsed in open

allttestherb[[length(1995:2008)]] # 36% fenced to 28% in open, probably not different
allttestherb[[length(1995:2009)]] # 25% fenced to 53% in open, suprising if same p=0.048
allttestherb[[length(1995:2010)]] # 15% fenced to 27% in open, suprising if same p=0.042
allttestherb[[length(1995:2011)]] # 18% fenced to 43% in open, probably not different
allttestherb[[length(1995:2012)]] # 0% fenced to 6% in open, probably not different
allttestherb[[length(1995:2013)]] # 38% fenced to 45% in open, probably not different




t.test(length~fence, data = asmi.raw[asmi.raw$AsMi_site_id > 2 & asmi.raw$year > 2005,])

#Percent herbivory between fenced and open
t.test(X..Browsed~Fence, data=ps.asmi.t[ps.asmi.t$Year>2005,])

```


Table 4: Average Astragalus microcymbus fruit per plot within the South Beaver Creek Drainage near Gunnison, CO and Cebolla Creek drainage. Site 1 is Cebolla Creek Mid and site 2 is Cebolla Creek North. Standard errors are given in parentheses. 
```{r}
fruit <- aggregate(fruit ~ AsMi_plot_id + year + AsMi_site_id + fence, 
                  data = asmi.raw, function(x) sum(x,na.rm = TRUE))
head(fruit)


tbl3.1 <- summarySE(fruit, measurevar="fruit",groupvars=c("AsMi_site_id","year"))

sites <- unique(tbl3.1$AsMi_site_id)
tbl3 <- lapply(sites, function(x){
  paste(round(tbl3.1[tbl3.1$AsMi_site_id == x,"fruit"],2)," (",
        round(tbl3.1[tbl3.1$AsMi_site_id == x,"se"],1), ")", sep="")
})

#Cebolla Creek
write.csv(data.frame(tbl3[[1]],tbl3[[2]]), file=paste(savepath,"Table4_Cebolla.csv"), row.names=TRUE)
#South Beaver Creek
write.csv(data.frame(tbl3[[3]],tbl3[[4]],tbl3[[5]],tbl3[[6]]), file=paste(savepath,"Table4_SouthBeaver.csv"), row.names=TRUE)

```


#Table 4: Growth rate (λ) and standard deviation within treatment (fenced or open plots) of Astragalus microcymbus individuals within the South Beaver Creek drainage near Gunnison, CO. Plot 598 in site 26, added in 2004, is excluded.   


### But if I add individuals not as seedlings (even though I know they aren't seedlings this year) then they aren't given credit for reproducing.. # could add a New2me category that is clearly not a seedling but a delayed/missed one. Then should add a seedling to the previous year as a stop gap? So count up number of seedlings and number of seedlings in the next year that are reproductive and subtract them from the current seedling number!
```{r}
table(asmi.raw$browsing)
table(asmi.raw$Browsing...Status) 
nrow(asmi.raw) #13806->16377->17817->19324
table(asmi.raw$AsMi_site_id,asmi.raw$year)

cebolla <- asmi.raw[asmi.raw$AsMi_site_id %in% c(1,2),]
table(cebolla$AsMi_site_id,cebolla$year)

sbc <- asmi.raw[asmi.raw$AsMi_site_id %in% c(5,15,19,26),]
table(sbc$AsMi_site_id,sbc$year)

#remove plot 598 from SBC, it was added late; Plot 598 was added in 2004, remove for this. .. or do all plots on their own instead of by sites? Or make sure the transitions are proportional, I think I need each plot on it's own since they start at different times, can't combine into one site. 
# or since they aren't seedlings the first year, it's fine, there's still the number transitioning 
# sbc <- sbc[sbc$AsMi_plot_id != 598,]

# the others added later: 238 & 300 @ 1996 - take out 1995
# sbc <- sbc[sbc$year > 1995,]

# KEY TO OBJECTS
# After commenting out the removed year and the added plots... then asmi.1 is SBC, cebolla is Cebolla and asmi.all is both
asmi.1 <- sbc[order(sbc$AsMi_site_id, sbc$AsMi_tag_id, sbc$year),]
cebolla <- cebolla[order(cebolla$AsMi_site_id, cebolla$AsMi_tag_id, cebolla$year),]

asmi.1$status <- factor(asmi.1$status)
table(asmi.1$status)

cebolla$status <- factor(cebolla$status)
table(cebolla$status)

#just keep all together go by plot
asmi.all <- asmi.raw[order(asmi.raw$AsMi_site_id, 
                           asmi.raw$AsMi_tag_id, asmi.raw$year),]
table(asmi.all$status)

```

Set order of classes
```{r}
# Later work in seeds
# stages <- c("seed", "seedling", "vegetative", "reproductive", "dormant","dead") 

stages <- c("seedling", "vegetative", "reproductive", "dormant","dead") 

# SBC
# Cebolla
asmi.1$status <- ordered(asmi.1$status, levels = stages)
cebolla$status <- ordered(cebolla$status, levels = stages)

# Both
asmi.all$status <- ordered(asmi.all$status, levels = stages)

```

check errors
```{r}
table(asmi.1$status)
table(cebolla$status)

# should all be reproductive (status 4 in DBG phpMyAdmin)
asmi.1[asmi.1$flower == 1 & asmi.1$status == "vegetative",]
cebolla[cebolla$flower == 1 & cebolla$status == "vegetative",]
asmi.all[asmi.all$flower == 1 & asmi.all$status == "vegetative",]

# made all NA lengths 0
# table(asmi.1$status[is.na(asmi.1$length)])

asmi.1$browsed[asmi.1$browsing==0]<-FALSE  	
asmi.1$browsed[asmi.1$browsing==1]<-TRUE
table(asmi.1$browsed)
table(asmi.1$browsing)

# Same for cebolla plots
cebolla$browsed[cebolla$browsing==0]<-FALSE    
cebolla$browsed[cebolla$browsing==1]<-TRUE
table(cebolla$browsed)
table(cebolla$browsing)


asmi.all$browsed[asmi.all$browsing==0]<-FALSE  	
asmi.all$browsed[asmi.all$browsing==1]<-TRUE
table(asmi.all$browsed)
table(asmi.all$browsing)
```

Merge year to year, year.x is year t, year.y is year t+1   
remove dead from stages, just fate    
At this point, just get asmi.all1 to work, if can deal with addition of plots, then can put the two together
```{r}
asmi.all1 <- subset(merge(asmi.all, asmi.all, by = "AsMi_tag_id", sort = FALSE), year.x == year.y - 1)  

# Which of these say dead to seedling, should get rid of these, or dead to dead
asmi.all1[asmi.all1$status.x=="dead",]
asmi.all1 <- asmi.all1[asmi.all1$status.x!="dead",]
```


    
Want    
Narrow down to      
[1] "AsMi_site_id.x" "AsMi_tag_id"    "year.x"             
[4] "length.x"       "fruit.x"        "browsed.x"           
[7] "fence.x"        "status.x"       "status.y"     
```{r}
cols <- c("AsMi_site_id.x","AsMi_tag_id","year.x","length.x",
          "fruit.x","browsed.x","fence.x","status.x","status.y","AsMi_plot_id.x")
asmi.all2 <- asmi.all1[, names(asmi.all1) %in% unique(grep(paste(cols,collapse="|"),
                                                  names(asmi.all1), value = TRUE))]
colnames(asmi.all2) <- c( "tag","year","length","fruits","stage","plot",
                       "site","fenced","browse","fate")
## re-number
rownames(asmi.all2) <- 1:nrow(asmi.all2)

# Get rid of stage 'dead' because nothing starts as dead!
asmi.all2$stage <- ordered(asmi.all2$stage, levels = stages[-length(stages)])

# check transitions
#fate down and stage across the top; These are the raw numbers combined for all years 
table(Fate = asmi.all2$fate, Stage = asmi.all2$stage) #Nope, cannot have 2 seedlings stay seedlings! And Dormant never go dead!

asmi.all2[asmi.all2$fate == "seedling" & asmi.all2$stage == "seedling",] # tag 3571 and 3946
# asmi.raw[asmi.raw$AsMi_tag_id %in% c(3571,3946),]

asmi.all2[asmi.all2$stage == "dormant" & asmi.all2$fate == "dead",]

```

bootstrap distributions of population growth rates (lambda), stage vectors, and projection matrix elements by randomly sampling with replacement from a stage-fate data frame of observed transitions   

Doesn't make sense... shouldn't be so high... Because 26 had additional plots added in 1996?    
There are seedlings that go from 'seedling' to 'dead' that have values for $seedling   
something is off.    
Made some fixes to raw data where fruit were counted but confusion led to putting 0 for flower column    
Will change all seedling with fruit to reproductive

```{r}
asmi.boot <- asmi.all2
asmi.boot$fruits[is.na(asmi.boot$fruits)] <- 0

table(asmi.boot$year, asmi.boot$site) # from 1995 transitions stage -> fate up to currentyr-1 stage->fate 
# add 'seedling' column
# give credit for reproductive seedlings to two years prior because must be more than one year old
asmi.boot[asmi.boot$fruits>0 & asmi.boot$stage=="seedling" & asmi.boot$length<20,]
# should probably not call plants over 20cm with fruit a seedling
asmi.boot$stage[asmi.boot$fruits>0 & asmi.boot$stage=="seedling" & asmi.boot$length>19] <- "reproductive"


nrow(asmi.boot ) #13868 -> 15280

asmi.boot$seedling <- unlist(lapply(split(asmi.boot, asmi.boot$plot), function(plot){
  # [-length(sort(unique(plot$year)))] want all years to get correct length
  out <- lapply(sort(unique(plot$year)),function(year){
  # For each next year, how many seedlings were there? 
  seedlings.t1 <- nrow(asmi.boot[asmi.boot$year == year+1 &
                                   asmi.boot$stage == "seedling" & 
                                   asmi.boot$fruits==0,])
  seedlings.t2 <- nrow(asmi.boot[asmi.boot$year == year+2 & 
                                   asmi.boot$stage == "seedling" & 
                                   asmi.boot$fruits>0,])
  seedlings <- sum(seedlings.t1, seedlings.t2)
  # The number of fruit produced per individual divided by all fruit produced * seedlings in the next year
  seedlingsout <- plot$fruits[plot$year==year]/sum(plot$fruits[plot$year==year],na.rm = TRUE) * seedlings
  seedlingsout
  })
  out
}))

boottrans <- lapply(split(asmi.boot, asmi.boot$plot), function(x){
  data.frame(Plot = unique(x$plot),
             Site = unique(x$site),
             Boot = boot.transitions(x,1000,fertility = "fruits")$lambda)
  })

bt <- do.call(rbind, boottrans)

ggplot(bt, aes(as.factor(Plot), Boot, colour = as.factor(Plot)))+
  geom_boxplot()+
  facet_wrap(~Site, ncol=3)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```


#Figure 4 Distribution of consecutive years of dormancy
```{r}
# asmi.1 is already sorted by site, tag, year
#dorms <- rle(as.numeric(asmi.2$fate))$lengths[rle(as.numeric(asmi.2$fate))$values ==4]
levels(asmi.1$status) # 4 is dormant

dorms <- do.call(rbind,lapply(split(asmi.1, asmi.1$AsMi_tag_id), function(x){
  dormlns <- rle(as.numeric(x$status))$lengths[rle(as.numeric(x$status))$values==4]
  out <- data.frame(Tag=rep(unique(x$AsMi_tag_id), length(dormlns)),dorms=dormlns)
  out
}))


table(dorms$dorms) 

jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/Fig4.jpg", sep = ""),
         units = "mm", res = 300, height = 100, width = 130)

ggplot(dorms, aes(dorms))+
  geom_histogram(bins = 20)+
  theme_bw()+
  ylab("Frequency")+
  xlab("Consecutive years dormant")

dev.off()
```

#only South beaver creek
```{r}
median(dorms$dorms) #3-->2
length(dorms$dorms[dorms$dorms==1]) #347 -> 358 -> 478
length(dorms$dorms[dorms$dorms==1])/length(dorms$dorms) # 37% -> 42%
# How many tags had some amount of dormancy? How'd I get that before
dormantsandnot <- do.call(rbind,lapply(split(asmi.1, asmi.1$AsMi_tag_id), function(x){
  dormlns <- rle(as.numeric(x$status))$lengths[rle(as.numeric(x$status))$values==4]
  if(length(dormlns)==0){
    out <- data.frame(Tag=unique(x$AsMi_tag_id),dorms=0)
  } else {
    out <- data.frame(Tag=rep(unique(x$AsMi_tag_id), length(dormlns)),dorms=dormlns)
  }
  out
}))
dormantsandnot$dormYN <- 0
dormantsandnot$dormYN[dormantsandnot$dorms>0] <- 1
sum(dormantsandnot$dormYN)/nrow(dormantsandnot) # 0.3483473 -> 0.359


length(dorms$dorms) #848 -> 959 -> 1136
length(dorms$dorms[dorms$dorms > 5]) #353 -> 355 -> 380
length(dorms$dorms[dorms$dorms > 15]) #93 -> 82?? -> 98
length(dorms$dorms[dorms$dorms == 21]) #13 -> 13
length(dorms$dorms[dorms$dorms > 20]) #13 -> 14


```

Reproductive lengths - South Beaver Creek only   
```{r}
levels(asmi.1$status)
# [1] "seedling"     "vegetative"   "reproductive" "dormant"      "dead"

repros <- do.call(rbind, lapply(split(asmi.1, asmi.1$AsMi_tag_id), function(tag){
  reprolns <- rle(as.numeric(tag$status))$lengths[rle(as.numeric(tag$status))$values==3]
  out <- data.frame(Tag=rep(unique(tag$AsMi_tag_id), length(reprolns)), 
                    Site=rep(unique(tag$AsMi_site_id), length(reprolns)),
                    Plot=rep(unique(tag$AsMi_plot_id), length(reprolns)),
                    repros=reprolns)
  out
}))

# max(repros$reproslength)
max(repros$repros) # 8
repros[repros$repros == max(repros$repros),]

repros[repros$repros == max(repros$repros)-4,]

plotrepros <- data.frame(table(repros$Tag, repros$repros)) #Var1 is tag, Var2 is reprolenth, Freq times
mean(plotrepros$Freq[plotrepros$Var2==1])

ggplot(plotrepros, aes(x=Var2, y=Freq ))+
  geom_boxplot()+ 
  theme(legend.position="none")

ggplot(repros, aes(repros, colour=as.factor(Tag)))+
  geom_histogram(bins=8)+
  theme_bw()+
  ylab("Frequency")+
  xlab("Consecutive years reproductive")+ 
  theme(legend.position="none")

```

#Stage based PVA   
```{r}
#is survival associate diwht a continutous classifying variable?
surv.asmi <- asmi.all2  # asmi.2
surv.asmi$surv <- 1
surv.asmi$surv[surv.asmi$fate=="dead"] <- 0
table(surv.asmi$surv)

str(surv.asmi)

#stages are L, Q, and C? linear, quadractic, cubic - because of the ordinal factor, just factor it
summary(glm(surv~ as.factor(as.numeric(stage)) +as.factor(site), family=binomial(link = "logit"), surv.asmi))

surv.asmi$stage <- factor(surv.asmi$stage, levels=levels(surv.asmi$stage), ordered=FALSE)
str(surv.asmi)
summary(glm(surv~ stage +as.factor(site), family=binomial(link = "logit"), surv.asmi))


#survival as a cox proportional hazards regression model
library(survival)

# interval data, the starting time for the interval (so the year is the stage year and survival is based on fate, next year); "righ censoring" means date of death is unknown, which it is actually! 
#Survival curve is probability that time of death is greater than some specified time
survObj <- Surv(time = surv.asmi$year, event=as.logical(surv.asmi$surv))
model <- coxph(survObj ~ strata(factor(site)), data=surv.asmi)
model <- coxph(survObj ~ as.factor(site), data=surv.asmi)
summary(model)

model_fence <- coxph(survObj ~ fenced, data=surv.asmi)
summary(model_fence)

model_fence_site <- coxph(survObj ~ fenced*site, data=surv.asmi)
summary(model_fence_site)

model_stage <- coxph(survObj ~ stage, data=surv.asmi)
summary(model_stage)

#plotting time to death


```


https://rpubs.com/daspringate/survival    
https://datascience.stackexchange.com/questions/8162/r-plotsurv-newdata-draws-same-lines-many-times-why    


```{r}
#plot survival of a given year by size
for(i in sort(unique(surv.asmi$year))){
  plot(surv.asmi$length[surv.asmi$year==i], 
       surv.asmi$surv[surv.asmi$year==i], main= paste(i), xlab="length",ylab="Probability of survival")
  g<- glm(surv~length, family=binomial,surv.asmi[surv.asmi$year==i,])
  curve(predict(g,data.frame(length=x),type="resp"), col="green4",add=TRUE)
  #points(surv.asmi$length[surv.asmi$year==i],fitted(g), pch=20)
}

plot(surv.asmi$length, 
       surv.asmi$surv, main= "1996 - 2017", xlab="length",ylab="Probability of survival")
  g<- glm(surv~length, family=binomial,surv.asmi)
  curve(predict(g,data.frame(length=x),type="resp"), col="green4",add=TRUE)

# Plot survivial per year by fruit
for(i in sort(unique(surv.asmi$year))){
  plot(surv.asmi$fruits[surv.asmi$year==i], 
       surv.asmi$surv[surv.asmi$year==i], main= paste(i), xlab="fruits",ylab="Probability of survival")
  g<- glm(surv~fruits, family=binomial,surv.asmi[surv.asmi$year==i,])
  curve(predict(g,data.frame(fruits=x),type="resp"), col="green4",add=TRUE)
  #points(surv.asmi$length[surv.asmi$year==i],fitted(g), pch=20)
}
  
  
plot(surv.asmi$fruits, 
       surv.asmi$surv, main= "1996 - 2017", xlab="fruits",ylab="Probability of survival")
  g<- glm(surv~fruits, family=binomial,surv.asmi)
  curve(predict(g,data.frame(fruits=x),type="resp"), col="green4",add=TRUE)
  

surv.asmi$frYN <- 0
surv.asmi$frYN[surv.asmi$fruits>0] <- 1

# Probability of being reproductive given length
for(i in sort(unique(surv.asmi$year))){
  plot(surv.asmi$length[surv.asmi$year==i], 
       surv.asmi$frYN[surv.asmi$year==i], main= paste(i), xlab="length",ylab="Probability of reproductive")
  g<- glm(frYN~length, family=binomial,surv.asmi[surv.asmi$year==i,])
  curve(predict(g,data.frame(length=x),type="resp"), col="green4",add=TRUE)
}
    
plot(surv.asmi$length, 
       surv.asmi$frYN, main= "1996 - 2019", xlab="length",ylab="Probability of reproductive")
  g<- glm(frYN~length, family=binomial,surv.asmi)
  curve(predict(g,data.frame(length=x),type="resp"), col="green4",add=TRUE)  
  
```


# Another way to look at survival curves
```{r}
fit <- survfit(Surv(length, surv) ~ fenced, 
               data = surv.asmi[surv.asmi$length>0 & surv.asmi$year>2005,]) 

jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/Fig9_Surv_fence_size.jpg", sep = ""),
         units = "mm", res = 300, height = 100, width = 150)

ggsurvplot(fit, data=surv.asmi[surv.asmi$length>0& surv.asmi$year>2005,], risk.table = FALSE, xlab = "length", conf.int = TRUE)

dev.off()
```

# Fit these with dampening survival estimates? based on what are likely to be seen in the rest of the year but dormant in July? 

```{r}
fit <- survfit(Surv(length, surv) ~ site, 
               data = surv.asmi[surv.asmi$length>0 & surv.asmi$year>2005,]) 

ggsurvplot(fit, data=surv.asmi[surv.asmi$length>0& surv.asmi$year>2005,], risk.table = FALSE, xlab = "length")

```


```{r}

asmi.raw.1 <- asmi.raw[with(asmi.raw, order(AsMi_site_id,AsMi_plot_id,AsMi_tag_id,year)),]

asmi.raw.1[asmi.raw.1$AsMi_tag_id==10,]
asmi.1[asmi.1$AsMi_tag_id==10,] # Alive in 1995, not detected again until 2004 when big and flowering
asmi.1[asmi.1$AsMi_tag_id==3,] # in 1996, maybe these were seen in 1995 but dead by 1996?
asmi.1[asmi.1$AsMi_tag_id==11,] # Some tag made in error I guess

#Probability of being reproductive given years alive
levels(asmi.raw.1$status) # 3 is reproductive; 1 is dead
# Should add at least 1 year to the years alive if reproductive 

notdeadyet <- do.call(rbind,lapply(split(asmi.raw.1, asmi.raw.1$AsMi_tag_id), function(x){
  if(nrow(x[x$status!="dead",])>0){
    if(x$status[1] == "reproductive"){
      addyear <- 1
    } else {
      addyear <- 0
    }
    StageLength <- nrow(x[x$status!="dead",])
    data.frame(Tag=x$AsMi_tag_id[x$status!="dead"],
               year = x$year[x$status!="dead"],
               YrsAlive=(1+addyear):(StageLength+addyear))
    }
  }))

surv.asmi.1 <- merge(asmi.raw, notdeadyet, by.x = c("AsMi_tag_id","year"), by.y = c("Tag","year"))
surv.asmi.1[surv.asmi.1$AsMi_tag_id==10,]
surv.asmi.1[surv.asmi.1$status=="reproductive"&surv.asmi.1$YrsAlive<3,]

surv.asmi.1$frYN <- 0
surv.asmi.1$frYN[surv.asmi.1$fruit>0] <- 1

# Probability of being reproductive given length alive

plot(surv.asmi.1$YrsAlive, 
       surv.asmi.1$frYN, main= "1995 - 2018", xlab="Years alive",ylab="Probability of reproductive")
  g<- glm(frYN~YrsAlive, family=binomial,surv.asmi.1)
  curve(predict(g,data.frame(YrsAlive=x),type="resp"), col="green4",add=TRUE)  
  

```

# This doesn't make sense! Can't substitude length for time? Is it cummulative? 
```{r}
surv.asmi.1 <- surv.asmi.1[surv.asmi.1$length < 99,]

fit <- survfit(Surv(length, flower) ~ AsMi_site_id, 
               data = surv.asmi.1[surv.asmi.1$length>0,]) 

ggsurvplot(fit, data=surv.asmi.1[surv.asmi.1$length>0,], risk.table = FALSE, xlab = "length", ylab="Probability of Reproductive")

```
```{r}
surv.asmi.2 <- merge(surv.asmi, notdeadyet, by.x=c("tag","year"), by.y=c("Tag","year"))

fit <- survfit(Surv(YrsAlive, surv) ~ site, 
               data = surv.asmi.2[surv.asmi.2$length>0,]) 

ggsurvplot(fit, data=surv.asmi.2[surv.asmi.2$length>0,], risk.table = FALSE, xlab = "Age", ylab="Probability of Reproductive")

```

```{r}
plot(10,10, type="n")
matplot(contr.poly(15)[,1:4], type="b") 
```



# From previous versions
cebolla <- asmi.raw[asmi.raw$AsMi_site_id %in% c(1,2),]
sbc <- asmi.raw[asmi.raw$AsMi_site_id %in% c(5,15,19,26),]

asmi.1 <- sbc[order(sbc$AsMi_site_id, sbc$AsMi_tag_id, sbc$year),]
cebolla <- cebolla[order(cebolla$AsMi_site_id, cebolla$AsMi_tag_id, cebolla$year),]

asmi.2 <- subset(merge(asmi.1, asmi.1, by = "AsMi_tag_id", sort = FALSE), year.x == year.y - 1)   
cebolla1 <- subset(merge(cebolla, cebolla, by = "AsMi_tag_id", sort = FALSE), year.x == year.y - 1)  



Why are there 25 slots for Site PVA? and all but the last four are empty - last 4 have the 4 SBC populations
notfenced has 21 blank (each year)

Dormancy can be set to 0-1     

```{r}
all.pva <- StagePVA(asmi.all2)

  '%ni%' <- Negate('%in%')
asmi.pva <- StagePVA(asmi.all2[asmi.all2$site>2 & asmi.all2$plot %ni% c(598,238,300),]) 
# Need to exclude plots added later, 598
cebolla.pva <- StagePVA(asmi.all2[asmi.all2$site<3,])
```

By plot, South Beaver Creek
site is then a list of the plots per site
```{r}
site <- sapply(unique(asmi.all2$site), function(x){
  as.character(unique(asmi.all2$plot[asmi.all2$site == x]))
  }, simplify = FALSE)
names(site)<-unique(asmi.all2$site)
site

all.pva$plot.matrix[site$'15'[1]]
```

# Matrix Models     
## Table 5: Growth rate    
SBC 
```{r}
lmdSD(asmi.pva$pro.matrix, 1996, currentyr-2)
#         lmda        SD
# [1,] 1.179791 0.9690063

#Pre-fencing (2004-2005 transition)
paste(round(lmdSD(asmi.pva$pro.matrix, 1996, 2004)[1],2)," (",
      round(lmdSD(asmi.pva$pro.matrix, 1996, 2004)[2],2), ")", sep ="")

mats.list <- list(asmi.pva$pro.matrix,asmi.pva$fenced.pro.matrix,asmi.pva$notfenced.pro.matrix)
tbl4.all <- sapply(mats.list, function(x){
   paste(round(lmdSD(x, 1996, 2004)[1],2)," (",
         round(lmdSD(x, 1996, 2004)[2],2),")", sep="")
    })

t(tbl4.all)

# Post-fencing (2005-year before current so currentyr-2:currentyr-1)
tbl4.allpost <- sapply(mats.list[-1], function(x){
  paste(round(lmdSD(x, 2005,currentyr-2)[1],2)," (",
        round(lmdSD(x, 2005,currentyr-2)[2],2),")", sep="")
})

write.csv(tbl4.allpost, file=paste(savepath,"Table5_allSBCpost.csv"), row.names=TRUE)


tbl4.allopen <- paste(round(lmdSD(asmi.pva$notfenced.pro.matrix, 1996,currentyr-2)[1],2)," (",
                      round(lmdSD(asmi.pva$notfenced.pro.matrix, 1996,currentyr-2)[2],2),")", sep="")


write.csv(tbl4.allopen, file=paste(savepath,"tbl5_allSBCopen.csv"), row.names=TRUE)
```

Cebolla all
1:Mid
2:North
```{r}

# All
lmdSD(cebolla.pva$pro.matrix, 2014, currentyr-2)
# lmdSD(cebolla.pva$pro.matrix, 2014, currentyr-1) #in 2016, not enough data to exclude the last one
#         lmda       SD
#[1,] 1.138889 1.038878
#[1,] 1.318087 0.6141668  in 2019

#Cebolla Mid = Site 1
paste(round(lmdSD(cebolla.pva$Site$`1`, 2014, currentyr-2)[1],2)," (",
      round(lmdSD(cebolla.pva$Site$`1`, 2014, currentyr-2)[2],2), ")", sep ="")

#Cebolla North = Site 2
paste(round(lmdSD(cebolla.pva$Site$`2`, 2014, currentyr-2)[1],2)," (",
      round(lmdSD(cebolla.pva$Site$`2`, 2014, currentyr-2)[2],2), ")", sep ="")

mats.list <- list(cebolla.pva$pro.matrix,cebolla.pva$fenced.pro.matrix,cebolla.pva$notfenced.pro.matrix)
sapply(mats.list, function(x){
   paste(round(lmdSD(x, 2014, currentyr-2)[1],2)," (",
         round(lmdSD(x, 2014, currentyr-2)[2],2),")", sep="")
    })
```
 
T-test fenced vs. open after fencing installed   
```{r T.test paired growth rates}
t.test(lmdAn(asmi.pva$fenced.pro.matrix, 2005, currentyr-2),
       lmdAn(asmi.pva$notfenced.pro.matrix, 2005, currentyr-2),
       paired = TRUE)

```

T-test for growth rate before and after fencing  
```{r}
t.test(lmdAn(asmi.pva$fenced.pro.matrix, 1996, 2004),
       lmdAn(asmi.pva$fenced.pro.matrix, 2005, currentyr-2))
```


# Table 5: Growth rate (lambda) and standard deviation
pattern is:          

All pre-fence  1996-2004        |All post-fence 2005-currentyr-2 |Open plots 1996-currentyr-2   
--------------------------------|--------------------------------|----------------------    
asmi.pva$pro.matrix             |                                |  
asmi.pva$fenced.pro.matrix      | asmi.pva$fenced.pro.matrix     |           
asmi.pva$notfenced.pro.matrix   | asmi.pva$notfenced.pro.matrix  | asmi.pva$notfenced         
      
      
Sites 5,19,26,  1996-2004       
(which is through 2005 but starting transition of 2004)   

1996-2005               |   2005-2014            |   1996-2014
------------------------|------------------------|---------------------          
asmi.pva$Site$"5"       |                        |       
asmi.pva$fenced$"5"     | asmi.pva$fenced$"5"    |                
asmi.pva$notfenced$"5"  | asmi.pva$notfenced$"5" |  asmi.pva$notfenced$"5"             

Site 15
`asmi.pva$Site$"15"` ...        

[[1]]:All; [[2]]:fenced; [[3]]:open
```{r}
# matord.list <- list(asmi.pva$Site, asmi.pva$fenced,asmi.pva$notfenced)
matord.list <- list(all.pva$Site, all.pva$fenced,all.pva$notfenced)

# 1996 (remove first year) through 2004 since it's 2004-2005 before fencing
# All
# was asmi.2 instead of all.pva; still not working
tbl4.96.04 <- 
  lapply(as.character(unique(asmi.all$AsMi_site_id)), function(x){
    # mat <- cat("matord.list[[1]]$\`",x,"`", sep='')
    mat <- matord.list[[1]]$x
    outapply<-lapply(mat, function(y){
      out<- paste(round(lmdSD(y[[factor(x)]],1996,2004)[1],2)," (",
            round(lmdSD(y[[factor(x)]],1996,2004)[2],2),")", sep="")
      out
    })
    outapply
  })

#site 5
paste(round(lmdSD(asmi.pva$Site$'5',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'5',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$fenced$'5',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'5',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'5',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'5',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$fenced$'5',2005,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'5',2005,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'5',2005,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'5',2005,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'5',1996,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'5',1996,currentyr-2)[2],2),")", sep="")

#Site 15
paste(round(lmdSD(asmi.pva$Site$'15',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'15',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$Site$'15',2005,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'15',2005,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$Site$'15',1996,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'15',1996,currentyr-2)[2],2),")", sep="")

#site 19
paste(round(lmdSD(asmi.pva$Site$'19',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'19',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$fenced$'19',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'19',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'19',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'19',1996,2004)[2],2),")", sep="")


paste(round(lmdSD(asmi.pva$fenced$'19',2005,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'19',2005,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'19',2005,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'19',2005,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'19',1996,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'19',1996,currentyr-2)[2],2),")", sep="")

#site 26
paste(round(lmdSD(asmi.pva$Site$'26',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'26',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$fenced$'26',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'26',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'26',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'26',1996,2004)[2],2),")", sep="")


paste(round(lmdSD(asmi.pva$fenced$'26',2005,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'26',2005,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'26',2005,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'26',2005,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'26',1996,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'26',1996,currentyr-2)[2],2),")", sep="")

#Cebolla North 1; Mid 2
paste(round(lmdSD(cebolla.pva$notfenced$'1',2014,currentyr-2)[1],2)," (",
            round(lmdSD(cebolla.pva$notfenced$'1',2014,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(cebolla.pva$notfenced$'2',2014,currentyr-2)[1],2)," (",
            round(lmdSD(cebolla.pva$notfenced$'2',2014,currentyr-2)[2],2),")", sep="")

```

Figure 3: Life cycle diagram of Astragalus microcymbus, 1996-currentyr-1 mean transition rates (solid lines) and fecundity rates (dashed lines), and resulting sensitivities and elasticities. Individuals that become reproductive in the first year are classified as seedlings. 

```{r}
# SBC and Cebolla
eigen.analysis(mean(all.pva$notfenced.pro.matrix))
mean(all.pva$notfenced.pro.matrix)

# Only SBC
eigen.analysis(mean(asmi.pva$notfenced.pro.matrix))
mean(asmi.pva$notfenced.pro.matrix)

```

###Environmental Data from PRISM:   
<http://prism.oregonstate.edu/explorer/>  
<https://github.com/ropensci/prism>

Process takes a while   
Can go back to folder and delete old provisional data to replace with more current   
```{r, eval = FALSE}
# Set wd for prism
options(prism.path = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/PRISM_asmiclimate")

#Precipitation total, rain and snow
get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)

#Maximum temperature (average)
get_prism_monthlys(type="tmax", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)

#Minimum temperature (average)
get_prism_monthlys(type="tmin", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)

```

Error, didn't download
```{r, eval=FALSE}
get_prism_monthlys(type="ppt", mon = 9, keepZip = FALSE, years = 1996)
get_prism_monthlys(type="ppt", mon = 6, keepZip = FALSE, years = 1999)
get_prism_monthlys(type="ppt", mon = 8, keepZip = FALSE, years = 1999)
get_prism_monthlys(type="ppt", mon = 6, keepZip = FALSE, years = 2000)
get_prism_monthlys(type="ppt", mon = 5, keepZip = FALSE, years = 2002)
get_prism_monthlys(type="ppt", mon = 9, keepZip = FALSE, years = 2006)
get_prism_monthlys(type="ppt", mon = 10, keepZip = FALSE, years = 2006)
get_prism_monthlys(type="ppt", mon = 12, keepZip = FALSE, years = 2012)

#get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = 1981)
#get_prism_monthlys(type="tmin", mon = 1:12, keepZip = FALSE, years = 1981)
#get_prism_monthlys(type="tmax", mon = 1:12, keepZip = FALSE, years = 1981)
```



UTM Zone 13 from ArcGIS
```{r}
asmilatlong <- read.csv("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Word/2016_asmi/UTM_asmiplots.csv")

# Convert from UTM to lat/long
asmi.ll <- spTransform(SpatialPoints(cbind(asmilatlong$Easting,asmilatlong$Northing), 
                                     proj4string = CRS("+proj=utm +zone=13 + datum=WGS84")), 
                       CRS("+proj=longlat +datum=WGS84"))

asmiLL <- data.frame(coordinates(asmi.ll),asmilatlong$Tag__,asmilatlong$Tag_Commen)

```



# Want Site, Year, Month, ppt, tmin, tmax
```{r, eval = FALSE}
maxs <- grep("tmax", ls_prism_data(absPath=TRUE)[,2])
mins <- grep("tmin", ls_prism_data(absPath = TRUE)[,2])
ppt <- grep("ppt", ls_prism_data(absPath = TRUE)[,2])

length(maxs)
length(mins)
length(ppt)

avgTemps.max <- lapply(maxs, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = raster::extract(rastertemps, asmiLL[,c("coords.x1","coords.x2")]), date = ls_prism_data()[x,])
})

avgTemps.min <- lapply(mins, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = raster::extract(rastertemps, asmiLL[,c("coords.x1","coords.x2")]), date = ls_prism_data()[x,])
})

avgPrecip <- lapply(ppt, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = raster::extract(rastertemps, asmiLL[,c("coords.x1","coords.x2")]), date = ls_prism_data()[x,])
})

mins.avg <- do.call(rbind, avgTemps.min)
maxs.avg <- do.call(rbind, avgTemps.max)
ppt.avg <- do.call(rbind, avgPrecip)

mins.avg <- data.frame(mins.avg, asmilatlong$Tag__, asmilatlong$Tag_Commen)
maxs.avg <- data.frame(maxs.avg, asmilatlong$Tag__, asmilatlong$Tag_Commen)
ppt.avg <- data.frame(ppt.avg, asmilatlong$Tag__, asmilatlong$Tag_Commen)


mins.avg$Year <- as.numeric(substr(vapply(strsplit(as.character(mins.avg$date), '_'), 
                                   function(x) x[5], character(1)), 1,4))
mins.avg$Month <- as.numeric(substr(vapply(strsplit(as.character(mins.avg$date), '_'), 
                                   function(x) x[5], character(1)), 5,6))

maxs.avg$Year <- as.numeric(substr(vapply(strsplit(as.character(maxs.avg$date), '_'), 
                                   function(x) x[5], character(1)), 1,4))
maxs.avg$Month <- as.numeric(substr(vapply(strsplit(as.character(maxs.avg$date), '_'), 
                                   function(x) x[5], character(1)), 5,6))

ppt.avg$Year <- as.numeric(substr(vapply(strsplit(as.character(ppt.avg$date), '_'), 
                                   function(x) x[5], character(1)), 1,4))
ppt.avg$Month <- as.numeric(substr(vapply(strsplit(as.character(ppt.avg$date), '_'), 
                                   function(x) x[5], character(1)), 5,6))


# Didn't get all the ppt for 2019
asmi.climate_tminmax <- merge(mins.avg, maxs.avg, by = c("Year","Month","asmilatlong.Tag__",
                                                         "asmilatlong.Tag_Commen"))
names(asmi.climate_tminmax) <- c("Year","Month","Plot","Site","tmin","date.tmin","tmax", "date.tmax")
asmi.climate <- merge(asmi.climate_tminmax, ppt.avg, by.x = c("Year","Month","Plot","Site"),
                      by.y = c("Year","Month","asmilatlong.Tag__","asmilatlong.Tag_Commen"))
names(asmi.climate) <- c(names(asmi.climate)[1:8],"ppt","date.ppt")
# asmi.climate <- cbind(mins.avg, maxs.avg[,1], ppt.avg[,1])
```


```{r}
# names(asmi.climate) <- c("tmin","date","Plot","Site","tmax","Precip")

# #date is a factor
# asmi.climate$date <- as.character(asmi.climate$date)
# 
# #split by _ select the YYYYMM numbers
# asmi.climate$Year <- as.numeric(substr(vapply(strsplit(asmi.climate$date, '_'), 
#                                    function(x) x[5], character(1)), 1,4))
# asmi.climate$Month <- as.numeric(substr(vapply(strsplit(asmi.climate$date, '_'), 
#                                    function(x) x[5], character(1)), 5,6))

# asmi.c <- asmi.climate[,-2]
asmi.c <- asmi.climate

# Get a list of sites and plots per Creek to merge with asmi.c
plots.site <- asmi.raw[!duplicated(asmi.raw$AsMi_plot_id),c("AsMi_plot_id","AsMi_site_id")]
plots.site$Creek <- "South Beaver"
plots.site$Creek[plots.site$AsMi_site_id < 3] <- "Cebolla"

asmi.c <- merge(plots.site, asmi.c, by.x="AsMi_plot_id", by.y="Plot")
names(asmi.c) <- c("Plot","Site",names(asmi.c)[3:length(asmi.c)])

#Label Prev12 as 08 through 12 of the previous year and give it the year for 01-07 (of the previous year (the next year) 
asmi.c$Prev12 <- asmi.c$Year
asmi.c$Prev12[asmi.c$Month > 7] <- asmi.c$Year[asmi.c$Month > 7]+1

head(asmi.c[with(asmi.c, order(Year,Month,Site,Plot))&asmi.c$Year==1980,],100)  

# so months after July go with the next year; t+1 is t month 8-12 and t+1 months 1-1
```


```{r}


asmi.c <- asmi.c[with(asmi.c, order(Year,Month,Site,Plot)),]

write.table(asmi.c, file = paste("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/" ,currentyr,"asmi.c.csv",sep=""), sep=",")

aggregate(asmi.c[,c("tmin","tmax","ppt")], list(Creek=asmi.c$Creek), function(x) mean(x)) #Average monthly... 
sort(unique(asmi.c$Year))

# first add by all prev12 then average all by creek
# Precipitation: ppt But with changes ppt is x
prev12clim <- aggregate(asmi.c[,c("ppt")], list(Creek=asmi.c$Creek, Site=asmi.c$Site, 
                                     Plot=asmi.c$Plot, YearPrev12=asmi.c$Prev12),
                        function(x) sum(x)) # Only want to sum ppt, not tmin and tmax 
# 1980 to currentyr
# aggregate(prev12clim$ppt, list(Creek=prev12clim$Creek), mean)
aggregate(prev12clim$x, list(Creek=prev12clim$Creek), mean)

# over the study period 1995-currentyr
# aggregate(prev12clim$ppt[prev12clim$YearPrev12 > 1994], 
#           list(Creek=prev12clim$Creek[prev12clim$YearPrev12 > 1994]), mean)
aggregate(prev12clim$x[prev12clim$YearPrev12 > 1994], 
          list(Creek=prev12clim$Creek[prev12clim$YearPrev12 > 1994]), mean)

# Temperature: tmin and tmax
prev12clim.temp <- aggregate(asmi.c[,c("tmin","tmax")], list(Creek=asmi.c$Creek, Site=asmi.c$Site, 
                                     Plot=asmi.c$Plot, YearPrev12=asmi.c$Prev12),
                        function(x) mean(x)) # Only want to sum ppt, not tmin and tmax 
# 1980 to currentyr
aggregate(prev12clim.temp[,c("tmin","tmax")], list(Creek=prev12clim$Creek), mean)

# over the study period 1995-currentyr
aggregate(prev12clim.temp[prev12clim.temp$YearPrev12 > 1994,c("tmin","tmax")], 
          list(Creek=prev12clim.temp$Creek[prev12clim.temp$YearPrev12 > 1994]), mean)
 
```

After create new climate dataset, can download it from GitHub
```{r}
asmi.c <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/PVA/master/datasets/asmi.c.csv"))

```




#autocorrelations   
https://campus.datacamp.com/courses/introduction-to-time-series-analysis/correlation-analysis-and-the-autocorrelation-function?ex=9#next    
alive.site$length are the number of indiviudals with length>0 and that aren't na per site per year (and per fenced or not plots)
```{r}
# Not sure what trying to do? Take away the first row each time?
# length_tmin1 <- split(alive.site$length[-1],alive.site$AsMi_site_id)
length_tmin1 <- split(alive.site$length,alive.site$AsMi_site_id)
length_tmin1.removed <- lapply(length_tmin1, function(x) x[-1])

# length_t <- split(alive.site$length[-nrow(alive.site)],
#                         alive.site$AsMi_site_id)

length_t.removed <- lapply(length_tmin1, function(x) x[-length(x)])
length_tmin1.removed
length_t.removed

autocor <- mapply(cbind,length_t.removed,length_tmin1.removed)
```

```{r}
plot(autocor[[1]], xlim=c(0,325), ylim=c(0,350), pch=20)
for(i in 2:6){
  points(autocor[[i]], col=i, pch=20)
}
```

```{r}
autocor1 <- do.call(rbind,autocor)
# sample covariance in acf is scaled with 1/(n-1) instead of 1/n
cor(autocor1[,1],autocor1[,2])*(nrow(autocor1)/(nrow(autocor1)+1))

#but to combine all sites time series, need to keep steps separate by site
lapply(split(alive.site$length,alive.site$AsMi_site_id), function(x){
  acf(x, lag.max=15, plot=TRUE)
})

#Blue is the 95% CI around zero, different from zero correlation
```
Cross-correlation of weather and number of individuals with AGG in July
```{r}



```




# 2017 June 2 for NCAR
```{r}

uniqclim <- unique(asmi.c[,c("Year","tmin","tmax","ppt")])
clim_agg <- merge(uniqclim, ps.asmi, by = "Year")


library(reshape2)
clim_agg_long <- melt(clim_agg[,c(1:6,8)], measure.vars = c("tmin","tmax","ppt","Total.Alive"))
levels(clim_agg_long$variable) <- c("Minimum temperature","Maximum temperature",
                                    "Precipitation (mm)","Individuals per plot")

ggplot(clim_agg_long[clim_agg_long$variable%in% c("Precipitation (mm)","Individuals per plot") & clim_agg_long$Site>3,], 
       aes(Year, value))+
#  geom_point()+
  stat_smooth(alpha=0.5)+
  facet_wrap(~variable, scales="free", ncol=1)+
  theme_bw()

```

```{r}
ggplot(clim_agg_long[clim_agg_long$variable%in% c("Minimum temperature","Individuals per plot") & clim_agg_long$Site>3,], 
       aes(Year, value))+
#  geom_point()+
  stat_smooth(alpha=0.5)+
  facet_wrap(~variable, scales="free", ncol=1)+
  theme_bw()
```

```{r}
ggplot(clim_agg_long[clim_agg_long$Site>3,], 
       aes(as.factor(Year), value))+
#  geom_point()+
  stat_smooth(alpha=0.5)+
  geom_boxplot()+
  facet_wrap(~variable, scales="free", ncol=1)+
  theme_bw()
```


# Annual precipiation average per year
```{r}
creekyear.avg <- aggregate(ppt~Creek+Prev12+Month, data = asmi.c[asmi.c$Year > 1994,], mean)
creekyear <- aggregate(ppt~Creek+Prev12, data = creekyear.avg, sum)

#ppt mm
mean(creekyear$ppt[creekyear$Creek == "Cebolla"])
mean(creekyear$ppt[creekyear$Creek == "South Beaver"])
mean(creekyear$ppt)
```

# Set seasonal climate factors

```{r}

asmi.c$season <- "winter"
asmi.c[asmi.c$Month>3 & asmi.c$Month<8, "season"] <- "springSummer"
asmi.c[asmi.c$Month>7 & asmi.c$Month<12, "season"] <- "fall"

asmi.c.summary <- aggregate(asmi.c[,names(asmi.c) %in% 
                                     grep(paste(c("tmin","tmax","ppt"),collapse="|"),
                                          names(asmi.c), value=TRUE)], 
                            asmi.c[,c("season","Creek","Prev12")],
                            FUN = function(x) mean(x, na.rm = TRUE))

head(asmi.c.summary)

# currentyr-1? should it just be currentyr? or not less than currentyr? 
season <- reshape(asmi.c.summary[asmi.c.summary$Prev12 < currentyr+1 & asmi.c.summary$Prev12 > 1994,],
                  idvar=c("Creek","Prev12"),
                  timevar = "season",
                  direction="wide")
head(season)

```

#PCA what split mast seeding years, high domrant individuals (not AGG), and percent reproductive     


2013 report: winter temp, spring/summer temp - both PCs, all split   
2014 report: winter precip, fall precip, spring/summer precip - both PCs, all split     
2015 report: PC1: fall precip, winter min temp, spring/summer precip    
             PC2: fall min, fall max, winter precip - mast seeding    
2016 report: PC1: fall max temp, spring/summer min temp - nothing split   
             PC2: fall min temp, fall precip, winter precip winter max temp    
2017 report: PC1: fall min fall max    
             PC2: fall precip, winter precip   nobody separated   
             

Seasons    
Winter: December-March (12-3)    
Spring/summer: April-July (4-7)    
Fall: August-November (8-11)   



# South Beaver Creek
# FRUIT
Take highest 3 loadings and look at how one affects the other 
```{r}
ps.asmi.t$Creek <- NA

ps.asmi.t$Creek[ps.asmi.t$Site > 4] <- "South Beaver"
ps.asmi.t$Creek[ps.asmi.t$Site < 3] <- "Cebolla"
table(ps.asmi.t$Creek)

asmi.env <- merge(season, ps.asmi.t, by.x = c("Creek","Prev12"), by.y = c("Creek","Year"))
names(asmi.env)

openlmdas <- data.frame(Year = 1995:(currentyr-1), 
                        Lmda = lmdAn(all.pva$notfenced.pro.matrix, 1995, currentyr-1)[1,], Fence = "n")

lmda5 <- data.frame(Site = 5,Lmda = lmdAn(all.pva$Site$'5', 1995, currentyr-1)[1,], 
                              Prev12 = 1995:(currentyr-1), Creek = "South Beaver")
lmda15 <- data.frame(Site = 15,Lmda = lmdAn(all.pva$Site$'15', 1995, currentyr-1)[1,],
                   Prev12 = 1995:(currentyr-1), Creek = "South Beaver")
lmda19 <- data.frame(Site = 19,Lmda = lmdAn(all.pva$Site$'19', 1995, currentyr-1)[1,],
                   Prev12 = 1995:(currentyr-1), Creek = "South Beaver")
lmda26 <- data.frame(Site = 26,Lmda = lmdAn(all.pva$Site$'26', 1995, currentyr-1)[1,],
                   Prev12 = 1995:(currentyr-1), Creek = "South Beaver")
lmda1 <- data.frame(Site = 1,Lmda = lmdAn(all.pva$Site$'1', 2014, currentyr-1)[1,],
                   Prev12 = 2014:(currentyr-1), Creek = "Cebolla")
lmda2 <- data.frame(Site = 2,Lmda = lmdAn(all.pva$Site$'2', 2014, currentyr-1)[1,],
                   Prev12 = 2014:(currentyr-1), Creek = "Cebolla")

lmdas.all <- rbind(lmda5,lmda15,lmda19,lmda26,lmda1,lmda2)

ggplot(lmdas.all, aes(Prev12, Lmda, colour=Creek))+
  geom_point()

season <- merge(season, lmdas.all, by = c("Prev12","Creek"))

```

# Should come in with count of seedlings per year and see how that is impacted by climate
```{r}
asmi.env
table(season$Site)
table(asmi.c$Site)
# aic.asmi <- merge(asmi.all1, season, by.x = c("Year","Site"), by.y = c("Prev12","Site"))
# .x is t and .y is t+1
aic.asmi <- merge(asmi.all, season, by.x = c("year","AsMi_site_id"), by.y = c("Prev12","Site"))

```

Multinomial logistic regression  
library(nnet)

```{r}
multinom(status ~ ppt.springSummer, aic.asmi)

lm1 <- multinom(status ~ ppt.fall + ppt.winter + ppt.springSummer +
            tmax.winter + tmax.fall + tmax.springSummer +
            tmin.springSummer + tmin.fall + tmin.winter, aic.asmi)
lm2 <- multinom(status ~ ppt.springSummer, aic.asmi)
lm3 <- multinom(status ~ tmin.winter + tmax.springSummer, aic.asmi) 
lm4 <- multinom(status ~ ppt.winter, aic.asmi)
lm5 <- multinom(status ~ 1, aic.asmi)
lm6 <- multinom(status ~ AsMi_site_id, aic.asmi)
# lm7 <- multinom(Lmda ~ Prev12, aic.asmi)
lm7 <- multinom(status ~ year, aic.asmi)
lm8 <- multinom(status ~ ppt.fall + ppt.winter +
            tmax.winter + tmax.fall +  tmax.springSummer +
            tmin.fall + tmin.winter, aic.asmi)
lm9 <- multinom(status ~ ppt.winter*tmax.winter*tmin.winter, aic.asmi)
lm10 <- multinom(status ~ ppt.fall*tmax.fall*tmin.fall, aic.asmi)
lm11 <- multinom(status ~ ppt.fall*ppt.winter*tmax.winter*tmax.fall*tmax.springSummer*tmin.fall*tmin.winter, aic.asmi)
# lm1,
lm.list <- list(lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9, lm10, lm11)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

```

single seasonal factor to describe which stage a plant will be in
```{r}

lm1 <- multinom(status ~ ppt.fall, aic.asmi)
lm2 <- multinom(status ~ ppt.springSummer, aic.asmi)
lm9 <- multinom(status ~ ppt.winter, aic.asmi)
lm3 <- multinom(status ~ tmin.winter, aic.asmi) 
lm8 <- multinom(status ~ tmin.fall, aic.asmi)
lm4 <- multinom(status ~ tmin.springSummer, aic.asmi)
lm5 <- multinom(status ~ 1, aic.asmi)
lm6 <- multinom(status ~ AsMi_site_id, aic.asmi)
lm7 <- multinom(status ~ year, aic.asmi)
lm10 <- multinom(status ~ tmax.fall, aic.asmi)
lm11 <- multinom(status ~ tmax.winter, aic.asmi)
lm12 <- multinom(status ~ tmax.springSummer, aic.asmi)
# lm1,
lm.list <- list(lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9, lm10, lm11,lm12)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

ggplot(aic.asmi, aes(status, ppt.springSummer))+
  geom_boxplot()+
  theme_bw()
```

# if you were to pick one seasonal factor to describe annual growth rate, what would it be?  None of them 
So the precipitation and minimum temperature of the months preceeding the census (the spring/summer which is April-July) best describe the combined survival, growth, and germination that is lambda of each year    
From the AIC models, each Site behaves differently 
```{r}
aic.asmi.cc <- unique(aic.asmi[,c("AsMi_site_id","tmin.fall","tmax.fall",
                                  "ppt.fall","tmin.springSummer","tmax.springSummer",
                                  "ppt.springSummer","tmin.winter","tmax.winter","ppt.winter","Lmda")])

lm1 <- lm(Lmda ~ ppt.fall, aic.asmi.cc)
lm2 <- lm(Lmda ~ ppt.springSummer, aic.asmi.cc)
lm3 <- lm(Lmda ~ ppt.winter, aic.asmi.cc)
lm4 <- lm(Lmda ~ tmin.winter, aic.asmi.cc)
lm5 <- lm(Lmda ~ tmin.springSummer, aic.asmi.cc) 
lm6 <- lm(Lmda ~ tmin.fall, aic.asmi.cc)
lm7 <- lm(Lmda ~ 1, aic.asmi.cc)
lm8 <- lm(Lmda ~ AsMi_site_id, aic.asmi.cc)
lm9 <- lm(Lmda ~ tmax.winter, aic.asmi.cc)
lm10 <- lm(Lmda ~ tmax.fall, aic.asmi.cc)
lm11 <- lm(Lmda ~ tmax.springSummer, aic.asmi.cc)


lm.list <- list(lm1, lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9, lm10, lm11)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))

#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

```

```{r}
ggplot(asmi.env, aes(X..Dormant))+
  geom_histogram()+
  facet_grid(~Site)
```

# When looking at combinations, no relationship just as good as the interaction of a bunch   
```{r}


lm1 <- lm(Lmda ~ ppt.fall + ppt.winter + tmax.winter, season)
lm2 <- lm(Lmda ~ ppt.springSummer, season)
lm3 <- lm(Lmda ~ tmin.winter + tmax.springSummer, season) 
lm4 <- lm(Lmda ~ ppt.winter, season)
lm5 <- lm(Lmda ~ 1, season)

lm6 <- lm(Lmda ~ ppt.fall, season)

lm7 <- lm(Lmda ~ tmax.fall, season)

lm8 <- lm(Lmda ~ tmax.springSummer, season)

lm9 <- lm(Lmda ~ (ppt.fall + ppt.winter + tmax.winter)^2, season)
# lm6 <- lm(Lmda ~ Site, season)
# 
# lm7 <- lm(Lmda ~ Prev12, season)

lm.list <- list(lm1,lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))

#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}


```

```{r}


lm1 <- lm(Lmda ~ ppt.fall + ppt.winter + tmax.winter, season)
lm2 <- lm(Lmda ~ ppt.springSummer*tmin.springSummer, season)
lm3 <- lm(Lmda ~ tmin.winter * ppt.springSummer, season) 
lm4 <- lm(Lmda ~ ppt.winter, season)
lm5 <- lm(Lmda ~ 1, season)

lm6 <- lm(Lmda ~ ppt.fall, season)

lm7 <- lm(Lmda ~ tmin.springSummer, season)

lm8 <- lm(Lmda ~ ppt.springSummer, season)

lm9 <- lm(Lmda ~ (ppt.springSummer + ppt.springSummer + ppt.winter)^2, season)
# lm6 <- lm(Lmda ~ Site, season)
# 
# lm7 <- lm(Lmda ~ Prev12, season)

lm.list <- list(lm1,lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))

#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}


```


```{r}

percentAGG <- do.call(rbind,lapply(unique(ps.asmi.t$Year),function(x){
  thisyear <- ps.asmi.t[ps.asmi.t$Year==x & ps.asmi.t$Site>3,]
  percentalive <- sum(thisyear$Total.Alive)/sum(thisyear$Total.Plants)
  out <- data.frame(percentalive,year=x)
  out
}))

percentAGGCebollaandBeaver <- do.call(rbind,lapply(unique(ps.asmi.t$Year),function(x){
  thisyear <- ps.asmi.t[ps.asmi.t$Year==x,]
  percentalive <- sum(thisyear$Total.Alive)/sum(thisyear$Total.Plants)
  out <- data.frame(percentalive,year=x)
  out
}))

#Total.Plants - AGG and dormant
AGGDorm <- summarySE(ps.asmi.t, measurevar="Total.Plants",
                     groupvars=c("Fence","Year","Site","Creek"))
#Total.Alive - AGG
AGG <- summarySE(ps.asmi.t, measurevar="Total.Alive",
                 groupvars=c("Fence","Year","Site","Creek"))

#Total.Fruit
Fruit <- summarySE(ps.asmi.t, measurevar="Total.Fruit",
                   groupvars=c("Fence","Year","Site","Creek"))

#X..Flowered - %flowered
Repro <- summarySE(ps.asmi.t, measurevar="X..Flowered",
                   groupvars=c("Fence","Year","Site","Creek"))

```


 Figure 8    
AGG and Dormant  
South Beaver Creek    
+
  geom_rect(aes(xmin=2005.75,xmax=2015.5,ymin=0,ymax=75),
                    fill="gray80", alpha=0.01) 
```{r}

ps.asmi.t[ps.asmi.t$Fence == "y",]
table(ps.asmi.t$Total.Plants)
table(ps.asmi.t$Fence, ps.asmi.t$Year) 
# Swtich back? 

# Total.Plants>0 should only have plots that have some plants per year so no plots from earlier than they were started
p2SBC <- ggplot(ps.asmi.t[ps.asmi.t$Total.Plants>0 & ps.asmi.t$Year > 1995 &
                 ps.asmi.t$Year < currentyr & ps.asmi.t$Creek == "South Beaver",], 
       aes(Year, Total.Plants, shape = Fence, colour = Fence))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("Average AGG and dormant")+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75, lty =3)+      # Fencing put in, removed after 2015 census
  geom_vline(xintercept = 2006.75, lty = 4)+
  geom_vline(xintercept = 2015.5, lty =3) +
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.justification=c(0,0), legend.position=c(0,0),  #bottom left
        legend.background = element_rect(fill=alpha('white', 0.1)))


  
```

Cebolla AGG and Dormant = Total.Plants 
```{r}


p2CC <- ggplot(ps.asmi[ps.asmi$Year > 2014 & 
                 ps.asmi$Year < currentyr & ps.asmi$Site < 3,], 
       aes(Year, Total.Plants, shape = as.factor(Site), colour = as.factor(Site)))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.05),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.05),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("Average AGG and dormant per Plot")+
  ggtitle("f)") +
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Site",
                     values=c("#000000","#7e7e7e"),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_shape_manual("Site",
                     values=c(1,2),
                     labels = c("Cebolla Mid","Cebolla North"))+
  theme(legend.justification=c(1,1), legend.position=c(0.95,0.99),
        legend.background = element_rect(fill=alpha('white', 0.1))) 
# +
#   scale_y_continuous(limits = c(0,68)) +
#   scale_x_continuous(breaks = c(2014:currentyr-1))

```


#Gina Gleene suggestion   
log transformed! 
```{r}
ps.asmi1 <- ps.asmi[ps.asmi$Site<3 & ps.asmi$Year>2013 | ps.asmi$Site>4,]

# added plots 238 (site 26) and 300 (site 19) in 1996
# added 598 (site 26) in 2004 
ps.asmi1 <- ps.asmi1[!(ps.asmi1$Plot == 238 & ps.asmi1$Year < 1996),]
ps.asmi1 <- ps.asmi1[!(ps.asmi1$Plot == 300 & ps.asmi1$Year < 1996),]
ps.asmi1 <- ps.asmi1[!(ps.asmi1$Plot == 598 & ps.asmi1$Year < 2004),]


ggplot(ps.asmi1[ps.asmi1$Total.Alive>0 & ps.asmi1$Site > 3,], 
       aes(Year, Total.Alive, colour = as.factor(Site)))+
  geom_point()+
  stat_smooth(method="lm", se=TRUE, alpha=0.1)+
#  geom_ribbon(stat='smooth', method = "lm", se=TRUE, alpha=0.1, 
#              aes(color = NULL, group = factor(Site))) + 
  geom_line(stat='smooth', method = "lm", alpha=0.3)+
  theme_bw() +
  ylab("Average AGG per Plot")+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75)+
  geom_vline(xintercept = 2015.5)+
  geom_vline(xintercept = 2006.75, lty = 4)+
  theme(legend.justification=c(1,1), legend.position=c(1,1),
        legend.background = element_rect(fill=alpha('white', 0.1)))
```

# the decline is from one plot, the rest are stable or increasing!
```{r}
ggplot(ps.asmi.t[ps.asmi.t$Total.Alive>0 & ps.asmi.t$Creek == "South Beaver",], 
       aes(Year, Total.Alive, colour = as.factor(Plot)))+
  geom_point()+
 # geom_ribbon(stat='smooth', method = "lm", se=TRUE, alpha=0.1, 
#              aes(color = NULL, group = factor(Plot))) +
  geom_line(stat='smooth', method = "lm")+
  theme_bw() +
  ylab("Average AGG per Plot")+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75)+
  geom_vline(xintercept = 2006.75, lty = 4)+
  theme(legend.position="none") 

```

South Beaver
AGG
```{r}


p1SBC <- ggplot(ps.asmi[ps.asmi$Total.Alive>0 & ps.asmi$Site > 3,], 
       aes(Year, Total.Alive, shape = Fence, colour = Fence))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("Average AGG per Plot")+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75, lty =3)+      # Fencing put in, removed after 2015 census
  geom_vline(xintercept = 2006.75, lty = 4)+
  geom_vline(xintercept = 2015.5, lty =3) +
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.justification=c(1,1), legend.position=c(0.25,1),
        legend.background = element_rect(fill=alpha('white', 0.1))) 


```

Cebolla    
AGG   Total.Alive     
AGG + Dormant   Total.Plants
```{r}

p1CC <- ggplot(ps.asmi[ps.asmi$Site < 3 & ps.asmi$Year > 2013,], 
       aes(Year, Total.Alive, shape = as.factor(Site), colour = as.factor(Site)))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.15),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.15),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.15),
               geom = "line")+
  theme_bw() +
  ylab("Average AGG per Plot")+
  ggtitle("e)") +
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Site",
                     values=c("#000000","#7e7e7e"),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_shape_manual("Site",
                     values=c(1,2),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_x_continuous(breaks = c(2014:currentyr))+
  theme(legend.justification=c(0,1), legend.position=c(0,1),
        legend.background = element_rect(fill=alpha('white', 0.1))) 


```



Fruit   
South Beaver Creek
```{r}

p3SBC <- ggplot(ps.asmi[ps.asmi$Total.Plants>0 & ps.asmi$Site > 3,], 
       aes(Year, Total.Fruit, shape = Fence, colour = Fence))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ylab("Average Total Fruit per Plot")+
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75, lty =3)+      # Fencing put in, removed after 2015 census
  geom_vline(xintercept = 2006.75, lty = 4)+
  geom_vline(xintercept = 2015.5, lty =3) +
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1),
        legend.background = element_rect(fill=alpha('white', 0.1))) #upper right

```


Cebolla
```{r}

aggregate(Total.Fruit~Site+Year,data=ps.asmi[ps.asmi$Total.Plants>0 & ps.asmi$Site < 3,], mean)

aggregate(Total.Fruit~Site+Year,data=ps.asmi[ps.asmi$Total.Plants>0 & ps.asmi$Site<3,],
          std.error)


p3CC <- ggplot(ps.asmi[ps.asmi$Total.Plants>0 & ps.asmi$Site <3,], 
       aes(Year, Total.Fruit, shape = as.factor(Site), colour = as.factor(Site)))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.15),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.15),
               geom = "point")+
  stat_summary(fun.y = mean,position=position_dodge(width=0.15),
               geom = "line")+
  theme_bw() +
  ylab("Average Total Fruit per Plot")+
  ggtitle("g)") +
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Site", 
                     values=c("#000000","#7e7e7e"),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_shape_manual("Site", 
                     values=c(1,2),
                     labels = c("Cebolla Mid","Cebolla North"))+
  theme(legend.justification=c(0,1), legend.position=c(0,1),
        legend.background = element_rect(fill=alpha('white', 0.1)))+
  scale_x_continuous(breaks = c(2014:currentyr))

```
  
  
X..Flowered - Percent Reproductive
```{r}


p4SBC <- ggplot(ps.asmi.t[ps.asmi.t$Total.Plants>0 & ps.asmi.t$Creek == "South Beaver",], 
       aes(Year, X..Flowered, shape = Fence, colour = Fence))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ylab("% Reproductive per Plot")+
  ggtitle("d)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75, lty =3)+      # Fencing put in, removed after 2015 census
  geom_vline(xintercept = 2006.75, lty = 4)+
  geom_vline(xintercept = 2015.5, lty =3) +
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1),  #bottom left
        legend.background = element_rect(fill=alpha('white', 0.1))) #upper right

```

Cebolla
```{r}

p4CC <- ggplot(ps.asmi[ps.asmi$Total.Plants>0 & ps.asmi$Site<3,], 
       aes(Year, X..Flowered, shape = as.factor(Site), colour = as.factor(Site)))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.15),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.15),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,position=position_dodge(width=0.15),
               geom = "line")+
  theme_bw() +
  ylab("% Reproductive per Plot")+
  ggtitle("h)") +
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Site",
                     values=c("#000000","#7e7e7e"),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_shape_manual("Site",
                     values=c(1,2),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_x_continuous(breaks = c(2014:currentyr))+
  theme(legend.justification=c(0,1), legend.position=c(0,1),
        legend.background = element_rect(fill=alpha('white', 0.1))) #upper right

```






Figure 2
```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/","Fig2-SouthBeaverCreek.jpg", sep = ""),
         units = "mm", res = 300, height = 181.03*2, width = 186.87*2)

# Down each column
multiplot(p1SBC, p3SBC, p2SBC, p4SBC, cols=2)

dev.off()


```
Figure 2 Cebolla Creek
```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/","Fig2-CebollaCreek.jpg", sep = ""),
         units = "mm", res = 300, height = 181.03*2, width = 186.87*2)

# Down each column
multiplot(p1CC, p3CC, p2CC, p4CC, cols=2)

dev.off()


```

Going to skip this after 2016 since know that plants aren't below ground the whole season, not as much a quesiton of using this to figure out how much dormancy - dormancy = not AGG in July   
Need to change from set amount of time dormant to find the most likely length of dormancy given that 25-50 percent are actually veg, seedlings, or reproductive when not detected in July

### Years alive    
```{r}
dormyrs <- currentyr-1995

path <- paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,
              "_asmi/", collapse = '', sep = '')

#If a plant is still alive in the current year, there is no years alive calculated
yrsalive <- lapply(1:(dormyrs-1), function(x){ 
  path2 <- paste(path, "YrsAlive_dormant", x, ".csv", sep = "")
  ysal <- read.csv(path.expand(path2), na.strings="na")
  ysal <- cbind(ysal, YrsD = x)
  ysal[complete.cases(ysal),]
  })

head(yrsalive[[4]])

```

```{r}
sumYrsAlive <- lapply(yrsalive, function(x){
  summarySE(x[complete.cases(x),], measurevar="Yearsalive",groupvars="YrsD")
})

smya <- do.call(rbind, sumYrsAlive)

ggplot(smya, aes(YrsD, Yearsalive))+
  geom_line()

yrsaliveall <- do.call(rbind, yrsalive)

ggplot(yrsaliveall, aes(as.factor(YrsD), Yearsalive))+
  geom_violin()

# , colour= as.factor(AsMi_site_id)   
# Cebolla Creek not long enough to get at life length
ggplot(yrsaliveall[yrsaliveall$AsMi_site_id > 3,], aes(as.factor(YrsD), Yearsalive))+
  # geom_boxplot()+
  geom_violin()+
  theme_bw()

jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/Fig4b.jpg", sep = ""),
         units = "mm", res = 300, height = 100, width = 130)

ggplot(yrsaliveall[yrsaliveall$AsMi_site_id > 3,], aes(YrsD, Yearsalive, colour= as.factor(AsMi_site_id)))+
  # geom_jitter()+
  stat_smooth()+
  theme_bw()+
  scale_color_discrete(name = "Site")+
  xlab("Consecutive years dormant")+
  ylab("Life Length")

dev.off()
```

Of the 797 individuals alive in South Beaver Creek in 1995 ...
```{r}

lifelength <- do.call(rbind, yrsalive)


mean(lifelength$Yearsalive[lifelength$YrsD < 8]) #2.5
mean(lifelength$Yearsalive)
```

Dormancy    
repeat lengths   
```{r}
# how many individuals are dormant at some point
ind_dorm <- do.call(rbind,lapply(split(asmi.raw,asmi.raw$AsMi_tag_id), function(x){
  if(length(grep("dormant",x$status))>0){
    data.frame(Site = unique(x$AsMi_site_id), 
               Fence = unique(x$fence), 
               Plot = unique(x$AsMi_plot_id), 
               Dorm = 1)
  } else {
    data.frame(Site = unique(x$AsMi_site_id), 
               Fence = unique(x$fence), 
               Plot = unique(x$AsMi_plot_id), 
               Dorm = 0)
    }
  }))


table(ind_dorm$Dorm)
nrow(ind_dorm[ind_dorm$Dorm==1,]) # 1022

perc_ind_dorm <- aggregate(Dorm~Site+Plot+Fence, data=ind_dorm,
                           function(x) sum(x)/length(x))

aggregate(Dorm~Fence, data=ind_dorm,
          function(x) sum(x)/length(x))

#percent dormant individuals by site
aggregate(Dorm~Site, data=ind_dorm, function(x) sum(x)/length(x))
#percent individuals with any length of dormancy from SBC
sum(perc_ind_dorm$Dorm[perc_ind_dorm$Site>3])/length(perc_ind_dorm$Dorm[perc_ind_dorm$Site>3])



#in Raw, #2 is dormant
# 
# dorms <- do.call(c,lapply(unique(asmi.raw$AsMi_tag_id), function(x){
#   tag <- asmi.raw[asmi.raw$AsMi_tag_id == x,]
#   dormlns <- rle(as.numeric(tag$status))$lengths[rle(as.numeric(tag$status))$values==2]
#   dormlns
# }))

names(asmi.all1)
names(asmi.1)
names(asmi.all2)

#  But this could be multple times per individual
levels(asmi.all2$stage)
# dorms.1 <- rle(as.numeric(asmi.all2$stage))$lengths[rle(as.numeric(asmi.all2$stage))$values ==4]
dorms.1 <- lapply(split(asmi.all2, asmi.all2$tag), function(x){
  rle(as.numeric(x$stage))$lengths[rle(as.numeric(x$stage))$values == 4]
})
dorms.2 <- do.call(rbind, lapply(dorms.1, function(s) {
  if(length(s) > 0) max(s, na.rm = TRUE)
  })
  )

max(dorms.1) #21 -> 23
max(dorms.2)

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

# Does this really tell me the length of dormancy? It tells me every instanace of dormancy, not one per individual 
Mode(dorms.1) #1
length(dorms.1[dorms.1==1]) #441 -> 622
length(dorms.1[dorms.1==1])/length(dorms.1) #41.9% --> 0.47
length(dorms.1[dorms.1 == max(dorms.1)]) # 13 with 21 years -> 1 with 3887?? What now?!

# Now have selected only the longest period of dormancy per individual
Mode(dorms.2) #1
length(dorms.2[dorms.2==1]) #441 -> 415
length(dorms.2[dorms.2==1])/length(dorms.2) #41.9% --> 0.41
length(dorms.1[dorms.2 == max(dorms.2)]) # 13 with 21 years -> 4 with 23 years

```






#SKIP!
Figure 3: Was: Average life span of Astragalus microcymbus (with one standard error from the mean) given consecutive assumptions on length of possible whole plant dormancy. (b) Distribution of consecutive years of dormancy when dormancy is not limited.  
```{r}
ggplot(smya, aes(YrsD, Yearsalive))+
#  stat_smooth()+
  geom_errorbar(aes(ymin=Yearsalive-se, ymax=Yearsalive+se), 
                width=1) +
  theme_bw()+
  xlab("Maximum years dormant")+
  ylab("Life length")+
  scale_y_continuous(breaks = seq(2, 4, .5), limits = c(2.3, 3.8)) 

```

#Episodic fruit production paragraph   
```{r}
noreproductiveyears <- aggregate(flower~AsMi_site_id+year, data=asmi.raw,
                                 function(x) if(sum(x)>0){
                                   1
                                 } else {
                                   0
                                 })

ggplot(noreproductiveyears, aes(year,flower,colour=as.factor(AsMi_site_id)))+
  geom_point()+
  facet_grid(~AsMi_site_id)

#how many years are there no reproductive indiviudals per site
1-aggregate(flower~AsMi_site_id, data=noreproductiveyears,
          function(x) sum(x)/length(x))

#On average, no reproductive individuals how many years?  in 2016
mean(c(1-aggregate(flower~AsMi_site_id,
                   data=noreproductiveyears[noreproductiveyears$year<2017,],
          function(x) sum(x)/length(x))[-(1:2),2]))*(length(1995:(currentyr-1)))

#On average, no reproductive individuals how many years?  in current year
mean(c(1-aggregate(flower~AsMi_site_id, data=noreproductiveyears,
          function(x) sum(x)/length(x))[-(1:2),2]))*(length(1995:currentyr))

#Number of years of no reproductive for South Beaver Creek (not correct for Cebolla)
length(1995:currentyr)-aggregate(flower~AsMi_site_id, data=noreproductiveyears,sum)
```


#Intraannual visits
### Intraannual visits    
Will want to ignore sites that were not visited - deal with differently than plants that were not seen but are also NA      
### What is the most common stage class of individuals that were dormant for some portion of the growing season? 
2013
```{r}
intra.2013June <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Raw Data/2013/AsMiJune2013.csv"), na.strings="")

intra.2013July <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Raw Data/2013/AsMiJuly2013.csv"), na.strings="")

intra.2013Sept <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Raw Data/2013/September2013.csv"), na.strings="")



```


```{r}
intra <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Raw Data/2015 datasheets/2015_intrayear_asmi.csv"), na.strings="")

intra <- intra[ rowSums(is.na(intra[,grep("Ln", names(intra))[-1]])) != length(grep("Ln", names(intra))[-1]),] 

intra$UniqueID <- 1:nrow(intra)

demo.only <- intra[,-c(1:7,13,99:100)] 
names(demo.only)

# get rid of all NA in the wide form first instead of in the long?
nrow(demo.only)
nrow(demo.only[!is.na(demo.only$LnApr20_15),])
nrow( demo.only[ rowSums(is.na(demo.only[,grep("Ln", names(demo.only))])) != length(grep("Ln", names(demo.only))),] )
# demo.only <- demo.only[ rowSums(is.na(demo.only[,grep("Ln", names(demo.only))])) != length(grep("Ln", names(demo.only))),] 


# need to name the same before binding...
surname <- names(demo.only[,grep("Ln",names(demo.only))])

demo.only.bydate <- lapply(1:18, function(x){
  df <- data.frame(intra[,c(1:7,13,99:100)], demo.only[,((5*x-4):(5*x))],Survey = surname[x])
  names(df) <- c(names(intra[,c(1:7,13,99:100)]), "Ln","Fl","Fr","Br","Comment","Survey")
  # df[!is.na(df$Ln),]
  df
})

head(demo.only.bydate[[15]])

dm <- do.call(rbind, demo.only.bydate)

dm$Site[dm$Plot <= 610 & dm$Plot >= 606] <- "5"
dm$Site[dm$Plot == 8 | dm$Plot == 578 | dm$Plot == 581 | dm$Plot == 799] <- "15"
dm$Site[dm$Plot == 300 | dm$Plot <= 515 & dm$Plot >= 512] <- "19"
dm$Site[dm$Plot == 238 | dm$Plot == 480 |
          dm$Plot == 598 | dm$Plot == 611 | dm$Plot == 614] <- "26"
dm$Site[dm$Plot == 22 | dm$Plot == 1 | dm$Plot == 32 | dm$Plot == 42
        | dm$Plot == 52 ] <- "1"

dm$Site[dm$Plot == 16 | dm$Plot == 96 | dm$Plot == 58
        | dm$Plot == 89 | dm$Plot == 98 | dm$Plot == 90 ] <- "2"

sites <- c("5","15","19","26","1","2")
dm$Site <- ordered(dm$Site, levels = sites)

#May1 moved to 2014 order from 2015
levels(dm$Survey) <- c(sapply(c(substr(levels(dm$Survey)[1:5],3,6),
                       substr(levels(dm$Survey)[6],3,7),
                       substr(levels(dm$Survey)[7:9],3,6)),paste0, "_2014"),
                       sapply(c(substr(levels(dm$Survey)[10],3,6),
                       substr(levels(dm$Survey)[11],3,7),
                       substr(levels(dm$Survey)[12:13],3,6),
                       substr(levels(dm$Survey)[14],3,7),
                       substr(levels(dm$Survey)[15:18],3,6)),paste0, "_2015"))


#Add actual date to surveys
table(dm$Survey)
dm$Date <- as.Date("2014-04-21")
dm$Date[dm$Survey=="May1_2014"] <- as.Date("2014-05-13")
dm$Date[dm$Survey=="Jun1_2014"] <- as.Date("2014-06-02")
dm$Date[dm$Survey=="Jun2_2014"] <- as.Date("2014-06-25")
dm$Date[dm$Survey=="Jul1_2014"] <- as.Date("2014-07-15")
dm$Date[dm$Survey=="Aug14_2014"] <- as.Date("2014-08-05")
dm$Date[dm$Survey=="Sep1_2014"] <- as.Date("2014-09-07")
dm$Date[dm$Survey=="Oct1_2014"] <- as.Date("2014-10-08")
dm$Date[dm$Survey=="Oct2_2014"] <- as.Date("2014-10-28")
dm$Date[dm$Survey=="Apr2_2015"] <- as.Date("2015-04-20")
dm$Date[dm$Survey=="May11_2015"] <- as.Date("2015-05-11")
dm$Date[dm$Survey=="May2_2015"] <- as.Date("2015-05-26")
dm$Date[dm$Survey=="June_2015"] <- as.Date("2015-06-08")
dm$Date[dm$Survey=="June2_2015"] <- as.Date("2015-06-22")
dm$Date[dm$Survey=="July_2015"] <- as.Date("2015-07-22")
dm$Date[dm$Survey=="Aug1_2015"] <- as.Date("2015-08-11")
dm$Date[dm$Survey=="Sept_2015"] <- as.Date("2015-09-01")
dm$Date[dm$Survey=="Oct6_2015"] <- as.Date("2015-10-06")
table(dm$Date)

```
Skip
```{r}
fixnames <- names(intra)
fixnames[grep("Ln", fixnames)]

fixnames <- c(names(intra)[1:7], paste("April_2014",names(intra)[8:12],sep="_"),names(intra)[13],
              paste("May_2014", names(intra)[14:18],sep="_"), paste("June_1_2014", names(intra)[19:23],sep="_"),
              paste("June_2_2014", names(intra)[24:28],sep="_"), paste("July_2014", names(intra)[29:33],sep="_"),
              paste("August_2014", names(intra)[34:38],sep="_"),
              paste("September_2014", names(intra)[39:43],sep="_"),
              paste("October_1_2014", names(intra)[44:48],sep="_"),
              paste("October_2_2014", names(intra)[49:53],sep="_"),
              paste("April_2015", names(intra)[54:58],sep="_"),
              paste("May_1_2015", names(intra)[59:63],sep="_"),paste("May_2_2015", names(intra)[64:68],sep="_"),
              paste("June_1_2015", names(intra)[69:73],sep="_"),paste("June_2_2015", names(intra)[74:78],sep="_"),
              paste("July_2015", names(intra)[79:83],sep="_"),
              paste("August_2015", names(intra)[84:88],sep="_"),
              paste("September_2015", names(intra)[89:93],sep="_"),
              paste("October_2015", names(intra)[94:98],sep="_"), names(intra)[99:100])

names(intra) <- fixnames

# Just use dm where made into one line but make sure that NAs are kept
# intra$Status_April_2014 <- as.character("dead")
# intra$Status_May_2014 <- as.character("dead")
# intra$Status_June_1_2014 <- as.character("dead")
# intra$Status_June_2_2014 <-as.character("dead")
# intra$Status_July_2014 <-as.character("dead")
# intra$Status_August_2014 <-as.character("dead")
# intra$Status_September1_2014 <-as.character("dead")
# intra$Status_October_1_2014 <-as.character("dead")
# intra$Status_October_2_2014 <-as.character("dead")
# intra$Status_April_2015 <-as.character("dead")
# intra$Status_May_1_2015 <-as.character("dead")
# intra$Status_May_2_2015 <-as.character("dead")
# intra$Status_June_1_2015 <-as.character("dead")
# intra$Status_June_2_2015 <-as.character("dead")
# intra$Status_July_2015 <-as.character("dead")
# intra$Status_August_2015 <-as.character("dead")
# intra$Status_September_2015 <-as.character("dead")
# intra$Status_October_2015 <-as.character("dead")
# 
# for(i in grep("Status", names(intra))){
#   survey <- names(intra)[i]
#   strspname <- strsplit(survey, "_")
#   surveycols <- paste(unlist(strspname)[2:length(unlist(strspname))], sep="_", collapse = "_")
#   for(x in grep(surveycols, names(intra))){
#   intra[,i]
# }}

# intra[unlist(sapply(intra[,grep("_Comment", names(intra))], function(x) grepl("non-asmi", x)))] <- "not a seedling"
intra[grepl("non-asmi", intra)] <- "not asmi"
intra[grepl("fuzzy coty", intra)] <- "not asmi"
intra[grepl("no coty", intra)] <- "no baby"

# Assign status reached 
intra$status2014 <- as.character("dead")
intra$status2014[apply(intra[,grep("2014_Ln",names(intra))], 1, function(row) sum(row, na.rm=TRUE))>0] <- "vegetative"
intra$status2014[apply(intra[,grep("2014_Fl",names(intra))], 1, function(row) sum(row, na.rm=TRUE))>0] <- "reproductive"
intra$status2014[intra$July_2014_LnJul14 == 0] <- "dormant"
intra$status2014[unlist(sapply(intra[, grep("2014_Comment", names(intra))], function(x) grep("coty", x)))] <- "seedling" 

table(intra$status2014)
intra$status2014[apply(intra[,grep("2014_Ln",names(intra))], 1, function(row) sum(row, na.rm=TRUE))>0] <- "vegetative"

# library(dplyr)
# intra %>% filter_at(vars(grep("2014_Comments",names(intra))), any_vars(grepl("coty", .)))

intra$status2015 <- as.character("dead")
intra$status2015[apply(intra[,grep("2015_Ln",names(intra))], 1, function(row) sum(row, na.rm=TRUE))>0] <- "vegetative"
intra$status2015[apply(intra[,grep("2015_Ln",names(intra))], 1, function(row) sum(row, na.rm=TRUE))>0] <- "vegetative"
intra$status2015[apply(intra[,grep("2015_Fl",names(intra))], 1, function(row) sum(row, na.rm=TRUE))>0] <- "reproductive"
intra$status2015[intra$July_2015_LnJuly20.23_15 == 0] <- "dormant"
intra$status2015[unlist(sapply(intra[, grep("2015_Comment", names(intra))], function(x) grep("coty", x)))] <- "seedling" 


dm$Year <- format(as.Date(dm$Date, format="%Y-%m-%d"), "%Y")
dm$status <- as.character("vegetative")
dm$status[dm$Fl==1] <- "reproductive"
dm$status[dm$Ln == 0] <- "dormant"
dm$status[dm$AprSeedlings == 1] <- "seedling"
dm$status[grep("coty", dm$Comment)] <- "seedling"

### 
# dm$JulyDorm <- 0
# dm$JulyDorm[dm$Ln==0 ]
dm.season <- merge(dm, season, by.x = "Year", by.y = "Prev12")

intra$Year <- 
intra.season <- merge(intra)

ggplot(dm.season, aes(ppt.springSummer, fill = status))+
  geom_histogram()

```

```{r}
dm$status <- as.character(NA)
dm$status[dm$Ln > 0] <- "vegetative"
dm$status[dm$Fl ==1] <- "reproductive"
dm$status[dm$Ln == 0] <- "dormant"

table(dm$status, dm$Survey)
table(dm$Comment[dm$status=="vegetative"], dm$status[dm$status=="vegetative"])

dm$Comment <- as.character(dm$Comment)
dm$Comment[grep("non-asmi",dm$Comment)] <- "No"
dm$Comment[grep("no coty",dm$Comment)] <- "No"
dm$Comment[grep("not new", dm$Comment)] <- "No"
# dm$status[dm$Comment %in% c("lost", "subsum","same as","tag not","brows","broken", "dried","dea")] <- "dormant"

table(dm$Comment[dm$Ln < 10],dm$status[dm$Ln < 10])


toMatch <- c("coty","Coty","new plant","seedli")
asmicoty <- unique(dm$UniqueID[grep(paste(toMatch, collapse="|"),
                                          dm$Comment,
                                    ignore.case=TRUE)])

# The ones that are seedlings should be nothing "NA" before being seen while the ones that are found but not as seedlings should be dormant before 
# dm$status[grep("dead",dm$Comment)] <- "dead"

table(dm$Comment[dm$UniqueID %in% asmicoty])

dm$Year <- as.numeric(2014)
dm$Year[grep("2015",dm$Survey)] <- 2015

table(dm$Year, dm$status)

dm[dm$UniqueID %in% dm$UniqueID[dm$status=="dormant"],]

# These should be all that are alive sometime in 2014 or 2015 so can see number of seedlings in each time and number above ground in July each year

for(i in asmicoty){
  seedlingsurvey <- min(dm$Date[dm$UniqueID==i & !is.na(dm$status) ], na.rm=TRUE)
# many are nothing because wasnt' seen again after cotyledons, warnings are fine, dealt with in the if statement
  lastseen <- max(dm$Date[dm$UniqueID==i & dm$status %in% c("vegetative","reproductive")], na.rm=TRUE)
  
  toMatch <- c("coty","Coty","new p","seedli") 
  dm$status[grep(paste(toMatch, collapse="|"),
               dm$Comment, ignore.case=TRUE)] <- "seedling"


  if(is.infinite(lastseen)){
    dm$status[dm$Date>seedlingsurvey & dm$UniqueID==i] <- "dead"
    dm$status[dm$Date<seedlingsurvey & dm$UniqueID==i] <- "NA"
  } else {
    dm$status[dm$Date>seedlingsurvey & dm$UniqueID==i & dm$Date<lastseen & dm$status == "NA"] <- "dormant"
    dm$status[dm$Date>lastseen & dm$UniqueID==i] <- "dead"
    dm$status[dm$Date<seedlingsurvey & dm$UniqueID==i ] <- "NA"
  }
  
    # dm[dm$Date>=seedlingsurvey & dm$UniqueID==i & dm$status != "NA",]
}

# Assume any that are alive at some point over the two years and not detected as seedlings are dormant the rest of the time. 
notseedlingones <- unique(dm$UniqueID)[!unique(dm$UniqueID) %in% asmicoty]# setdiff(unique(dm$UniqueID), seedlingones)

table(dm$Year, dm$status)
table(dm$Comment[dm$UniqueID %in% notseedlingones])

# Inflated ones dormant in 2014, should only be dormant if exisited in prior to 2014
alivein2013 <- unique(dm$tag)[unique(dm$tag) %in% unique(intra.2013July$Tag)]
alivein2015 <- unique(dm$tag)[unique(dm$tag) %in% 
                                unique(asmi.1$tag_no[asmi.1$status != "dead" & asmi.1$year == 2015])]

for(i in notseedlingones){
  firstseen <- min(dm$Date[dm$UniqueID==i & dm$Ln > 0])
  lastseen <- max(dm$Date[dm$UniqueID==i & dm$status %in% c("vegetative","reproductive")], na.rm=TRUE)

  if(unique(dm$tag[dm$UniqueID==i]) %in% alivein2013){
    dm$status[dm$status == "NA"] <- "dormant"
    } else {
      if(is.infinite(lastseen)){
        dm$status[dm$Date>seedlingsurvey & dm$UniqueID==i] <- "dead"
        dm$status[dm$Date<seedlingsurvey & dm$UniqueID==i] <- "NA"
        } else {
          dm$status[dm$Date>seedlingsurvey & dm$UniqueID==i & dm$Date<lastseen & dm$status == "NA"] <- "dormant"
          if(unique(dm$tag[dm$UniqueID==i]) %in% alivein2015){
          dm$status[dm$Date>lastseen & dm$UniqueID==i] <- "dormant"
          } else {
            dm$status[dm$Date>lastseen & dm$UniqueID==i] <- "dead"
        }}
    }
  }

table(dm$Survey, dm$status)

'%ni%' <- Negate('%in%')

dm <- dm[!is.na(dm$status),]

ggplot(dm[dm$status %ni% c("NA","dead"),], aes(Survey, status))+
  # geom_violin()+
  # geom_jitter()+
  theme_bw()+
  geom_count()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplot(data.frame(table(dm$Date, dm$status)), aes(Var1, Freq, colour = Var2))+
  geom_point()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


```{r}
table(dm$Site)
table(season$Site)

dm$Site <- as.numeric(as.character(dm$Site))
dm.season <- merge(dm, season, by.x = c("Year","Site"), by.y = c("Prev12","Site"))


dm.table <- data.frame(table(dm$Date, dm$status))
names(dm.table) <- c("Date","status","Count")
dm.table$Year <- format(as.Date(dm.table$Date, format="%Y-%m-%d"), "%Y")
dm.table$Month <- format(as.Date(dm.table$Date, format="%Y-%m-%d"), "%m")
dm.climate <- merge(dm.table, season, by.x = "Year", by.y = "Prev12")

dm.season$Month <- format(as.Date(dm.season$Date, format="%Y-%m-%d"), "%m")

dm.climate.narm <- dm.climate[!is.na(dm.climate$status),]
dm.season.narm <- dm.season[!is.na(dm.season$status),]


ggplot(dm.climate.narm, aes(as.factor(Year), Count, colour = status))+
  geom_jitter()+
  geom_boxplot()+
  theme_bw()

# What is detected in July in a bad to good year
ggplot(dm.climate.narm[dm.climate.narm$Month == "07" & dm.climate.narm$status != "dead",], aes(as.numeric(Year), Count, colour = status))+
  geom_point()+
  # geom_boxplot()+
  theme_bw()+
  stat_smooth(method="lm")

# What is detected throughout the year in a bad to good year
ggplot(dm.climate.narm[dm.climate.narm$status != "dead",], aes(as.numeric(Year), Count, colour = status))+
  geom_point()+
  # geom_boxplot()+
  theme_bw()+
  stat_smooth(method="lm")

# proportions
ggplot(dm.season.narm[dm.season.narm$Month == "07" & dm.season.narm$status != "dead",], aes(as.numeric(Year),  fill = status))+
  geom_bar()+
  # geom_boxplot()+
  theme_bw()
```
In a bad year, there are many that are dormant in July, In a good year, about half are dormant in July that are above ground some other time during the year    
```{r}
dormJuly2014 <- table(dm.season.narm$status[dm.season.narm$Month=="07"],dm.season.narm$Year[dm.season.narm$Month=="07"])[2,1] # Dormant in 2014
dormJuly2015 <- table(dm.season.narm$status[dm.season.narm$Month=="07"],dm.season.narm$Year[dm.season.narm$Month=="07"])[2,2] # Dormant in 2015

totalAGGandDorm <- colSums(table(dm.season.narm$status[dm.season.narm$Month=="07" & dm.season.narm$status != "dead"],
              dm.season.narm$Year[dm.season.narm$Month=="07"& dm.season.narm$status != "dead"])) # AGG in either year and dormant

# binomial distribution of dormant or above ground 
# Poisson distribution of interval that the stage is greater than 2 throughout the year when dormant in July if 1=dead, 2=dormant, 3= seedling, 4=vegetative, and 5=reproductive  
# or binomial for each stage: dormant or dead; dormant or vegetative; dormant or reproductive given a good or bad year


# probability of dormant being AGG other time during the year in a bad year  
# Give the probability that a dormant plant is something else during the year

# The chance of being dormant each of the possible years (ignore the first and last) in July The probabilty that a plant will be dormant study length-2 or less of the time is...
pbinom(length(1995:currentyr)-2, size=length(1995:currentyr), 
       prob= 1-(dormJuly2014/totalAGGandDorm[1])) # 71% were dormant in July 2014 that were alive some other time so reduce this by that probability, they weren't prolonged dormant, just in July
pbinom(length(1995:currentyr)-2, size=length(1995:currentyr), 
       prob = 1-(dormJuly2015/totalAGGandDorm[2])) # 13% were dormant in July 2015 of all that were alive

#probability that a plant was dormant for length-2 times becomes: ???
dbinom(length(1995:currentyr)-2, size=length(1995:currentyr), prob= dormJuly2014/totalAGGandDorm[1])  # 5.7%
dbinom(length(1995:currentyr)-2, size=length(1995:currentyr), prob = dormJuly2015/totalAGGandDorm[2]) # 1.6e^-12%

# probability that each trial that was dormant was actually something else, some AGG
dbinom(length(1995:currentyr)-2, size=length(1995:currentyr), prob= 1-(dormJuly2014/totalAGGandDorm[1]))  # ca 0
dbinom(length(1995:currentyr)-2, size=length(1995:currentyr), prob = 1-(dormJuly2015/totalAGGandDorm[2])) # 5.5%

dbinom(length(1995:currentyr)-3, size=length(1995:currentyr), prob= 1-(dormJuly2014/totalAGGandDorm[1]))  # ca 0
dbinom(length(1995:currentyr)-3, size=length(1995:currentyr), prob = 1-(dormJuly2015/totalAGGandDorm[2])) # 5.5%

chanceofprolongeddorm <- do.call(rbind,lapply(2:(length(1995:currentyr)-2), function(x){
  good <- dbinom(length(1995:currentyr)-x, size=length(1995:currentyr), prob= 1-(dormJuly2014/totalAGGandDorm[1]))
  bad <- dbinom(length(1995:currentyr)-x, size=length(1995:currentyr), prob = 1-(dormJuly2015/totalAGGandDorm[2]))
  data.frame(YrsDorm = length(1995:currentyr)-x, good, bad)
}))


ggplot(chanceofprolongeddorm)+
  geom_point(aes(YrsDorm,good), colour = "green")+
  geom_point(aes(YrsDorm,bad), colour = "black")+
  theme_bw()
```

Or with those probabilies, change the status of each year for all individuals  
```{r}
# add error  Now I want Poisson or assign with probablity of other stage when in dormant  
# proportionally asaign to other   
surveys <- unique(dm.season.narm$Survey)
surveys <- data.frame(surveys, SurvNum = 1:18)
surveys$surveys <- as.character(surveys$surveys)
dm.season.narm$Survey <- as.character(dm.season.narm$Survey)
dm.season.narm.m <- merge(dm.season.narm, surveys, by.x = "Survey", by.y = "surveys")

# .x are time t and .y are t+1; maybe more times when still marked seedling even though not new in that survey?
dm.season.narm.stagefate <- subset(merge(dm.season.narm.m, dm.season.narm.m, by = "UniqueID", sort = FALSE),
                              SurvNum.x == SurvNum.y-1)

# table(rows, columns)  
table(Fate = dm.season.narm.stagefate$status.y, Stage = dm.season.narm.stagefate$status.x)
transtable <- table(Fate = dm.season.narm.stagefate$status.y, Stage = dm.season.narm.stagefate$status.x)
transtable[4,2] # dormancy when a seedling
transtable[3,2] # dormancy and then still reproductive
transtable[5,2] # dormancy and then vegetative
sum(transtable[2:5,2]) # All the dormants that are still alive in the next transition

levels(asmi.1$status) # "seedling"     "vegetative"   "reproductive" "dormant"      "dead"  is 1:5

# The probablily of the next transition but not the biggest it gets
testfoo <- sample(c("seedling","vegetative","reproductive","dormant" ),10, replace=TRUE,
       prob=c(transtable[4,2]/sum(transtable[2:5,2]),
              transtable[5,2]/sum(transtable[2:5,2]),
              transtable[3,2]/sum(transtable[2:5,2]),
              transtable[2,2]/sum(transtable[2:5,2])))


dorms.error <- do.call(rbind,lapply(split(asmi.1, asmi.1$AsMi_tag_id), function(x){
  x$status[x$status == "dormant"] <- sample(c("seedling","vegetative","reproductive","dormant" ),
                                            nrow(x[x$status == "dormant",]), replace=TRUE,
                                            prob=c(transtable[4,2]/sum(transtable[2:5,2]),
                                                   transtable[5,2]/sum(transtable[2:5,2]),
                                                   transtable[3,2]/sum(transtable[2:5,2]),
                                                   transtable[2,2]/sum(transtable[2:5,2])))
  dormlns <- rle(as.numeric(x$status))$lengths[rle(as.numeric(x$status))$values==4]
  out <- data.frame(Tag=rep(unique(x$AsMi_tag_id), length(dormlns)),dorms=dormlns)
  out
}))


ggplot(dorms.error, aes(dorms))+
  geom_histogram(bins = 20)+
  theme_bw()+
  ylab("Frequency")+
  xlab("Consecutive years dormant")

```

```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/Fig4_witherror.jpg", sep = ""),
         units = "mm", res = 300, height = 150, width = 180)
 
hist(dorms.error$dorms, xlim=c(0,24),  col = rgb(0,0,0,0.5), breaks = 20,
     ylab = "Frequency", xlab = "Consecutive years dormant", main = "")
hist(dorms$dorms, add=TRUE, col = rgb(0,0,1,0.5), breaks = 20)

dev.off()
```





#Tags with growth at any time during the early or late seasons 
```{r}
tagsintrayear <- split(dm, dm$tag)
unique(dm$Survey) #aprl 2014 ... Oct6_2015

tagsintrayear[[2]]


dm$TagperPlot <- paste(dm$tag,dm$Plot,sep="_") #dm$Dir, 
asmi.raw$TagperPlot <- paste(asmi.raw$tag_no,asmi.raw$AsMi_plot_id,sep="_") #asmi.raw$direction,

head(dm)
head(table(dm$TagperPlot))

#Add rows for dm for dates when the plant wasn't seen
tagsbydate <- data.frame(table(dm$TagperPlot, dm$Date))
sort(rowSums(table(dm$TagperPlot, dm$Date))) #all were seen at least once
tagsbydate[tagsbydate$Freq==1,]
notalive2014July <- tagsbydate[tagsbydate$Var2 == "2014-07-15" & tagsbydate$Freq == 0,]
notalive2015July <- tagsbydate[tagsbydate$Var2 == "2015-07-22" & tagsbydate$Freq == 0,]



ggplot(dm[dm$TagperPlot %in% notalive2015July$Var1,], 
       aes(Date,Ln, colour=TagperPlot))+
  geom_point()+
  geom_line()+
  facet_wrap(~Site)+
  theme(legend.position = "none")

ggplot(asmi.raw[asmi.raw$TagperPlot %in% notalive2015July$Var1,],
       aes(year,length, colour=TagperPlot))+
  geom_point()+
  geom_line()+
  labs(title="Individuals with growth sometime other than July 2015")+
  facet_wrap(~AsMi_site_id)+
  theme(legend.position = "none")

#The number of individuals that were alive sometime in 2015, just not the July census
table(asmi.raw$AsMi_site_id[asmi.raw$TagperPlot %in% notalive2015July$Var1],
      asmi.raw$year[asmi.raw$TagperPlot %in% notalive2015July$Var1])

#The number of individuals that were alive sometime in 2014, just not the July census
table(asmi.raw$AsMi_site_id[asmi.raw$TagperPlot %in% notalive2014July$Var1],
      asmi.raw$year[asmi.raw$TagperPlot %in% notalive2014July$Var1])


head(asmi.raw)
head(table(asmi.raw$TagperPlot),100)


ggplot(dm[dm$Date<"2015-01-01",], aes(Date,Ln,group=as.factor(Plot), 
                                      colour=as.factor(Plot)))+
  geom_point()+
  geom_smooth(se=FALSE)+
  theme_bw()

str(dm)

# Only rows refering to cotyledons
dm.coty <- dm[grep("coty",dm$Comment),]
dm.aprcoty <- dm[dm$AprSeedlings==1,]
# dm.coty <- rbind(dm.coty,dm.aprcoty)
dm.coty$Comment <- droplevels(dm.coty$Comment)
table(dm.coty$Comment)

# Don't want
c("cotyledon of non","no cotyledons")

# dm.coty <- dm.coty[!grepl("cotyledon of non",dm.coty$Comment),]
dm.coty <- dm.coty[!grepl("no cotyledon",dm.coty$Comment),]


ggplot(dm.coty, aes(Date,Ln,colour=as.factor(Date)))+
  geom_boxplot()

table(dm$Comment[grep("coty",dm$Comment)],dm$Site[grep("coty",dm$Comment)])
```



```{r}
head(asmi.raw$TagperPlot)
head(asmi.raw)
head(dm)

table(dm$Date)
table(dm$Survey)

dm[grep("coty", dm$Comment),]

tagsAGG <- unique(dm$tag[dm$Ln >0])
length(tagsAGG)
tagsAGG2 <- unique(dm$TagperPlot[dm$Ln >0])
length(tagsAGG2)

unique(asmi.raw$AsMi_tag_id)

head(asmi.raw)
tagsperplotperyear <- lapply( split(asmi.raw, asmi.raw$year), function(x){
  out <- data.frame(table(x$tag_no,x$AsMi_plot_id))
  out[out[,3]>1,]
  })

oopstags <- do.call(rbind,tagsperplotperyear)
oopstags

sort(unique(asmi.raw$year))

#how many double tags per plot were ones seen in intrayear surveys?  
#Need to link by tag number, plot, and distance
double.intra.tags <- unique(dm$tag[dm$tag %in% oopstags$Var1])

length(unique(asmi.raw$tag_no)) #2529
length(unique(dm$tag)) #1746

#for 2015, tag entered same, won't get tags 'fixed to 0.01 from 0.1
dm.match.raw <- lapply(1:nrow(dm),function(row){
  out <- asmi.raw[asmi.raw$AsMi_site_id==dm$Site[row]&
                    asmi.raw$AsMi_plot_id==dm$Plot[row]&
                    asmi.raw$distance==dm$Dist..m.[row]&
                                asmi.raw$year==2016,]
  })

dm.all <- do.call(rbind,dm.match.raw)
head(dm.all)

#Just tags with above ground growth in other times of the year
dm.agg <- dm[dm$Ln>0,]
dm.agg.match.raw <- lapply(1:nrow(dm.agg),function(row){
  out <- asmi.raw[asmi.raw$AsMi_site_id==dm.agg$Site[row]&
                    asmi.raw$AsMi_plot_id==dm.agg$Plot[row]&
                    asmi.raw$distance==dm.agg$Dist..m.[row],]
  })

dm.all.agg <- do.call(rbind,dm.agg.match.raw)
head(unique(dm.all.agg))
dm.all.agg <- unique(dm.all.agg)

tags.AGG <- split(dm.all.agg[dm.all.agg$length==0 & dm.all.agg$year>2015,],
                  dm.all.agg$AsMi_tag_id[dm.all.agg$length==0 & dm.all.agg$year>2015])

tags.AGG[[1]]
tags.AGG <- do.call(rbind,tags.AGG)
tags.AGG[tags.AGG$length>0,]




#tags with flowering plants
dm.flfr <- dm[dm$Fl==1,]
dm.flfr.match.raw <- lapply(1:nrow(dm.flfr),function(row){
  out <- asmi.raw[asmi.raw$AsMi_site_id==dm.flfr$Site[row]&
                    asmi.raw$AsMi_plot_id==dm.flfr$Plot[row]&
                    asmi.raw$distance==dm.flfr$Dist..m.[row],]
  })

dm.all.flfr <- do.call(rbind,dm.flfr.match.raw)
head(unique(dm.all.flfr))
dm.all.flfr <- unique(dm.all.flfr)

tags.flfr <- split(dm.all.flfr[dm.all.flfr$length==0 & dm.all.flfr$year>2015,],
                  dm.all.flfr$AsMi_tag_id[dm.all.flfr$length==0 & dm.all.flfr$year>2015])

tags.flfr[[1]]
tags.flfr <- do.call(rbind,tags.flfr)
tags.flfr[tags.flfr$length>0,]



dm[dm$tag %in% double.intra.tags,]
asmi.raw[asmi.raw$tag_no %in% double.intra.tags,]

#For dm, Survey is like year in asmi.raw 
dm.2merge <- dm[,c("X","Plot","Site","Survey","TagperPlot")] #poop, but sometimes these don't match because of a 0.1 or 0.01 difference! 

```


length over the surveys 
```{r}

ggplot(dm, aes(Survey, Ln, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_sdl', geom="errorbar", fun.args = list(mult=2))+
  facet_wrap(~Site, ncol=2)+
  theme_bw()+
  ylab("Average Length")+
  xlab("Survey")+
	theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5)) 

```

```{r}
sites <- unique(dm$Site)
plot(dm$Survey[dm$Site == sites[1]], dm$Ln[dm$Site == sites[1]])
plot(dm$Survey[dm$Site == sites[2]], dm$Ln[dm$Site == sites[2]], add=TRUE ,col="red")
plot(dm$Survey[dm$Site == sites[3]], dm$Ln[dm$Site == sites[3]], add=TRUE ,col="orange")
plot(dm$Survey[dm$Site == sites[4]], dm$Ln[dm$Site == sites[4]], add=TRUE ,col="yellow")
plot(dm$Survey[dm$Site == sites[5]], dm$Ln[dm$Site == sites[5]], add=TRUE ,col="green")
plot(dm$Survey[dm$Site == sites[6]], dm$Ln[dm$Site == sites[6]], add=TRUE ,col="blue")

```

```{r}
stripchart(Ln~Survey+Site,data=dm, 
           method="jitter",vertical=TRUE, col=1:6, pch=16,
           group.names=
             apply(expand.grid(c(paste("Site",1:6,sep="")),c(1:9,1:9)),
                   1, function(x){
                     paste(x[1],x[2])
                   }))

```


#dormancy within a season is preceded or followed by what stage class
```{r}
markrecapture <- dm
markrecapture$Mark <- 0
markrecapture$Mark[markrecapture$Ln>0] <- 1
table(markrecapture$Mark,markrecapture$Survey)

byplant <- sapply(split(markrecapture,markrecapture$UniqueID), function(x){
  table(x$Mark,x$Survey)
  })

byplantall <- do.call(rbind,byplant)
head(byplantall)

markrecapture$Stage <- "D" #dormant #only 4 rows
markrecapture$Stage[markrecapture$Ln > 0] <- "V" #vegetative
markrecapture$Stage[markrecapture$Ln > 0 & markrecapture$Fl == 1] <- "R" #Reproductive

#When you make a table, only a very few are actually marked dead, most are missing data
stagebyplant <- sapply(split(markrecapture, markrecapture$UniqueID), function(x){
  out <- table(x$Stage,x$Survey)
  if(!is.null(names(out[,1]))){
    out[1,][out[1,]==1] <- names(out[,1][1])
    if(length(names(out[,1])>1)){
      out[2,][out[2,]==1] <- names(out[,1][2])
      }
    out
    }
  })

nonullstagebyplant <- stagebyplant[!sapply(stagebyplant,is.null)]
length(which(stagebyplant[[1]][,1]!="0"))
data.frame(nonullstagebyplant[[1]])
str(data.frame(nonullstagebyplant[[1]]))

seqclass <- lapply(nonullstagebyplant, function(x){
  df <- data.frame(x)
  out <- sapply(split(df,df$Var2),function(r){
    if(nrow(r[r$Freq=="0",])==2){
      "0" 
      } else {
        as.character(r$Freq[r$Freq!="0"])
    }
      })
  out
})

seqXclass <- do.call(rbind,seqclass)

nrow(seqXclass)
##how many individuals were dormant some portion of the surveys?
seasonallydorm <- lapply(1:nrow(seqXclass),function(x){
    # if the first and last are removed from rle and there's still some lengths of dormant
    teststages <- rle(seqXclass[x,])
    teststages <- data.frame(teststages$lengths,teststages$values,tag=x)
    teststages <- teststages[-c(1,nrow(teststages)),]
    out <- teststages[teststages$teststages.values=="0",]
    out 
})

foo <- do.call(rbind,seasonallydorm)
length(unique(foo$tag))

#What is the stage before and after dormancy?
b4nafter <- lapply(1:nrow(seqXclass),function(x){
    # if the first and last are removed from rle and there's still some lengths of dormant
    teststages <- rle(seqXclass[x,])
    teststages <- data.frame(teststages$lengths,teststages$values,tag=x)
    teststages <- teststages[-c(1,nrow(teststages)),]
    before <- teststages[grep("0",teststages$teststages.values)-1,]
    after <- teststages[grep("0",teststages$teststages.values)+1,]
    out <- list(before,after)
    out
})

b4 <- do.call(rbind,lapply(b4nafter,"[[",1))
b4 <- b4[complete.cases(b4),]
aft3r <- do.call(rbind,lapply(b4nafter,"[[",2))
aft3r <- aft3r[complete.cases(aft3r),]

mean(nrow(b4[b4$teststages.values=="V",])/nrow(b4))
mean(nrow(b4[b4$teststages.values=="R",])/nrow(b4))

mean(nrow(aft3r[aft3r$teststages.values=="V",])/nrow(aft3r))
mean(nrow(aft3r[aft3r$teststages.values=="R",])/nrow(aft3r))


##Factor w/ 4 levels "0","D","R","V":
#percent of time goes from Vegetative to dormant
byplantbefore <- lapply(split(b4, b4$tag), function(x){
  nrow(x[x$teststages.values=="V",])/
    nrow(x)

})


nrow(beforeandafterstage[beforeandafterstage$outbefore=="R",])/
  nrow(beforeandafterstage)

```


Total AGG per plot per year
```{r}

#dm is any tags with some length at some point

dm$Fr <- as.numeric(dm$Fr)
dm$Fl[is.na(dm$Fl)] <- 0
dm$Fr[is.na(dm$Fr)] <- 0

#levels(dm$Site) <- gsub("Cebolla Mid", "1", levels(dm$Site))
#levels(dm$Site) <- gsub("Cebolla North", "2",levels(dm$Site))

surveys <- unique(dm$Survey)
surveys[1:9]
surveys[10:18]

dm.2014 <- dm[dm$Survey %in% surveys[1:9],]
dm.2015 <- dm[dm$Survey %in% surveys[10:18],]


sum.agg.2014 <- lapply(split(dm.2014,dm.2014$Site), function(y){
  out <- lapply(split(y,y$Survey), function(x){
     c(PercentAGG = length(unique(x$tag[x$Ln>0]))/length(unique(y$tag)),
    PercentFl = length(unique(x$tag[x$Fl == 1]))/length(unique(y$tag)),
    PercentBr = length(unique(x$tag))/length(unique(y$tag)),
    TotalFr = sum(x$Fr),
    PercentFr = length(unique(x$tag[x$Fr> 0]))/length(unique(y$tag)),
    Site = unique(y$Site),
    Survey = unique(x$Survey))
  })
  do.call(rbind,out)
})
sum.agg.2014[[1]]

sum.agg.2015 <- lapply(split(dm.2015,dm.2015$Site), function(y){
  out <- lapply(split(y,y$Survey), function(x){
     c(PercentAGG = length(unique(x$tag[x$Ln>0]))/length(unique(y$tag)),
    PercentFl = length(unique(x$tag[x$Fl == 1]))/length(unique(y$tag)),
    PercentBr = length(unique(x$tag))/length(unique(y$tag)),
    TotalFr = sum(x$Fr),
    PercentFr = length(unique(x$tag[x$Fr> 0]))/length(unique(y$tag)),
    Site = unique(y$Site),
    Survey = unique(x$Survey))
  })
  do.call(rbind,out)
})
sum.agg.2015[[1]]

all.summary14 <- do.call(rbind, sum.agg.2014)
all.summary15 <- do.call(rbind, sum.agg.2015)
all.summary <- data.frame(rbind(all.summary14,all.summary15))
all.summary <- all.summary[all.summary$PercentAGG>0,]

all.sum.mean <- tapply(all.summary$PercentAGG, all.summary$Survey, function(x) mean(x, rm.na=TRUE))
```

```{r}
plot(all.summary$Survey, all.summary$PercentAGG, pch=16, las=2,xlab="",ylab="Percent")
points(all.summary$Survey, all.summary$PercentFl,col="red")


stripchart(PercentAGG~Survey,data=all.summary, pch=16, method="jitter",
           vertical=TRUE, col="grey")
points(1:18,all.sum.mean, col="red", pch=4, cex=1.2)
abline(v=9.5)
```
```{r}

dm[grep("2015",dm$Survey),]

all.fl.mean <- tapply(all.summary$PercentFl, all.summary$Survey, function(x) mean(x,na.rm=TRUE))
when.fr <- tapply(all.summary$PercentFr, all.summary$Survey, function(x) mean(x,na.rm=TRUE))

stripchart(PercentFl~Survey,data=all.summary, pch=16, method="jitter",
           vertical=TRUE, col="grey")
points(1:18,all.fl.mean, col="red", pch=4, cex=1.2)
points(1:18,when.fr, col="purple", pch=16)

abline(v=9.5)

```


```{r}
sum.agg <- aggregate(dm$X, dm[,c("Plot","Site","Survey")],
          FUN = function(x){
            length(x)
          })

plotnum <- aggregate(dm$Plot, dm[,c("Site","Survey")],
                     FUN = function(x){
                       length(unique(x))
                     })

# Some Site 5 plot have no plants
plotnum$x[plotnum$Site == "5"] <- 5

# One Site 15 plot has no plants
plotnum$x[plotnum$Site == "15"] <- 4
```

```{r}
ggplot(sum.agg, aes(Survey, x, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
 # stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Average AGG per plot")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
  geom_text(data=plotnum, aes(label=x, y=-1, x=Survey, size = 0.9))+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")
  
```

```{r}

## Need percent of total indivduals seen each survey period (per year)
AGG14 <- dm[grep("2014",dm$Survey),]
# reset factor levels
AGG14$Survey <- factor(AGG14$Survey)

AGG15 <- dm[grep("2015",dm$Survey),]
AGG15$Survey <- factor(AGG15$Survey)


#or should it be the number that match? 
intersect(unique(AGG14$X[AGG14$Ln>0 & AGG14$Plot == "606" & AGG14$Survey == "Aprl_2014"]),
unique(AGG14$X[AGG14$Ln>0 & 
       AGG14$Plot == "606"]))/length(unique(AGG14$X[AGG14$Ln>0 & AGG14$Plot == "606"]))

AGGpersurvey.14 <- lapply(unique(AGG14$Plot), function(x){
  sapply(unique(AGG14$Survey), function(y){
    length(intersect(unique(AGG14$X[AGG14$Ln>0 & AGG14$Plot == x &AGG14$Survey == y]),
    unique(AGG14$X[AGG14$Ln>0 & 
                   AGG14$Plot == x])))/length(unique(AGG14$X[AGG14$Ln>0&AGG14$Plot == x]))
  })
})

AGGpersurvey.14[2]
```

```{r}

names(AGGpersurvey.14) <- unique(AGG14$Plot)

AGGper <- do.call(rbind,AGGpersurvey.14)
AGGper <- data.frame(AGGper)
names(AGGper) <- unique(AGG14$Survey)
AGGper <- data.frame(Plot=rownames(AGGper),AGGper)
AGGpSurvey <- reshape(AGGper, direction="long", varying = list(names(AGGper)[-1]),
                      v.names="AGG",
                      idvar="Plot",
                      timevar="Survey",
                      times=names(AGGper)[-1])


AGGpSurvey <- merge(AGGpSurvey,AGG14[,c("Plot","Site")],by = "Plot")
AGGpSurvey$Survey <- factor(AGGpSurvey$Survey, levels = unique(AGG14$Survey))
names(AGGpSurvey)
str(AGGpSurvey)
AGGpSurvey <- AGGpSurvey[AGGpSurvey$AGG!=0,]
```


Figure 6:  (b) The percent of Astragalus microcymbus individuals with AGG at each survey from the total individuals with AGG during the 2014 season. (c) Total number of Astragalus microcymbus individuals per stage class as a percent of the total observed throughout the season.  
```{r}
ggplot(AGGpSurvey, aes(Survey, AGG, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar',fun.args = list(mult=1))+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Percent of total AGG over the year per survey")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")+
  scale_y_continuous(labels = percent)


```


```{r}
AGGpersurvey.15 <- lapply(unique(AGG15$Plot), function(x){
  sapply(unique(AGG15$Survey), function(y){
    length(intersect(unique(AGG15$X[AGG15$Ln>0 & 
                         AGG15$Plot == x & 
                         AGG15$Survey == y]),
           unique(AGG15$X[AGG15$Ln>0 & AGG15$Plot == x])))/length(unique(AGG15$X[AGG15$Ln>0 & 
                                                               AGG15$Plot == x]))
  })
})

names(AGGpersurvey.15) <- unique(AGG15$Plot)


AGGper15 <- do.call(rbind,AGGpersurvey.15)
AGGper15 <- data.frame(AGGper15)
names(AGGper15) <- grep("2015", unique(dm$Survey), value = TRUE)
AGGper15 <- data.frame(Plot=rownames(AGGper15),AGGper15)
AGGpSurvey15 <- reshape(AGGper15, direction="long", varying = list(names(AGGper15)[-1]),
                      v.names="AGG",
                      idvar="Plot",
                      timevar="Survey",
                      times=names(AGGper15)[-1])

AGGpSurvey15 <- merge(AGGpSurvey15,dm[,c("Plot","Site")], by = "Plot")
tail(AGGpSurvey15)
```

```{r}
ggplot(AGGpSurvey15[AGGpSurvey15$AGG>0,], aes(Survey, AGG, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Percent of total AGG over the year per survey")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
#  geom_text(data=plotnum, aes(label=x, y=1, x=Survey, size = 0.9))+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")+
  scale_y_continuous(labels = percent)


```


In 2015, on average across sites in South Beaver Creek and Cebolla Creek...   
```{r}
AGGAnyTime15 <- ddply(AGG15, .(Site,Plot), summarise,
                      TUP = length(unique(tag[Ln>0])))

AGGAnyTimeSite15 <- ddply(AGG15, .(Site), summarise,
                      UP = length(unique(tag[Ln>0])))
AGGEachTime15 <- ddply(AGG15, .(Site,Plot,Survey), summarise,
                      UP = length(unique(tag[Ln>0])))

AGGmerge15 <- merge(AGGAnyTime15, AGGEachTime15, by = c("Site","Plot"))
```

Percent of total unique individuals seen over course of the growing season
```{r}
mean(AGGmerge15$UP[AGGmerge15$Survey =="June2_2015"]/AGGmerge15$TUP[AGGmerge15$Survey =="June2_2015"], na.rm = TRUE)

# Both South Beaver Creek and Cebolla Creek
mean(AGGmerge15$UP[AGGmerge15$Survey =="July_2015"]/AGGmerge15$TUP[AGGmerge15$Survey =="July_2015"], na.rm = TRUE)

std.error(AGGmerge15$UP[AGGmerge15$Survey =="July_2015"]/AGGmerge15$TUP[AGGmerge15$Survey =="July_2015"], na.rm = TRUE)

# ONly Cebolla Creek
mean(AGGmerge15$UP[AGGmerge15$Survey =="July_2015" & AGGmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), AGGmerge15$Site, value = TRUE)]/AGGmerge15$TUP[AGGmerge15$Survey =="July_2015"& AGGmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), AGGmerge15$Site, value = TRUE)], na.rm = TRUE)

std.error(AGGmerge15$UP[AGGmerge15$Survey =="July_2015" & AGGmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), AGGmerge15$Site, value = TRUE)]/AGGmerge15$TUP[AGGmerge15$Survey =="July_2015"& AGGmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), AGGmerge15$Site, value = TRUE)], na.rm = TRUE)

# ONly South beaver Creek
mean(AGGmerge15$UP[AGGmerge15$Survey =="July_2015" & AGGmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), AGGmerge15$Site, value = TRUE)]/AGGmerge15$TUP[AGGmerge15$Survey =="July_2015"& AGGmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), AGGmerge15$Site, value = TRUE)], na.rm = TRUE)

std.error(AGGmerge15$UP[AGGmerge15$Survey =="July_2015" & AGGmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), AGGmerge15$Site, value = TRUE)]/AGGmerge15$TUP[AGGmerge15$Survey =="July_2015"& AGGmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), AGGmerge15$Site, value = TRUE)], na.rm = TRUE)

```

## This is correct for 6b   
TUP = Total unique plants per plot over 2015   
UP = unique plants per plot per survey in 2015
```{r Figure 6(b)}
ggplot(AGGmerge15, aes(Survey, UP/TUP)) +
  stat_summary(fun.y = mean, geom = 'point') +
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1)) +
	facet_grid(~Site) +
	ylab('Percent of total AGG per plot over the growing season') +
	xlab("") +
	theme_bw() + 
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5)) +
  scale_y_continuous(labels = percent)

```


```{r intraanual seedlings}
head(dm)
dm.15 <- dm[grep("2015",dm$Survey),]
dm.15$Survey <- factor(dm.15$Survey)

coty.seeds <- ddply(dm.15[grep("coty", dm.15$Comment),],
                   .(Plot, Site), summarise,
                   tag = unique(tag))

head(coty.seeds)
tags.seed <- merge(dm.15, coty.seeds, by = c("Site","Plot","tag"))
```


# Seedlings only in 2015
```{r}
ggplot(tags.seed, aes(Survey, Ln, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~Site)+
  theme_bw()+
  xlab("Average Length")+
    theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5)) 


```

# how many seedlings up in each survey compared to all seedlings all year    
```{r}
aggregate(tag~Survey, function(x) length(unique(x)), data = tags.seed)

# how many had cotyledons in July? None I think
aggregate(tag~Survey, function(x) length(unique(x)), data = dm.15[grep("coty", dm.15$Comment),])

seedanytime15 <-  ddply(tags.seed, .(Site,Plot), summarise,
                      TUP = length(unique(tag[Ln>0])))
seedeachtime15 <- ddply(tags.seed, .(Site,Plot,Survey), summarise,
                      UP = length(unique(tag[Ln>0])))

seedmerge15 <- merge(seedanytime15, seedeachtime15, by = c("Site","Plot"))

mean(seedmerge15$UP[seedmerge15$Survey =="June2_2015"]/seedmerge15$TUP[seedmerge15$Survey =="June2_2015"], na.rm = TRUE)

# Both South Beaver Creek and Cebolla Creek
mean(seedmerge15$UP[seedmerge15$Survey =="July_2015"]/seedmerge15$TUP[seedmerge15$Survey =="July_2015"], na.rm = TRUE)

std.error(seedmerge15$UP[seedmerge15$Survey =="July_2015"]/seedmerge15$TUP[seedmerge15$Survey =="July_2015"], na.rm = TRUE)

# ONly Cebolla Creek
mean(seedmerge15$UP[seedmerge15$Survey =="July_2015" & seedmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), seedmerge15$Site, value = TRUE)]/seedmerge15$TUP[seedmerge15$Survey =="July_2015"& seedmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), seedmerge15$Site, value = TRUE)], na.rm = TRUE)

std.error(seedmerge15$UP[seedmerge15$Survey =="July_2015" & seedmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), seedmerge15$Site, value = TRUE)]/seedmerge15$TUP[seedmerge15$Survey =="July_2015"& seedmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), seedmerge15$Site, value = TRUE)], na.rm = TRUE)

# ONly South beaver Creek
mean(seedmerge15$UP[seedmerge15$Survey =="July_2015" & seedmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), seedmerge15$Site, value = TRUE)]/seedmerge15$TUP[seedmerge15$Survey =="July_2015"& seedmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), seedmerge15$Site, value = TRUE)], na.rm = TRUE)

std.error(seedmerge15$UP[seedmerge15$Survey =="July_2015" & seedmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), seedmerge15$Site, value = TRUE)]/seedmerge15$TUP[seedmerge15$Survey =="July_2015"& seedmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), seedmerge15$Site, value = TRUE)], na.rm = TRUE)
```


```{r}
AGG14$Ln[grep("Basal", AGG14$Comment)] <- 0.25
AGG14 <- AGG14[AGG14$Ln != 0,]

agg14 <- lapply(split(AGG14, list(AGG14$Plot,AGG14$Site)),
                   function(x){
                     sapply(unique(x$Survey), function(y){
                       nrow(x[x$Survey == y,])/nrow(x)
                       })
                   })

length(agg14[23][[1]])

length(agg14[23]$"607.5")
# agg14[vapply(agg14, function(x) dim(x)[1] > 1, NA)]
#Filter(function(x) dim(x)[1] > 1, agg14)
agg14[!unlist(lapply(agg14, is.null))]

names(agg14) <- 
do.call(rbind,agg14[agg14[[1]] > 1])
```


##Figure 6    
Don't worry about the same plant being up, when are the most plants with AGG
```{r}
rm(AGGpersurvey.14)
AGGpersurvey.14 <- lapply(unique(AGG14$Plot), function(x){
  sapply(unique(AGG14$Survey), function(y){
    length(AGG14$X[AGG14$Ln>0 & 
                     AGG14$Plot == x & 
                     AGG14$Survey == y])/length(AGG14$X[AGG14$Ln>0 &
                                                          AGG14$Plot == x])
           })
  })

names(AGGpersurvey.14) <- unique(AGG14$Plot)
AGGper <- do.call(rbind,AGGpersurvey.14)
AGGper <- data.frame(AGGper)
names(AGGper) <- unique(AGG14$Survey)
AGGper <- data.frame(Plot=rownames(AGGper),AGGper)
siteplot <- data.frame(table(AGG14$Plot, AGG14$Site))
siteplot <- siteplot[siteplot$Freq > 0,]
names(siteplot) <- c("Plot","Site","Freq")

AGGpSurvey <- reshape(AGGper, direction="long", varying = list(names(AGGper)[-1]),
                      v.names="AGG",
                      idvar="Plot",
                      timevar="Survey",
                      times=names(AGGper)[-1])

AGGpSurvey <- merge(AGGpSurvey,siteplot,by = "Plot")
AGGpSurvey$Survey <- factor(AGGpSurvey$Survey, levels = unique(AGG14$Survey))
```

```{r}
ggplot(AGGpSurvey[AGGpSurvey$AGG > 0,], aes(Survey, AGG, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Percent of total AGG over the year per survey")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
#  geom_text(data=plotnum, aes(label=x, y=1, x=Survey, size = 0.9))+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")+
  scale_y_continuous(labels = percent)


```

```{r}
rm(AGGpersurvey.15)
AGGpersurvey.15 <- lapply(unique(AGG15$Plot), function(x){
  sapply(unique(AGG15$Survey), function(y){
    length(AGG15$X[AGG15$Ln>0 & 
                     AGG15$Plot == x & 
                     AGG15$Survey == y])/length(AGG15$X[AGG15$Ln>0 &
                                                          AGG15$Plot == x])
           })
  })

names(AGGpersurvey.15) <- unique(AGG15$Plot)
AGGper.15 <- do.call(rbind,AGGpersurvey.15)
AGGper.15 <- data.frame(AGGper.15)
names(AGGper.15) <- unique(AGG15$Survey)
AGGper.15 <- data.frame(Plot=rownames(AGGper.15),AGGper.15)

AGGpSurvey.15 <- reshape(AGGper.15, direction="long", varying = list(names(AGGper.15)[-1]),
                      v.names="AGG",
                      idvar="Plot",
                      timevar="Survey",
                      times=names(AGGper.15)[-1])

AGGpSurvey.15 <- merge(AGGpSurvey.15,siteplot,by = "Plot")
AGGpSurvey.15$Survey <- factor(AGGpSurvey.15$Survey, levels = unique(AGG15$Survey))
```

```{r}
ggplot(AGGpSurvey.15[AGGpSurvey.15$AGG > 0,], aes(Survey, AGG, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Percent of total AGG over the year per survey")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
#  geom_text(data=plotnum, aes(label=x, y=1, x=Survey, size = 0.9))+
#  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")+
  scale_y_continuous(labels = percent)


```

figure 6c
```{r}
# set status
head(dm)
dm$status <- "dead"
dm$status[dm$Ln > 0 & dm$Fl == 0] <- "vegetative"
dm$status[dm$Ln > 0 & dm$Fl == 1] <- "reproductive"

table(dm$status,dm$Survey)

#One case says 'no cotyledons'
#Seedlings in 2014
dm.14 <- dm[grep("2014",dm$Survey),]
dm.14$Survey <- factor(dm.14$Survey)

coty.seeds14 <- ddply(dm.14[grep("coty", dm.14$Comment),],
                   .(Plot, Site), summarise,
                   tag = unique(tag))

head(coty.seeds14)
tags.seed14 <- merge(dm.14, coty.seeds14, by = c("Site","Plot","tag"))

#Seedlings in 2015
dm.15 <- dm[grep("2015",dm$Survey),]
dm.15$Survey <- factor(dm.15$Survey)

coty.seeds15 <- ddply(dm.15[grep("coty", dm.15$Comment),],
                   .(Plot, Site), summarise,
                   tag = unique(tag))

head(coty.seeds15)
tags.seed15 <- merge(dm.15, coty.seeds15, by = c("Site","Plot","tag"))
tags.seedall <- rbind(tags.seed14, tags.seed15)

table(dm$Comment)
unique(dm$Comment[grep("coty", dm$Comment)])
dm$Comment[grep("no coty", dm$Comment)] <- "Cotyledons "
seedlings <- dm[grep("coty", dm$Comment),] 
seedlings$Comment <- factor(seedlings$Comment)
table(seedlings$Comment, seedlings$Ln)

table(tags.seedall$status)
tags.seedall[tags.seedall$status == "reproductive",]
dm[dm$tag == 273 & dm$Site == 26,]


ggplot(tags.seed15, aes(Survey, Ln, group = Site))+
  stat_summary(fun.y = mean, geom="point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~Site)


#Set seedling status to tags that we saw cotyledons in 2014 or 2015


# one seedling became reproductive after germinating in 2015
dm$status[dm$Ln > 0 & dm$Fl == 1] <- "reproductive"

#dormant would have an existing tag and length at a later time
length(unique(dm$tag[dm$status == "dead"]))

dm$status <- factor(dm$status, levels = c("seedling","vegetative","reproductive","dormant","dead"))


unique.season <- ddply(dm, .(Site, Plot, status), summarise,
                       UniqueNumAGG = length(unique(X[Ln >0])))

#unique.season <- lapply(split(dm, dm[,c("Site","Plot","status")]), function(x){
#  if(nrow(x) > 0){
#    cbind(x[1,c("Site","Plot","status")], num = nrow(x))
#    }
#})
# Filter(function(x) dim(x)[1] > 0, unique.season)

unique.season

number.time <- ddply(dm, .(Site, Plot, Survey, status), summarise,
                     NumAGG = length(unique(X[Ln >0])))

merge.num.season <- merge(unique.season, number.time, by = c("Site","Plot","status"))

merge.num.season$Percent <- merge.num.season$NumAGG/merge.num.season$UniqueNumAGG

ggplot(merge.num.season, aes(status, Percent, colour = status)) +
  geom_boxplot() +
  theme_bw() +
	facet_grid(~ Survey)+
	ylab("Percent of total") +
	theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust = 0))+
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))+
  scale_y_continuous(labels = percent)

```

July census     
Size of seedlings in July, are all less than 10cm, can we use that as metric for future annual measurements?    
Becky's comment: "For the july census can we say that all seedlings were less than 10 cm and all re-emerging plants are greater than 10cm? I.e., can we use these data to have a cut off for the July census..kind of like we do with Scgl for reproductive vs non-reproductive? If so then we could use this to back track and re-assess all prior years data and also use it going forward with just the July census."

```{r}
unique(merge.num.season$Survey)
aggregate(Percent~Survey+status, mean, data = merge.num.season)

head(dm)
aggregate(Ln~Survey+status, mean, data = dm)

head(tags.seed15)
aggregate(Ln~Survey+status, mean, data = tags.seed15) #aaaahhh, lengths for dead??
aggregate(Ln~Survey+status, max, data = tags.seed15) #aaaahhh, lengths for dead??

#try again to classify seedlings for the whole year even if they become reproductive later
head(tags.seedall) # all tags with coty seed at some point in that year, 2014, or within 2015
aggregate(Ln~Survey, mean, data = tags.seedall) # July 5.6cm
aggregate(Ln~Survey, max, data = tags.seedall)

ggplot(aggregate(Ln~Survey, mean, data = tags.seedall), aes(Survey, Ln)) +
  geom_point() 

ggplot(aggregate(Ln~Survey, max, data = tags.seedall), aes(Survey, Ln)) +
  geom_point() 
```


```{r learned from intra, eval=FALSE}
dm$SurveyNum <- as.numeric(dm$Survey)
dm$tag[dm$status == "seedling"]

tags <- ddply(dm, .(status), summarise,
              Tags = unique(tag))

tags.plot <- tags$Tags[tags$status == "seedling"]

tags.seed <- merge(dm, data.frame(tag = tags.plot), by = "tag")

# For the most part stayed under 10cm if saw cotyledons
ggplot(tags.seed, aes(Survey, Ln, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~Site)+
  theme_bw()+
  xlab("Average Length")+
    theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5)) 

ggplot(tags.seed, aes(Survey, Ln, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~status)+
  theme_bw()+
  xlab("Average Length")+
    theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5)) 


dm.pva <- subset(merge(dm, dm, by = c("Site","Plot","X")), SurveyNum.x == SurveyNum.y - 1)


```


Figure for Becky annual report 01232018
```{r}
alive.byyear <- aggregate(length~year, data=alive[alive$AsMi_site_id>3,],
                          FUN= sum)

ggsave("Q:/Research/MEDL_folder/AsMi_yr.jpg",device="jpeg",
ggplot(alive.byyear, aes(year,length))+
  geom_line(colour="blue")+
  ggtitle("Astragalus microcymbus")+
  theme_classic()+
  ylab("Total Population"))
  
write.csv(alive.byyear,"Q:/Research/MEDL_folder/AsMi_yr.csv")

```

# Indivdiuals, density at Cebolla from demography compared to point-in-time counts   
```{r}
circleplots <- pi*(3^2)

pit1.north <- 441
pit2.north <- 987

densepit1.north <- 68/pit1.north
densepit2.north <- 114/pit2.north

mean(densepit1.north,densepit2.north) # 0.154 indv/sq meter

densecebolla <- 40/circleplots

AGG.CC <- aggregate(Total.Alive ~ Site + Year, ps.asmi[ps.asmi$Site<3 & ps.asmi$Year>2013,],
                    function(x) mean(x))
averageAGG <- aggregate(Total.Alive ~ Site, AGG.CC, function(x) mean(x))
averageAGG$Total.Alive/circleplots

aggregate(Total.Alive~Creek+Year, ps.asmi, function(x) sum(x))

```

# Annual percent of AGG+Dormant in 1996 (Year 2) compared to now, by plot (so compared to second year of plots that were added)   
```{r}
AGG.pplot <- aggregate(Total.Plants ~ Site + Plot + Creek + Year, ps.asmi, function(x) sum(x))
AGG.pplot$PercentPlants <- as.numeric(NA)
#Cebolla should all be from 2015, added in 2014
AGG.pplot$PercentPlants[AGG.pplot$Site<3 & AGG.pplot$Year>2015] <-
  AGG.pplot$Total.Plants[AGG.pplot$Site<3 & AGG.pplot$Year>2015]/
  AGG.pplot$Total.Plants[AGG.pplot$Site<3 & AGG.pplot$Year==2015]

# Do all ignoring that plot 238 and 300 need to be updated to having 1997 as the second year and 598 having 2005 as its second year
'%ni%' <- Negate('%in%')
originalplots <- sort(unique(ps.asmi$Plot))
originalplots <- originalplots[originalplots %ni% c(238,300,598)]
AGG.pplot$PercentPlants[AGG.pplot$Site>2 & AGG.pplot$Year>1996 & AGG.pplot$Plot %in% originalplots] <-
  AGG.pplot$Total.Plants[AGG.pplot$Site>2 & AGG.pplot$Year>1996 & AGG.pplot$Plot %in% originalplots]/
  AGG.pplot$Total.Plants[AGG.pplot$Site>2 & AGG.pplot$Year==1996 & AGG.pplot$Plot %in% originalplots]

# 1996 added plots
AGG.pplot$PercentPlants[AGG.pplot$Site>2 & AGG.pplot$Year>1997 & AGG.pplot$Plot %in% c(238,300)] <-
  AGG.pplot$Total.Plants[AGG.pplot$Site>2 & AGG.pplot$Year>1997 & AGG.pplot$Plot %in% c(238,300)]/
  AGG.pplot$Total.Plants[AGG.pplot$Site>2 & AGG.pplot$Year==1997 & AGG.pplot$Plot %in% c(238,300)]

# 2004 addition
AGG.pplot$PercentPlants[AGG.pplot$Site>2 & AGG.pplot$Year>2005 & AGG.pplot$Plot %in% c(598)] <-
  AGG.pplot$Total.Plants[AGG.pplot$Site>2 & AGG.pplot$Year>2005 & AGG.pplot$Plot %in% c(598)]/
  AGG.pplot$Total.Plants[AGG.pplot$Site>2 & AGG.pplot$Year==2005 & AGG.pplot$Plot %in% c(598)]

ggplot(aggregate(PercentPlants ~ Site + Year, AGG.pplot, function(x) mean(x, na.rm=TRUE)),
       aes(Year, PercentPlants, colour=as.factor(Site), shape=as.factor(Site)))+
  geom_point()+
  geom_line()+
  theme_bw()

ggplot(aggregate(PercentPlants ~ Creek + Year, AGG.pplot, function(x) mean(x, na.rm=TRUE)),
       aes(Year, PercentPlants, colour=as.factor(Creek), shape=as.factor(Creek)))+
  geom_point()+
  geom_line()+
  theme_bw()
```

# Annual percent of AGG in 1995 (first year) compared to year, by plot (so compared to second year of plots that were added)   
```{r}
AGG.pplot$Total.Alive <- aggregate(Total.Alive ~ Site + Plot + Creek + Year, ps.asmi, function(x) sum(x))$Total.Alive
AGG.pplot$PercentAlive95 <- as.numeric(NA)
#Cebolla should all be from 2015
AGG.pplot$PercentAlive95[AGG.pplot$Site<3 & AGG.pplot$Year>2014] <-
  AGG.pplot$Total.Alive[AGG.pplot$Site<3 & AGG.pplot$Year>2014]/
  AGG.pplot$Total.Alive[AGG.pplot$Site<3 & AGG.pplot$Year==2014]

# Do all ignoring that plot 238 and 300 need to be updated to having 1997 as the second year and 598 having 2005 as its second year
AGG.pplot$PercentAlive95[AGG.pplot$Site>2 & AGG.pplot$Year>1995& AGG.pplot$Plot %in% originalplots] <-
  AGG.pplot$Total.Alive[AGG.pplot$Site>2 & AGG.pplot$Year>1995& AGG.pplot$Plot %in% originalplots]/
  AGG.pplot$Total.Alive[AGG.pplot$Site>2 & AGG.pplot$Year==1995& AGG.pplot$Plot %in% originalplots]

# 1996 added plots
AGG.pplot$PercentAlive95[AGG.pplot$Site>2 & AGG.pplot$Year>1996 & AGG.pplot$Plot %in% c(238,300)] <-
  AGG.pplot$Total.Alive[AGG.pplot$Site>2 & AGG.pplot$Year>1996 & AGG.pplot$Plot %in% c(238,300)]/
  AGG.pplot$Total.Alive[AGG.pplot$Site>2 & AGG.pplot$Year==1996 & AGG.pplot$Plot %in% c(238,300)]

# 2004 addition
AGG.pplot$PercentAlive95[AGG.pplot$Site>2 & AGG.pplot$Year>2004 & AGG.pplot$Plot %in% c(598)] <-
  AGG.pplot$Total.Alive[AGG.pplot$Site>2 & AGG.pplot$Year>2004 & AGG.pplot$Plot %in% c(598)]/
  AGG.pplot$Total.Alive[AGG.pplot$Site>2 & AGG.pplot$Year==2004 & AGG.pplot$Plot %in% c(598)]

ggplot(aggregate(PercentAlive95 ~ Site + Year, AGG.pplot, function(x) mean(x, na.rm=TRUE)), 
       aes(Year, PercentAlive95, colour=as.factor(Site), shape = as.factor(Site)))+
  geom_point()+
  geom_line()+
  theme_bw()

plotfenced <- unique(ps.asmi$Plot[ps.asmi$Fence=="y"])

aggregate(PercentAlive95 ~ Site + Year, AGG.pplot[AGG.pplot$Plot %in% plotfenced,], function(x) mean(x, na.rm=TRUE))
```

# Annual percent of AGG in 1996 compared to each year, by plot (so compared to second year of plots that were added)   
```{r}
# AGG.pplot <- aggregate(Total.Alive ~ Site + Plot + Creek + Year, ps.asmi, function(x) sum(x))
AGG.pplot$PercentAlive96 <- as.numeric(NA)
#Cebolla should all be from 2015
AGG.pplot$PercentAlive96[AGG.pplot$Site<3 & AGG.pplot$Year>2015] <-
  AGG.pplot$Total.Alive[AGG.pplot$Site<3 & AGG.pplot$Year>2015]/
  AGG.pplot$Total.Alive[AGG.pplot$Site<3 & AGG.pplot$Year==2015]

# Do all ignoring that plot 238 and 300 need to be updated to having 1997 as the second year and 598 having 2005 as its second year
AGG.pplot$PercentAlive96[AGG.pplot$Site>2 & AGG.pplot$Year>1996& AGG.pplot$Plot %in% originalplots] <-
  AGG.pplot$Total.Alive[AGG.pplot$Site>2 & AGG.pplot$Year>1996& AGG.pplot$Plot %in% originalplots]/
  AGG.pplot$Total.Alive[AGG.pplot$Site>2 & AGG.pplot$Year==1996& AGG.pplot$Plot %in% originalplots]

# 1996 added plots
AGG.pplot$PercentAlive96[AGG.pplot$Site>2 & AGG.pplot$Year>1997 & AGG.pplot$Plot %in% c(238,300)] <-
  AGG.pplot$Total.Alive[AGG.pplot$Site>2 & AGG.pplot$Year>1997 & AGG.pplot$Plot %in% c(238,300)]/
  AGG.pplot$Total.Alive[AGG.pplot$Site>2 & AGG.pplot$Year==1997 & AGG.pplot$Plot %in% c(238,300)]

# 2004 addition
AGG.pplot$PercentAlive96[AGG.pplot$Site>2 & AGG.pplot$Year>2005 & AGG.pplot$Plot %in% c(598)] <-
  AGG.pplot$Total.Alive[AGG.pplot$Site>2 & AGG.pplot$Year>2005 & AGG.pplot$Plot %in% c(598)]/
  AGG.pplot$Total.Alive[AGG.pplot$Site>2 & AGG.pplot$Year==2005 & AGG.pplot$Plot %in% c(598)]

ggplot(aggregate(PercentAlive96 ~ Site + Year, AGG.pplot, function(x) mean(x, na.rm=TRUE)), 
       aes(Year, PercentAlive96, colour=as.factor(Site), shape = as.factor(Site)))+
  geom_point()+
  geom_line()+
  theme_bw()

aggregate(PercentAlive96 ~ Plot + Year, AGG.pplot, function(x) x)$PercentAlive96

aggregate(PercentAlive96 ~ Creek + Year, AGG.pplot, function(x) mean(x, na.rm=TRUE))
```

Results: Density (AGG)
```{r}

popsizes <- aggregate(Total.Alive ~ Site + Creek + Fence + Year, ps.asmi, function(x) mean(x, na.rm=TRUE))

popsizes[popsizes$Site==5,]

plot(popsizes$Year[popsizes$Site==5],popsizes$Total.Alive[popsizes$Site==5], pch=rep(c("n","y"),24))
abline(h=0)

popsizes$Total.Alive[popsizes$Site==5 & popsizes$Year==currentyr]/popsizes$Total.Alive[popsizes$Site==5 & popsizes$Year==1995]

popsizes$Total.Alive[popsizes$Site==15 & popsizes$Year==currentyr]/popsizes$Total.Alive[popsizes$Site==15 & popsizes$Year==1995]

popsizes$Total.Alive[popsizes$Site==19 & popsizes$Year==currentyr]/popsizes$Total.Alive[popsizes$Site==19 & popsizes$Year==1995]

popsizes$Total.Alive[popsizes$Site==26 & popsizes$Year==currentyr]/popsizes$Total.Alive[popsizes$Site==26 & popsizes$Year==1995]
```

Results: Fruit
```{r}
reproductive <- aggregate(X..Flowered.1 ~ Site + Year, ps.asmi, function(x) sum(x, na.rm=TRUE))

reproductive[reproductive$X..Flowered.1==0,]
rowSums(table(reproductive$Site, reproductive$Year))
length(1995:2018)

rowSums(table(reproductive$Site, reproductive$Year))[3:6]/length(1995:currentyr)

# Years with no reproduction
length(1995:currentyr)-rowSums(table(reproductive$Site, reproductive$Year))[3:6]
mean(length(1995:currentyr)-rowSums(table(reproductive$Site, reproductive$Year))[3:6])

# Percent of years that are reproductive
mean(rowSums(table(reproductive$Site, reproductive$Year))[3:6]/length(1995:currentyr))
```

Results: herbivory
```{r}
# Herbivory by insects (removing Unknown)
sum(table(asmi.raw$Browsing...Status)[c(1,3)])/sum(table(asmi.raw$Browsing...Status)[-5])


# Herbivory by mammals (removing Unknown)
sum(table(asmi.raw$Browsing...Status)[c(2,3)])/sum(table(asmi.raw$Browsing...Status)[-5])


table(asmi.raw$Browsing...Status)[-5]/sum(table(asmi.raw$Browsing...Status)[-5])

ps.cor2 <- merge(ps.cor, season, by.x = c("Site", "Year.y"), by.y = c("Site","Prev12"))

lm1 <- lm(Total.Alivelogtransformed.y ~ X..Browsed.x, ps.cor)
lm2 <- lm(Total.Alivelogtransformed.y ~ X..Floweredlogtransformed.x, ps.cor)
lm3 <- lm(Total.Alivelogtransformed.y ~ Total.Alivelogtransformed.x, ps.cor) 
lm4 <- lm(Total.Alivelogtransformed.y ~ X..Browsed.x*Fence.x, ps.cor)
lm5 <- lm(Total.Alivelogtransformed.y ~ 1, ps.cor)
lm6 <- lm(Total.Alivelogtransformed.y ~ X..Browsed.y, ps.cor)

lm7 <- lm(Total.Alivelogtransformed.y ~ Total.Alivelogtransformed.x *X..Browsed.x , ps.cor) 

lm.list <- list(lm1,lm2, lm3, lm4, lm5, lm6, lm7)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

lm1 <- lm(Total.Alivelogtransformed.y ~ X..Browsed.x, ps.cor)
lm2 <- lm(Total.Alivelogtransformed.y ~ X..Floweredlogtransformed.x, ps.cor)
lm3 <- lm(Total.Alivelogtransformed.y ~ Total.Alivelogtransformed.x, ps.cor) 
lm4 <- lm(Total.Alivelogtransformed.y ~ X..Browsed.x*Fence.x, ps.cor)
lm5 <- lm(Total.Alivelogtransformed.y ~ 1, ps.cor)
lm6 <- lm(Total.Alivelogtransformed.y ~ X..Browsed.y, ps.cor)

lm7 <- lm(Total.Alivelogtransformed.y ~ Total.Alivelogtransformed.x *X..Browsed.x , ps.cor) 

lm.list <- list(lm1,lm2, lm3, lm4, lm5, lm6, lm7)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}
```

Discussion: percent of dormant indivdiuals
```{r}

ps.asmi$PercentDorm <- ps.asmi$X..Dormant/sum(ps.asmi$Total.Alive,ps.asmi$Total.Plants, na.rm=TRUE)  
aggregate(PercentDorm~Year, ps.asmi, function(x) mean(x, na.rm=TRUE))  
```


# Integral Projection Models    
Janeiro et al. 2017 Towards robust evolutionary...
Rees et al. 2014 Constructing IPMs when more than one census is available (Appendix S4) and others and the main paper, Building integral projeciton models: a user's guide

# Mark-recapture
<http://www.montana.edu/rotella/documents/502/lab07RMark.html>    
Laake and Rexstad 2008
Alexander et al. 2009 Detection, survival rates...
Chen et al. 2009 Factors affecting detection...
MacKenzie et al. 2009 Modeling species occurrence dynamics...
Kellner and Swihart 2014 Accounting for Imperfect detection...
Chandler et al. 2018 Estimating recruitment from capture-recapture data...
Mark-recapture   
```{r}

library(RMark)

# Convert dataset into capture histories  
head(asmi.raw)
table(asmi.raw$AsMi_tag_id[asmi.raw$length>0],asmi.raw$year[asmi.raw$length>0])


```

Autoregressive and moveing average modeling method   (Liu and Guo 2019)   
     find the order p and q of the ARMA(p,q) from the autocorrelation and parial correlation coefficient 
     Can find the time domain and frequency domain of data
     Should be able to figure out the current priodic mast seeding and then model if it increases or decreases, the impact on future growth of AsMi    
     tailing means that either ACF or PACF
does not approach to 0 at each lag order, and truncation on
order p and q means ACF and PACF   
Fruit is episodic, mast seeding, would make sense to add a sin and/or cos wave to the fit    
```{r}
library(astsa)

head(asmi.raw)
ps.ts <- aggregate(Total.Fruitlogtransformed.x~Year.x, data=ps.cor, sum)
asmi.raw.ts <- aggregate(fruit~year+AsMi_site_id, data=asmi.raw, sum)

co2 <- ts(ps.ts$Total.Fruitlogtransformed.x, frequency = 1, start = c(1995,1))
plot(co2, xlab="Year", ylab = "Fruit")

co25 <- ts(asmi.raw.ts$fruit[asmi.raw.ts$AsMi_site_id==5], frequency=1, start=c(1995,1))
plot(co25, xlab="Year", ylab = "Fruit")

co215 <- ts(asmi.raw.ts$fruit[asmi.raw.ts$AsMi_site_id==15], frequency=1, start=c(1995,1))
plot(co215, xlab="Year", ylab = "Fruit")


co219 <- ts(asmi.raw.ts$fruit[asmi.raw.ts$AsMi_site_id==19], frequency=1, start=c(1995,1))
plot(co219, xlab="Year", ylab = "Fruit")

co226 <- ts(asmi.raw.ts$fruit[asmi.raw.ts$AsMi_site_id==26], frequency=1, start=c(1995,1))
plot(co226, xlab="Year", ylab = "Fruit")

co21 <- ts(asmi.raw.ts$fruit[asmi.raw.ts$AsMi_site_id==1], frequency=1, start=c(2014,1))
co2_2 <- ts(asmi.raw.ts$fruit[asmi.raw.ts$AsMi_site_id==2], frequency=1, start=c(2014,1))


plot(co25, xlab="Year", ylab = "Fruit", ylim=c(0,15050))
lines(co215, col="red")
lines(co219, col="cyan")
lines(co226, col="blue")
lines(co21, col="orange")
lines(co2_2, col="green")

```

```{r}


```


Steps for model order selection   
     1. residual vaiogram   
     2. order determination using F test   
     3. order estimation with AIC and BIC   
     4. Parameter estimations with moment estimation and least square and maximum likelihood estimation    
      
      
Low order moment estimation can be solved directly, high order obtained using linear iterative or Newton-Raphson method. 

Autoregressive AR(p)
Moving average MA(q)
ARMA(p,q)      
arima() estimates underlying mean of time series unless d?0
x_t = mu + rho(x_t-1 - mu) + white noise  

```{r}


```


Simulate stationary processes  
```{r}
## ARMA(2,2) description for arim.sim()
ARMA22 <- list(order=c(2,0,2), ar=c(-0.7,0.2), ma=c(0.7,0.2))
## mean of process
mu <- 5
## simulated process (+ mean) , big sample size
ARMA.sim <- arima.sim(n=10000, model=ARMA22) + mu
## estimate parameters
arima(x=ARMA.sim, order=c(2,0,2))
```

<https://nwfsc-timeseries.github.io/atsa-labs/chap-tslab.html#data-and-packages-1> 
```{r}
# library(devtools)
# devtools::install_github("nwfsc-timeseries/atsalibrary")

```

<https://www.itl.nist.gov/div898/handbook/pmc/section4/pmc44a.htm>    
```{r}
# R commands and output:

## Read the data and save as a time series object.
table = read.table("G_SERIES.DAT", skip=25)
vec = ts(table)

## Load the necessary libraries.
library(stats)
library(lawstat)

## Plot the data print summary statistics.
par(mfrow=c(1,1), cex=1.2)
plot(1:length(vec),vec, type="o", pch=18, col="blue",
     xlab = "Observation", ylab="Series G")
print(summary(vec))

## Take natural log of original series and plot the results.
lvec = log(vec)
par(mfrow=c(1,1), cex=1.2)
plot(1:length(vec),lvec, type="o", pch=18, col="red",
	xlab = "Observation", ylab="ln(Series G)")

## Take first differences of transformed series to remove trend 
## and plot the transformed and differenced data.
fd = diff(lvec)
par(mfrow=c(1,1), cex=1.2)
plot(fd, type="o", pch=18,  col="darkblue",
	xlab = "Observation", ylab="Differenced ln(Series G)")

## Compute the autocorrelation of the transformed and differenced series.
ac <- acf(fd, type = c("correlation"), lag.max=36, main="Autocorrelation of Series G")

## Print ACF for first 36 lags.
round(c(ac$acf),4)

##>  [1]  1.0000  0.1998 -0.1201 -0.1508 -0.3221 -0.0840  0.0258 -0.1110 -0.3367
##> [10] -0.1156 -0.1093  0.2059  0.8414  0.2151 -0.1396 -0.1160 -0.2789 -0.0517
##> [19]  0.0125 -0.1144 -0.3372 -0.1074 -0.0752  0.1995  0.7369  0.1973 -0.1239
##> [28] -0.1027 -0.2110 -0.0654  0.0157 -0.1154 -0.2893 -0.1269 -0.0407  0.1474
##> [37]  0.6574

## Plot the ACF with 95 % confidence limits.
par(mfrow=c(1,1), cex=1.2)
plot(ac, ci=.95, ci.type="ma", main="ACF with 95 % Confidence Limits",
     ylim=c(-1,1))

##  Take seasonal differences of the transformed and differenced series.
sfd = diff(fd, lag=12)

## Plot final time series.
par(mfrow=c(1,1), cex=1.2)
plot(sfd, type="o", pch=18,  col="red", xlab = "Observation", 
     ylab="Seasonal and First Differenced ln(Series G)")

## Compute autocorrelation of final series.
sac = acf(sfd, type = c("correlation"), lag.max=36, 
           main="Autocorrelation of Series G")

## Plot the ACF of differenced series with 95 % confidence limits.
par(mfrow=c(1,1), cex=1.2)
plot(sac, ci=.95, ci.type="ma", main="ACF with 95 % Confidence Limits",
     ylim = c(-1,1))

## Fit a MA model to original series.  The arima function will 
## perform the necessary differences.
ma = arima(log(vec), order = c(0, 1, 1), 
            seasonal=list(order=c(0,1,1), period=12))
ma

##> Call:
##> arima(x = log(vec), order = c(0, 1, 1), seasonal = list(order = c(0, 1, 1), 
##>     period = 12))

##> Coefficients:
##>           ma1     sma1
##>       -0.4018  -0.5569
##> s.e.   0.0896   0.0731

##> sigma^2 estimated as 0.001348:  log likelihood = 244.7,  aic = -483.4

## Use the Box-Ljung test to determine if the residuals are 
## random up to 30 lags.
BT = Box.test(ma$residuals, lag=30, type = "Ljung-Box", fitdf=2)
BT

##>         Box-Ljung test
##> 
##> data:  ma$residuals 
##> X-squared = 29.4935, df = 30, p-value = 0.3878

## Although the output indicates that the degrees of freedom for 
## the test are 30, the p-value is based on df-fitdf = 30-2 = 28.
1-pchisq(29.4935,28)

##> [1] 0.3878282

## Determine critical region.
qchisq(0.95,28)

##> [1] 41.33714

## Generate predictions of 12 future values.
p = predict(ma,12)

## Compute 90% confidence intervals for each prediction
## and convert back to original units.
L90 = exp(p$pred - 1.645*p$se)
U90 = exp(p$pred + 1.645*p$se)

## Generate forecasts in original units.  To avoid under-predicting,
## the forecasts are adjusted to account for log transformation.
Forecast = exp(p$pred + ma$sigma2/2)

## Print the forecast results.
Period = c((length(vec)+1):(length(vec)+12))
df = data.frame(Period,L90,Forecast,U90)
print(df,row.names=FALSE)

##>   Period      L90 Forecast      U90
##>      145 424.0234 450.7261 478.4649
##>      146 396.7861 426.0042 456.7577
##>      147 442.5731 479.3298 518.4399
##>      148 451.3902 492.7365 537.1454
##>      149 463.3034 509.3982 559.3245
##>      150 527.3754 583.7383 645.2544
##>      151 601.9371 670.4625 745.7830
##>      152 595.7602 667.5274 746.9323
##>      153 495.7137 558.5657 628.5389
##>      154 439.1900 497.5430 562.8899
##>      155 377.7598 430.1618 489.1730
##>      156 417.3149 477.5643 545.7760

## Plot last 36 observations and the predictions with confidence limits.
par(mfrow=c(1,1), cex=1.2)
plot(c(108:144),table[108:144],xlim=c(108,160),ylim=c(300,800), type="o",
     ylab="Series G", xlab="Observation", col="black",
     main="12 Forecasts and 90% Confidence Intervals")
points(Forecast, pch=16, col="blue")
lines(c(145:156), L90, col="red")
lines(c(145:156), U90, col="red")

```


# Add error and variance to dormancy
# change dormant to reproductive, seedling???, or vegetative in a given year based on climate   
```{r}
# relationship of climate and likelyhood of being stage given climate; ppt.springSummer best descriptor of status in July
season




```





<https://blogs.oracle.com/datascience/introduction-to-forecasting-with-arima-in-r> 

<https://www.analyticsvidhya.com/blog/2015/12/complete-tutorial-time-series-modeling/>

How to pick the values of p, q, and d
<https://stats.stackexchange.com/questions/10750/arma-modeling-in-r>

ARIMA <https://machinelearningmastery.com/gentle-introduction-box-jenkins-method-time-series-forecasting/> forecasting time series data    

Powerpoint for ARIMA <http://www.ghahramani.ca/uploads/1/7/0/4/17042208/box-jenkins-r-seminar.pdf> 
<https://ncss-wpengine.netdna-ssl.com/wp-content/themes/ncss/pdf/Procedures/NCSS/The_Box-Jenkins_Method.pdf>

<https://datascienceplus.com/time-series-analysis-using-arima-model-in-r/> 

