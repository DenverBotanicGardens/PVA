---
title: "AsMi_annual report"
author: "Michelle DePrenger-Levin"
date: "Tuesday, October 27, 2015"
output: html_document
---
The git remote is "AsMiPVA"
AsMiPVA

```{r}
library(reshape2)
library(ggplot2)
library(psych)
library(popbio)
library(devtools)
library(sciplot)
library(plotrix)
library(scales)
library(plyr)
library(devtools)
library(digest)
library(RCurl)
# install_github(repo = "prism", username = "ropensci")
library(prism)
library(rgdal)
library(raster)
library(Rmisc)
# library(data.table)
# install.packages('survminer')
# library(survminer)

library(car) # line 381


# A ggplot plot layout function 
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  numPlots = length(plots)
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }
 if (numPlots==1) {
    print(plots[[1]])
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

Remove all variables, keep functions
```{r reset values, eval = FALSE}
rm(list = setdiff(ls(), lsf.str()))
```

summarySE function borrowed from http://www.cookbook-r.com/Manipulating_data/Summarizing_data/  
Function for t.tests, for annual lambdas
```{r}

# StagePVA_Function.R
script <- getURL("https://raw.githubusercontent.com/DenverBotanicGardens/PVA/master/StagePVA_Function.R",ssl.verifypeer = FALSE)
eval(parse(text = script))


# ### Function for lambda and 
# requires library(popbio)    
# x is the list of matrices, i.e. notfenced.Site.matrix$"26",     
# 					or fenced.Site.matrix$"19"[2:17])    
# y is the start year    
# z is the start of the last transition

lmdSD <- function(x,y,z){
  
  startyr <- min(as.numeric(names(x)))
	yrs <- startyr:z
	st <- match(c(y,z),yrs)
	
	lambdaAll <- c()
	for(i in c(y:z)){
		lambdaAll <- cbind(lambdaAll,eigen.analysis(x[[as.character(i)]])$lambda)
	}	
	StandDev <- sqrt(var(c(lambdaAll)))	#Standard Deviation
	cbind(lmda = lambda(mean(x[st[1]:st[2]])),SD = StandDev)
}	

lmdAn <- function(x,y,z){
  yrs <- 1995:z
	st <- match(c(y,z),yrs)
	
	lambdaAll <- c()
	for(i in c(y:z)){
		lambdaAll <- cbind(lambdaAll,eigen.analysis(x[[as.character(i)]])$lambda)
	}	
	lambdaAll
}
```


# Download raw_data 
<https://research.botanicgardens.org/admin/demographics/asmi/reports/raw_data.php>   
Save all sites, all data, and set to 20 years allowed dormant (or all possible years)    
Put the new data in folder currentyr_asmi and name it RawData_currentyr 
```{r}
currentyr <- as.numeric(format(as.Date(Sys.Date(),format="%Y-%m-%d"), "%Y"))
rawdatapath <- paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/", 
                     currentyr,"_asmi/RawData_",
                     currentyr, ".csv", collapse = '', sep = '')

asmi.raw <- read.csv(path.expand(rawdatapath), na.strings = "na")

# No longer adding climate data to the database
asmi.raw <- asmi.raw[,grep(paste(c("Temp","Rain","Snow","Aug.Jul"),collapse="|"), names(asmi.raw),
                           value = TRUE, invert = TRUE)]

table(asmi.raw$year, asmi.raw$AsMi_site_id)
table(asmi.raw$year, asmi.raw$AsMi_plot_id)
table(asmi.raw$Browsing...Status)
#asmi.raw <- transform(asmi.raw, year = as.numeric(year))

table(asmi.raw$AsMi_plot_id,asmi.raw$AsMi_site_id)

# one blank row at the end of the csv download
asmi.raw[asmi.raw$status == "",]
asmi.raw <- asmi.raw[asmi.raw$status != "",]
asmi.raw$status <- factor(asmi.raw$status)
table(asmi.raw$status)

#reset factors of browsing to eliminate " "
asmi.raw$Browsing...Status[asmi.raw$Browsing...Status == "mammal"] <- "Mammal"
asmi.raw$Browsing...Status <- factor(asmi.raw$Browsing...Status)

#reset factors for fence
asmi.raw$fence <- factor(asmi.raw$fence)
table(asmi.raw$fence)

asmi.raw[asmi.raw$length>90 & !is.na(asmi.raw$length),] 
asmi.raw$length[asmi.raw$length == 921] <- 21

asmi.raw[asmi.raw$status=="vegetative" & asmi.raw$fruit>0,]
wrongAsMidataid <- asmi.raw$AsMi_data_id[asmi.raw$status=="vegetative" & asmi.raw$fruit>0]
asmi.raw$flower[asmi.raw$AsMi_data_id %in% wrongAsMidataid] <- 1
asmi.raw$status[asmi.raw$AsMi_data_id %in% wrongAsMidataid] <- "reproductive"
asmi.raw[asmi.raw$AsMi_data_id %in% wrongAsMidataid,]
```

Table 1:Demographic data of Astragalus microcymbus within the South Beaver Creek and Cebolla Creek drainages near Gunnison, Colorado. (a) Average number of individuals with above ground growth (AGG) followed by total individuals (AGG and dormant) per plot. (b) Percent of reproductive individuals followed by average reproductive individuals per plot. Site 1 is Cebolla Creek Mid and site 2 is Cebolla Creek north. Standard errors are shown in parentheses.
```{r}
#AGG
alive <-aggregate(length ~ AsMi_plot_id + year + AsMi_site_id + fence, 
                  data = asmi.raw, function(x) length(x[x>0 & !is.na(x)])) #length of group when the plant had a length greater than zero


alive2 <- do.call(rbind, lapply(split(asmi.raw, list(asmi.raw$AsMi_plot_id,asmi.raw$year)), 
                                function(x){
                                  if(nrow(x)==0){
                                    out <- c(Plot=NA,Year=NA,Site=NA,Fence=NA,AGG=NA,Alive=NA)
                                    out
                                  } else {
                                  AGG <- nrow(x[x$length>0,])
                                  Alive <- length(x$status[x$status!="dead"])
                                  out <- data.frame(Plot = unique(x$AsMi_plot_id),
                                                    Year = unique(x$year),
                                                    Site = unique(x$AsMi_site_id),
                                                    Fence = unique(x$fence),
                                                    AGG, Alive)
                                  out}
                                  }))

alive2<- alive2[complete.cases(alive2),]

totalyr <- aggregate(length~AsMi_site_id, data = alive[alive$year == currentyr,], sum)
sum(totalyr$length[1:2])
sum(totalyr$length[3:6])

# What percent of original size are all plots?
totalPerOriginal <- lapply(split(alive2,alive2$Plot),
                                  function(plot){
                                    first <- plot$AGG[plot$Year==min(plot$Year)]
                                    last <- plot$AGG[plot$Year==max(plot$Year)]
                                    percent <- last/first
                                    out <- data.frame(plot[plot$Year==min(plot$Year),],
                                                      plot[plot$Year==max(plot$Year),
                                                           c("Year","AGG","Alive")],
                                                      percent)
                                    out
                                    })
totPOrig <- do.call(rbind,totalPerOriginal)

outdata <- (aggregate(percent~Site+Fence, data=totPOrig, mean))
outdata[with(outdata, order(percent,Site,Fence)),]


#AGG and dormant
aggdorm <- aggregate(status ~ AsMi_plot_id +year + AsMi_site_id  + fence,
                     data = asmi.raw, function(x) length(x[x != "dead" & !is.na(x)]))


ggplot(alive, aes(year, length, colour=as.factor(AsMi_site_id)))+
#  geom_point()+
  stat_smooth(se=FALSE)+
  ylab("Individuals per plot")+
  xlab("Year")+
  theme_bw()+
  scale_color_manual("Sites",labels = c("Cebolla Mid", 
                                          "Cebolla North",
                                          "5","15","19","26"),
                     values = c("cyan", "darkblue",
                                "olivedrab","olivedrab1",
                                "mediumseagreen","mistyrose3"))


table(alive$AsMi_site_id, alive$length)
asmi.raw[asmi.raw$length>90 & !is.na(asmi.raw$length),] # Plot 238, tag 925, Ln '921' -> 21??



table(alive$AsMi_site_id, alive$year) # 2 is cebolla north, 1 is mid
```

#Fluctuations  
```{r}

#AGG
alive.site <-aggregate(length ~ year + AsMi_site_id + fence, 
                  data = asmi.raw, function(x) length(x[x>0 & !is.na(x)]))

#AGG and dormant
aggdorm.site <- aggregate(status ~ year + AsMi_site_id  + fence,
                     data = asmi.raw, function(x) length(x[x != "dead" & !is.na(x)]))


PercentAlive <- lapply(split(alive.site, alive.site$AsMi_site_id), function(x){
  nofence <- x$length[x$year == max(x$year)&
                        x$fence=="n"]/x$length[x$year==min(x$year)&x$fence=="n"]
  fence <- x$length[x$year == max(x$year)&
                      x$fence=="y"]/x$length[x$year==min(x$year)&x$fence=="y"]
  cbind(nofence,fence)

  })

```



```{r}
tbl1a.1 <- summarySE(alive, measurevar="length", groupvars=c("AsMi_site_id", "year"))

tbl1a.2 <- summarySE(aggdorm, measurevar="status", groupvars=c("AsMi_site_id", "year"))

sites <- unique(tbl1a.1$AsMi_site_id)

tbl1.1 <- lapply(sites, function(x){
  paste(round(tbl1a.1[tbl1a.1$AsMi_site_id == x,"length"],2)," (",
        round(tbl1a.1[tbl1a.1$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1.2 <- lapply(sites, function(x){
  paste(round(tbl1a.2[tbl1a.2$AsMi_site_id == x,"status"],2)," (",
        round(tbl1a.2[tbl1a.2$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1a <- lapply(1:6, function(x){
  data.frame(tbl1.1[[x]],tbl1.2[[x]])
  })

savepath <- paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/", 
                     currentyr,"_asmi/", collapse = '', sep = '')

Table1 <- data.frame(tbl1a[[3]],tbl1a[[4]],tbl1a[[5]],tbl1a[[6]])
names(Table1) <- c("Site 05 (5 plots)"," ","Site 15 (4 plots)"," ",
                   "Site 19 (5 plots)"," ","Site 26 (5 plots)"," ")

write.table(Table1, file=paste(savepath,"Table1a_SouthBeaverCreek.csv"), sep=",", row.names=FALSE, col.names = TRUE)

Table1_Cebolla <- data.frame(tbl1a[[1]],tbl1a[[2]])
names(Table1_Cebolla) <- c("Site 1 (5 plots)"," ","Site 2 (6 plots)"," ")

write.table(Table1_Cebolla, file=paste(savepath,"Table1a_CebollaCreek.csv"), sep=",", row.names=FALSE, col.names = TRUE)


# Percent and total preproductive
# precent reproductive, return 0 if no 
prep <- aggregate(flower~AsMi_plot_id+year+AsMi_site_id +fence,
                  data = asmi.raw[asmi.raw$length > 0 & !is.na(asmi.raw$length),],
                  function(x){
                    if(length(x)>0){
                      sum(x,na.rm = TRUE)/length(x)
                    } else {
                        0
                      }
                  })
tbl1b.1 <- summarySE(prep, measurevar="flower", groupvars=c("AsMi_site_id","year"))

#sites above
#percent reproductive 
tbl1.3 <- lapply(sites, function(x){
  paste(round(tbl1b.1[tbl1b.1$AsMi_site_id == x,"flower"],3)*100,"% (",
        round(tbl1b.1[tbl1b.1$AsMi_site_id == x,"se"],3)*100, "%)", sep="")
})

tbl1.3[[3]]

#total reproductive
totrep <- aggregate(flower ~ AsMi_plot_id +year + AsMi_site_id  + fence,
                    data = asmi.raw[asmi.raw$length > 0 & !is.na(asmi.raw$length),], 
                    function(x) sum(x, na.rm = TRUE))


tbl1b.2 <- summarySE(totrep, measurevar="flower",groupvars=c("AsMi_site_id","year"))

tbl1.4 <- lapply(sites, function(x){
  paste(round(tbl1b.2[tbl1b.2$AsMi_site_id == x,"flower"],2)," (",
        round(tbl1b.2[tbl1b.2$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1b <- lapply(1:6, function(x){
  data.frame(tbl1.3[[x]], tbl1.4[[x]])
  })

Table1b <- data.frame(tbl1b[[3]],tbl1b[[4]],tbl1b[[5]],tbl1b[[6]])
names(Table1b) <- c("Site 05 (5 plots)"," ","Site 15 (4 plots)"," ",
                   "Site 19 (5 plots)"," ","Site 26 (5 plots)"," ")

write.table(Table1b, file=paste(savepath,"Table1b_SouthBeaverCreek.csv"), sep=",", row.names=FALSE, col.names = TRUE)

Table1b_Cebolla <- data.frame(tbl1b[[1]],tbl1b[[2]])
names(Table1b_Cebolla) <- c("Site 1 (5 plots)"," ","Site 2 (6 plots)"," ")

write.table(Table1b_Cebolla, file=paste(savepath,"Table1b_CebollaCreek.csv"), sep=",", row.names=FALSE, col.names = TRUE)
```

#Correlated biotic factors

Table 2: Biotic factors correlated among the percent browsed individuals in the current year, density of reproductive individuals in the current year, fruit production in the current year, and the percent of reproductive individuals and above ground growth (AGG) in the current and previous year of Astragalus microcymbus per year (1995-2014) within the South Beaver Creek drainage ....Significant PCC are indicated with an asterisk (p-value < 0.05).  

Plot Summary (weather data is prev. Aug through currrent Jul)   
Total.Plants are AGG and dormant    
Total.Alive is AGG   
X..Flowered must be percent flowered and    
X..Flowered.1 is number flowered

#Save new annual data in folder titled "<current year>_asmi" and name the file "PlotSummary_<current year>"
```{r}
plotdatapath <- paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",currentyr,
                      "_asmi/PlotSummary_",currentyr,".csv",
                      collapse = '', sep = '')
ps.asmi <- read.csv(path.expand(plotdatapath))

ps.asmi$Creek <- "SouthBeaver"
ps.asmi$Creek[ps.asmi$Site < 3] <- "Cebolla" 
ps.asmi$Creek <- as.factor(ps.asmi$Creek)

# Don't need the climate data from database, will download from PRISM
ps.asmi <- ps.asmi[,grep(paste(c("Temp","Rain","Snow","Aug.Jul"),collapse="|"), names(ps.asmi),
                           value = TRUE, invert = TRUE)]

head(ps.asmi)

cors <- c("Total.Alive","X..Browsed","X..Flowered","X..Dormant","Total.Fruit")



```

#log transform
```{r}
#t for transformations!
ps.asmi.t <- ps.asmi


ps.asmi.t <- ps.asmi.t[ps.asmi.t$Site<3 & ps.asmi.t$Year>2013 | ps.asmi.t$Site>4,]

# added plots 238 (site 26) and 300 (site 19) in 1996
# added 598 (site 26) in 2004 
ps.asmi.t <- ps.asmi.t[!(ps.asmi.t$Plot == 238 & ps.asmi.t$Year < 1996),]
ps.asmi.t <- ps.asmi.t[!(ps.asmi.t$Plot == 300 & ps.asmi.t$Year < 1996),]
ps.asmi.t <- ps.asmi.t[!(ps.asmi.t$Plot == 598 & ps.asmi.t$Year < 2004),]

table(ps.asmi.t$Year,ps.asmi.t$Site) #no rows for years when some plots weren't in yet



hist(ps.asmi.t$Total.Alive)
ks.test(ps.asmi.t$Total.Alive, plnorm)

hist(log(ps.asmi.t$Total.Alive+1))
ks.test(log(ps.asmi.t$Total.Alive+1), pnorm)

#log(ps.asmi.t$Total.Alive+1) right skew
scatterplotMatrix(~Total.Alive+log(ps.asmi.t$Total.Alive+1), 
                 diagonal = "qqplot",
                 data=ps.asmi.t,
                 reg.line=FALSE,
                 smoother="")

#Want percent herbivory
ps.asmi.t$Percent..Browsing <- ps.asmi.t$X..Browsed/ps.asmi.t$Total.Alive

ps.asmi.t$Percent..Dormant <-
  (ps.asmi.t$Total.Plants-ps.asmi.t$Total.Alive)/ps.asmi.t$Total.Plants


logtrans <- c("Total.Alive", "Percent..Browsing",
              "X..Flowered.1","X..Flowered","Percent..Dormant","Total.Fruit")
intersect(names(ps.asmi.t),logtrans) #Check that names are right


log.t.cols <- do.call(data.frame,lapply(ps.asmi.t[,logtrans], function(x){ 
  log(x + 1)})) 
  #NA in num flowered
transformed <- sapply(logtrans,function(x) paste(x,"logtransformed",sep=""))

names(log.t.cols) <- transformed
ps.asmi.t <- data.frame(ps.asmi.t,log.t.cols)


#Arcsin sq rt transform percent browsing
assqrt <- do.call(data.frame,lapply(ps.asmi.t["Percent..Browsing"],
                                  function(x) asin(sqrt(x/100))))

names(assqrt) <- "X..Browsedarcsinsqrttransformed"
ps.asmi.t <- data.frame(ps.asmi.t, assqrt)

#Arcsin sq rt transform percent reproductive
assqrt.repro <- do.call(data.frame,lapply(ps.asmi.t["X..Flowered"],
                                  function(x) asin(sqrt(x/100))))

names(assqrt.repro) <- "X..Floweredarcsinsqrttransformed"
ps.asmi.t <- data.frame(ps.asmi.t, assqrt.repro)

scatterplotMatrix(~X..Floweredarcsinsqrttransformed+X..Flowered.1logtransformed+
                    Percent..Dormantlogtransformed+X..Browsedarcsinsqrttransformed, 
                 diagonal = "qqplot",
                 data=ps.asmi.t,
                 reg.line=FALSE,
                 smoother="")

ps.asmi.t$X..Flowered.1logtransformed[is.na(ps.asmi.t$X..Flowered.1logtransformed)] <- 0
ps.asmi.t$Percent..Dormantlogtransformed[is.na(ps.asmi.t$Percent..Dormantlogtransformed)] <- 0
ps.asmi.t$Percent..Browsinglogtransformed[is.na(ps.asmi.t$Percent..Browsinglogtransformed)] <- 0
ps.asmi.t$X..Floweredarcsinsqrttransformed[is.na(ps.asmi.t$X..Floweredarcsinsqrttransformed)] <- 0
ps.asmi.t$X..Browsedarcsinsqrttransformed[is.na(ps.asmi.t$X..Browsedarcsinsqrttransformed)] <- 0

ps.cor <- subset(merge(ps.asmi.t, ps.asmi.t, 
                       by = c("Site","Plot")), Year.x == Year.y - 1)
```

cors =  "Total.Alive" "X..Browsed"  "X..Flowered" "X..Dormant"  "Total.Fruit"    
ps.cor has both previous (.x) = t      
and following year (.y) = t+1
```{r}

forcor <- names(ps.cor[,grep("transformed",names(ps.cor))])[c(1,7:8,3,5:6,
                                                              9,15:16,11,13:14)]
cor.vars <- length(forcor)

cortests <- apply(combn(1:cor.vars,2), 2, function(x){
  cor.df <- ps.cor[,forcor]
  ct <- cor.test(cor.df[,x[1]], cor.df[,x[2]])
  out <- data.frame(Var.1 = names(cor.df)[x[1]], Var.2 = names(cor.df)[x[2]],
                    P.val = ct$p.value, Cor.est = ct$estimate)
})

df.c <- do.call(rbind,cortests)

write.csv(df.c, file=paste(savepath,"Table2_PCC.csv"), row.names=TRUE)

#significant - don't worry about signficant alone or don't report at all
df.c[df.c$P.val > 0.04,]

```



#AIC  Information Criteria   
AIC = -2L + 2k   
  L is loglikelihood   
  k is number of parameters     
Compare all models at the same time, instead of stepping through pairwise comparisons of tests. 
Flawed still, too many factors/parameters, not enough data. 

Just look at differences separating site and not, separate plot or not. 
Can look at these and then work forward to test predictive on new data (like the BLM or sites we visit this year)
```{r}

names(ps.cor) #.x is year t, .y is t+1; Alive is AGG, Plants is AGG+dormant; X..Flowered is percent of alive flowered, X..Flowered.1 is the number of reproductive individuals 
```


```{r}
require(AICcmodavg)
library(lme4)
library(lattice)

lm1 <- lm(Total.Alivelogtransformed.y ~ Year.x, ps.cor)
lm2 <- lm(Total.Alivelogtransformed.y ~ Year.x*as.factor(Site), ps.cor)
lm3 <- lm(Total.Alivelogtransformed.y ~ Year.x*Creek.x, ps.cor) #Need add creek!
lm4 <- lm(Total.Alivelogtransformed.y ~ Year.x*Fence.x, ps.cor)

lm.list <- list(lm1,lm2, lm3, lm4)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))

#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

str(ps.cor)

lmer(Total.Alivelogtransformed.x ~ Year.x|Site, ps.cor)  #random intercept
lmer(Total.Alivelogtransformed.y ~ Year.x|Creek.x, ps.cor)  #random intercept
xyplot(Total.Alive.x ~ Year.x|as.factor(Site), ps.cor,
       type = c("g","p","r"),
       index = function(x,y) coef(lm(y~x))[1],
       xlab = "Year", 
       ylab = "Individuals with AGG", aspect = "xy")

xyplot(Total.Alive.x ~ Year.x|as.factor(Creek.x), ps.cor,
       type = c("g","p","r"),
       index = function(x,y) coef(lm(y~x))[1],
       xlab = "Year", 
       ylab = "Individuals with AGG", aspect = "xy")

```


# don't have first or last year when using ps.cor    
shoud use ps.asmi.t instead
```{r}
lmer(Total.Alivelogtransformed.y ~ Fence.x|Creek.x, ps.cor)  #random intercept
xyplot(Total.Alivelogtransformed.x ~ Fence.x|as.factor(Site), ps.cor,
       type = c("g","p"),
       xlab = "Year", 
       ylab = "Individuals with AGG", aspect = "xy")

xyplot(Total.Alive ~ Year|as.factor(Site), ps.asmi.t[ps.asmi.t$Year > 2013,],
       type = c("g","p","r"),
       index = function(x,y) coef(lm(y~x))[1],
       xlab = "Year", 
       ylab = "Individuals with AGG", aspect = "xy")

#Since fencing put in, just beaver creek
xyplot(Total.Alive ~ Year|Fence, 
       ps.asmi.t[ps.asmi.t$Creek == "SouthBeaver" & ps.asmi.t$Year > 2005,],
       type = c("g","p","r"),
       index = function(x,y) coef(lm(y~x))[1],
       xlab = "Year", 
       ylab = "Individuals with AGG", aspect = "xy")

#both sites since started Cebolla
xyplot(Total.Alive ~ Year|Creek, ps.asmi.t[ps.asmi.t$Year > 2013,],
       type = c("g","p","r"),
       index = function(x,y) coef(lm(y~x))[1],
       xlab = "Year", 
       ylab = "Individuals with AGG", aspect = "xy")


```


#AIC for fruit
```{r}

#Candidate models  
lm1 <- lm(Total.Fruitlogtransformed.y ~  Year.x, ps.cor)
lm2 <- lm(Total.Fruitlogtransformed.y ~ Year.x*as.factor(Site), ps.cor)
lm3 <- lm(Total.Fruitlogtransformed.y ~ Year.x*Creek.x, ps.cor) #Need add creek!
lm4 <- lm(Total.Fruitlogtransformed.y ~ Year.x*Fence.x, ps.cor)
# lm5 <- lm(Total.Fruitlogtransformed.y ~ Year.x*as.factor(Plot), ps.cor)

lm.list <- list(lm1,lm2,lm3,lm4) # ,lm5)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))

#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}
```

#AIC for reproductive
```{r}

#Candidate models  
lm1 <- lm(X..Flowered.1logtransformed.x ~  Year.x, ps.cor)
lm2 <- lm(X..Flowered.1logtransformed.x ~ Year.x*as.factor(Site), ps.cor)
lm3 <- lm(X..Flowered.1logtransformed.x ~ Year.x*Creek.x, ps.cor) #Need add creek!
lm4 <- lm(X..Flowered.1logtransformed.x ~ Year.x*Fence.x, ps.cor)
# lm5 <- lm(Total.Fruitlogtransformed.y ~ Year.x*as.factor(Plot), ps.cor)

lm.list <- list(lm1,lm2,lm3,lm4) # ,lm5)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))

#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}
```


Table 2: Biotic factors correlated among the percent dormant individuals, percent browsed individuals, density of reproductive individuals, fruit production, and the percent of reproductive individuals and above ground growth (AGG) of Astragalus microcymbus per year (1995 - 2017	) within the South Beaver Creek drainage (38? 27' 39.8" N, 106? 57' 37.6" W). 
```{r}

cor.out <- round(cor(ps.cor[,forcor]),2)

notsig <- df.c[df.c$P.val > 0.04,]

cor.sign <- apply(notsig,1,function(x){
  row1 <- which(dimnames(cor.out)[[1]] == x[1]) #row
  column2 <- which(dimnames(cor.out)[[2]] == x[2]) #column
  c(row1,column2)
})

pairs(ps.cor[,names(ps.cor) %in% 
             unique(grep(paste(cors,collapse="|"),names(ps.cor), value=TRUE))][1:5])

pairs(ps.cor[,grep("transformed",names(ps.cor))][1:6])


```




# Herbivory section
```{r}

table(asmi.raw$Browsing...Status)
nrow(asmi.raw[grep("Mammal",asmi.raw$Browsing...Status),])
nrow(asmi.raw[grep("Insect",asmi.raw$Browsing...Status),])
nrow(asmi.raw[!(asmi.raw$status %in% c("dead","dormant")) ,])

nrow(asmi.raw[grep("Mammal",asmi.raw$Browsing...Status),])/
  nrow(asmi.raw[!(asmi.raw$status %in% c("dead","dormant")) ,])

nrow(asmi.raw[grep("Insect",asmi.raw$Browsing...Status),])/
  nrow(asmi.raw[!(asmi.raw$status %in% c("dead","dormant")) ,])


summary(lm(Total.Alivelogtransformed.y ~ X..Browsedarcsinsqrttransformed.x, 
           data = ps.cor)) #previous year
summary(lm(Total.Alivelogtransformed.y ~ X..Browsedarcsinsqrttransformed.y, 
           data = ps.cor)) #current year

summary(lm(Total.Alivelogtransformed.y ~ X..Floweredlogtransformed.x, data = ps.cor))
summary(lm(Total.Alivelogtransformed.y ~ X..Floweredlogtransformed.y, data = ps.cor))




#Fencing put in for browsing
t.test(X..Browsedarcsinsqrttransformed~Fence, data = ps.asmi.t)
t.test(X..Browsed~Fence, data = ps.asmi.t)


t.test(Percent..Browsinglogtransformed~Fence, data = ps.asmi.t[ps.asmi.t$Year<2006,])

t.test(X..Browsedarcsinsqrttransformed~Fence, data = ps.asmi.t[ps.asmi.t$Year<2006,])
t.test(X..Browsed~Fence, data = ps.asmi.t[ps.asmi.t$Year  <2006,])

#Fencing for plots after 2006
t.test(X..Browsedarcsinsqrttransformed~Fence, data = ps.asmi.t[ps.asmi.t$Year>2006,])
t.test(X..Browsed~Fence, data = ps.asmi.t[ps.asmi.t$Year>2006,])

#fenced plots compared before and after, open too
t.test(ps.asmi.t$X..Browsedarcsinsqrttransformed[ps.asmi.t$Year<2007&
                                                   ps.asmi.t$Fence=="y"],
       ps.asmi.t$X..Browsedarcsinsqrttransformed[ps.asmi.t$Year>=2007&
                                                   ps.asmi.t$Fence=="y"])

#AGG 
t.test(Total.Alivelogtransformed~Fence, data = ps.asmi.t[ps.asmi.t$Year>2006,])
t.test(Total.Alive~Fence, data = ps.asmi.t[ps.asmi.t$Year>2006,])


t.test(Total.Alivelogtransformed~Fence, data =
         ps.asmi.t[ps.asmi.t$Year>2006&ps.asmi.t$Year<2009,])
t.test(Total.Alive~Fence, data = ps.asmi.t[ps.asmi.t$Year>2006&ps.asmi.t$Year<2009,])

#Fencing for plots after 2006
t.test(Total.Alivelogtransformed~Fence, data = ps.asmi.t)
t.test(Total.Alive~Fence, data = ps.asmi.t)


#AGG and dormant
t.test(Total.Plants~Fence, data = ps.asmi.t[ps.asmi.t$Year>2006,])

#Fencing for plots after 2006
t.test(Total.Alivelogtransformed~Fence, data = ps.asmi.t)
t.test(Total.Alive~Fence, data = ps.asmi.t)



#In all years after fence installation
t.test(Total.Fruitlogtransformed~Fence, data = ps.asmi.t[ps.asmi.t$Year > 2005,])
t.test(X..Floweredarcsinsqrttransformed~Fence, data = ps.asmi.t[ps.asmi.t$Year > 2005,])



t.test(X..Flowered.y~Fence.y, data = ps.cor[ps.cor$Year.x > 2005,])

#individuals with AGG after fencing
t.test(Total.Alive.y~Fence.y, data = ps.cor[ps.cor$Year.x > 2005,])

#individuals with AGG and dormant after fencing
t.test(Total.Plants~Fence, data = ps.asmi.t[ps.asmi$Year > 2005,])
t.test(Total.Plants~Fence, data = ps.asmi.t)

t.test(ps.asmi.t$Total.Plants[ps.asmi.t$Year<2006&
                                ps.asmi.t$Fence=="y"],
       ps.asmi.t$Total.Plants[ps.asmi.t$Year>=2006&
                                ps.asmi.t$Fence=="y"])


#herbivory
t.test(X..Browsed~Fence, data = ps.asmi.t[ps.asmi.t$Year > 2005,]) #not signficantly different
allttestherb <- lapply(1995:currentyr, function(x){
  t.test(X..Browsed~Fence, data = ps.asmi.t[ps.asmi.t$Year == x,])
  })

allttestherb[[22]]

t.test(length~fence, data = asmi.raw[asmi.raw$AsMi_site_id > 2 & asmi.raw$year > 2005,])

#Percent herbivory between fenced and open
t.test(X..Browsedarcsinsqrttransformed~Fence, data=ps.asmi.t[ps.asmi.t$Year>2005,])

t.test(X..Browsedarcsinsqrttransformed~Fence, data=ps.asmi.t[ps.asmi.t$Year>2005,])
```


Table 3: Average Astragalus microcymbus fruit per plot within the South Beaver Creek Drainage near Gunnison, CO and Cebolla Creek drainage. Site 1 is Cebolla Creek Mid and site 2 is Cebolla Creek North. Standard errors are given in parentheses. 
```{r}
fruit <- aggregate(fruit ~ AsMi_plot_id + year + AsMi_site_id + fence, 
                  data = asmi.raw, function(x) sum(x,na.rm = TRUE))
head(fruit)


tbl3.1 <- summarySE(fruit, measurevar="fruit",groupvars=c("AsMi_site_id","year"))

sites <- unique(tbl3.1$AsMi_site_id)
tbl3 <- lapply(sites, function(x){
  paste(round(tbl3.1[tbl3.1$AsMi_site_id == x,"fruit"],2)," (",
        round(tbl3.1[tbl3.1$AsMi_site_id == x,"se"],1), ")", sep="")
})

#Cebolla Creek
write.csv(data.frame(tbl3[[1]],tbl3[[2]]), file=paste(savepath,"Table3_Cebolla.csv"), row.names=TRUE)
#South Beaver Creek
write.csv(data.frame(tbl3[[3]],tbl3[[4]],tbl3[[5]],tbl3[[6]]), file=paste(savepath,"Table3_SouthBeaver.csv"), row.names=TRUE)

```


Table 4: Growth rate (Î») and standard deviation within treatment (fenced or open plots) of Astragalus microcymbus individuals within the South Beaver Creek drainage near Gunnison, CO. Plot 598 in site 26, added in 2004, is excluded.   

```{r}
table(asmi.raw$browsing)
table(asmi.raw$Browsing...Status) 
nrow(asmi.raw) #13806->16377
table(asmi.raw$AsMi_site_id,asmi.raw$year)

cebolla <- asmi.raw[asmi.raw$AsMi_site_id %in% c(1,2),]
table(cebolla$AsMi_site_id,cebolla$year)

sbc <- asmi.raw[asmi.raw$AsMi_site_id %in% c(5,15,19,26),]
table(sbc$AsMi_site_id,sbc$year)

#remove plot 598 from SBC, it was added late; Plot 598 was added in 2004, remove for this. .. or do all plots on their own instead of by sites? Or make sure the transitions are proportional, I think I need each plot on it's own since they start at different times, can't combine into one site. 
# or since they aren't seedlings the first year, it's fine, there's still the number transitioning 
# sbc <- sbc[sbc$AsMi_plot_id != 598,]

# the others added later: 238 & 300 @ 1996 - take out 1995
# sbc <- sbc[sbc$year > 1995,]

# KEY TO OBJECTS
# After commenting out the removed year and the added plots... then asmi.1 is SBC, cebolla is Cebolla and asmi.all is both
asmi.1 <- sbc[order(sbc$AsMi_site_id, sbc$AsMi_tag_id, sbc$year),]
cebolla <- cebolla[order(cebolla$AsMi_site_id, cebolla$AsMi_tag_id, cebolla$year),]

asmi.1$status <- factor(asmi.1$status)
table(asmi.1$status)

cebolla$status <- factor(cebolla$status)
table(cebolla$status)

#just keep all together go by plot
asmi.all <- asmi.raw[order(asmi.raw$AsMi_site_id, 
                           asmi.raw$AsMi_tag_id, asmi.raw$year),]
table(asmi.all$status)

```

Set order of classes
```{r}
# Later work in seeds
# stages <- c("seed", "seedling", "vegetative", "reproductive", "dormant","dead") 

stages <- c("seedling", "vegetative", "reproductive", "dormant","dead") 

asmi.1$status <- ordered(asmi.1$status, levels = stages)
cebolla$status <- ordered(cebolla$status, levels = stages)

asmi.all$status <- ordered(asmi.all$status, levels = stages)
```

check errors
```{r}
table(asmi.1$status)
table(cebolla$status)

# should all be reproductive (status 4 in DBG phpMyAdmin)
asmi.1[asmi.1$flower == 1 & asmi.1$status == "vegetative",]
cebolla[cebolla$flower == 1 & cebolla$status == "vegetative",]
asmi.all[cebolla$flower == 1 & asmi.all$status == "vegetative",]


table(asmi.1$year, asmi.1$AsMi_site_id)
tail(table(asmi.1$length) )
tail(table(cebolla$length))
tail(table(asmi.all$length))

table(asmi.1$status[is.na(asmi.1$length)])
asmi.1[asmi.1$length > 100 & !is.na(asmi.1$length),]

# One length that was recorded crazy
# asmi.1$length[asmi.1$length == 921] <- NA
# asmi.all$length[asmi.all$length == 921] <- NA

asmi.1$browsed[asmi.1$browsing==0]<-FALSE  	
asmi.1$browsed[asmi.1$browsing==1]<-TRUE
table(asmi.1$browsed)
table(asmi.1$browsing)

# Same for cebolla plots
cebolla$browsed[cebolla$browsing==0]<-FALSE    
cebolla$browsed[cebolla$browsing==1]<-TRUE
table(cebolla$browsed)
table(cebolla$browsing)


asmi.all$browsed[asmi.all$browsing==0]<-FALSE  	
asmi.all$browsed[asmi.all$browsing==1]<-TRUE
table(asmi.all$browsed)
table(asmi.all$browsing)
```

Merge year to year, year.x is year t, year.y is year t+1   
remove dead from stages, just fate   
```{r}
asmi.2 <- subset(merge(asmi.1, asmi.1, by = "AsMi_tag_id", sort = FALSE), year.x == year.y - 1)   
cebolla1 <- subset(merge(cebolla, cebolla, by = "AsMi_tag_id", sort = FALSE), year.x == year.y - 1)  

asmi.all1 <- subset(merge(asmi.all, asmi.all, by = "AsMi_tag_id", sort = FALSE), year.x == year.y - 1)  

```


    
Want    
Narrow down to      
[1] "AsMi_site_id.x" "AsMi_tag_id"    "year.x"             
[4] "length.x"       "fruit.x"        "browsed.x"           
[7] "fence.x"        "status.x"       "status.y"     
```{r}
cols <- c("AsMi_site_id.x","AsMi_tag_id","year.x","length.x",
          "fruit.x","browsed.x","fence.x","status.x","status.y","AsMi_plot_id.x")
asmi.2 <- asmi.2[, names(asmi.2) %in% unique(grep(paste(cols,collapse="|"),
                                                  names(asmi.2), value = TRUE))]
colnames(asmi.2) <- c( "tag","year","length","fruits","stage","plot",
                       "site","fenced","browse","fate")
## re-number
rownames(asmi.2) <- 1:nrow(asmi.2)
# Get rid of stage 'dead'
asmi.2$stage <- ordered(asmi.2$stage, levels = stages[-length(stages)])
# check transitions
#fate down and stage across the top; These are the raw numbers combined for all years 
table(Fate = asmi.2$fate, Stage = asmi.2$stage)

cebolla.2 <- cebolla1[, names(cebolla1) %in% unique(grep(paste(cols,collapse="|"),
                                                  names(cebolla1), value = TRUE))]
colnames(cebolla.2) <- c( "tag","year","length","fruits","stage","plot",
                       "site","fenced","browse","fate")

#To just do plot at a time
asmi.all1 <- asmi.all1[, names(asmi.all1) %in% unique(grep(paste(cols,collapse="|"),
                                                  names(asmi.all1), value = TRUE))]
colnames(asmi.all1) <- c( "tag","year","length","fruits","stage","plot",
                       "site","fenced","browse","fate")
## re-number
rownames(asmi.all1) <- 1:nrow(asmi.all1)
# Get rid of stage 'dead'
asmi.all1$stage <- ordered(asmi.all1$stage, levels = stages[-length(stages)])
# check transitions
#fate down and stage across the top; These are the raw numbers combined for all years 
table(Fate = asmi.all1$fate, Stage = asmi.all1$stage)

```

bootstrap distributions of population growth rates (lambda), stage vectors, and projection matrix elements by randomly sampling with replacement from a stage-fate data frame of observed transitions   

Doesn't make sense... shouldn't be so high... Because 26 had additional plots added in 1996?    
There are seedlings that go from 'seedling' to 'dead' that have values for $seedling   
something is off.    
Made some fixes to raw data where fruit were counted but confusion led to putting 0 for flower column    
Will change all seedling with fruit to reproductive
## START HERE
```{r}
asmi.boot <- asmi.all1
asmi.boot$fruits[is.na(asmi.boot$fruits)] <- 0

table(asmi.boot$year, asmi.boot$site) # from 1995 transitions stage -> fate up to currentyr-1 stage->fate 
# add 'seedling' column
# change seedlings with length greater than 30 to 'vegetative'
table(asmi.boot$stage[asmi.boot$length>30])
table(asmi.boot$stage[asmi.boot$fruits>0])
asmi.boot[asmi.boot$fruits>0 & asmi.boot$stage=="seedling" & asmi.boot$length<20,]
hist(asmi.boot$length[asmi.boot$fruits>0])
hist(asmi.boot$length[asmi.boot$fruits>0 & asmi.boot$stage=="seedling"])
hist(asmi.boot$length[asmi.boot$fruits>0 & asmi.boot$stage=="reproductive"])
asmi.boot[asmi.boot$stage=="vegetative" & asmi.boot$fruits>0,]

asmi.boot$stage[asmi.boot$fruits>0 & asmi.boot$stage=="seedling"] <- "reproductive"

asmi.boot$seedling <- do.call(c,lapply(sort(unique(asmi.boot$year)),function(year){
  # For each next year, how many seedlings were there? 
  seedlings <- nrow(asmi.boot[asmi.boot$year == year+1 & asmi.boot$stage == "seedling",])
  # The number of fruit produced per individual divided by all fruit produced * seedlings in the next year
  seedlingsout <- asmi.boot$fruits[asmi.boot$year==year]/sum(asmi.boot$fruits[asmi.boot$year==year],na.rm = TRUE) * seedlings
  seedlingsout
  }))

asmi.boot[asmi.boot$year==year,]
asmi.boot[asmi.boot$seedling>0,]
asmi.boot[is.na(asmi.boot$stage),]

boottrans <- lapply(unique(asmi.boot$plot), function(x){
  data.frame(cbind(Plot = x,
                   Boot = boot.transitions(asmi.boot[asmi.boot$plot == x & 
                                                       asmi.boot$fenced == "n",], 
                                           1000,
                                           fertility = "fruits")$lambda))
  })

bt <- do.call(rbind, boottrans)
head(bt)
#dev.off()
ggplot(bt, aes(as.factor(Plot), Boot, colour = as.factor(Plot)))+
  geom_boxplot()+
  facet_grid(~Site)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```


Check errors    
```{r}

# sorted by tag and then year so....
firststage <- asmi.2[!duplicated(asmi.2$tag),]
table(firststage$stage[firststage$year != 1996]) # 11 times when first account of tagged individual is vegetative, not seedling, why?! Fixed by 2018

#firststage[firststage$stage=="vegetative" & firststage$year!=1996,]


foo <- rle(as.numeric(asmi.2$stage))
foo$values[1:10]
foo$lengths[1:10]
sum(foo$lengths[1:10])
asmi.2$stage[1:sum(foo$lengths[1:10])]
```

#Figure 3
```{r}
# asmi.1 is already sorted by site, tag, year
#dorms <- rle(as.numeric(asmi.2$fate))$lengths[rle(as.numeric(asmi.2$fate))$values ==4]
levels(asmi.1$status) # 4 is dormant

dorms <- do.call(rbind,lapply(split(asmi.1, asmi.1$AsMi_tag_id), function(x){
  dormlns <- rle(as.numeric(x$status))$lengths[rle(as.numeric(x$status))$values==4]
  out <- data.frame(Tag=rep(unique(x$AsMi_tag_id), length(dormlns)),dorms=dormlns)
  out
}))


table(dorms$dorms) 

jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/Fig2.jpg", sep = ""),
         units = "mm", res = 300, height = 100, width = 130)

ggplot(dorms, aes(dorms))+
  geom_histogram(bins = 20)+
  theme_bw()+
  ylab("Frequency")+
  xlab("Consecutive years dormant")

dev.off()
```

#only South beaver creek
```{r}
median(dorms$dorms) #3
length(dorms$dorms[dorms$dorms==1]) #347 -> 358
length(dorms$dorms[dorms$dorms==1])/length(dorms$dorms) # 37%
# How many tags had some amount of dormancy? How'd I get that before
dormantsandnot <- do.call(rbind,lapply(split(asmi.1, asmi.1$AsMi_tag_id), function(x){
  dormlns <- rle(as.numeric(x$status))$lengths[rle(as.numeric(x$status))$values==4]
  if(length(dormlns)==0){
    out <- data.frame(Tag=unique(x$AsMi_tag_id),dorms=0)
  } else {
    out <- data.frame(Tag=rep(unique(x$AsMi_tag_id), length(dormlns)),dorms=dormlns)
  }
  out
}))
dormantsandnot$dormYN <- 0
dormantsandnot$dormYN[dormantsandnot$dorms>0] <- 1
sum(dormantsandnot$dormYN)/nrow(dormantsandnot) # 0.3483473


length(dorms$dorms) #848 -> 959
length(dorms$dorms[dorms$dorms > 5]) #353 -> 355
length(dorms$dorms[dorms$dorms > 15]) #93 -> 82??
length(dorms$dorms[dorms$dorms == 21]) #13 -> 0, oh, I downloaded with dorm = 20 I think!
```

Reproductive lengths - South Beaver Creek only   
```{r}

identical(asmi.2$fate, asmi.2$fate[with(asmi.2,order(tag,year))])

# repros <- rle(as.numeric(asmi.2$fate[with(asmi.2,order(tag,year))]))$lengths[rle(as.numeric(asmi.2$fate[with(asmi.2, order(tag,year))]))$values ==3]

x<- split(asmi.2, asmi.2$tag)
x[[1000]]
as.numeric(x[[1000]]$stage[with(x[[1000]],order(year))])
as.numeric(x[[1000]]$stage)

asmi.2[asmi.2$tag==44,] # Seedling in 2011 but rows for all years

rle(as.numeric(x[[1000]]$stage[with(x[[1000]],order(year))]))$lengths[rle(as.numeric(x[[1000]]$stage[with(x[[1000]],order(year))]))$values==3]

repros <- do.call(rbind, lapply(split(asmi.2, asmi.2$tag), function(x){
  reproslength <- rle(as.numeric(x$stage[with(x,order(year))]))$lengths[rle(as.numeric(x$stage[with(x,order(year))]))$values==3]
  out <- data.frame(Tag=rep(unique(x$tag),length(reproslength)),
             reproslength)
  out[complete.cases(out),]
}))

max(repros$reproslength)
ggplot(repros, aes(reproslength))+
  geom_histogram(bins=8)+
  theme_bw()+
  ylab("Frequency")+
  xlab("Consecutive years reproductive")

```

#Stage based PVA   
```{r}
#is survival associate diwht a continutous classifying variable?
surv.asmi <- asmi.2
surv.asmi$surv <- 1
surv.asmi$surv[surv.asmi$fate=="dead"] <- 0
table(surv.asmi$surv)

str(surv.asmi)

#stages are L, Q, and C? linear, quadractic, cubic - because of the ordinal factor, just factor it
summary(glm(surv~ as.factor(as.numeric(stage)) +as.factor(site), family=binomial(link = "logit"), surv.asmi))

surv.asmi$stage <- factor(surv.asmi$stage, levels=levels(surv.asmi$stage), ordered=FALSE)
str(surv.asmi)
summary(glm(surv~ stage +as.factor(site), family=binomial(link = "logit"), surv.asmi))


#survival as a cox proportional hazards regression model
library(survival)

# interval data, the starting time for the interval (so the year is the stage year and survival is based on fate, next year); "righ censoring" means date of death is unknown, which it is actually! 
#Survival curve is probability that time of death is greater than some specified time
survObj <- Surv(time = surv.asmi$year, event=as.logical(surv.asmi$surv))
model <- coxph(survObj ~ strata(factor(site)), data=surv.asmi)


#plotting time to death


```


https://rpubs.com/daspringate/survival    
https://datascience.stackexchange.com/questions/8162/r-plotsurv-newdata-draws-same-lines-many-times-why    


```{r}
#plot survival of a given year by size
for(i in sort(unique(surv.asmi$year))){
  plot(surv.asmi$length[surv.asmi$year==i], 
       surv.asmi$surv[surv.asmi$year==i], main= paste(i), xlab="length",ylab="Probability of survival")
  g<- glm(surv~length, family=binomial,surv.asmi[surv.asmi$year==i,])
  curve(predict(g,data.frame(length=x),type="resp"), col="green4",add=TRUE)
  #points(surv.asmi$length[surv.asmi$year==i],fitted(g), pch=20)
}

plot(surv.asmi$length, 
       surv.asmi$surv, main= "1996 - 2017", xlab="length",ylab="Probability of survival")
  g<- glm(surv~length, family=binomial,surv.asmi)
  curve(predict(g,data.frame(length=x),type="resp"), col="green4",add=TRUE)

# Plot survivial per year by fruit
for(i in sort(unique(surv.asmi$year))){
  plot(surv.asmi$fruits[surv.asmi$year==i], 
       surv.asmi$surv[surv.asmi$year==i], main= paste(i), xlab="fruits",ylab="Probability of survival")
  g<- glm(surv~fruits, family=binomial,surv.asmi[surv.asmi$year==i,])
  curve(predict(g,data.frame(fruits=x),type="resp"), col="green4",add=TRUE)
  #points(surv.asmi$length[surv.asmi$year==i],fitted(g), pch=20)
}
  
  
plot(surv.asmi$fruits, 
       surv.asmi$surv, main= "1996 - 2017", xlab="fruits",ylab="Probability of survival")
  g<- glm(surv~fruits, family=binomial,surv.asmi)
  curve(predict(g,data.frame(fruits=x),type="resp"), col="green4",add=TRUE)
  

surv.asmi$frYN <- 0
surv.asmi$frYN[surv.asmi$fruits>0] <- 1

# Probability of being reproductive given length
for(i in sort(unique(surv.asmi$year))){
  plot(surv.asmi$length[surv.asmi$year==i], 
       surv.asmi$frYN[surv.asmi$year==i], main= paste(i), xlab="fruits",ylab="Probability of reproductive")
  g<- glm(frYN~length, family=binomial,surv.asmi[surv.asmi$year==i,])
  curve(predict(g,data.frame(length=x),type="resp"), col="green4",add=TRUE)
}
    
plot(surv.asmi$length, 
       surv.asmi$frYN, main= "1996 - 2017", xlab="length",ylab="Probability of reproductive")
  g<- glm(frYN~length, family=binomial,surv.asmi)
  curve(predict(g,data.frame(length=x),type="resp"), col="green4",add=TRUE)  
  
```


# Another way to look at survival curves
```{r}
fit <- survfit(Surv(length, surv) ~ fenced, 
               data = surv.asmi[surv.asmi$length>0 & surv.asmi$year>2005,]) 

ggsurvplot(fit, data=surv.asmi[surv.asmi$length>0& surv.asmi$year>2005,], risk.table = FALSE, xlab = "length", conf.int = TRUE)
```

```{r}
fit <- survfit(Surv(length, surv) ~ site, 
               data = surv.asmi[surv.asmi$length>0 & surv.asmi$year>2005,]) 

ggsurvplot(fit, data=surv.asmi[surv.asmi$length>0& surv.asmi$year>2005,], risk.table = FALSE, xlab = "length")

```


```{r}

asmi.raw.1 <- asmi.raw[with(asmi.raw, order(AsMi_site_id,AsMi_plot_id,AsMi_tag_id,year)),]

asmi.raw.1[asmi.raw.1$AsMi_tag_id==10,]
asmi.1[asmi.1$AsMi_tag_id==10,] # Alive in 1995, not detected again until 2004 when big and flowering
asmi.1[asmi.1$AsMi_tag_id==3,] # in 1996, maybe these were seen in 1995 but dead by 1996?
asmi.1[asmi.1$AsMi_tag_id==11,] # Some tag made in error I guess

#Probability of being reproductive given years alive
levels(asmi.raw.1$status) # 3 is reproductive; 1 is dead
# Should add at least 1 year to the years alive if reproductive 

notdeadyet <- do.call(rbind,lapply(split(asmi.raw.1, asmi.raw.1$AsMi_tag_id), function(x){
  if(nrow(x[x$status!="dead",])>0){
    if(x$status[1] == "reproductive"){
      addyear <- 1
    } else {
      addyear <- 0
    }
    StageLength <- nrow(x[x$status!="dead",])
    data.frame(Tag=x$AsMi_tag_id[x$status!="dead"],
               year = x$year[x$status!="dead"],
               YrsAlive=(1+addyear):(StageLength+addyear))
    }
  }))

surv.asmi.1 <- merge(asmi.raw, notdeadyet, by.x = c("AsMi_tag_id","year"), by.y = c("Tag","year"))
surv.asmi.1[surv.asmi.1$AsMi_tag_id==10,]
surv.asmi.1[surv.asmi.1$status=="reproductive"&surv.asmi.1$YrsAlive<3,]

surv.asmi.1$frYN <- 0
surv.asmi.1$frYN[surv.asmi.1$fruit>0] <- 1

# Probability of being reproductive given length alive

plot(surv.asmi.1$YrsAlive, 
       surv.asmi.1$frYN, main= "1995 - 2018", xlab="Years alive",ylab="Probability of reproductive")
  g<- glm(frYN~YrsAlive, family=binomial,surv.asmi.1)
  curve(predict(g,data.frame(YrsAlive=x),type="resp"), col="green4",add=TRUE)  
  

```

# This doesn't make sense! Can't substitude length for time? Is it cummulative? 
```{r}
surv.asmi.1 <- surv.asmi.1[surv.asmi.1$length < 99,]

fit <- survfit(Surv(length, flower) ~ AsMi_site_id, 
               data = surv.asmi.1[surv.asmi.1$length>0,]) 

ggsurvplot(fit, data=surv.asmi.1[surv.asmi.1$length>0,], risk.table = FALSE, xlab = "length", ylab="Probability of Reproductive")

```
```{r}
surv.asmi.2 <- merge(surv.asmi, notdeadyet, by.x=c("tag","year"), by.y=c("Tag","year"))

fit <- survfit(Surv(YrsAlive, surv) ~ site, 
               data = surv.asmi.2[surv.asmi.2$length>0,]) 

ggsurvplot(fit, data=surv.asmi.2[surv.asmi.2$length>0,], risk.table = FALSE, xlab = "Age", ylab="Probability of Reproductive")

```

```{r}
plot(10,10, type="n")
matplot(contr.poly(15)[,1:4], type="b") 
```



Why are there 25 slots for Site PVA? and all but the last four are empty - last 4 have the 4 SBC populations
notfenced has 21 blank (each year)

Dormancy can be set to 0-1     

```{r}
asmi.pva <- StagePVA(asmi.2)
cebolla.pva <- StagePVA(cebolla.2)
```

By plot, South Beaver Creek
```{r}
site <- sapply(unique(asmi.2$site), function(x){
  as.character(unique(asmi.2$plot[asmi.2$site == x]))
  }, simplify = FALSE)
names(site)<-unique(asmi.2$site)
site

asmi.pva$plot.matrix[site$'15'[1]]
```


# Table 4: Growth rate    
All
```{r}
lmdSD(asmi.pva$pro.matrix, 1996, currentyr-2)
#         lmda        SD
# [1,] 1.179791 0.9690063

#Pre-fencing (2004-2005 transition)
paste(round(lmdSD(asmi.pva$pro.matrix, 1996, 2004)[1],2)," (",
      round(lmdSD(asmi.pva$pro.matrix, 1996, 2004)[2],2), ")", sep ="")

mats.list <- list(asmi.pva$pro.matrix,asmi.pva$fenced.pro.matrix,asmi.pva$notfenced.pro.matrix)
tbl4.all <- sapply(mats.list, function(x){
   paste(round(lmdSD(x, 1996, 2004)[1],2)," (",
         round(lmdSD(x, 1996, 2004)[2],2),")", sep="")
    })

t(tbl4.all)

tbl4.allpost <- sapply(mats.list[-1], function(x){
  paste(round(lmdSD(x, 2005,currentyr-2)[1],2)," (",
        round(lmdSD(x, 2005,currentyr-2)[2],2),")", sep="")
})

write.csv(tbl4.allpost, file=paste(savepath,"Table4_allpost.csv"), row.names=TRUE)


tbl4.allopen <- paste(round(lmdSD(asmi.pva$notfenced.pro.matrix, 1996,currentyr-2)[1],2)," (",
                      round(lmdSD(asmi.pva$notfenced.pro.matrix, 1996,currentyr-2)[2],2),")", sep="")


write.csv(tbl4.allopen, file=paste(savepath,"tbl4_allopen.csv"), row.names=TRUE)
```

Cebolla all
1:Mid
2:North
```{r}

# All
lmdSD(cebolla.pva$pro.matrix, 2014, currentyr-2)
# lmdSD(cebolla.pva$pro.matrix, 2014, currentyr-1) #in 2016, not enough data to exclude the last one
#         lmda       SD
#[1,] 1.138889 1.038878

#Cebolla Mid = Site 1
paste(round(lmdSD(cebolla.pva$Site$`1`, 2014, currentyr-2)[1],2)," (",
      round(lmdSD(cebolla.pva$Site$`1`, 2014, currentyr-2)[2],2), ")", sep ="")

#Cebolla North = Site 2
paste(round(lmdSD(cebolla.pva$Site$`2`, 2014, currentyr-2)[1],2)," (",
      round(lmdSD(cebolla.pva$Site$`2`, 2014, currentyr-2)[2],2), ")", sep ="")

mats.list <- list(cebolla.pva$pro.matrix,cebolla.pva$fenced.pro.matrix,cebolla.pva$notfenced.pro.matrix)
sapply(mats.list, function(x){
   paste(round(lmdSD(x, 2014, currentyr-2)[1],2)," (",
         round(lmdSD(x, 2014, currentyr-2)[2],2),")", sep="")
    })
```
 
T-test fenced vs. open after fencing installed   
```{r T.test paired growth rates}
t.test(lmdAn(asmi.pva$fenced.pro.matrix, 2005, currentyr-2),
       lmdAn(asmi.pva$notfenced.pro.matrix, 2005, currentyr-2),
       paired = TRUE)

```

T-test for growth rate before and after fencing  
```{r}
t.test(lmdAn(asmi.pva$fenced.pro.matrix, 1996, 2004),
       lmdAn(asmi.pva$fenced.pro.matrix, 2005, currentyr-2))
```


# Table 4
pattern is:          

All pre-fence  1996-2004        |All post-fence 2005-currentyr-2 |Open plots 1996-currentyr-2   
--------------------------------|--------------------------------|----------------------    
asmi.pva$pro.matrix             |                                |  
asmi.pva$fenced.pro.matrix      | asmi.pva$fenced.pro.matrix     |           
asmi.pva$notfenced.pro.matrix   | asmi.pva$notfenced.pro.matrix  | asmi.pva$notfenced         
      
      
Sites 5,19,26,  1996-2004       
(which is through 2005 but starting transition of 2004)   

1996-2005               |   2005-2014            |   1996-2014
------------------------|------------------------|---------------------          
asmi.pva$Site$"5"       |                        |       
asmi.pva$fenced$"5"     | asmi.pva$fenced$"5"    |                
asmi.pva$notfenced$"5"  | asmi.pva$notfenced$"5" |  asmi.pva$notfenced$"5"             

Site 15
`asmi.pva$Site$"15"` ...        

[[1]]:All; [[2]]:fenced; [[3]]:open
```{r}
matord.list <- list(asmi.pva$Site, asmi.pva$fenced,asmi.pva$notfenced)

lapply(seq_along(asmi.pva$Site), function(n,i){ paste(n[[i]])}, 
       n=names(asmi.pva$Site))

# 1996 (remove first year) through 2004 since it's 2004-2005 before fencing
# All
# not working! move on to one by one
tbl4.96.04 <- 
  lapply(as.character(unique(asmi.2$site)), function(x){
    mat <- cat("matord.list[[1]]$\`",x,"`", sep='')
    outapply<-lapply(mat, function(y){
      out<- paste(round(lmdSD(y[[factor(x)]],1996,2004)[1],2)," (",
            round(lmdSD(y[[factor(x)]],1996,2004)[2],2),")", sep="")
      out
    })
    outapply
  })

#site 5
paste(round(lmdSD(asmi.pva$Site$'5',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'5',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$fenced$'5',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'5',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'5',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'5',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$fenced$'5',2005,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'5',2005,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'5',2005,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'5',2005,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'5',1996,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'5',1996,currentyr-2)[2],2),")", sep="")

#Site 15
paste(round(lmdSD(asmi.pva$Site$'15',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'15',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$Site$'15',2005,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'15',2005,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$Site$'15',1996,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'15',1996,currentyr-2)[2],2),")", sep="")

#site 19
paste(round(lmdSD(asmi.pva$Site$'19',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'19',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$fenced$'19',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'19',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'19',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'19',1996,2004)[2],2),")", sep="")


paste(round(lmdSD(asmi.pva$fenced$'19',2005,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'19',2005,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'19',2005,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'19',2005,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'19',1996,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'19',1996,currentyr-2)[2],2),")", sep="")

#site 26
paste(round(lmdSD(asmi.pva$Site$'26',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'26',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$fenced$'26',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'26',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'26',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'26',1996,2004)[2],2),")", sep="")


paste(round(lmdSD(asmi.pva$fenced$'26',2005,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$fenced$'26',2005,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'26',2005,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'26',2005,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$notfenced$'26',1996,currentyr-2)[1],2)," (",
            round(lmdSD(asmi.pva$notfenced$'26',1996,currentyr-2)[2],2),")", sep="")

#Cebolla Mid
paste(round(lmdSD(cebolla.pva$notfenced$'1',2014,currentyr-2)[1],2)," (",
            round(lmdSD(cebolla.pva$notfenced$'1',2014,currentyr-2)[2],2),")", sep="")

paste(round(lmdSD(cebolla.pva$notfenced$'2',2014,currentyr-2)[1],2)," (",
            round(lmdSD(cebolla.pva$notfenced$'2',2014,currentyr-2)[2],2),")", sep="")

```

Figure 3: Life cycle diagram of Astragalus microcymbus, 1996-currentyr-1 mean transition rates (solid lines) and fecundity rates (dashed lines), and resulting sensitivities and elasticities. Individuals that become reproductive in the first year are classified as seedlings. 

```{r}
eigen.analysis(mean(asmi.pva$notfenced.pro.matrix))
mean(asmi.pva$notfenced.pro.matrix)
```

###Environmental Data from PRISM:   
<http://prism.oregonstate.edu/explorer/>  
<https://github.com/ropensci/prism>

Process takes a while   
Can go back to folder and delete old provisional data to replace with more current   
```{r, eval = FALSE}
# Set wd for prism
options(prism.path = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/PRISM_asmiclimate")

#Precipitation total, rain and snow
get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)

#Maximum temperature (average)
get_prism_monthlys(type="tmax", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)

#Minimum temperature (average)
get_prism_monthlys(type="tmin", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)

```

Error, didn't download
```{r, eval=FALSE}
get_prism_monthlys(type="ppt", mon = 9, keepZip = FALSE, years = 1996)
get_prism_monthlys(type="ppt", mon = 6, keepZip = FALSE, years = 1999)
get_prism_monthlys(type="ppt", mon = 8, keepZip = FALSE, years = 1999)
get_prism_monthlys(type="ppt", mon = 6, keepZip = FALSE, years = 2000)
get_prism_monthlys(type="ppt", mon = 5, keepZip = FALSE, years = 2002)
get_prism_monthlys(type="ppt", mon = 9, keepZip = FALSE, years = 2006)
get_prism_monthlys(type="ppt", mon = 10, keepZip = FALSE, years = 2006)
get_prism_monthlys(type="ppt", mon = 12, keepZip = FALSE, years = 2012)

#get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = 1981)
#get_prism_monthlys(type="tmin", mon = 1:12, keepZip = FALSE, years = 1981)
#get_prism_monthlys(type="tmax", mon = 1:12, keepZip = FALSE, years = 1981)
```



UTM Zone 13 from ArcGIS
```{r}
asmilatlong <- read.csv("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Word/2016_asmi/UTM_asmiplots.csv")

# Convert from UTM to lat/long
asmi.ll <- spTransform(SpatialPoints(cbind(asmilatlong$Easting,asmilatlong$Northing), 
                                     proj4string = CRS("+proj=utm +zone=13 + datum=WGS84")), 
                       CRS("+proj=longlat +datum=WGS84"))

asmiLL <- data.frame(coordinates(asmi.ll),asmilatlong$Tag__,asmilatlong$Tag_Commen)

```



# Want Site, Year, Month, ppt, tmin, tmax
```{r, eval = FALSE}
maxs <- grep("tmax", ls_prism_data(absPath=TRUE)[,2])
mins <- grep("tmin", ls_prism_data(absPath = TRUE)[,2])
ppt <- grep("ppt", ls_prism_data(absPath = TRUE)[,2])


avgTemps.max <- lapply(maxs, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, asmiLL[,c("coords.x1","coords.x2")]), date = ls_prism_data()[x,])
})

avgTemps.min <- lapply(mins, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, asmiLL[,c("coords.x1","coords.x2")]), date = ls_prism_data()[x,])
})

avgPrecip <- lapply(ppt, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, asmiLL[,c("coords.x1","coords.x2")]), date = ls_prism_data()[x,])
})

mins.avg <- do.call(rbind, avgTemps.min)
maxs.avg <- do.call(rbind, avgTemps.max)
ppt.avg <- do.call(rbind, avgPrecip)

mins.avg <- data.frame(mins.avg, asmilatlong$Tag__, asmilatlong$Tag_Commen)
maxs.avg <- data.frame(maxs.avg, asmilatlong$Tag__, asmilatlong$Tag_Commen)
ppt.avg <- data.frame(ppt.avg, asmilatlong$Tag__, asmilatlong$Tag_Commen)

asmi.climate <- cbind(mins.avg, maxs.avg[,1], ppt.avg[,1])
names(asmi.climate) <- c("tmin","date","Plot","Site","tmax","Precip")

#date is a factor
asmi.climate$date <- as.character(asmi.climate$date)

#split by _ select the YYYYMM numbers
asmi.climate$Year <- as.numeric(substr(vapply(strsplit(asmi.climate$date, '_'), 
                                   function(x) x[5], character(1)), 1,4))
asmi.climate$Month <- as.numeric(substr(vapply(strsplit(asmi.climate$date, '_'), 
                                   function(x) x[5], character(1)), 5,6))

asmi.c <- asmi.climate[,-2]

plots.site <- asmi.raw[!duplicated(asmi.raw$AsMi_plot_id),c("AsMi_plot_id","AsMi_site_id")]
plots.site$Creek <- "South Beaver"
plots.site$Creek[plots.site$AsMi_site_id < 3] <- "Cebolla"

asmi.c <- merge(plots.site, asmi.c, by.x="AsMi_plot_id", by.y="Plot")
names(asmi.c) <- c("Plot","Site","Creek",names(asmi.c)[4:length(asmi.c)])

#Label Prev12 as 08 through 12 of the previous year and give it the year for 01-07 (of the previous year (the next year) 
asmi.c$Prev12 <- asmi.c$Year
asmi.c$Prev12[asmi.c$Month > 7] <- asmi.c$Year[asmi.c$Month > 7]+1

head(asmi.c[with(asmi.c, order(Year,Month,Site,Plot))&asmi.c$Year==1980,],100)




asmi.c <- asmi.c[with(asmi.c, order(Year,Month,Site,Plot)),]

write.table(asmi.c, file = "P:/hackathon/GitPVA/datasets/asmi.c.csv", sep=",")
```

After create new climate dataset, can download it from GitHub
```{r}
asmi.c <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/PVA/master/datasets/asmi.c.csv"))

```


#autocorrelations   
https://campus.datacamp.com/courses/introduction-to-time-series-analysis/correlation-analysis-and-the-autocorrelation-function?ex=9#next 
```{r}
length_tmin1 <- split(alive.site$length[-1],alive.site$AsMi_site_id)
length_t <- split(alive.site$length[-nrow(alive.site)],
                        alive.site$AsMi_site_id)
length_tmin1
length_t
autocor <- mapply(cbind,length_t,length_tmin1)
```

```{r}
plot(autocor[[1]], xlim=c(0,325), ylim=c(0,350), pch=20)
for(i in 2:6){
  points(autocor[[i]], col=i, pch=20)
}
```

```{r}
autocor1 <- do.call(rbind,autocor)
# sample covariance in acf is scaled with 1/(n-1) instead of 1/n
cor(autocor1[,1],autocor1[,2])*(nrow(autocor1)/(nrow(autocor1)+1))

#but to combine all sites time series, need to keep steps separate by site
lapply(split(alive.site$length,alive.site$AsMi_site_id), function(x){
  acf(x, lag.max=15, plot=TRUE)
})

#Blue is the 95% CI around zero, different from zero correlation
```
Cross-correlation of weather and number of individuals with AGG in July
```{r}



```




# 2017 June 2 for NCAR
```{r}

uniqclim <- unique(asmi.c[,c("Year","tmin","tmax","Precip")])
clim_agg <- merge(uniqclim, ps.asmi, by = "Year")


library(reshape2)
clim_agg_long <- melt(clim_agg[,c(1:6,8)], measure.vars = c("tmin","tmax","Precip","Total.Alive"))
levels(clim_agg_long$variable) <- c("Minimum temperature","Maximum temperature",
                                    "Precipitation (mm)","Individuals per plot")

ggplot(clim_agg_long[clim_agg_long$variable%in% c("Precipitation (mm)","Individuals per plot") & clim_agg_long$Site>3,], 
       aes(Year, value))+
#  geom_point()+
  stat_smooth(alpha=0.5)+
  facet_wrap(~variable, scales="free", ncol=1)+
  theme_bw()

```

```{r}
ggplot(clim_agg_long[clim_agg_long$variable%in% c("Minimum temperature","Individuals per plot") & clim_agg_long$Site>3,], 
       aes(Year, value))+
#  geom_point()+
  stat_smooth(alpha=0.5)+
  facet_wrap(~variable, scales="free", ncol=1)+
  theme_bw()
```

```{r}
ggplot(clim_agg_long[clim_agg_long$Site>3,], 
       aes(as.factor(Year), value))+
#  geom_point()+
  stat_smooth(alpha=0.5)+
  geom_boxplot()+
  facet_wrap(~variable, scales="free", ncol=1)+
  theme_bw()
```


# Annual precipiation average per year
```{r}
creekyear.avg <- aggregate(Precip~Creek+Prev12+Month, data = asmi.c[asmi.c$Year > 1994,], mean)
creekyear <- aggregate(Precip~Creek+Prev12, data = creekyear.avg, sum)

#ppt mm
mean(creekyear$Precip[creekyear$Creek == "Cebolla"])
mean(creekyear$Precip[creekyear$Creek == "South Beaver"])
mean(creekyear$Precip)
```



#PCA what split mast seeding years, high domrant individuals (not AGG), and percent reproductive     


2013 report: winter temp, spring/summer temp - both PCs, all split   
2014 report: winter precip, fall precip, spring/summer precip - both PCs, all split     
2015 report: PC1: fall precip, winter min temp, spring/summer precip    
             PC2: fall min, fall max, winter precip - mast seeding    
2016 report: PC1: fall max temp, spring/summer min temp - nothing split   
             PC2: fall min temp, fall precip, winter precip winter max temp    
2017 report: PC1: fall min fall max    
             PC2: fall precip, winter precip   nobody separated   
             




Seasons    
Winter: December-March (12-3)    
Spring/summer: April-July (4-7)    
Fall: August-November (8-11)   

ENM uses 75% correlated as cutoff.. what if I increased from 50% to 75%??
```{r}
#cutoff <- 0.49
cutoff <- 0.65
#cutoff <- 0.75

cor.table<-cor(season[,-(1:2)])
data <- as.data.frame(as.table(cor.table))
combins <- combn(colnames(cor.table),2,FUN=function(x) paste(x,collapse="_"))
cor.data <- data[data$Var1 != data$Var2, ]
data <- cor.data[paste(cor.data$Var1, cor.data$Var2, sep="_") %in% combins,]

#pick one that explains more variation of the pairs that are highly correlated to exclude.
#Splitting by year so that's the Y? which describes each year best?
lmall <- as.formula(paste("Prev12 ~",
                          paste(names(season[,-c(1:2)]), collapse="+")))
coefout <- summary(do.call("lm", list(lmall, quote(season))))$coefficients

#coefout[order(coefout[,4]),]
# exclude the onze with the larger p-value
excludeworse <- data[abs(data$Freq)>cutoff,]
coefout <- data.frame(name = row.names(coefout),coefout)
coefout$name <- as.character(coefout$name)
exclude <- apply(excludeworse, 1, function(row){
  badone <- coefout$name[coefout$Pr...t.. == 
                               max(coefout$Pr...t..[coefout$name==row[1]],
                                   coefout$Pr...t..[coefout$name==row[2]])]
  badone
})
 

#Which are correlated? 
data[abs(data$Freq)>cutoff,]

tomatch <- c("Creek","Prev12",exclude)

# take everything other than Creek, Prev12, and the ones with the worse P.val
forpca <- season[,c(grep(paste(tomatch, collapse="|"),
                            names(season), value=TRUE, invert=TRUE))]
names(forpca)
```

#Environmental Data
T-tests for Creek from old PCA figures
```{r}
asmi.pca <- princomp(forpca,cor=TRUE)
summary(asmi.pca)
asmi.load <- loadings(asmi.pca)
asmi.pc <- predict(asmi.pca)

asmi.pc <- data.frame(asmi.pc,season)

t.test(Comp.1~Creek, data=asmi.pc)
t.test(Comp.2~Creek, data=asmi.pc)

write.csv(asmi.load, file=paste(savepath,"Table6_PCA.csv"), row.names=TRUE, 
          col.names = TRUE)


```

# South Beaver Creek
# FRUIT
Take highest 3 loadings and look at how one affects the other 
```{r}
ps.asmi.t$Creek[ps.asmi.t$Site > 4] <- "South Beaver"
ps.asmi.t$Creek[ps.asmi.t$Site < 3] <- "Cebolla"

asmi.env <- merge(season, ps.asmi.t, by.x = c("Creek","Prev12"), by.y = c("Creek","Year"))

comp1 <- sort(abs(asmi.load[,1]))[(length(asmi.load[,1])-2):length(asmi.load[,1])]

comp2 <- sort(abs(asmi.load[,2]))[(length(asmi.load[,2])-2):length(asmi.load[,2])]
```



# Cebolla [1] and South Beaver Creek [2]
```{r}
LevelsComps <- do.call(rbind, lapply(1:3, function(x){
  MidL <- unique(ave(season[,names(comp1[x])],season$Creek)) -
    aggregate(season[,names(comp1[x])],by = list(season$Creek), sd)$x
  MidH <- unique(ave(season[,names(comp1[x])],season$Creek)) +
    aggregate(season[,names(comp1[x])],by = list(season$Creek), sd)$x
  Mid <- unique(ave(season[,names(comp1[x])],season$Creek))
  comp1 <- data.frame(Creek = aggregate(season[,names(comp1[x])],
                                        by = list(season$Creek), sd)$Group.1, 
                      Comp = "Comp1",
                      Variable = paste(names(comp1[x])), 
                      MidL, MidH, Mid)
  MidL2 <- unique(ave(season[,names(comp2[x])],season$Creek)) -
    aggregate(season[,names(comp2[x])],by = list(season$Creek), sd)$x
  MidH2 <- unique(ave(season[,names(comp2[x])],season$Creek)) +
    aggregate(season[,names(comp2[x])],by = list(season$Creek), sd)$x
  Mid2 <- unique(ave(season[,names(comp2[x])],season$Creek))
  comp2 <- data.frame(Creek = aggregate(season[,names(comp2[x])],
                                        by = list(season$Creek), sd)$Group.1,
                      Comp = "Comp2",
                      Variable = paste(names(comp2[x])), 
                      MidL = MidL2, MidH = MidH2, Mid = Mid2)
  out <- rbind(comp1,comp2)
}))

LevelsComps

```


```{r}
for(j in 1:nrow(LevelsComps)){
  x <- LevelsComps[j,]
  asmi.envC1above <- asmi.env[asmi.env[[unlist(x[3])]] > x[6],]
  asmi.envC1below <- asmi.env[asmi.env[[unlist(x[3])]] <= x[6],]
  
  for(i in names(comp1)){
    
    jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/",i,unlist(x[1]),"LmComps.jpg", sep = ""),
         units = "mm", res = 300, height = 81.03, width = 86.87)
    
    print(ggplot(asmi.envC1above[asmi.envC1below[["Creek"]] == as.character(unlist(x[1])),],
                 aes(asmi.envC1above[asmi.envC1below$Creek == paste(unlist(x[1])),i],
                     Total.Fruit)) +
            geom_point()+
            ylab("Total Fruit")+
            xlab(paste(i))+
            ggtitle(paste(unlist(x[1]),": Above average", paste(unlist(x[3]))))+
            stat_smooth(method = "lm")+
            theme_bw())
    
    dev.off()
  }
  rm(asmi.envC1above,asmi.envC1below)
}



```


# Cebolla [1] and South Beaver Creek [2]
Above and below mean [1] with [2]
```{r}
# per levels of:
names(comp1[1])
lmFruit <- lm(Total.Fruit[asmi.env[names(comp1[1])] > Mid[2]] ~ 
                asmi.env[asmi.env[,names(comp1[1])] > Mid[2],names(comp1[2])],
              data = asmi.env[asmi.env[,names(comp1[1])] > Mid[2] & 
                                asmi.env$Creek == "South Beaver",])

asmi.envC1above <- asmi.env[asmi.env[,names(comp1[1])] > Mid[2] &
                              asmi.env$Creek == "South Beaver",]

# examine variation in:
names(comp1[2])
ggplot(asmi.envC1above, aes(asmi.envC1above[,names(comp1[2])],
                            Total.Fruit)) +
  geom_point()+
  ylab("Total Fruit")+
  xlab(paste(names(comp1[2])))+
  ggtitle(paste("Above average", names(comp1[1])))+
  stat_smooth(method = "lm")
  
summary(lmFruit)


```

```{r}
names(comp1[2])
lmFruit <- lm(Total.Fruit[asmi.env[names(comp1[1])] <= Mid[2]] ~ 
                asmi.env[asmi.env[,names(comp1[1])] <= Mid[2],names(comp1[2])],
              data = asmi.env[asmi.env[,names(comp1[1])] <= Mid[2] & 
                                asmi.env$Creek == "South Beaver",])

asmi.envC1below <- asmi.env[asmi.env[,names(comp1[1])] <= Mid[2] &
                              asmi.env$Creek == "South Beaver",]

ggplot(asmi.envC1below, aes(asmi.envC1below[,names(comp1[2])],
                            Total.Fruit)) +
  geom_point()+
  ylab("Total Fruit")+
  xlab(paste(names(comp1[2])))+
  ggtitle(paste("Above average", names(comp1[1])))+
  stat_smooth(method = "lm")
  
summary(lmFruit)


```

#High [1] with [1]
```{r}
names(comp1[1])
lmFruit <- lm(Total.Fruit[asmi.env[names(comp1[1])] > MidH] ~ 
                asmi.env[asmi.env[,names(comp1[1])] > MidH,names(comp1[1])],
              data = asmi.env[asmi.env[,names(comp1[1])] > MidH,])

ggplot(asmi.env[asmi.env[,names(comp1[1])] > MidH,], 
       aes(asmi.env[asmi.env[,names(comp1[1])] > MidH,names(comp1[1])],
           Total.Fruit[asmi.env[names(comp1[1])] > MidH])) +
  geom_point()+
  ylab("Total Fruit")+
  xlab(paste(names(comp1[1])))+
  ggtitle(paste("High", names(comp1[1])))+
  stat_smooth(method = "lm")
  


summary(lmFruit)
```

#Middle  [1] with [1]
```{r}
lmFruit.mid <- lm(Total.Fruit[asmi.env[names(comp1[1])] <= MidH &
                              asmi.env[names(comp1[1])] >= MidL] ~ 
                asmi.env[asmi.env[,names(comp1[1])] <= MidH &
                          asmi.env[names(comp1[1])] >= MidL,names(comp1[1])],
              data = asmi.env[asmi.env[,names(comp1[1])] > MidH &
                          asmi.env[names(comp1[1])] >= MidL,])

ggplot(asmi.env[asmi.env[,names(comp1[1])] <= MidH &
                              asmi.env[names(comp1[1])] >= MidL,], 
       aes(asmi.env[asmi.env[,names(comp1[1])] <= MidH &
                              asmi.env[names(comp1[1])] >= MidL,names(comp1[1])],
           Total.Fruit[asmi.env[names(comp1[1])] <= MidH &
                              asmi.env[names(comp1[1])] >= MidL])) +
  geom_point()+
  ylab("Total Fruit")+
  xlab(paste(names(comp1[1])))+
  ggtitle(paste("High", names(comp1[1])))+
  stat_smooth(method="lm", formula = y~x)
```
#Low [1] with [1]
```{r}
lmFruit <- lm(Total.Fruit[asmi.env[names(comp1[1])] < MidL] ~ 
                asmi.env[asmi.env[,names(comp1[1])] < MidL,names(comp1[1])],
              data = asmi.env[asmi.env[,names(comp1[1])] < MidL,])

ggplot(asmi.env[asmi.env[,names(comp1[1])] < MidL,], 
       aes(asmi.env[asmi.env[,names(comp1[1])] < MidL,names(comp1[1])],
           Total.Fruit[asmi.env[names(comp1[1])] < MidL])) +
  geom_point()+
  ylab("Total Fruit")+
  xlab(paste(names(comp1[1])))+
  ggtitle(paste("High", names(comp1[1])))+
  stat_smooth(method="lm", formula = y~x)

```




```{r}
summary(asmi.pca)
PoV <- asmi.pca$sdev^2/sum(asmi.pca$sdev^2)


    jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/","Fig7a.jpg", sep = ""),
         units = "mm", res = 300, height = 181.03, width = 186.87)


ggplot(asmi.pc, aes(Comp.1,Comp.2, colour = Creek))+
  geom_point()+
  stat_ellipse()+
  theme_bw()+
  xlab(paste("PC1 (",round(PoV[1],2)*100,"%)",sep=""))+
  ylab(paste("PC2 (",round(PoV[2],2)*100,"%)",sep=""))+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.justification=c(0,1), legend.position=c(0,1),
        legend.background = element_rect(fill=alpha('white', 0.1)))+
  scale_color_manual("Drainage", 
                     labels = c("Cebolla Creek","South Beaver Creek"), 
                     values = c("darkseagreen","black")) 

dev.off()
  

```


```{r}

percentAGG <- do.call(rbind,lapply(unique(ps.asmi.t$Year),function(x){
  thisyear <- ps.asmi.t[ps.asmi.t$Year==x & ps.asmi.t$Site>3,]
  percentalive <- sum(thisyear$Total.Alive)/sum(thisyear$Total.Plants)
  out <- data.frame(percentalive,year=x)
  out
}))

percentAGGCebollaandBeaver <- do.call(rbind,lapply(unique(ps.asmi.t$Year),function(x){
  thisyear <- ps.asmi.t[ps.asmi.t$Year==x,]
  percentalive <- sum(thisyear$Total.Alive)/sum(thisyear$Total.Plants)
  out <- data.frame(percentalive,year=x)
  out
}))

#Total.Plants - AGG and dormant
AGGDorm <- summarySE(ps.asmi.t, measurevar="Total.Plants",
                     groupvars=c("Fence","Year","Site","Creek"))
#Total.Alive - AGG
AGG <- summarySE(ps.asmi.t, measurevar="Total.Alive",
                 groupvars=c("Fence","Year","Site","Creek"))

#Total.Fruit
Fruit <- summarySE(ps.asmi.t, measurevar="Total.Fruit",
                   groupvars=c("Fence","Year","Site","Creek"))

#X..Flowered - %flowered
Repro <- summarySE(ps.asmi.t, measurevar="X..Flowered",
                   groupvars=c("Fence","Year","Site","Creek"))

```


 Figure 8    
AGG and Dormant  
South Beaver Creek    
+
  geom_rect(aes(xmin=2005.75,xmax=2015.5,ymin=0,ymax=75),
                    fill="gray80", alpha=0.01) 
```{r}

    jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/","Fig8b.jpg", sep = ""),
         units = "mm", res = 300, height = 181.03, width = 186.87)


ggplot(ps.asmi.t[ps.asmi.t$Total.Plants>0 & ps.asmi.t$Year > 1995 & 
                 ps.asmi.t$Year < currentyr & ps.asmi.t$Creek == "South Beaver",], 
       aes(Year, Total.Plants, shape = Fence, colour = Fence))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("Average AGG and dormant")+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75, lty =3)+      # Fencing put in, removed after 2015 census
  geom_vline(xintercept = 2006.75, lty = 4)+
  geom_vline(xintercept = 2015.5, lty =3) +
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.justification=c(0,0), legend.position=c(0,0),  #bottom left
        legend.background = element_rect(fill=alpha('white', 0.1)))

dev.off()
  
```

Cebolla  
```{r}


    jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/","Fig8b-Cebolla.jpg", sep = ""),
         units = "mm", res = 300, height = 181.03, width = 186.87)


ggplot(ps.asmi.t[ps.asmi.t$Total.Plants>0 & ps.asmi.t$Year > 2013 & 
                 ps.asmi.t$Year < currentyr & ps.asmi.t$Creek == "Cebolla",], 
       aes(Year, Total.Plants, shape = as.factor(Site), colour = as.factor(Site)))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.05),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.05),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("Average AGG and dormant per Site")+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Site",
                     values=c("#000000","#7e7e7e"),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_shape_manual("Site",
                     values=c(1,2),
                     labels = c("Cebolla Mid","Cebolla North"))+
  theme(legend.justification=c(1,0), legend.position=c(1,0)) +
  scale_y_continuous(limits = c(0,68)) +
  scale_x_continuous(breaks = c(2014:currentyr-1))
  
dev.off()
```

#Gina Gleene suggestion   
log transformed! 
```{r}
ps.asmi1 <- ps.asmi[ps.asmi$Site<3 & ps.asmi$Year>2013 | ps.asmi$Site>4,]

# added plots 238 (site 26) and 300 (site 19) in 1996
# added 598 (site 26) in 2004 
ps.asmi1 <- ps.asmi1[!(ps.asmi1$Plot == 238 & ps.asmi1$Year < 1996),]
ps.asmi1 <- ps.asmi1[!(ps.asmi1$Plot == 300 & ps.asmi1$Year < 1996),]
ps.asmi1 <- ps.asmi1[!(ps.asmi1$Plot == 598 & ps.asmi1$Year < 2004),]


ggplot(ps.asmi1[ps.asmi1$Total.Alive>0 & ps.asmi1$Site > 3,], 
       aes(Year, Total.Alive, colour = as.factor(Site)))+
  geom_point()+
  stat_smooth(method="lm", se=TRUE, alpha=0.1)+
#  geom_ribbon(stat='smooth', method = "lm", se=TRUE, alpha=0.1, 
#              aes(color = NULL, group = factor(Site))) + 
  geom_line(stat='smooth', method = "lm", alpha=0.3)+
  theme_bw() +
  ylab("Average AGG per Site")+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75)+
  geom_vline(xintercept = 2015.5)+
  geom_vline(xintercept = 2006.75, lty = 4)+
  theme(legend.justification=c(1,1), legend.position=c(1,1),
        legend.background = element_rect(fill=alpha('white', 0.1)))
```

# the decline is from one plot, the rest are stable or increasing!
```{r}
ggplot(ps.asmi.t[ps.asmi.t$Total.Alive>0 & ps.asmi.t$Creek == "South Beaver",], 
       aes(Year, Total.Alive, colour = as.factor(Plot)))+
  geom_point()+
 # geom_ribbon(stat='smooth', method = "lm", se=TRUE, alpha=0.1, 
#              aes(color = NULL, group = factor(Plot))) +
  geom_line(stat='smooth', method = "lm")+
  theme_bw() +
  ylab("Average AGG per Site")+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75)+
  geom_vline(xintercept = 2006.75, lty = 4)+
  theme(legend.position="none") 

```

South Beaver
AGG
```{r}

# jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
#            currentyr,"_asmi/","Fig8a.jpg", sep = ""),
#      units = "mm", res = 300, height = 181.03, width = 186.87)


p1SBC <- ggplot(ps.asmi[ps.asmi$Total.Alive>0 & ps.asmi$Site > 3,], 
       aes(Year, Total.Alive, shape = Fence, colour = Fence))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("Average AGG per Site")+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75, lty =3)+      # Fencing put in, removed after 2015 census
  geom_vline(xintercept = 2006.75, lty = 4)+
  geom_vline(xintercept = 2015.5, lty =3) +
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.justification=c(0,0), legend.position=c(0,0),#upper right
        legend.background = element_rect(fill=alpha('white', 0.1))) 
# dev.off()

```

Cebolla
AGG
```{r}
# jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
#            currentyr,"_asmi/","Fig8a-Cebolla.jpg", sep = ""),
#      units = "mm", res = 300, height = 181.03, width = 186.87)

p1CC <- ggplot(ps.asmi[ps.asmi$Total.Alive>0 & ps.asmi$Site < 3,], 
       aes(Year, Total.Alive, shape = as.factor(Site), colour = as.factor(Site)))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.05),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.05),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("Average AGG per Site")+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Site",
                     values=c("#000000","#7e7e7e"),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_shape_manual("Site",
                     values=c(1,2),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_x_continuous(breaks = c(2014:currentyr))+
  theme(legend.justification=c(0,1), legend.position=c(0,1),
        legend.background = element_rect(fill=alpha('white', 0.1))) 

# dev.off()

```



Fruit   
South Beaver Creek
```{r}
# jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
#               currentyr,"_asmi/","Fig8c.jpg", sep = ""),
#          units = "mm", res = 300, height = 181.03, width = 186.87)

p3SBC <- ggplot(ps.asmi[ps.asmi$Total.Plants>0 & ps.asmi$Site > 3,], 
       aes(Year, Total.Fruit, shape = Fence, colour = Fence))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("Total Fruit per Site")+
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75, lty =3)+      # Fencing put in, removed after 2015 census
  geom_vline(xintercept = 2006.75, lty = 4)+
  geom_vline(xintercept = 2015.5, lty =3) +
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1),
        legend.background = element_rect(fill=alpha('white', 0.1))) #upper right
# dev.off()

```


Cebolla
```{r}

aggregate(Total.Fruit~Site+Year,data=ps.asmi[ps.asmi$Total.Plants>0 & ps.asmi$Site < 3,], mean)

aggregate(Total.Fruit~Site+Year,data=ps.asmi[ps.asmi$Total.Plants>0 & ps.asmi$Site<3,],
          std.error)

jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/","Fig8c-Cebolla.jpg", sep = ""),
         units = "mm", res = 300, height = 181.03, width = 186.87)


ggplot(ps.asmi[ps.asmi$Total.Plants>0 & ps.asmi$Site <3,], 
       aes(Year, Total.Fruit, shape = as.factor(Site), colour = as.factor(Site)))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.05),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.05),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("Total Fruit per Site")+
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Site", 
                     values=c("#000000","#7e7e7e"),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_shape_manual("Site", 
                     values=c(1,2),
                     labels = c("Cebolla Mid","Cebolla North"))+
  theme(legend.justification=c(0,1), legend.position=c(0,1),
        legend.background = element_rect(fill=alpha('white', 0.1)))+
  scale_x_continuous(breaks = c(2014:currentyr))

dev.off()
```
  
  
X..Flowered - Percent Reproductive
```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/","Fig8d.jpg", sep = ""),
         units = "mm", res = 300, height = 181.03, width = 186.87)


ggplot(ps.asmi.t[ps.asmi.t$Total.Plants>0 & ps.asmi.t$Creek == "South Beaver",], 
       aes(Year, X..Flowered, shape = Fence, colour = Fence))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("% Reproductive per Site")+
  ggtitle("d)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75, lty =3)+      # Fencing put in, removed after 2015 census
  geom_vline(xintercept = 2006.75, lty = 4)+
  geom_vline(xintercept = 2015.5, lty =3) +
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1),  #bottom left
        legend.background = element_rect(fill=alpha('white', 0.1))) #upper right

dev.off()
```

Cebolla
```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/","Fig8d-Cebolla.jpg", sep = ""),
         units = "mm", res = 300, height = 181.03, width = 186.87)

ggplot(ps.asmi[ps.asmi$Total.Plants>0 & ps.asmi$Site<3,], 
       aes(Year, X..Flowered, shape = as.factor(Site), colour = as.factor(Site)))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.05),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.05),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("% Reproductive per Site")+
  ggtitle("d)") +
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Site",
                     values=c("#000000","#7e7e7e"),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_shape_manual("Site",
                     values=c(1,2),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_x_continuous(breaks = c(2014:currentyr))+
  theme(legend.justification=c(0,1), legend.position=c(0,1),
        legend.background = element_rect(fill=alpha('white', 0.1))) #upper right

dev.off()
```






Figure 7
```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/","Fig7-SouthBeaverCreek.jpg", sep = ""),
         units = "mm", res = 300, height = 181.03*2, width = 186.87*2)

# Down each column
multiplot(p1SBC, p3SBC, p2SBC, p4SBC)

dev.off()


```


Going to skip this after 2016 since know that plants aren't below ground the whole season, not as much a quesiton of using this to figure out how much dormancy - dormancy = not AGG in July

### Years alive    
```{r}
dormyrs <- currentyr-1995

path <- paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,
              "_asmi/", collapse = '', sep = '')

#If a plant is still alive in the current year, there is no years alive calculated
yrsalive <- lapply(1:dormyrs, function(x){ 
  path2 <- paste(path, "YrsAlive_dormant", x, ".csv", sep = "")
  ysal <- read.csv(path.expand(path2), na.strings="na")
  ysal <- cbind(ysal, YrsD = x)
  ysal[complete.cases(ysal),]
  })

head(yrsalive[[4]])

```

```{r}
sumYrsAlive <- lapply(yrsalive, function(x){
  summarySE(x[complete.cases(x),], measurevar="Yearsalive",groupvars="YrsD")
})

smya <- do.call(rbind, sumYrsAlive)
```

Of the 797 individuals alive in South Beaver Creek in 1995 ...
```{r}

lifelength <- do.call(rbind, yrsalive)


mean(lifelength$Yearsalive[lifelength$YrsD < 8]) #2.5
mean(lifelength$Yearsalive)
```

Dormancy    
repeat lengths   
```{r}
# how many individuals are dormant at some point
ind_dorm <- do.call(rbind,lapply(split(asmi.raw,asmi.raw$AsMi_tag_id), function(x){
  if(length(grep("dormant",x$status))>0){
    data.frame(Site = unique(x$AsMi_site_id), 
               Fence = unique(x$fence), 
               Plot = unique(x$AsMi_plot_id), 
               Dorm = 1)
  } else {
    data.frame(Site = unique(x$AsMi_site_id), 
               Fence = unique(x$fence), 
               Plot = unique(x$AsMi_plot_id), 
               Dorm = 0)
    }
  }))

perc_ind_dorm <- aggregate(Dorm~Site+Plot+Fence, data=ind_dorm,
                           function(x) sum(x)/length(x))

#percent dormant individuals by site
aggregate(Dorm~Site, data=ind_dorm, function(x) sum(x)/length(x))
#percent individuals with any length of dormancy from SBC
sum(perc_ind_dorm$Dorm[perc_ind_dorm$Site>3])/length(perc_ind_dorm$Dorm[perc_ind_dorm$Site>3])



#in Raw, #2 is dormant
# 
# dorms <- do.call(c,lapply(unique(asmi.raw$AsMi_tag_id), function(x){
#   tag <- asmi.raw[asmi.raw$AsMi_tag_id == x,]
#   dormlns <- rle(as.numeric(tag$status))$lengths[rle(as.numeric(tag$status))$values==2]
#   dormlns
# }))

#dorms <- rle(as.numeric(asmi.2$stage))$lengths[rle(as.numeric(asmi.2$stage))$values ==4]
max(dorms) #21

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

Mode(dorms) #1
length(dorms[dorms==1]) #441
length(dorms[dorms==1])/length(dorms) #41.9%
length(dorms[dorms == max(dorms)]) # 13 with 21 years

```

#SKIP!
Figure 3: Was: Average life span of Astragalus microcymbus (with one standard error from the mean) given consecutive assumptions on length of possible whole plant dormancy. (b) Distribution of consecutive years of dormancy when dormancy is not limited.  
```{r}
ggplot(smya, aes(YrsD, Yearsalive))+
#  stat_smooth()+
  geom_errorbar(aes(ymin=Yearsalive-se, ymax=Yearsalive+se), 
                width=1) +
  theme_bw()+
  xlab("Maximum years dormant")+
  ylab("Life length")+
  scale_y_continuous(breaks = seq(2, 4, .5), limits = c(2.3, 3.8)) 

```

#Episodic fruit production paragraph   
```{r}
noreproductiveyears <- aggregate(flower~AsMi_site_id+year, data=asmi.raw,
                                 function(x) if(sum(x)>0){
                                   1
                                 } else {
                                   0
                                 })

ggplot(noreproductiveyears, aes(year,flower,colour=as.factor(AsMi_site_id)))+
  geom_point()+
  facet_grid(~AsMi_site_id)

#how many years are there no reproductive indiviudals per site
1-aggregate(flower~AsMi_site_id, data=noreproductiveyears,
          function(x) sum(x)/length(x))

#On average, no reproductive individuals how many years?  in 2016
mean(c(1-aggregate(flower~AsMi_site_id,
                   data=noreproductiveyears[noreproductiveyears$year<2017,],
          function(x) sum(x)/length(x))[-(1:2),2]))*(length(1995:(currentyr-1)))

#On average, no reproductive individuals how many years?  in current year
mean(c(1-aggregate(flower~AsMi_site_id, data=noreproductiveyears,
          function(x) sum(x)/length(x))[-(1:2),2]))*(length(1995:currentyr))

#Number of years of no reproductive for South Beaver Creek (not correct for Cebolla)
length(1995:currentyr)-aggregate(flower~AsMi_site_id, data=noreproductiveyears,sum)
```

#Plot summary for demographic data per year

# Old, not doing PCA anymore!!
Figure 7: Principal component analysis of nine environmental factors separating yearly demographic data on Astragalus microcymbus within the South Beaver Creek drainage near Gunnison, CO. Blue points are mast seeding years (top left), years with greater than the average reproductive individuals per plot (17%; top right), and years with greater than 28% dormant plants per plot (bottom) excluding the first and last years of the study, 1995 and 2015 (shown in gray). 
```{r}
# fruit above a SE above
avgfruit <- aggregate(Total.Fruit ~ Creek, data = ps.asmi.t, mean)
SEfruit <- aggregate(Total.Fruit ~ Creek, data = ps.asmi.t, std.error)
avgfruit[,2]+SEfruit[,2]
#make column that is 1 if more than average total fruit that year, 0 if less than average
pcafruit <- aggregate(Total.Fruit ~ Year, 
                      data = ps.asmi.t[ps.asmi.t$Creek == "South Beaver",], function(x){
  if(mean(x) > avgfruit$Total.Fruit[avgfruit$Creek == "South Beaver"]){
    1
    }else{
      0
      }
  })

# percent reproductive
avgfl <- aggregate(X..Flowered ~ Creek, data = ps.asmi.t, mean)
SEfl <- aggregate(X..Flowered ~ Creek, data = ps.asmi.t, std.error)
avgfl[,2]+SEfl[,2]
pcarepro <- aggregate(X..Flowered ~ Year, 
                      data = ps.asmi.t[ps.asmi.t$Creek == "South Beaver",], function(x){
  if(mean(x) > avgfl$X..Flowered[avgfl$Creek == "South Beaver"]){
    1
    }else{
      0
      }
  })

# percent dormant
avgdorm <- aggregate(((Total.Plants-Total.Alive)/Total.Plants) ~ Creek, data = ps.asmi.t, mean)
SEdorm <- aggregate(((Total.Plants-Total.Alive)/Total.Plants) ~ Creek, data = ps.asmi.t, std.error)
avgdorm[,2]+SEdorm[,2]
pcadorm <- aggregate(((Total.Plants-Total.Alive)/Total.Plants) ~ Year, 
                      data = ps.asmi.t[ps.asmi.t$Creek == "South Beaver",], function(x){
  if(mean(x) > 
     avgdorm$`((Total.Plants - Total.Alive)/Total.Plants)`[avgdorm$Creek == "South Beaver"]){
    1
    }else{
      0
      }
  })
pcadorm[pcadorm$Year == 1995 | pcadorm$Year == currentyr,2] <- 2


ps.pc <- data.frame(asmi.pc[asmi.pc$Creek == "South Beaver",], 
                    Fruit = pcafruit$Total.Fruit,
                    Repro = pcarepro$X..Flowered,
                    PerDorm = pcadorm[,2])


ps.pc.2 <- merge(ps.asmi.t, asmi.pc, by.x = c("Creek","Year"), by.y = c("Creek","Prev12"))

```

T.tests for PCA
```{r}
t.test(Comp.2~Fruit, data = ps.pc)
t.test(Comp.2~PerDorm, data = ps.pc[ps.pc$Prev12 > 1995 & ps.pc$Prev12 < currentyr,])

t.test(Comp.1~Fruit, data = ps.pc)
t.test(Comp.1~PerDorm, data = ps.pc[ps.pc$Prev12 > 1995 & ps.pc$Prev12 < currentyr,])

```


#South Beaver Creek Only
```{r t-tests}
# Reproductive not signficantly different
avgfl$X..Flowered[avgfl$Creek == "South Beaver"]
t.test(Comp.1 ~ as.factor(Repro), data = ps.pc)
t.test(Comp.2 ~ as.factor(Repro), data = ps.pc)

# Mast Seeding
#mast seeding years
ps.pc$Prev12[ps.pc$Fruit ==1]
#defined as above:
avgfruit$Total.Fruit[avgfruit$Creek == "South Beaver"]
t.test(Comp.1 ~ as.factor(Fruit), data = ps.pc)
t.test(Comp.2 ~ as.factor(Fruit), data = ps.pc)
t.test(Comp.3 ~ as.factor(Fruit), data = ps.pc)

# Dormant
 avgdorm$`((Total.Plants - Total.Alive)/Total.Plants)`[avgdorm$Creek == "South Beaver"]
t.test(Comp.1 ~ as.factor(PerDorm), data = ps.pc[ps.pc$Prev12 > 1995 & ps.pc$Prev12 < currentyr,])
t.test(Comp.2 ~ as.factor(PerDorm), data = ps.pc[ps.pc$Prev12 > 1995 & ps.pc$Prev12 < currentyr,])
```


Souht Beaver Creek
Percent reproductive
```{r fruit}

jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/","Fig7c.jpg", sep = ""),
         units = "mm", res = 300, height = 181.03, width = 186.87)



ggplot(ps.pc, aes(Comp.1, Comp.2, colour = as.factor(Repro), label = Prev12))+
  geom_text(alpha = 0.75, angle = 45, size = 3) +
  stat_ellipse()+
  xlab(paste("PC1 (",round(PoV[1],2)*100,"%)",sep=""))+
  ylab(paste("PC2 (",round(PoV[2],2)*100,"%)",sep=""))+
  theme_bw()+
  ggtitle("c)")+
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Percent Reproductive", 
                     labels = c(paste("<=", round(avgfl[2,2],2)*100,"%",sep=""),
                                paste(">", round(avgfl[2,2],2)*100,"%",sep="")), 
                     values = c("grey50","black"))+
  theme(legend.justification=c(0,0), legend.position=c(0,0),
        legend.background = element_rect(fill=alpha('white', 0.1)))

dev.off()
```

Mast seeding
```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/","Fig7b.jpg", sep = ""),
         units = "mm", res = 300, height = 181.03, width = 186.87)

ggplot(ps.pc, aes(Comp.1, Comp.2, colour = as.factor(Fruit), label = Prev12))+
  geom_text(alpha = 0.75, angle = 45, size = 3) +
  stat_ellipse()+
  xlab(paste("PC1 (",round(PoV[1],2)*100,"%)",sep=""))+
  ylab(paste("PC2 (",round(PoV[2],2)*100,"%)",sep=""))+
  theme_bw()+
  ggtitle("b)")+
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Mast Seeding", labels = c("Low/No Seed","Mast"), values = c("grey50","black"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1),
        legend.background = element_rect(fill=alpha('white', 0.1))) 
dev.off()
  
```

Percent dormant
```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/","Fig7d.jpg", sep = ""),
         units = "mm", res = 300, height = 181.03, width = 186.87)


ggplot(ps.pc, aes(Comp.1, Comp.2, colour = as.factor(PerDorm), label = Prev12))+
  geom_text(alpha = 0.75, angle = 45, size = 3) +
  stat_ellipse()+
  xlab(paste("PC1 (",round(PoV[1],2)*100,"%)",sep=""))+
  ylab(paste("PC2 (",round(PoV[2],2)*100,"%)",sep=""))+
  theme_bw()+
  ggtitle("d)")+
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Percent Dormant", 
                     labels = c(paste("<=", round(avgdorm[2,2],2)*100,"%",sep=""),
                                paste(">", round(avgdorm[2,2],2)*100,"%",sep="")), 
                     values = c("grey50","black","red"))+
  theme(legend.justification=c(0,0), legend.position=c(0,0),
        legend.background = element_rect(fill=alpha('white', 0.1)))
dev.off()
```

Environmental Data    
try using same variables as in 2014   
```{r}
exclude14 <- c("tmin.fall","tmax.fall","tmax.spring/summer","tmax.winter")
tomatch14 <- c("Creek","Prev12",exclude14)

forpca14 <- season[,c(grep(paste(tomatch14, collapse="|"),
                            names(season), value=TRUE, invert=TRUE))]
names(forpca14)

asmi.pca14 <- princomp(forpca14,cor=TRUE)
summary(asmi.pca14)
asmi.load14 <- loadings(asmi.pca14)
asmi.pc14 <- predict(asmi.pca14)

asmi.pc14 <- data.frame(asmi.pc14,season)
```

```{r}

asmi.c$season <- "winter"
asmi.c[asmi.c$Month>3 & asmi.c$Month<8, "season"] <- "springSummer"
asmi.c[asmi.c$Month>7 & asmi.c$Month<12, "season"] <- "fall"

asmi.c.summary <- aggregate(asmi.c[,names(asmi.c) %in% 
                                     grep(paste(c("tmin","tmax","Precip"),collapse="|"),
                                          names(asmi.c), value=TRUE)], 
                            asmi.c[,c("season","Creek","Prev12")],
                            FUN = function(x) mean(x, na.rm = TRUE))

head(asmi.c.summary)

# currentyr-1? should it just be currentyr? or not less than currentyr? 
season <- reshape(asmi.c.summary[asmi.c.summary$Prev12 < currentyr+1 & asmi.c.summary$Prev12 > 1994,],
                  idvar=c("Creek","Prev12"),
                  timevar = "season",
                  direction="wide")
head(season)

```

#Intraannual visits
### Intraannual visits    
Will want to ignore sites that were not visited - deal with differently than plants that were not seen but are also NA      
### What is the most common stage class of individuals that were dormant for some portion of the growing season? 

```{r}
intra <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Raw Data/2015 datasheets/2015_intrayear_asmi.csv"), na.strings="")

intra$UniqueID <- 1:nrow(intra)

demo.only <- intra[,-c(1:7,13,99:100)]
names(demo.only)

# need to name the same before binding...
surname <- names(demo.only[,grep("Ln",names(demo.only))])

demo.only.bydate <- lapply(1:18, function(x){
  df <- data.frame(intra[,c(1:7,13,99:100)], demo.only[,((5*x-4):(5*x))],Survey = surname[x])
  names(df) <- c(names(intra[,c(1:7,13,99:100)]), "Ln","Fl","Fr","Br","Comment","Survey")
  df[!is.na(df$Ln),]
})

head(demo.only.bydate[[15]])

dm <- do.call(rbind, demo.only.bydate)

dm$Site[dm$Plot <= 610 & dm$Plot >= 606] <- "5"
dm$Site[dm$Plot == 8 | dm$Plot == 578 | dm$Plot == 581 | dm$Plot == 799] <- "15"
dm$Site[dm$Plot == 300 | dm$Plot <= 515 & dm$Plot >= 512] <- "19"
dm$Site[dm$Plot == 238 | dm$Plot == 480 |
          dm$Plot == 598 | dm$Plot == 611 | dm$Plot == 614] <- "26"
dm$Site[dm$Plot == 22 | dm$Plot == 1 | dm$Plot == 32 | dm$Plot == 42
        | dm$Plot == 52 ] <- "Cebolla Mid"

dm$Site[dm$Plot == 16 | dm$Plot == 96 | dm$Plot == 58
        | dm$Plot == 89 | dm$Plot == 98 | dm$Plot == 90 ] <- "Cebolla North"

sites <- c("5","15","19","26","Cebolla Mid","Cebolla North")
dm$Site <- ordered(dm$Site, levels = sites)

#May1 moved to 2014 order from 2015
levels(dm$Survey) <- c(sapply(c(substr(levels(dm$Survey)[1:5],3,6),
                       substr(levels(dm$Survey)[6],3,7),
                       substr(levels(dm$Survey)[7:9],3,6)),paste0, "_2014"),
                       sapply(c(substr(levels(dm$Survey)[10],3,6),
                       substr(levels(dm$Survey)[11],3,7),
                       substr(levels(dm$Survey)[12:13],3,6),
                       substr(levels(dm$Survey)[14],3,7),
                       substr(levels(dm$Survey)[15:18],3,6)),paste0, "_2015"))


#Add actual date to surveys
table(dm$Survey)
dm$Date <- as.Date("2014-04-21")
dm$Date[dm$Survey=="May1_2014"] <- as.Date("2014-05-13")
dm$Date[dm$Survey=="Jun1_2014"] <- as.Date("2014-06-02")
dm$Date[dm$Survey=="Jun2_2014"] <- as.Date("2014-06-25")
dm$Date[dm$Survey=="Jul1_2014"] <- as.Date("2014-07-15")
dm$Date[dm$Survey=="Aug14_2014"] <- as.Date("2014-08-05")
dm$Date[dm$Survey=="Sep1_2014"] <- as.Date("2014-09-07")
dm$Date[dm$Survey=="Oct1_2014"] <- as.Date("2014-10-08")
dm$Date[dm$Survey=="Oct2_2014"] <- as.Date("2014-10-28")
dm$Date[dm$Survey=="Apr2_2015"] <- as.Date("2015-04-20")
dm$Date[dm$Survey=="May11_2015"] <- as.Date("2015-05-11")
dm$Date[dm$Survey=="May2_2015"] <- as.Date("2015-05-26")
dm$Date[dm$Survey=="June_2015"] <- as.Date("2015-06-08")
dm$Date[dm$Survey=="June2_2015"] <- as.Date("2015-06-22")
dm$Date[dm$Survey=="July_2015"] <- as.Date("2015-07-22")
dm$Date[dm$Survey=="Aug1_2015"] <- as.Date("2015-08-11")
dm$Date[dm$Survey=="Sept_2015"] <- as.Date("2015-09-01")
dm$Date[dm$Survey=="Oct6_2015"] <- as.Date("2015-10-06")
table(dm$Date)

```

#Tags with growth at any time during the early or late seasons 
```{r}
tagsintrayear <- split(dm, dm$tag)
unique(dm$Survey) #aprl 2014 ... Oct6_2015

tagsintrayear[[2]]


dm$TagperPlot <- paste(dm$tag,dm$Plot,sep="_") #dm$Dir, 
asmi.raw$TagperPlot <- paste(asmi.raw$tag_no,asmi.raw$AsMi_plot_id,sep="_") #asmi.raw$direction,

head(dm)
head(table(dm$TagperPlot))

#Add rows for dm for dates when the plant wasn't seen
tagsbydate <- data.frame(table(dm$TagperPlot, dm$Date))
sort(rowSums(table(dm$TagperPlot, dm$Date))) #all were seen at least once
tagsbydate[tagsbydate$Freq==1,]
notalive2014July <- tagsbydate[tagsbydate$Var2 == "2014-07-15" & tagsbydate$Freq == 0,]
notalive2015July <- tagsbydate[tagsbydate$Var2 == "2015-07-22" & tagsbydate$Freq == 0,]



ggplot(dm[dm$TagperPlot %in% notalive2015July$Var1,], 
       aes(Date,Ln, colour=TagperPlot))+
  geom_point()+
  geom_line()+
  facet_wrap(~Site)+
  theme(legend.position = "none")

ggplot(asmi.raw[asmi.raw$TagperPlot %in% notalive2015July$Var1,],
       aes(year,length, colour=TagperPlot))+
  geom_point()+
  geom_line()+
  labs(title="Individuals with growth sometime other than July 2015")+
  facet_wrap(~AsMi_site_id)+
  theme(legend.position = "none")

#The number of individuals that were alive sometime in 2015, just not the July census
table(asmi.raw$AsMi_site_id[asmi.raw$TagperPlot %in% notalive2015July$Var1],
      asmi.raw$year[asmi.raw$TagperPlot %in% notalive2015July$Var1])

#The number of individuals that were alive sometime in 2014, just not the July census
table(asmi.raw$AsMi_site_id[asmi.raw$TagperPlot %in% notalive2014July$Var1],
      asmi.raw$year[asmi.raw$TagperPlot %in% notalive2014July$Var1])


head(asmi.raw)
head(table(asmi.raw$TagperPlot),100)


ggplot(dm[dm$Date<"2015-01-01",], aes(Date,Ln,group=as.factor(Plot), 
                                      colour=as.factor(Plot)))+
  geom_point()+
  geom_smooth(se=FALSE)+
  theme_bw()

str(dm)

# Only rows refering to cotyledons
dm.coty <- dm[grep("coty",dm$Comment),]
dm.aprcoty <- dm[dm$AprSeedlings==1,]
# dm.coty <- rbind(dm.coty,dm.aprcoty)
dm.coty$Comment <- droplevels(dm.coty$Comment)
table(dm.coty$Comment)

# Don't want
c("cotyledon of non","no cotyledons")

# dm.coty <- dm.coty[!grepl("cotyledon of non",dm.coty$Comment),]
dm.coty <- dm.coty[!grepl("no cotyledon",dm.coty$Comment),]


ggplot(dm.coty, aes(Date,Ln,colour=as.factor(Date)))+
  geom_boxplot()

table(dm$Comment[grep("coty",dm$Comment)],dm$Site[grep("coty",dm$Comment)])
```



```{r}
head(asmi.raw$TagperPlot)
head(asmi.raw)
head(dm)

dm[grep("coty", dm$Comment),]

tagsAGG <- unique(dm$tag[dm$Ln >0])
length(tagsAGG)
tagsAGG2 <- unique(dm$TagperPlot[dm$Ln >0])
length(tagsAGG2)

unique(asmi.raw$AsMi_tag_id)

head(asmi.raw)
tagsperplotperyear <- lapply( split(asmi.raw, asmi.raw$year), function(x){
  out <- data.frame(table(x$tag_no,x$AsMi_plot_id))
  out[out[,3]>1,]
  })

oopstags <- do.call(rbind,tagsperplotperyear)
oopstags

sort(unique(asmi.raw$year))

#how many double tags per plot were ones seen in intrayear surveys?  
#Need to link by tag number, plot, and distance
double.intra.tags <- unique(dm$tag[dm$tag %in% oopstags$Var1])

length(unique(asmi.raw$tag_no)) #2529
length(unique(dm$tag)) #1746

#for 2015, tag entered same, won't get tags 'fixed to 0.01 from 0.1
dm.match.raw <- lapply(1:nrow(dm),function(row){
  out <- asmi.raw[asmi.raw$AsMi_site_id==dm$Site[row]&
                    asmi.raw$AsMi_plot_id==dm$Plot[row]&
                    asmi.raw$distance==dm$Dist..m.[row]&
                                asmi.raw$year==2016,]
  })

dm.all <- do.call(rbind,dm.match.raw)
head(dm.all)

#Just tags with above ground growth in other times of the year
dm.agg <- dm[dm$Ln>0,]
dm.agg.match.raw <- lapply(1:nrow(dm.agg),function(row){
  out <- asmi.raw[asmi.raw$AsMi_site_id==dm.agg$Site[row]&
                    asmi.raw$AsMi_plot_id==dm.agg$Plot[row]&
                    asmi.raw$distance==dm.agg$Dist..m.[row],]
  })

dm.all.agg <- do.call(rbind,dm.agg.match.raw)
head(unique(dm.all.agg))
dm.all.agg <- unique(dm.all.agg)

tags.AGG <- split(dm.all.agg[dm.all.agg$length==0 & dm.all.agg$year>2015,],
                  dm.all.agg$AsMi_tag_id[dm.all.agg$length==0 & dm.all.agg$year>2015])

tags.AGG[[1]]
tags.AGG <- do.call(rbind,tags.AGG)
tags.AGG[tags.AGG$length>0,]




#tags with flowering plants
dm.flfr <- dm[dm$Fl==1,]
dm.flfr.match.raw <- lapply(1:nrow(dm.flfr),function(row){
  out <- asmi.raw[asmi.raw$AsMi_site_id==dm.flfr$Site[row]&
                    asmi.raw$AsMi_plot_id==dm.flfr$Plot[row]&
                    asmi.raw$distance==dm.flfr$Dist..m.[row],]
  })

dm.all.flfr <- do.call(rbind,dm.flfr.match.raw)
head(unique(dm.all.flfr))
dm.all.flfr <- unique(dm.all.flfr)

tags.flfr <- split(dm.all.flfr[dm.all.flfr$length==0 & dm.all.flfr$year>2015,],
                  dm.all.flfr$AsMi_tag_id[dm.all.flfr$length==0 & dm.all.flfr$year>2015])

tags.flfr[[1]]
tags.flfr <- do.call(rbind,tags.flfr)
tags.flfr[tags.flfr$length>0,]



dm[dm$tag %in% double.intra.tags,]
asmi.raw[asmi.raw$tag_no %in% double.intra.tags,]

#For dm, Survey is like year in asmi.raw 
dm.2merge <- dm[,c("X","Plot","Site","Survey","TagperPlot")] #poop, but sometimes these don't match because of a 0.1 or 0.01 difference! 

```


length over the surveys 
```{r}

ggplot(dm, aes(Survey, Ln, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_sdl', geom="errorbar", fun.args = list(mult=2))+
  facet_wrap(~Site, ncol=2)+
  theme_bw()+
  ylab("Average Length")+
  xlab("Survey")+
	theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5)) 

```

```{r}
sites <- unique(dm$Site)
plot(dm$Survey[dm$Site == sites[1]], dm$Ln[dm$Site == sites[1]])
plot(dm$Survey[dm$Site == sites[2]], dm$Ln[dm$Site == sites[2]], add=TRUE ,col="red")
plot(dm$Survey[dm$Site == sites[3]], dm$Ln[dm$Site == sites[3]], add=TRUE ,col="orange")
plot(dm$Survey[dm$Site == sites[4]], dm$Ln[dm$Site == sites[4]], add=TRUE ,col="yellow")
plot(dm$Survey[dm$Site == sites[5]], dm$Ln[dm$Site == sites[5]], add=TRUE ,col="green")
plot(dm$Survey[dm$Site == sites[6]], dm$Ln[dm$Site == sites[6]], add=TRUE ,col="blue")

```

```{r}
stripchart(Ln~Survey+Site,data=dm, 
           method="jitter",vertical=TRUE, col=1:6, pch=16,
           group.names=
             apply(expand.grid(c(paste("Site",1:6,sep="")),c(1:9,1:9)),
                   1, function(x){
                     paste(x[1],x[2])
                   }))

```


#dormancy within a season is preceded or followed by what stage class
```{r}
markrecapture <- dm
markrecapture$Mark <- 0
markrecapture$Mark[markrecapture$Ln>0] <- 1
table(markrecapture$Mark,markrecapture$Survey)

byplant <- sapply(split(markrecapture,markrecapture$UniqueID), function(x){
  table(x$Mark,x$Survey)
  })

byplantall <- do.call(rbind,byplant)
head(byplantall)

markrecapture$Stage <- "D" #dormant #only 4 rows
markrecapture$Stage[markrecapture$Ln > 0] <- "V" #vegetative
markrecapture$Stage[markrecapture$Ln > 0 & markrecapture$Fl == 1] <- "R" #Reproductive

#When you make a table, only a very few are actually marked dead, most are missing data
stagebyplant <- sapply(split(markrecapture, markrecapture$UniqueID), function(x){
  out <- table(x$Stage,x$Survey)
  if(!is.null(names(out[,1]))){
    out[1,][out[1,]==1] <- names(out[,1][1])
    if(length(names(out[,1])>1)){
      out[2,][out[2,]==1] <- names(out[,1][2])
      }
    out
    }
  })

nonullstagebyplant <- stagebyplant[!sapply(stagebyplant,is.null)]
length(which(stagebyplant[[1]][,1]!="0"))
data.frame(nonullstagebyplant[[1]])
str(data.frame(nonullstagebyplant[[1]]))

seqclass <- lapply(nonullstagebyplant, function(x){
  df <- data.frame(x)
  out <- sapply(split(df,df$Var2),function(r){
    if(nrow(r[r$Freq=="0",])==2){
      "0" 
      } else {
        as.character(r$Freq[r$Freq!="0"])
    }
      })
  out
})

seqXclass <- do.call(rbind,seqclass)

nrow(seqXclass)
##how many individuals were dormant some portion of the surveys?
seasonallydorm <- lapply(1:nrow(seqXclass),function(x){
    # if the first and last are removed from rle and there's still some lengths of dormant
    teststages <- rle(seqXclass[x,])
    teststages <- data.frame(teststages$lengths,teststages$values,tag=x)
    teststages <- teststages[-c(1,nrow(teststages)),]
    out <- teststages[teststages$teststages.values=="0",]
    out 
})

foo <- do.call(rbind,seasonallydorm)
length(unique(foo$tag))

#What is the stage before and after dormancy?
b4nafter <- lapply(1:nrow(seqXclass),function(x){
    # if the first and last are removed from rle and there's still some lengths of dormant
    teststages <- rle(seqXclass[x,])
    teststages <- data.frame(teststages$lengths,teststages$values,tag=x)
    teststages <- teststages[-c(1,nrow(teststages)),]
    before <- teststages[grep("0",teststages$teststages.values)-1,]
    after <- teststages[grep("0",teststages$teststages.values)+1,]
    out <- list(before,after)
    out
})

b4 <- do.call(rbind,lapply(b4nafter,"[[",1))
b4 <- b4[complete.cases(b4),]
aft3r <- do.call(rbind,lapply(b4nafter,"[[",2))
aft3r <- aft3r[complete.cases(aft3r),]

mean(nrow(b4[b4$teststages.values=="V",])/nrow(b4))
mean(nrow(b4[b4$teststages.values=="R",])/nrow(b4))

mean(nrow(aft3r[aft3r$teststages.values=="V",])/nrow(aft3r))
mean(nrow(aft3r[aft3r$teststages.values=="R",])/nrow(aft3r))


##Factor w/ 4 levels "0","D","R","V":
#percent of time goes from Vegetative to dormant
byplantbefore <- lapply(split(b4, b4$tag), function(x){
  nrow(x[x$teststages.values=="V",])/
    nrow(x)

})


nrow(beforeandafterstage[beforeandafterstage$outbefore=="R",])/
  nrow(beforeandafterstage)

```


Total AGG per plot per year
```{r}

#dm is any tags with some length at some point

dm$Fr <- as.numeric(dm$Fr)
dm$Fl[is.na(dm$Fl)] <- 0
dm$Fr[is.na(dm$Fr)] <- 0

#levels(dm$Site) <- gsub("Cebolla Mid", "1", levels(dm$Site))
#levels(dm$Site) <- gsub("Cebolla North", "2",levels(dm$Site))

surveys <- unique(dm$Survey)
surveys[1:9]
surveys[10:18]

dm.2014 <- dm[dm$Survey %in% surveys[1:9],]
dm.2015 <- dm[dm$Survey %in% surveys[10:18],]


sum.agg.2014 <- lapply(split(dm.2014,dm.2014$Site), function(y){
  out <- lapply(split(y,y$Survey), function(x){
     c(PercentAGG = length(unique(x$tag[x$Ln>0]))/length(unique(y$tag)),
    PercentFl = length(unique(x$tag[x$Fl == 1]))/length(unique(y$tag)),
    PercentBr = length(unique(x$tag))/length(unique(y$tag)),
    TotalFr = sum(x$Fr),
    PercentFr = length(unique(x$tag[x$Fr> 0]))/length(unique(y$tag)),
    Site = unique(y$Site),
    Survey = unique(x$Survey))
  })
  do.call(rbind,out)
})
sum.agg.2014[[1]]

sum.agg.2015 <- lapply(split(dm.2015,dm.2015$Site), function(y){
  out <- lapply(split(y,y$Survey), function(x){
     c(PercentAGG = length(unique(x$tag[x$Ln>0]))/length(unique(y$tag)),
    PercentFl = length(unique(x$tag[x$Fl == 1]))/length(unique(y$tag)),
    PercentBr = length(unique(x$tag))/length(unique(y$tag)),
    TotalFr = sum(x$Fr),
    PercentFr = length(unique(x$tag[x$Fr> 0]))/length(unique(y$tag)),
    Site = unique(y$Site),
    Survey = unique(x$Survey))
  })
  do.call(rbind,out)
})
sum.agg.2015[[1]]

all.summary14 <- do.call(rbind, sum.agg.2014)
all.summary15 <- do.call(rbind, sum.agg.2015)
all.summary <- data.frame(rbind(all.summary14,all.summary15))
all.summary <- all.summary[all.summary$PercentAGG>0,]

all.sum.mean <- tapply(all.summary$PercentAGG, all.summary$Survey, function(x) mean(x, rm.na=TRUE))
```

```{r}
plot(all.summary$Survey, all.summary$PercentAGG, pch=16, las=2,xlab="",ylab="Percent")
points(all.summary$Survey, all.summary$PercentFl,col="red")


stripchart(PercentAGG~Survey,data=all.summary, pch=16, method="jitter",
           vertical=TRUE, col="grey")
points(1:18,all.sum.mean, col="red", pch=4, cex=1.2)
abline(v=9.5)
```
```{r}

dm[grep("2015",dm$Survey),]

all.fl.mean <- tapply(all.summary$PercentFl, all.summary$Survey, function(x) mean(x,na.rm=TRUE))
when.fr <- tapply(all.summary$PercentFr, all.summary$Survey, function(x) mean(x,na.rm=TRUE))

stripchart(PercentFl~Survey,data=all.summary, pch=16, method="jitter",
           vertical=TRUE, col="grey")
points(1:18,all.fl.mean, col="red", pch=4, cex=1.2)
points(1:18,when.fr, col="purple", pch=16)

abline(v=9.5)

```


```{r}
sum.agg <- aggregate(dm$X, dm[,c("Plot","Site","Survey")],
          FUN = function(x){
            length(x)
          })

plotnum <- aggregate(dm$Plot, dm[,c("Site","Survey")],
                     FUN = function(x){
                       length(unique(x))
                     })

# Some Site 5 plot have no plants
plotnum$x[plotnum$Site == "5"] <- 5

# One Site 15 plot has no plants
plotnum$x[plotnum$Site == "15"] <- 4
```

```{r}
ggplot(sum.agg, aes(Survey, x, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
 # stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Average AGG per plot")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
  geom_text(data=plotnum, aes(label=x, y=-1, x=Survey, size = 0.9))+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")
  
```

```{r}

## Need percent of total indivduals seen each survey period (per year)
AGG14 <- dm[grep("2014",dm$Survey),]
# reset factor levels
AGG14$Survey <- factor(AGG14$Survey)

AGG15 <- dm[grep("2015",dm$Survey),]
AGG15$Survey <- factor(AGG15$Survey)


#or should it be the number that match? 
intersect(unique(AGG14$X[AGG14$Ln>0 & AGG14$Plot == "606" & AGG14$Survey == "Aprl_2014"]),
unique(AGG14$X[AGG14$Ln>0 & 
       AGG14$Plot == "606"]))/length(unique(AGG14$X[AGG14$Ln>0 & AGG14$Plot == "606"]))

AGGpersurvey.14 <- lapply(unique(AGG14$Plot), function(x){
  sapply(unique(AGG14$Survey), function(y){
    length(intersect(unique(AGG14$X[AGG14$Ln>0 & AGG14$Plot == x &AGG14$Survey == y]),
    unique(AGG14$X[AGG14$Ln>0 & 
                   AGG14$Plot == x])))/length(unique(AGG14$X[AGG14$Ln>0&AGG14$Plot == x]))
  })
})

AGGpersurvey.14[2]
```

```{r}

names(AGGpersurvey.14) <- unique(AGG14$Plot)

AGGper <- do.call(rbind,AGGpersurvey.14)
AGGper <- data.frame(AGGper)
names(AGGper) <- unique(AGG14$Survey)
AGGper <- data.frame(Plot=rownames(AGGper),AGGper)
AGGpSurvey <- reshape(AGGper, direction="long", varying = list(names(AGGper)[-1]),
                      v.names="AGG",
                      idvar="Plot",
                      timevar="Survey",
                      times=names(AGGper)[-1])


AGGpSurvey <- merge(AGGpSurvey,AGG14[,c("Plot","Site")],by = "Plot")
AGGpSurvey$Survey <- factor(AGGpSurvey$Survey, levels = unique(AGG14$Survey))
names(AGGpSurvey)
str(AGGpSurvey)
AGGpSurvey <- AGGpSurvey[AGGpSurvey$AGG!=0,]
```


Figure 6:  (b) The percent of Astragalus microcymbus individuals with AGG at each survey from the total individuals with AGG during the 2014 season. (c) Total number of Astragalus microcymbus individuals per stage class as a percent of the total observed throughout the season.  
```{r}
ggplot(AGGpSurvey, aes(Survey, AGG, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar',fun.args = list(mult=1))+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Percent of total AGG over the year per survey")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")+
  scale_y_continuous(labels = percent)


```


```{r}
AGGpersurvey.15 <- lapply(unique(AGG15$Plot), function(x){
  sapply(unique(AGG15$Survey), function(y){
    length(intersect(unique(AGG15$X[AGG15$Ln>0 & 
                         AGG15$Plot == x & 
                         AGG15$Survey == y]),
           unique(AGG15$X[AGG15$Ln>0 & AGG15$Plot == x])))/length(unique(AGG15$X[AGG15$Ln>0 & 
                                                               AGG15$Plot == x]))
  })
})

names(AGGpersurvey.15) <- unique(AGG15$Plot)


AGGper15 <- do.call(rbind,AGGpersurvey.15)
AGGper15 <- data.frame(AGGper15)
names(AGGper15) <- grep("2015", unique(dm$Survey), value = TRUE)
AGGper15 <- data.frame(Plot=rownames(AGGper15),AGGper15)
AGGpSurvey15 <- reshape(AGGper15, direction="long", varying = list(names(AGGper15)[-1]),
                      v.names="AGG",
                      idvar="Plot",
                      timevar="Survey",
                      times=names(AGGper15)[-1])

AGGpSurvey15 <- merge(AGGpSurvey15,dm[,c("Plot","Site")], by = "Plot")
tail(AGGpSurvey15)
```

```{r}
ggplot(AGGpSurvey15[AGGpSurvey15$AGG>0,], aes(Survey, AGG, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Percent of total AGG over the year per survey")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
#  geom_text(data=plotnum, aes(label=x, y=1, x=Survey, size = 0.9))+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")+
  scale_y_continuous(labels = percent)


```


In 2015, on average across sites in South Beaver Creek and Cebolla Creek...   
```{r}
AGGAnyTime15 <- ddply(AGG15, .(Site,Plot), summarise,
                      TUP = length(unique(tag[Ln>0])))

AGGAnyTimeSite15 <- ddply(AGG15, .(Site), summarise,
                      UP = length(unique(tag[Ln>0])))
AGGEachTime15 <- ddply(AGG15, .(Site,Plot,Survey), summarise,
                      UP = length(unique(tag[Ln>0])))

AGGmerge15 <- merge(AGGAnyTime15, AGGEachTime15, by = c("Site","Plot"))
```

Percent of total unique individuals seen over course of the growing season
```{r}
mean(AGGmerge15$UP[AGGmerge15$Survey =="June2_2015"]/AGGmerge15$TUP[AGGmerge15$Survey =="June2_2015"], na.rm = TRUE)

# Both South Beaver Creek and Cebolla Creek
mean(AGGmerge15$UP[AGGmerge15$Survey =="July_2015"]/AGGmerge15$TUP[AGGmerge15$Survey =="July_2015"], na.rm = TRUE)

std.error(AGGmerge15$UP[AGGmerge15$Survey =="July_2015"]/AGGmerge15$TUP[AGGmerge15$Survey =="July_2015"], na.rm = TRUE)

# ONly Cebolla Creek
mean(AGGmerge15$UP[AGGmerge15$Survey =="July_2015" & AGGmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), AGGmerge15$Site, value = TRUE)]/AGGmerge15$TUP[AGGmerge15$Survey =="July_2015"& AGGmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), AGGmerge15$Site, value = TRUE)], na.rm = TRUE)

std.error(AGGmerge15$UP[AGGmerge15$Survey =="July_2015" & AGGmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), AGGmerge15$Site, value = TRUE)]/AGGmerge15$TUP[AGGmerge15$Survey =="July_2015"& AGGmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), AGGmerge15$Site, value = TRUE)], na.rm = TRUE)

# ONly South beaver Creek
mean(AGGmerge15$UP[AGGmerge15$Survey =="July_2015" & AGGmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), AGGmerge15$Site, value = TRUE)]/AGGmerge15$TUP[AGGmerge15$Survey =="July_2015"& AGGmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), AGGmerge15$Site, value = TRUE)], na.rm = TRUE)

std.error(AGGmerge15$UP[AGGmerge15$Survey =="July_2015" & AGGmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), AGGmerge15$Site, value = TRUE)]/AGGmerge15$TUP[AGGmerge15$Survey =="July_2015"& AGGmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), AGGmerge15$Site, value = TRUE)], na.rm = TRUE)

```

## This is correct for 6b   
TUP = Total unique plants per plot over 2015   
UP = unique plants per plot per survey in 2015
```{r Figure 6(b)}
ggplot(AGGmerge15, aes(Survey, UP/TUP)) +
  stat_summary(fun.y = mean, geom = 'point') +
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1)) +
	facet_grid(~Site) +
	ylab('Percent of total AGG per plot over the growing season') +
	xlab("") +
	theme_bw() + 
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5)) +
  scale_y_continuous(labels = percent)

```


```{r intraanual seedlings}
head(dm)
dm.15 <- dm[grep("2015",dm$Survey),]
dm.15$Survey <- factor(dm.15$Survey)

coty.seeds <- ddply(dm.15[grep("coty", dm.15$Comment),],
                   .(Plot, Site), summarise,
                   tag = unique(tag))

head(coty.seeds)
tags.seed <- merge(dm.15, coty.seeds, by = c("Site","Plot","tag"))
```


# Seedlings only in 2015
```{r}
ggplot(tags.seed, aes(Survey, Ln, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~Site)+
  theme_bw()+
  xlab("Average Length")+
    theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5)) 


```

# how many seedlings up in each survey compared to all seedlings all year    
```{r}
aggregate(tag~Survey, function(x) length(unique(x)), data = tags.seed)

# how many had cotyledons in July? None I think
aggregate(tag~Survey, function(x) length(unique(x)), data = dm.15[grep("coty", dm.15$Comment),])

seedanytime15 <-  ddply(tags.seed, .(Site,Plot), summarise,
                      TUP = length(unique(tag[Ln>0])))
seedeachtime15 <- ddply(tags.seed, .(Site,Plot,Survey), summarise,
                      UP = length(unique(tag[Ln>0])))

seedmerge15 <- merge(seedanytime15, seedeachtime15, by = c("Site","Plot"))

mean(seedmerge15$UP[seedmerge15$Survey =="June2_2015"]/seedmerge15$TUP[seedmerge15$Survey =="June2_2015"], na.rm = TRUE)

# Both South Beaver Creek and Cebolla Creek
mean(seedmerge15$UP[seedmerge15$Survey =="July_2015"]/seedmerge15$TUP[seedmerge15$Survey =="July_2015"], na.rm = TRUE)

std.error(seedmerge15$UP[seedmerge15$Survey =="July_2015"]/seedmerge15$TUP[seedmerge15$Survey =="July_2015"], na.rm = TRUE)

# ONly Cebolla Creek
mean(seedmerge15$UP[seedmerge15$Survey =="July_2015" & seedmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), seedmerge15$Site, value = TRUE)]/seedmerge15$TUP[seedmerge15$Survey =="July_2015"& seedmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), seedmerge15$Site, value = TRUE)], na.rm = TRUE)

std.error(seedmerge15$UP[seedmerge15$Survey =="July_2015" & seedmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), seedmerge15$Site, value = TRUE)]/seedmerge15$TUP[seedmerge15$Survey =="July_2015"& seedmerge15$Site %in% grep(paste(c("1","2"), collapse="|"), seedmerge15$Site, value = TRUE)], na.rm = TRUE)

# ONly South beaver Creek
mean(seedmerge15$UP[seedmerge15$Survey =="July_2015" & seedmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), seedmerge15$Site, value = TRUE)]/seedmerge15$TUP[seedmerge15$Survey =="July_2015"& seedmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), seedmerge15$Site, value = TRUE)], na.rm = TRUE)

std.error(seedmerge15$UP[seedmerge15$Survey =="July_2015" & seedmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), seedmerge15$Site, value = TRUE)]/seedmerge15$TUP[seedmerge15$Survey =="July_2015"& seedmerge15$Site %in% grep(paste(c("5","15","19","26"), collapse="|"), seedmerge15$Site, value = TRUE)], na.rm = TRUE)
```


```{r}
AGG14$Ln[grep("Basal", AGG14$Comment)] <- 0.25
AGG14 <- AGG14[AGG14$Ln != 0,]

agg14 <- lapply(split(AGG14, list(AGG14$Plot,AGG14$Site)),
                   function(x){
                     sapply(unique(x$Survey), function(y){
                       nrow(x[x$Survey == y,])/nrow(x)
                       })
                   })

length(agg14[23][[1]])

length(agg14[23]$"607.5")
# agg14[vapply(agg14, function(x) dim(x)[1] > 1, NA)]
#Filter(function(x) dim(x)[1] > 1, agg14)
agg14[!unlist(lapply(agg14, is.null))]

names(agg14) <- 
do.call(rbind,agg14[agg14[[1]] > 1])
```


##Figure 6    
Don't worry about the same plant being up, when are the most plants with AGG
```{r}
rm(AGGpersurvey.14)
AGGpersurvey.14 <- lapply(unique(AGG14$Plot), function(x){
  sapply(unique(AGG14$Survey), function(y){
    length(AGG14$X[AGG14$Ln>0 & 
                     AGG14$Plot == x & 
                     AGG14$Survey == y])/length(AGG14$X[AGG14$Ln>0 &
                                                          AGG14$Plot == x])
           })
  })

names(AGGpersurvey.14) <- unique(AGG14$Plot)
AGGper <- do.call(rbind,AGGpersurvey.14)
AGGper <- data.frame(AGGper)
names(AGGper) <- unique(AGG14$Survey)
AGGper <- data.frame(Plot=rownames(AGGper),AGGper)
siteplot <- data.frame(table(AGG14$Plot, AGG14$Site))
siteplot <- siteplot[siteplot$Freq > 0,]
names(siteplot) <- c("Plot","Site","Freq")

AGGpSurvey <- reshape(AGGper, direction="long", varying = list(names(AGGper)[-1]),
                      v.names="AGG",
                      idvar="Plot",
                      timevar="Survey",
                      times=names(AGGper)[-1])

AGGpSurvey <- merge(AGGpSurvey,siteplot,by = "Plot")
AGGpSurvey$Survey <- factor(AGGpSurvey$Survey, levels = unique(AGG14$Survey))
```

```{r}
ggplot(AGGpSurvey[AGGpSurvey$AGG > 0,], aes(Survey, AGG, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Percent of total AGG over the year per survey")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
#  geom_text(data=plotnum, aes(label=x, y=1, x=Survey, size = 0.9))+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")+
  scale_y_continuous(labels = percent)


```

```{r}
rm(AGGpersurvey.15)
AGGpersurvey.15 <- lapply(unique(AGG15$Plot), function(x){
  sapply(unique(AGG15$Survey), function(y){
    length(AGG15$X[AGG15$Ln>0 & 
                     AGG15$Plot == x & 
                     AGG15$Survey == y])/length(AGG15$X[AGG15$Ln>0 &
                                                          AGG15$Plot == x])
           })
  })

names(AGGpersurvey.15) <- unique(AGG15$Plot)
AGGper.15 <- do.call(rbind,AGGpersurvey.15)
AGGper.15 <- data.frame(AGGper.15)
names(AGGper.15) <- unique(AGG15$Survey)
AGGper.15 <- data.frame(Plot=rownames(AGGper.15),AGGper.15)

AGGpSurvey.15 <- reshape(AGGper.15, direction="long", varying = list(names(AGGper.15)[-1]),
                      v.names="AGG",
                      idvar="Plot",
                      timevar="Survey",
                      times=names(AGGper.15)[-1])

AGGpSurvey.15 <- merge(AGGpSurvey.15,siteplot,by = "Plot")
AGGpSurvey.15$Survey <- factor(AGGpSurvey.15$Survey, levels = unique(AGG15$Survey))
```

```{r}
ggplot(AGGpSurvey.15[AGGpSurvey.15$AGG > 0,], aes(Survey, AGG, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~Site)+
  theme_bw()+
  ylab("Percent of total AGG over the year per survey")+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))+
#  geom_text(data=plotnum, aes(label=x, y=1, x=Survey, size = 0.9))+
#  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  theme(legend.position="none")+
  scale_y_continuous(labels = percent)


```

figure 6c
```{r}
# set status
head(dm)
dm$status <- "dead"
dm$status[dm$Ln > 0 & dm$Fl == 0] <- "vegetative"
dm$status[dm$Ln > 0 & dm$Fl == 1] <- "reproductive"

table(dm$status,dm$Survey)

#One case says 'no cotyledons'
#Seedlings in 2014
dm.14 <- dm[grep("2014",dm$Survey),]
dm.14$Survey <- factor(dm.14$Survey)

coty.seeds14 <- ddply(dm.14[grep("coty", dm.14$Comment),],
                   .(Plot, Site), summarise,
                   tag = unique(tag))

head(coty.seeds14)
tags.seed14 <- merge(dm.14, coty.seeds14, by = c("Site","Plot","tag"))

#Seedlings in 2015
dm.15 <- dm[grep("2015",dm$Survey),]
dm.15$Survey <- factor(dm.15$Survey)

coty.seeds15 <- ddply(dm.15[grep("coty", dm.15$Comment),],
                   .(Plot, Site), summarise,
                   tag = unique(tag))

head(coty.seeds15)
tags.seed15 <- merge(dm.15, coty.seeds15, by = c("Site","Plot","tag"))
tags.seedall <- rbind(tags.seed14, tags.seed15)

table(dm$Comment)
unique(dm$Comment[grep("coty", dm$Comment)])
dm$Comment[grep("no coty", dm$Comment)] <- "Cotyledons "
seedlings <- dm[grep("coty", dm$Comment),] 
seedlings$Comment <- factor(seedlings$Comment)
table(seedlings$Comment, seedlings$Ln)

table(tags.seedall$status)
tags.seedall[tags.seedall$status == "reproductive",]
dm[dm$tag == 273 & dm$Site == 26,]


ggplot(tags.seed15, aes(Survey, Ln, group = Site))+
  stat_summary(fun.y = mean, geom="point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~Site)


#Set seedling status to tags that we saw cotyledons in 2014 or 2015


# one seedling became reproductive after germinating in 2015
dm$status[dm$Ln > 0 & dm$Fl == 1] <- "reproductive"

#dormant would have an existing tag and length at a later time
length(unique(dm$tag[dm$status == "dead"]))

dm$status <- factor(dm$status, levels = c("seedling","vegetative","reproductive","dormant","dead"))


unique.season <- ddply(dm, .(Site, Plot, status), summarise,
                       UniqueNumAGG = length(unique(X[Ln >0])))

#unique.season <- lapply(split(dm, dm[,c("Site","Plot","status")]), function(x){
#  if(nrow(x) > 0){
#    cbind(x[1,c("Site","Plot","status")], num = nrow(x))
#    }
#})
# Filter(function(x) dim(x)[1] > 0, unique.season)

unique.season

number.time <- ddply(dm, .(Site, Plot, Survey, status), summarise,
                     NumAGG = length(unique(X[Ln >0])))

merge.num.season <- merge(unique.season, number.time, by = c("Site","Plot","status"))

merge.num.season$Percent <- merge.num.season$NumAGG/merge.num.season$UniqueNumAGG

ggplot(merge.num.season, aes(status, Percent, colour = status)) +
  geom_boxplot() +
  theme_bw() +
	facet_grid(~ Survey)+
	ylab("Percent of total") +
	theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust = 0))+
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))+
  scale_y_continuous(labels = percent)

```

July census     
Size of seedlings in July, are all less than 10cm, can we use that as metric for future annual measurements?    
Becky's comment: "For the july census can we say that all seedlings were less than 10 cm and all re-emerging plants are greater than 10cm? I.e., can we use these data to have a cut off for the July census..kind of like we do with Scgl for reproductive vs non-reproductive? If so then we could use this to back track and re-assess all prior years data and also use it going forward with just the July census."

```{r}
unique(merge.num.season$Survey)
aggregate(Percent~Survey+status, mean, data = merge.num.season)

head(dm)
aggregate(Ln~Survey+status, mean, data = dm)

head(tags.seed15)
aggregate(Ln~Survey+status, mean, data = tags.seed15) #aaaahhh, lengths for dead??
aggregate(Ln~Survey+status, max, data = tags.seed15) #aaaahhh, lengths for dead??

#try again to classify seedlings for the whole year even if they become reproductive later
head(tags.seedall) # all tags with coty seed at some point in that year, 2014, or within 2015
aggregate(Ln~Survey, mean, data = tags.seedall) # July 5.6cm
aggregate(Ln~Survey, max, data = tags.seedall)

ggplot(aggregate(Ln~Survey, mean, data = tags.seedall), aes(Survey, Ln)) +
  geom_point() 

ggplot(aggregate(Ln~Survey, max, data = tags.seedall), aes(Survey, Ln)) +
  geom_point() 
```


```{r learned from intra, eval=FALSE}
dm$SurveyNum <- as.numeric(dm$Survey)
dm$tag[dm$status == "seedling"]

tags <- ddply(dm, .(status), summarise,
              Tags = unique(tag))

tags.plot <- tags$Tags[tags$status == "seedling"]

tags.seed <- merge(dm, data.frame(tag = tags.plot), by = "tag")

# For the most part stayed under 10cm if saw cotyledons
ggplot(tags.seed, aes(Survey, Ln, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~Site)+
  theme_bw()+
  xlab("Average Length")+
    theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5)) 

ggplot(tags.seed, aes(Survey, Ln, group = Site))+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.data='mean_cl_normal', geom='errorbar', fun.args = list(mult=1))+
  facet_grid(~status)+
  theme_bw()+
  xlab("Average Length")+
    theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5)) 


dm.pva <- subset(merge(dm, dm, by = c("Site","Plot","X")), SurveyNum.x == SurveyNum.y - 1)


```


Figure for Becky annual report 01232018
```{r}
alive.byyear <- aggregate(length~year, data=alive[alive$AsMi_site_id>3,],
                          FUN= sum)

ggsave("Q:/Research/MEDL_folder/AsMi_yr.jpg",device="jpeg",
ggplot(alive.byyear, aes(year,length))+
  geom_line(colour="blue")+
  ggtitle("Astragalus microcymbus")+
  theme_classic()+
  ylab("Total Population"))
  
write.csv(alive.byyear,"Q:/Research/MEDL_folder/AsMi_yr.csv")

```
