---
title: "AsMi_annual report"
author: "Michelle DePrenger-Levin"
date: "Tuesday, October 27, 2015"
output: pdf_document
---

AsMiPVA

```{r}
library(reshape2)
library(ggplot2)
library(psych)
library(popbio)
```


```{r}
asmi.raw <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/2015_asmi/RawData_20yrsdormant_111115.csv"), na.strings = "na")

head(asmi.raw)
table(asmi.raw$year, asmi.raw$AsMi_site_id)
table(asmi.raw$Browsing...Status)
#asmi.raw <- transform(asmi.raw, year = as.numeric(year))
str(asmi.raw)
table(asmi.raw$AsMi_plot_id,asmi.raw$AsMi_site_id)

# one blank row at the end of the csv download
asmi.raw[asmi.raw$status == "",]
asmi.raw <- asmi.raw[asmi.raw$status != "",]

#reset factors of browsing to eliminate " "
asmi.raw$Browsing...Status <- factor(asmi.raw$Browsing...Status)

```



Table 1:Demographic data of Astragalus microcymbus within the South Beaver Creek and Cebolla Creek drainages near Gunnison, Colorado. (a) Average number of individuals with above ground growth (AGG) followed by total individuals (AGG and dormant) per plot. (b) Percent of reproductive individuals followed by average reproductive individuals per plot. Site 1 is Cebolla Creek Mid and site 2 is Cebolla Creek north. Standard errors are shown in parentheses.
```{r}
#alive <- lapply(split(asmi.raw, list(asmi.raw$AsMi_plot_id, asmi.raw$year)),function(x){
#  nrow(x[x$length>0,])
#})

#AGG
alive <-aggregate(length ~ AsMi_plot_id + year + AsMi_site_id + fence, 
                  data = asmi.raw, function(x) length(x[x>0]))

#AGG and dormant
aggdorm <- aggregate(status ~ AsMi_plot_id +year + AsMi_site_id + fence,
                     data = asmi.raw, function(x) length(x[x != "dead"]))

ggplot(alive, aes(year, length, colour=as.factor(AsMi_site_id)))+
  geom_point()+
  stat_smooth(size=1)+
  theme_bw()+
  scale_color_manual("Sites/n",labels = c("Cebolla Mid", 
                                          "Cebolla South",
                                          "5","15","19","26"),
                     values = c("cyan", "darkblue",
                                "olivedrab","olivedrab1",
                                "mediumseagreen","mistyrose3"))

tbl1a.1 <- summarySE(alive, measurevar="length", groupvars=c("AsMi_site_id", "year"))
tbl1a.1[tbl1a.1$year == 2015,]

tbl1a.2 <- summarySE(aggdorm, measurevar="status", groupvars=c("AsMi_site_id", "year"))

sites <- unique(tbl1a.1$AsMi_site_id)
tbl1.1 <- lapply(sites, function(x){
  paste(round(tbl1a.1[tbl1a.1$AsMi_site_id == x,"length"],2)," (",
        round(tbl1a.1[tbl1a.1$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1.2 <- lapply(sites, function(x){
  paste(round(tbl1a.2[tbl1a.2$AsMi_site_id == x,"status"],2)," (",
        round(tbl1a.2[tbl1a.2$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1a <- lapply(1:6, function(x){
  data.frame(tbl1.1[[x]],tbl1.2[[x]])
  })

#Cebolla Mid, Site 1
tbl1a[[1]]

#Cebolla North, Site 2
tbl1a[[2]]

#South Beaver Creek, Site 5
tbl1a[[3]]
#South Beaver Creek, Site 15
tbl1a[[4]]
#South Beaver Creek, Site 19
tbl1a[[5]]
#South Beaver Creek, Site 26
tbl1a[[6]]
```

Percent and total preproductive
```{r}
# Percent and average reproductive

#precent reproductive
prep <- aggregate(flower~AsMi_plot_id+year+AsMi_site_id,
                  data = asmi.raw[asmi$length > 0,],
                  function(x){
                    sum(x,na.rm = TRUE)/length(x)
                  })
head(prep)
str(prep)
tbl1b.1 <- summarySE(prep, measurevar="flower", groupvars=c("AsMi_site_id","year"))
head(tbl1b.1)

#sites above
#percent reproductive 
tbl1.3 <- lapply(sites, function(x){
  paste(round(tbl1b.1[tbl1b.1$AsMi_site_id == x,"flower"],3)*100,"% (",
        round(tbl1b.1[tbl1b.1$AsMi_site_id == x,"se"],3)*100, "%)", sep="")
})

tbl1.3[[3]]

#total reproductive
totrep <- aggregate(flower ~ AsMi_plot_id +year + AsMi_site_id + fence,
                    data = asmi.raw[asmi$length > 0,], 
                    function(x) sum(x, na.rm = TRUE))

head(totrep)
tbl1b.2 <- summarySE(totrep, measurevar="flower",groupvars=c("AsMi_site_id","year"))

tbl1.4 <- lapply(sites, function(x){
  paste(round(tbl1b.2[tbl1b.2$AsMi_site_id == x,"flower"],2)," (",
        round(tbl1b.2[tbl1b.2$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1b <- lapply(1:6, function(x){
  data.frame(tbl1.3[[x]], tbl1.4[[x]])
  })

#Cebolla Mid, 1
tbl1b[[1]]

#Cebolla North, 2
tbl1b[[2]]

#South Beaver Creek, 5
tbl1b[[3]]

#South Beaver Creek, 15
tbl1b[[4]]

#South Beaver Creek, 19
tbl1b[[5]]

#South Beaver Creek, 26
tbl1b[[6]]


```

Table 2: Biotic factors correlated among the percent browsed individuals in the current year, density of reproductive individuals in the current year, fruit production in the current year, and the percent of reproductive individuals and above ground growth (AGG) in the current and previous year of Astragalus microcymbus per year (1995 – 2014) within the South Beaver Creek drainage ....Significant PCC are indicated with an asterisk (p-value < 0.05).  

Plot Summary (weather data is prev. Aug through currrent Jul)   
Total.Plants are AGG and dormant    
Total.Alive is AGG   
X..Flowered must be percent flowered and    
X..Flowered.1 is number flowered
```{r}
ps.asmi <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/2015_asmi/PlotSummary_2015.csv"))

head(ps.asmi)

ps.asmi.t <- ps.asmi

#log transform
logtrans <- c("X..Flowered.1","Total.Alive","X..Dormant","Total.Fruit",
              "X..Flowered")
intersect(names(ps.asmi.t),logtrans) #Check that names are right
ps.asmi.t[,logtrans] <- lapply(ps.asmi.t[,logtrans], 
                                     function(x) log(x + 1)) #NA in num flowered
ps.asmi.t$X..Flowered.1[is.na(ps.asmi.t$X..Flowered.1)] <- 0

#arcsine square root transformed  asin(sqrt(x/100))
ps.asmi.t["X..Browsed"] <- lapply(ps.asmi.t["X..Browsed"],
                                  function(x) asin(sqrt(x/100)))


ps.cor <- subset(merge(ps.asmi.t, ps.asmi.t, 
                       by = c("Site","Plot")), Year.x == Year.y - 1)
head(ps.cor[,c("Year.x","Year.y")])

head(ps.cor)
cor.plot(cor(ps.cor[,names(ps.cor) %in% 
                      unique(grep(paste(cors,collapse="|"),
                                  names(ps.cor), value=TRUE))]),
         numbers = TRUE)

cor(ps.cor[,names(ps.cor) %in% 
                      unique(grep(paste(cors,collapse="|"),
                                  names(ps.cor), value=TRUE))])

#If errors:
#dev.off()
cors <- c("Total.Alive","X..Browsed","X..Flowered","X..Dormant","Total.Fruit")
cor(ps.cor[,names(ps.cor) %in% 
             unique(grep(paste(cors,collapse="|"),names(ps.cor), value=TRUE))])

cor.plot(cor(ps.cor[,names(ps.cor) %in% 
                      unique(grep(paste(cors,collapse="|"),
                                  names(ps.cor), value=TRUE))]),
         numbers = TRUE)

```


```{r}
cortests <- lapply(ps.cor[,names(ps.cor) %in% 
                            unique(grep(paste(cors,collapse="|"),
                                        names(ps.cor), value=TRUE))],
                   function(x){
                     sapply(ps.cor[,names(ps.cor) %in% 
                                     unique(grep(paste(cors,collapse="|"),
                                                 names(ps.cor), value=TRUE))],
                            function(y){
                              ct <- cor.test(x,y)
                              cbind(ct$p.value,ct$estimate)
                              })
                     })


t(cortests[[1]]) # Total.Alive.x to all
tst <- lapply(cortests, function(x) data.frame(t(x)))
df.c <- do.call(rbind,tst)

cortests[[2]] # X..Browsed.x to all

head(df.c)
nrow(df.c)

#All significant
df.c[df.c$X1 > 0.001,]

```



```{r}
#get rid of the number of reproductive individuals, only percent reproductive
ps.cor <- ps.cor[,grep("Flowered.1.", names(ps.cor), invert=TRUE)]

cors <- c("Total.Alive","X..Browsed","X..Flowered","X..Dormant","Total.Fruit")

cor.plot(cor(ps.cor[,names(ps.cor) %in% unique(grep(paste(cors,collapse="|"),
                                           names(ps.cor), value = TRUE))]),
         numbers = TRUE)
```

Table 3: Average Astragalus microcymbus fruit per plot within the South Beaver Creek Drainage near Gunnison, CO and Cebolla Creek drainage. Site 1 is Cebolla Creek Mid and site 2 is Cebolla Creek North. Standard errors are given in parentheses. 
```{r}
fruit <- aggregate(fruit ~ AsMi_plot_id + year + AsMi_site_id + fence, 
                  data = asmi.raw, function(x) sum(x,na.rm = TRUE))
head(fruit)


tbl3.1 <- summarySE(fruit, measurevar="fruit",groupvars=c("AsMi_site_id","year"))

sites <- unique(tbl3.1$AsMi_site_id)
tbl3 <- lapply(sites, function(x){
  paste(round(tbl3.1[tbl3.1$AsMi_site_id == x,"fruit"],2)," (",
        round(tbl3.1[tbl3.1$AsMi_site_id == x,"se"],1), ")", sep="")
})

#Cebolla Creek
data.frame(tbl3[[1]],tbl3[[2]])
#South Beaver Creek
data.frame(tbl3[[3]],tbl3[[4]],tbl3[[5]],tbl3[[6]])

```


Table 4: Growth rate (λ) and standard deviation within treatment (fenced or open plots) of Astragalus microcymbus individuals within the South Beaver Creek drainage near Gunnison, CO. Plot 598 in site 26, added in 2004, is excluded.   

```{r}
table(asmi.raw$Browsing...Status)
asmi.raw$Browsing...Status[asmi.raw$Browsing...Status == "mammal"] <- "Mammal"

asmi.raw$Browsing...Status <- factor(asmi.raw$Browsing...Status)

table(asmi.raw$browsing)
table(asmi.raw$Browsing...Status) #lots of missing -1 and one row with nothing
nrow(asmi.raw)
table(asmi.raw$AsMi_site_id,asmi.raw$year)

cebolla <- asmi.raw[asmi.raw$AsMi_site_id %in% c(1,2),]
table(cebolla$AsMi_site_id,cebolla$year)

sbc <- asmi.raw[asmi.raw$AsMi_site_id %in% c(5,15,19,26),]
table(sbc$AsMi_site_id,sbc$year)

#remove plot 598 from SBC, it was added so late.. or do all plots on their own instead of by sites? 
sbc <- sbc[sbc$AsMi_plot_id != 598,]

asmi.1 <- sbc[order(sbc$AsMi_site_id, sbc$AsMi_tag_id, sbc$year),]
cebolla <- cebolla[order(cebolla$AsMi_site_id, cebolla$AsMi_tag_id, cebolla$year),]

asmi.1$status <- factor(asmi.1$status)
table(asmi.1$status)
```

Set order of classes
```{r}
# Later work in seeds
# stages <- c("seed", "seedling", "vegetative", "reproductive", "dormant","dead") 

stages <- c("seedling", "vegetative", "reproductive", "dormant","dead") 

asmi.1$status <- ordered(asmi.1$status, levels = stages)
cebolla$status <- ordered(cebolla$status, levels = stages)


```

check errors
```{r}
table(asmi.1$status)
table(asmi.1$year,asmi.1$status)
table(asmi.1$year, asmi.1$AsMi_site_id)
table(asmi.1$length) # looks like tag numbers got recorded as length

asmi.1[is.na(asmi.1$length),]
asmi.1[asmi.1$length > 100,]

# One length that was recorded crazy
asmi.1$length[asmi.1$length == 921] <- NA

asmi.1$browsed[asmi.1$browsing==0]<-FALSE  	
asmi.1$browsed[asmi.1$browsing==1]<-TRUE
table(asmi.1$browsed)
table(asmi.1$browsing)

# Same for cebolla plots
cebolla$browsed[cebolla$browsing==0]<-FALSE    
cebolla$browsed[cebolla$browsing==1]<-TRUE
table(cebolla$browsed)
table(cebolla$browsing)
```

Merge year to year, year.x is year t, year.y is year t+1   
remove dead from stages, just fate   
```{r}
asmi.2 <- subset(merge(asmi.1, asmi.1, by = "AsMi_tag_id", sort = FALSE), year.x == year.y - 1)   
cebolla <- subset(merge(cebolla, cebolla, by = "AsMi_tag_id", sort = FALSE), year.x == year.y - 1)   
names(asmi.2)
head(asmi.2[,grep("year", names(asmi.2), )])
```

Want    
Narrow down to      
[1] "AsMi_site_id.x" "AsMi_tag_id"    "year.x"             
[4] "length.x"       "fruit.x"        "browsed.x"           
[7] "fence.x"        "status.x"       "status.y"     
```{r}
cols <- c("AsMi_site_id.x","AsMi_tag_id","year.x","length.x",
          "fruit.x","browsed.x","fence.x","status.x","status.y","AsMi_plot_id.x")
asmi.2 <- asmi.2[, names(asmi.2) %in% unique(grep(paste(cols,collapse="|"),
                                                  names(asmi.2), value = TRUE))]
colnames(asmi.2) <- c( "tag","year","length","fruits","stage","plot",
                       "site","fenced","browse","fate")
## re-number
rownames(asmi.2) <- 1:nrow(asmi.2)
# Get rid of stage 'dead'
asmi.2$stage <- ordered(asmi.2$stage, levels = stages[-length(stages)])
# check transitions
#fate down and stage across the top; These are the raw numbers combined for all years 
table(Fate = asmi.2$fate, Stage = asmi.2$stage)
table(asmi.2$site, asmi.2$year)
table(asmi.2$plot, asmi.2$year)
table(asmi.2$stage)
```

bootstrap distributions of population growth rates (lambda), stage vectors, and projection matrix elements by randomly sampling with replacement from a stage-fate data frame of observed transitions   

Doesn't make sense... shouldn't be so high...

```{r}
boottrans <- lapply(unique(asmi.2$site), function(x){
  data.frame(cbind(Site = x,
                   Boot = boot.transitions(asmi.2[asmi.2$site == x & asmi.2$fenced == "n",], 
                                           1000,
                                           fertility = "fruits")$lambda))
  })

bt <- do.call(rbind, boottrans)
head(bt)
ggplot(bt, aes(as.factor(Site), Boot, colour = as.factor(Site)))+
  geom_boxplot()
```

Dormancy    
repeat lengths   
```{r}
dorms <- rle(as.numeric(asmi.2$stage))$lengths[rle(as.numeric(asmi.2$stage))$values ==4]
max(dorms)
ggplot(data.frame(Dormant = dorms), aes(Dormant))+
  geom_histogram()+
  theme_bw()+
  ylab("Frequency")+
  xlab("Consecutive years dormant")


median(dorms) #2
length(dorms[dorms==1]) #296
length(dorms) #725
length(dorms[dorms > 5]) #237
length(dorms[dorms > 15]) #20
```


Dormancy can be set to 0-1   
```{r}
load(path.expand("P:/hackathon/GitPVA/StagePVAFunction.R"))

asmi.pva <- StagePVA(asmi.2)

```


By plot
```{r}
site <- sapply(unique(asmi.2$site), function(x){
  as.character(unique(asmi.2$plot[asmi.2$site == x]))
  }, simplify = FALSE)
names(site)<-unique(asmi.2$site)
site

asmi.pva$plot.matrix[site$'15'[1]]



```

### Function for lambda and 
requires library(popbio)
x is the list of matrices, i.e. notfenced.Site.matrix$"26", 
					or fenced.Site.matrix$"19"[2:17])
y is the start year
z is the start of the last transition
```{r}
lmdSD <- function(x,y,z){

	yrs <- 1995:z
	st <- match(c(y,z),yrs)
	
	lambdaAll <- c()
	for(i in c(y:z)){
		lambdaAll <- cbind(lambdaAll,eigen.analysis(x[[as.character(i)]])$lambda)
	}	
	StandDev <- sqrt(var(c(lambdaAll)))	#Standard Deviation
	cbind(lmda = lambda(mean(x[st[1]:st[2]])),SD = StandDev)
}	
```


```{r}
lmdSD(asmi.pva$pro.matrix, 1996, 2014)
#         lmda        SD
#[1,] 0.916556 0.1715709  
paste(round(lmdSD(asmi.pva$pro.matrix, 1996, 2004)[1],2)," (",
      round(lmdSD(asmi.pva$pro.matrix, 1996, 2004)[2],2), ")", sep ="")

mats.list <- list(asmi.pva$pro.matrix,asmi.pva$fenced.pro.matrix,asmi.pva$notfenced.pro.matrix)
tbl4.all <- sapply(mats.list, function(x){
   paste(round(lmdSD(x, 1996, 2004)[1],2)," (",
         round(lmdSD(x, 1996, 2004)[2],2),")", sep="")
    })

tbl4.allpost <- sapply(mats.list[-1], function(x){
  paste(round(lmdSD(x, 2005,2013)[1],2)," (",
        round(lmdSD(x, 2005,2013)[2],2),")", sep="")
})

tbl4.allopen <- paste(round(lmdSD(asmi.pva$notfenced.pro.matrix, 1996,2013)[1],2)," (",
                      round(lmdSD(asmi.pva$notfenced.pro.matrix, 1996,2013)[2],2),")", sep="")
```

# Table 4
pattern is:          

All pre-fence  1996-2004        |All post-fence 2005-2013       |Open plots 1996-2013       
--------------------------------|--------------------------------|----------------------    
asmi.pva$pro.matrix             |                                |  
asmi.pva$fenced.pro.matrix      | asmi.pva$fenced.pro.matrix     |           
asmi.pva$notfenced.pro.matrix   | asmi.pva$notfenced.pro.matrix  | asmi.pva$notfenced         
      
      
Sites 5,19,26,  1996-2004       
(which is through 2005 but starting transition of 2004)     
------------------------|-----------------------------|---------------------
asmi.pva$Site$"5"       |                             |
asmi.pva$fenced$"5"     |      asmi.pva$fenced$"5"    |           
asmi.pva$notfenced$"5"  |      asmi.pva$notfenced$"5" |  asmi.pva$notfenced$"5"      

Site 15
`asmi.pva$Site$"15"` ...        

```{r}
matord.list <- list(asmi.pva$Site, asmi.pva$fenced,asmi.pva$notfenced)

# yarggg, won't work!!
tbl4.96.04 <- 
  lapply(as.character(unique(asmi.2$site)), function(x){
    lapply(matord.list, function(y){
      paste(round(lmdSD(y[[factor(x)]],1996,2004)[1],2)," (",
            round(lmdSD(y[[factor(x)]],1996,2004)[2],2),")", sep="")
    })
  })

#site 5
paste(round(lmdSD(asmi.pva$Site$'5',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'5',1996,2004)[2],2),")", sep="")

paste(round(lmdSD(asmi.pva$Site$'5',1996,2004)[1],2)," (",
            round(lmdSD(asmi.pva$Site$'5',1996,2004)[2],2),")", sep="")

```


Figure 3: Life cycle diagram of Astragalus microcymbus, 1996-2014 mean transition rates (solid lines) and fecundity rates (dashed lines), and resulting sensitivities and elasticities. Individuals that become reproductive in the first year are classified as seedlings.    

```{r}
asmi.pva$notfenced.pro.matrix$'2012'


```




summarySE function borrowed from http://www.cookbook-r.com/Manipulating_data/Summarizing_data/    
```{r}
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
    library(plyr)

    # New version of length which can handle NA's: if na.rm==T, don't count them
    length2 <- function (x, na.rm=FALSE) {
        if (na.rm) sum(!is.na(x))
        else       length(x)
    }

    # This does the summary. For each group's data frame, return a vector with
    # N, mean, and sd
    datac <- ddply(data, groupvars, .drop=.drop,
      .fun = function(xx, col) {
        c(N    = length2(xx[[col]], na.rm=na.rm),
          mean = mean   (xx[[col]], na.rm=na.rm),
          sd   = sd     (xx[[col]], na.rm=na.rm)
        )
      },
      measurevar
    )

    # Rename the "mean" column    
    datac <- rename(datac, c("mean" = measurevar))

    datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean

    # Confidence interval multiplier for standard error
    # Calculate t-statistic for confidence interval: 
    # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
    ciMult <- qt(conf.interval/2 + .5, datac$N-1)
    datac$ci <- datac$se * ciMult

    return(datac)
}
```


### Years alive    

```{r}
path <- "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/2015_asmi/"

yrsalive <- lapply(1:10, function(x){ 
  path2 <- paste(path, "YrsAlive_dormant", x, ".csv", sep = "")
  ysal <- read.csv(path.expand(path2), na.strings="na")
  cbind(ysal, YrsD = x)
  })

head(yrsalive[[4]])
str(yrsalive[[1]])

yrsalive[[1]][is.na(yrsalive[[1]]$Yearsalive),]

yrsalive[[3]][is.na(yrsalive[[3]]$AsMi_plot_id),]


#eliminate na or make them zeros?
# complete.cases will eliminate any that aren't yet dead or are new in 2015 sinece they've only been seen one year. 
sumYrsAlive <- lapply(yrsalive, function(x){
  summarySE(x[complete.cases(x),], measurevar="Yearsalive",groupvars=c("AsMi_plot_id","AsMi_site_id","YrsD"))
})

tail(sumYrsAlive[[5]])

smya <- do.call(rbind, sumYrsAlive)

ggplot(smya, aes(YrsD, Yearsalive))+
  geom_point()+
  stat_smooth()

```


Ignore making NA to zeros
```{r}
#try making them zeros
yrsalivezero <- lapply(yrsalive, function(x){
  replace(x, is.na(x), 0)
})

head(yrsalivezero[[5]])
yrsalivezero[[5]][yrsalivezero[[5]]$AsMi_plot_id == 0,]

sumyrsalivezero <- lapply(yrsalivezero, function(x){
  summarySE(x[complete.cases(x),], measurevar="Yearsalive",groupvars=c("AsMi_plot_id","AsMi_site_id"))
})

smzero <- do.call(rbind,sumyrsalivezero)
head(sumyrsalivezero[[5]])  # Why is there 1 row of no data? In the download there is one row of blank

#Wait, want to know how many years allowed dormant and want years before cbind, but this is the summary...
smzero <- smzero[smzero$AsMi_plot_id != 0,]
head(smzero)


```




###Environmental Data from PRISM:   
<http://prism.oregonstate.edu/explorer/>   


```{r}
asmi.climate <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/2015_asmi/prism_data_csv.csv"),skip=6)
head(asmi.climate)

asmi.climate$Year <- substr(asmi.climate$Date,1,4)
asmi.climate$Month <- substr(asmi.climate$Date,6,7)
asmi.climate <- data.frame(Site = "South Beaver Creek", asmi.climate)

asmi.c <- asmi.climate[,c(1,3,5,7:9)]
names(asmi.c) <- c("Site","Precip","tmin","tmax","Year","Month")
head(asmi.c)
```

Seasons    
Winter: December-March (12-3)    
Spring/summer: April-July (4-7)    
Fall: August-November (8-11)   
```{r}
asmi.c$season <- "winter"
asmi.c[asmi.c$Month>3 & asmi.c$Month<8, "season"] <- "spring/summer"
asmi.c[asmi.c$Month>7 & asmi.c$Month<12, "season"] <- "fall"

asmi.c.summary <- aggregate(asmi.c[,2:4])

```


### Intraannual visits    
Will want to ignore sites that were not visited - deal with differently than plants that were not seen but are also NA    


```{r}
intra <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Raw Data/2015 datasheets/2015_intrayear_asmi.csv"), na.strings="")

head(intra)
names(intra)
str(intra)

intra[intra$Plot == 8,"LnJune22.24"]
head(intra[intra$Plot == 8,])

intra <- transform(intra, LnJune22.24 = as.numeric(LnJune22.24))

sur.plots <- read.csv(path.expand("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/2015_asmi/IntraYearsurveys_tomerge.csv"), na.strings="")

# More helpful to swap
#colnames(intra)[grep("Ln",names(intra))] <- c("Ln13",colnames(tsur.plots))
#colnames(intra)

nms <- colnames(intra[grep("Ln",names(intra))])
row.names(sur.plots) <- nms[-1]

sur.plots
tsur.plots <- t(sur.plots[,-1])
head(tsur.plots)
colnames(tsur.plots) <- sur.plots[,1]

sp <- melt(tsur.plots)
surveyed <- sp[sp$value==1,]
notsurveyed <- sp[is.na(sp$value),]

foo <- lapply(split(intra, intra$Plot), 
              function(x){
                cbind(colSums(x[,grep("Ln", names(x))], na.rm = TRUE),unique(x$Plot))
                })
foo[[2]]
sumln <- do.call(rbind, foo)
rownames(sumln)
plotswithdata <- sumln[sumln[,1] > 0,]
plotsmissingdata <- sumln[sumln[,1] == 0,]



str(intra)


```

Reformat intra data    
```{r}
head(intra)

melt(intra[grep("")])
```





