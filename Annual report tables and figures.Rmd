---
title: "AsMi_annual report"
author: "Michelle DePrenger-Levin"
date: "Tuesday, October 27, 2015"
output:
  word_document: default
  html_document: default
---
The git remote is "AsMiPVA"
AsMiPVA


2020 - convert everything to z-scores (mean of 0, SD) All values (x-mean)/SD

On Onedrive "C:\Users\DePrengm\OneDrive - Denver Botanic Gardens\P drive\hackathon\GitPVA\"

```{r}
# library(reshape2) 
library(dplyr)
library(tidyr)
library(ggplot2)
# library(psych)
library(popbio)
library(Rage)
library(devtools)
library(sciplot)
library(plotrix)
library(scales)
# library(plyr)
library(digest)
library(RCurl)
# library(roxygen2)  # only need if files have roxygen2 comments
# install_github(repo = "prism", username = "ropensci")
library(prism)
# prism_set_dl_dir("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/PRISM_asmiclimate")
# library(rgdal) Will go away in 2023 https://r-spatial.org/r/2022/04/12/evolution.html and https://github.com/r-spatial/evolution rgdal: version: 1.6-2, (SVN revision 1183)

library(raster)
library(Rmisc)  ## USES dplyr
# library(data.table)
# library(survminer)

library(car) 

# AIC
require(AICcmodavg)
library(lme4)
library(lattice)

#Plots and figures
library(DiagrammeR)
library(patchwork)

library(MASS)
library(HDInterval)

library(popdemo)
library(RMark)

```


Remove all variables, keep functions
```{r reset values, eval = FALSE}
rm(list = setdiff(ls(), lsf.str()))
rm(list = ls())
```

summarySE function borrowed from http://www.cookbook-r.com/Manipulating_data/Summarizing_data/  
Function for t.tests, for annual lambdas
```{r}

# StagePVA_Function.R
# source_url("https://raw.githubusercontent.com/DenverBotanicGardens/PVA/master/StagePVA_Function.R")
# script <- getURL("https://raw.githubusercontent.com/DenverBotanicGardens/PVA/master/StagePVA_Function.R",ssl.verifypeer = FALSE)
# eval(parse(text = script))

# StagePVA_simple for one plot at a time function is StagePVA_single
# source_url("https://raw.githubusercontent.com/DenverBotanicGardens/PVA/master/StagePVA_simple.R")
# script <- getURL("https://raw.githubusercontent.com/DenverBotanicGardens/PVA/master/StagePVA_simple.R",ssl.verifypeer = FALSE)
# eval(parse(text = script))

# ### Function for lambda and 
# requires library(popbio)    
# x is the list of matrices, i.e. notfenced.Site.matrix$"26",     
# 					or fenced.Site.matrix$"19"[2:17])    
# y is the start year    
# z is the start of the last transition


## 2023 - too much uncertainty about a seedling vs. a resprout, use three stage PVA
# Vegetative, Reproductive, Dormant
## Get 2 stage pva to make MPMs
source_url("https://raw.githubusercontent.com/DenverBotanicGardens/PVA/master/StagePVA2stages_dormancyoptional.R")


lmdSD <- function(x,y,z){
  
  startyr <- min(as.numeric(names(x)))
	yrs <- startyr:z
	st <- match(c(y,z),yrs)
	
	lambdaAll <- c()
	for(i in c(y:z)){
		lambdaAll <- cbind(lambdaAll,eigen.analysis(x[[as.character(i)]])$lambda)
	}	
	StandDev <- sqrt(var(c(lambdaAll)))	#Standard Deviation
	cbind(lmda = lambda(mean(x[st[1]:st[2]])),SD = StandDev)
}	

lmdAn <- function(x,y,z){
	lambdaAll <- c()
	for(i in c(y:z)){
		lambdaAll <- cbind(lambdaAll,eigen.analysis(x[[as.character(i)]])$lambda)
	}	
	lambdaAll
}
```


# Methods, Bayesian multiple types of data to estimate parameters and latent states   
```{r}
grViz("digraph integrated_pop {
      
      # digraph = directed, graph = undirected, graphID
      graph [compound = true, color = blue, rankdir = LR]
      
      # node definitions with substituted label text
      node [shape = circle, fontname = Helvetica]
      # Demographic monitoring
      a [label = '@@1-1']
      b [label = '@@1-2']
      c [label = '@@1-3']
      d [label = '@@1-4']
      i [label = '@@1-5']
      
      # Within season monitoring
      e [label = '@@2-1']
      f [label = '@@2-2']
      g [label = '@@2-3']
      h [label = <&Phi;<SUB>stn_j</SUB>>]
      
      # name must start with 'cluster_'
      subgraph cluster_demography {
        graph [style = dashed, color = Sienna]
        rank = same; a;d;
        rank = same; b; c;
        i -> a
        a -> {b c}
        b -> c
        # c -> a # [style = dashed, color = LimeGreen]
        c -> i [style = dashed, color = red]
        a -> d
        b -> d
        c -> d
        c -> b [color = darkgrey]
        d -> b [color = darkgrey]
        d -> c [color = darkgrey]
        d -> d [style = dashed, color = red] #, dir = back]
        c -> c
        b -> b
        i -> i [style = dashed, color = red]
        
        label = 'Demography'
      }
      
      subgraph cluster_seasonal {
        graph [style = dashed, color = Sienna]
        e -> {f g}
        f -> g
        
        label = 'Within season'
      }
      
      subgraph cluster_census {
        graph [style = dashed, color = grey]
        N_t
        
        label = 'Time series'
      }
      
      subgraph cluster_detection {
        graph [style = dashed, color = Sienna]
        h
        
        label = 'Detection probability'
      }
      
    h -> {e f g} [lhead = cluster_seasonal] [style = dashed, color = Indigo, dir = both]
    h -> d [color = Indigo]
    # f -> d [ltail = cluster_demography, lhead = cluster_seasonal] 
    [lhead = cluster_demography, ltail = cluster_census]
    }
      
      [1]: c('Seedling','Vegetative','Reproductive','Dormant','Seed')
      [2]: c('Seedling','Vegetative','Reproductive')
      ")

```



# Download raw_data 
<https://research.botanicgardens.org/admin/demographics/asmi/reports/raw_data.php>   
Save all sites, all data, and set to 20 years allowed dormant (or all possible years)    
Put the new data in folder currentyr_asmi and name it RawData_currentyr 
```{r}
currentyr <- as.numeric(format(as.Date(Sys.Date(),format="%Y-%m-%d"), "%Y"))

##To change if someone other than Michelle is running code
userpath <- "C:/Users/DePrengm/"

rawdatapath <- paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/", currentyr, "_Astragalus-microcymbus_RawData.csv", collapse = '', sep = '')

asmi.raw <- read.csv(rawdatapath, na.strings = "na")

# need to remove all plot 89, site 1 in 2020 and beyond
asmi.raw <- asmi.raw[!(asmi.raw$AsMi_plot_id == 89 & asmi.raw$year > 2019),]


# For the path and start of the name of each file
savepath <- paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_AnnualReports/", currentyr, "_Astragalus-microcymbus_AnnualReport/", collapse = '', sep = '')

## How many plant seen this year?
nrow(asmi.raw[asmi.raw$year == currentyr & asmi.raw$length > 0,])


asmi.raw$length[is.na(asmi.raw$length)] <- 0

# For plots that didn't start in 1995 !!! All new plants are listed as seedlings in 2014 and none should
table(asmi.raw$AsMi_plot_id[asmi.raw$AsMi_site_id==1], 
      asmi.raw$status[asmi.raw$AsMi_site_id==1], 
      asmi.raw$year[asmi.raw$AsMi_site_id==1])

table(asmi.raw$AsMi_plot_id[asmi.raw$AsMi_site_id==2], 
      asmi.raw$status[asmi.raw$AsMi_site_id==2], 
      asmi.raw$year[asmi.raw$AsMi_site_id==2])

# Site 26 had two plots added later; Plots 238 and 300 were added in 1996 with no seedlings! good!;  plot 598 was added in 2004, no seedlings, good!  
table(asmi.raw$AsMi_plot_id[asmi.raw$AsMi_plot_id %in% c(238,300,598)], 
      asmi.raw$status[asmi.raw$AsMi_plot_id %in% c(238,300,598)],
      asmi.raw$year[asmi.raw$AsMi_plot_id %in% c(238,300,598)])

# Need to change all the seedling in 2014 for sites 1 and 2 to appropriate vegetative or reproductive 
asmi.raw$status[asmi.raw$AsMi_site_id<3 & asmi.raw$year == 2014 & asmi.raw$flower == 0] <- "vegetative"
asmi.raw$status[asmi.raw$AsMi_site_id<3 & asmi.raw$year == 2014 & asmi.raw$flower == 1] <- "reproductive"

# No longer adding climate data to the database
asmi.raw <- asmi.raw[,grep(paste(c("Temp","Rain","Snow","Aug.Jul"),collapse="|"), names(asmi.raw),
                           value = TRUE, invert = TRUE)]

table(asmi.raw$year, asmi.raw$AsMi_site_id)
table(asmi.raw$year, asmi.raw$AsMi_plot_id)
table(asmi.raw$Browsing...Status)
asmi.raw$Browsing...Status[asmi.raw$Browsing...Status == "mammal" ] <- "Mammal"
asmi.raw[asmi.raw$Browsing...Status ==""& !is.na(asmi.raw$Browsing...Status),]
asmi.raw[is.na(asmi.raw$AsMi_data_id),]
asmi.raw <- asmi.raw[!is.na(asmi.raw$AsMi_data_id),] # remove any rows with NA for data_id

# Which plot # go with which site
plotsXsite <- as.data.frame(table(asmi.raw$AsMi_plot_id,asmi.raw$AsMi_site_id))
plotsXsite[plotsXsite$Freq > 0,]

# one blank row at the end of the csv download, gone by 2021
asmi.raw[asmi.raw$status == "",]
# asmi.raw <- asmi.raw[asmi.raw$status != "",]
asmi.raw$status <- factor(asmi.raw$status)
table(asmi.raw$status)

#reset factors of browsing to eliminate " "
# asmi.raw$Browsing...Status[asmi.raw$Browsing...Status == "mammal"] <- "Mammal"
asmi.raw$Browsing...Status <- factor(asmi.raw$Browsing...Status)

#reset factors for fence
asmi.raw$fence <- factor(asmi.raw$fence)
table(asmi.raw$fence)

asmi.raw[asmi.raw$length>90 & !is.na(asmi.raw$length),] 
asmi.raw$length[asmi.raw$length == 921] <- 21

# If there are fruit, it flowered and needs to be reproductive, not vegetative
asmi.raw[asmi.raw$status=="vegetative" & asmi.raw$fruit>0,] # 5 times in 2020
wrongAsMidataid <- asmi.raw$AsMi_data_id[asmi.raw$status=="vegetative" & asmi.raw$fruit>0]
asmi.raw$flower[asmi.raw$AsMi_data_id %in% wrongAsMidataid] <- 1
asmi.raw$status[asmi.raw$AsMi_data_id %in% wrongAsMidataid] <- "reproductive"
asmi.raw[asmi.raw$AsMi_data_id %in% wrongAsMidataid,]

## If not first year seen, cannot be seedling (found this error when checking stage to fate table)
asmi.raw %>%
  filter(AsMi_tag_id == 2551)

asmi.raw <- asmi.raw %>%
  mutate(status = as.character(status)) %>%
  dplyr::mutate(status = case_when((AsMi_tag_id == 2551 & year == 2015) ~ "vegetative",
                            TRUE ~ status)) %>%
  mutate(status = as.factor(status))


# Years of study in the abstract
length(1995:currentyr)
```


## First age of reproduction   
```{r}
# Assign age of 1 to all seedlings
asmi.raw$age[asmi.raw$status == "seedling"] <- 1

i <- unique(asmi.raw$AsMi_tag_id)[1]
for(i in unique(asmi.raw$AsMi_tag_id)){
  if(any(asmi.raw$status[asmi.raw$AsMi_tag_id == i] %in% "seedling")){
    asmi.raw$age[asmi.raw$AsMi_tag_id == i] <-  1:length(asmi.raw$year[asmi.raw$AsMi_tag_id == i])
  } else {
    asmi.raw$age[asmi.raw$AsMi_tag_id == i] <- 2:(length(asmi.raw$year[asmi.raw$AsMi_tag_id == i])+1)
  }
}  

head(asmi.raw)
## Estimate of age of first reproduction from known ages
firstagerepro <- c()
for(i in unique(asmi.raw$AsMi_tag_id)){
  if(any(asmi.raw$status[asmi.raw$AsMi_tag_id == i] %in% "seedling")){
    firstagerepro <- c(firstagerepro, match("reproductive",asmi.raw$status[asmi.raw$AsMi_tag_id == i]) )
  }
}

length(firstagerepro)
sum(is.na(firstagerepro))

hist(firstagerepro)
median(firstagerepro, na.rm = TRUE) ## 3
HDInterval::hdi(firstagerepro)
```


### Drop to bottom to download new climate data!! and to make and save annual, seasonal data
UTM Zone 13 from ArcGIS
```{r}
# asmilatlong <- read.csv("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Word/2016_asmi/UTM_asmiplots.csv")
asmilatlong <- read.csv(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_AnnualReports/2016_Astragalus-microcymbus_AnnualReport/UTM_asmiplots.csv", sep="", collapse = ""))

# Convert from UTM to lat/long
asmi.ll <- spTransform(SpatialPoints(cbind(asmilatlong$Easting,asmilatlong$Northing), 
                                     proj4string = CRS("+proj=utm +zone=13 + datum=WGS84")), 
                       CRS("+proj=longlat +datum=WGS84"))

asmiLL <- data.frame(raster::coordinates(asmi.ll),asmilatlong$Tag__,asmilatlong$Tag_Commen)

# only if made it for current year, then load here and skip the climate chunks that follow
load( paste("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/asmi.climate", currentyr,".Rdata", sep=""))
load(paste("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/asmi.annual", currentyr,".Rdata", sep=""))
load(paste("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/asmi.season", currentyr,".Rdata", sep=""))
load(paste("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/asmi.season.wide", currentyr,".Rdata", sep=""))

```
asmi.c from github    Plot Site   Creek   tmin        Site.1 tmax Precip Year Month Prev12


```{r}
## I think wants wide instead of long as in asmi.annual
# asmi.c <- asmi.climate
asmi.c <- asmi.annual %>%
  pivot_wider(names_from = Variable, values_from = Value) %>%
  dplyr::mutate(across(ppt:tmin, scale, .names = "{.col}_scaled")) %>%
  mutate(Year = Prev12)
  

# Get a list of sites and plots per Creek to merge with asmi.c
plots.site <- asmi.raw[!duplicated(asmi.raw$AsMi_plot_id),c("AsMi_plot_id","AsMi_site_id")]
plots.site <- plots.site[complete.cases(plots.site),]
plots.site$Creek <- "SouthBeaver"
plots.site$Creek[plots.site$AsMi_site_id < 3] <- "Cebolla"

asmi.c <- merge(plots.site, asmi.c, by.x="AsMi_plot_id", by.y="Plot")
asmi.c <- asmi.c %>%
  dplyr::rename(Plot = AsMi_plot_id, SiteID = AsMi_site_id)

asmi.season.wide %>%
  filter(Prev12 > 2012 & Prev12 < 2016) %>%
  ungroup() %>% ## but it's not grouped, maybe was taking as each row is a group without this call?
  dplyr::mutate(across(ppt_fall:tmin_winter, .fns = scale)) %>% #, .names = "{.col}_scaled")) %>%
  # pivot_longer(cols = ppt_fall_scaled:tmin_winter_scaled, names_to = "VarSeason",
  pivot_longer(cols = ppt_fall:tmin_winter, names_to = "VarSeason",
               values_to = "Value") %>%
  left_join(plots.site, by = c('Plot' = 'AsMi_plot_id')) %>%
  separate(VarSeason, c("Variable","season"), sep = "_") %>%
  ggplot(  aes(Prev12, Value, color = site))+
    geom_point()+
    stat_smooth()+
    theme_bw()+
    scale_color_manual("Site", values = c("black","grey50","deepskyblue","cyan4","cyan","cornflowerblue"))+
    # facet_grid(Variable ~ season + Creek)
    facet_grid(Variable ~ season)

asmi.season.wide %>%
  filter(Prev12 > 1994) %>%
  ungroup() %>% 
  dplyr::mutate(across(ppt_fall:tmin_winter, .fns = scale)) %>% 
  pivot_longer(cols = ppt_fall:tmin_winter, names_to = "VarSeason",
               values_to = "Value") %>%
  left_join(plots.site, by = c('Plot' = 'AsMi_plot_id')) %>%
  separate(VarSeason, c("Variable","season"), sep = "_") %>%
  ggplot(  aes(Prev12, Value, color = site))+
    geom_point()+
    stat_smooth()+
    theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
    scale_color_manual("Site", values = c("black","grey60","deepskyblue","cyan4","cyan","cornflowerblue"))+
    facet_grid(Variable ~ season + Creek)
    # facet_grid(Variable ~ season)

```

# Environmental Data
```{r}

# 1986 to currentyr
asmi.c %>% 
  group_by(Creek) %>%
  dplyr::summarise(across(ppt:tmin, mean)) %>%
  as.data.frame()


asmi.c %>%
  pivot_longer(cols = ppt_scaled:tmin_scaled, names_to = "variable", values_to = "value") %>%
ggplot(  aes(Prev12, value, color = site, group = site))+
  geom_point()+
  stat_smooth()+
  facet_grid(Creek~variable)

asmi.c %>%
  pivot_longer(cols = ppt:tmin, names_to = "variable", values_to = "value") %>%
  group_by(Creek, variable) %>%
  dplyr::summarise(mean1986_current = mean(value), sd1986_current = sd(value)) %>%
  as.data.frame()

asmi.c %>%
  pivot_longer(cols = ppt:tmin, names_to = "variable", values_to = "value") %>%
  filter(Year > 1994) %>%
  group_by(Creek, variable) %>%
  dplyr::summarise(mean1995_current = mean(value), sd1995_current = sd(value)) %>%
  as.data.frame()


```


## ---------------------------------------- Paper Analysis -------------------------------------------------

# Annual precipiation average per year
```{r}
length(1995:currentyr)

## Cebolla Creek 2014 - current year
CCc <- asmi.c %>%
  filter(Creek == "Cebolla" & Prev12 > 2013) %>%
  dplyr::summarise(Creek = "CC14",
                   meanPPT = mean(ppt), sdPPT = sd(ppt),
                   meanTmax = mean(tmax), sdTmax = sd(tmax),
                   meanTmin = mean(tmin), sdTmin = sd(tmin))

## South Beaver Creek 1995 - current year
SBCc <- asmi.c %>%
  filter(Creek == "SouthBeaver" & Prev12 > 1994) %>%
  dplyr::summarise(Creek = "SBC95",
                   meanPPT = mean(ppt), sdPPT = sd(ppt),
                   meanTmax = mean(tmax), sdTmax = sd(tmax),
                   meanTmin = mean(tmin), sdTmin = sd(tmin)) 

## 1986 - current year
historicc <- asmi.c %>%
  group_by(Creek) %>%
  dplyr::summarise(meanPPT = mean(ppt), sdPPT = sd(ppt),
            meanTmax = mean(tmax), sdTmax = sd(tmax),
            meanTmin = mean(tmin), sdTmin = sd(tmin)) 


CCc %>%
  bind_rows(SBCc) %>%
  bind_rows(historicc) %>% 
  mutate(Creek = factor(Creek, levels = c("Cebolla", "CC14", "SouthBeaver","SBC95"))) %>%
  # pivot_longer(cols = starts_with("mean"), 
  #              names_to = "meanVariable")
ggplot(  aes(Creek, meanPPT)) +
  geom_point()+
  geom_errorbar(aes(ymin = meanPPT - sdPPT, ymax = meanPPT + sdPPT))

CCc %>%
  bind_rows(SBCc) %>%
  bind_rows(historicc) %>% 
  mutate(Creek = factor(Creek, levels = c("Cebolla", "CC14", "SouthBeaver","SBC95"))) %>%
  # pivot_longer(cols = starts_with("mean"), 
  #              names_to = "meanVariable")
ggplot(  aes(Creek, meanTmax)) +
  geom_point()+
  geom_errorbar(aes(ymin = meanTmax - sdTmax, ymax = meanTmax + sdTmax))

CCc %>%
  bind_rows(SBCc) %>%
  bind_rows(historicc) %>% 
  mutate(Creek = factor(Creek, levels = c("Cebolla", "CC14", "SouthBeaver","SBC95"))) %>%
  # pivot_longer(cols = starts_with("mean"), 
  #              names_to = "meanVariable")
ggplot(  aes(Creek, meanTmin)) +
  geom_point()+
  geom_errorbar(aes(ymin = meanTmin - sdTmin, ymax = meanTmin + sdTmin))


CCc
SBCc
historicc
```


Table 1:Demographic data of Astragalus microcymbus within the South Beaver Creek and Cebolla Creek drainages near Gunnison, Colorado. (a) Average number of individuals with above ground growth (AGG) followed by total individuals (AGG and dormant) per plot. (b) Percent of reproductive individuals followed by average reproductive individuals per plot. Site 1 is Cebolla Creek Mid and site 2 is Cebolla Creek north. Standard errors are shown in parentheses.
```{r}
#AGG
#length of group when the plant had a length greater than zero
alive <-aggregate(length ~ AsMi_plot_id + year + AsMi_site_id + fence, 
                  data = asmi.raw, function(x) length(x[x>0 & !is.na(x)])) 

alive <- alive %>%
  filter(!(AsMi_plot_id == 89 & year > 2019)) %>%
  filter(!(AsMi_plot_id == 52 & year == 2024))

## Not fair comparison since lost plot in Site 2 and lost data at plot 52 in year 2024 due to tablets and excel
totalyr <- aggregate(length~AsMi_site_id, data = alive[alive$year == currentyr,], sum)
sum(totalyr$length[1:2])
sum(totalyr$length[3:6])


alive2 <- do.call(rbind,lapply(split(asmi.raw, list(asmi.raw$AsMi_plot_id, asmi.raw$year), drop=TRUE), function(plotyr){
  AGG <- length(unique(plotyr$AsMi_tag_id[plotyr$length > 0 & !is.na(plotyr$length)]))
  data.frame(Plot = plotyr$AsMi_plot_id[1], Year = plotyr$year[1], Site = plotyr$AsMi_site_id[1],
             Fence = plotyr$fence[1], AGG, Alive = length(unique(plotyr$AsMi_tag_id[plotyr$status != "dead"])))
}))


# What percent of original size are all plots?
totPOrig <- do.call(rbind,lapply(split(alive2,alive2$Plot),
                                  function(plot){
                                    first <- plot$AGG[plot$Year==min(plot$Year)]
                                    last <- plot$AGG[plot$Year==max(plot$Year)]
                                    percent <- last/first
                                    out <- data.frame(plot[plot$Year==min(plot$Year),],
                                                      plot[plot$Year==max(plot$Year),
                                                           c("Year","AGG","Alive")],
                                                      percent)
                                    out
                                    }))

outdata <- do.call(rbind,lapply(unique(totPOrig$Site), function(pl){
  data.frame(totPOrig[totPOrig$Site == pl,],average = mean(totPOrig$percent[totPOrig$Site == pl]))
       }))
outdata[with(outdata, order(percent,Site,Fence)),]
aggregate(AGG ~ Site, data = outdata, sum)

aggregate(AGG.1 ~ Site, data = outdata, sum)

#AGG and dormant
aggdorm <- aggregate(status ~ AsMi_plot_id +year + AsMi_site_id  + fence,
                     data = asmi.raw, function(x) length(x[x != "dead" & !is.na(x)]))
aggdorm <- aggdorm %>%
  filter(!(AsMi_plot_id == 89 & year > 2019)) %>%
  filter(!(AsMi_plot_id == 52 & year == 2024))

## Figure 2: Number of AsMi with AGG
# Need to exclude Plot 52 at site 1

alive %>%
  filter(length == 0)
asmi.raw %>%
  filter(AsMi_plot_id == 16 & year %in% c(2021,2022))

ggsave(paste(savepath, "Fig2AGG.jpg", sep = ""),
(alive %>%
  mutate(Creek = case_when(AsMi_site_id < 3 ~ "Cebolla",
                           AsMi_site_id > 3 ~ "South Beaver")) %>%
ggplot(  aes(as.factor(year), length)) + 
  geom_boxplot()+
  ylab("Individuals with AGG per plot")+
  xlab("Year")+
  theme_bw()+
  facet_wrap(~as.factor(AsMi_site_id) + Creek, scales = "free")+
  scale_color_discrete(guide = "none")+ 
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ggtitle("a)"))
/

(aggdorm %>%
  mutate(Creek = case_when(AsMi_site_id < 3 ~ "Cebolla",
                           AsMi_site_id > 3 ~ "South Beaver")) %>%
   filter(if_else(AsMi_site_id > 3, year > 1995, year > 2014)) %>%
   filter(if_else(AsMi_plot_id == 598, year > 2004, year > 1995)) %>%
   filter(if_else(AsMi_plot_id %in% c(238,300), year > 1996, year > 1995)) %>%
   filter(if_else(AsMi_plot_id == 89, year < 2020, year < currentyr)) %>% ## Tags removed in 2020 by unknown
   filter(year < currentyr) %>%
  ggplot(  aes(as.factor(year), status)) + 
  geom_boxplot()+
  ylab("Individuals with AGG and dormant per plot")+
  xlab("Year")+
  theme_bw()+
  facet_wrap(~as.factor(AsMi_site_id) + Creek, scales = "free")+
  scale_color_discrete(guide = "none")+ 
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
   ggtitle(("b)"))), 
width=275, height=250,units='mm', dpi=300)



```

#Fluctuations  
```{r}

#AGG
alive.site <-aggregate(length ~ year + AsMi_site_id + fence, 
                  data = asmi.raw, function(x) length(x[x>0 & !is.na(x)]))

a.s <- asmi.raw %>%
  group_by(year, AsMi_site_id, fence) %>%
  filter(length > 0 & !is.na(length)) %>%
  dplyr::summarise(length = n()) %>%
  arrange(AsMi_site_id, fence, year) %>%
  as.data.frame()

#AGG and dormant
aggdorm.site <- aggregate(status ~ year + AsMi_site_id  + fence,
                     data = asmi.raw, function(x) length(x[x != "dead" & !is.na(x)]))

agg.s <- asmi.raw %>%
  group_by(year, AsMi_site_id, fence) %>%
  filter(status != "dead" & !is.na(status)) %>%
  dplyr::summarise(length = n()) %>%
  arrange(AsMi_site_id, fence, year)

PercentAlive <- lapply(split(alive.site, alive.site$AsMi_site_id), function(x){
  nofence <- x$length[x$year == max(x$year)&
                        x$fence=="n"]/x$length[x$year==min(x$year)&x$fence=="n"]
  fence <- x$length[x$year == max(x$year)&
                      x$fence=="y"]/x$length[x$year==min(x$year)&x$fence=="y"]
  cbind(nofence,fence)

  })

tbl1a.1 <- summarySE(alive, measurevar="length", groupvars=c("AsMi_site_id", "year"))

tbl1a.2 <- summarySE(aggdorm, measurevar="status", groupvars=c("AsMi_site_id", "year"))

sites <- unique(tbl1a.1$AsMi_site_id)

tbl1.1 <- lapply(sites, function(x){
  paste(round(tbl1a.1[tbl1a.1$AsMi_site_id == x,"length"],2)," (",
        round(tbl1a.1[tbl1a.1$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1.2 <- lapply(sites, function(x){
  paste(round(tbl1a.2[tbl1a.2$AsMi_site_id == x,"status"],2)," (",
        round(tbl1a.2[tbl1a.2$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1a <- lapply(1:6, function(x){
  data.frame(tbl1.1[[x]],tbl1.2[[x]])
  })


Table1 <- data.frame(tbl1a[[3]],tbl1a[[4]],tbl1a[[5]],tbl1a[[6]])
names(Table1) <- c("Site 05 (5 plots)"," ","Site 15 (4 plots)"," ",
                   "Site 19 (5 plots)"," ","Site 26 (5 plots)"," ")

write.table(Table1, file=paste(savepath,"Table1a_SouthBeaverCreek.csv", collapse = '', sep = ''), sep=",", row.names=FALSE, col.names = TRUE)

Table1_Cebolla <- data.frame(tbl1a[[1]],tbl1a[[2]])
names(Table1_Cebolla) <- c("Site 1 (5 plots)"," ","Site 2 (6 plots)"," ")

write.table(Table1_Cebolla, file=paste(savepath,"Table1a_CebollaCreek.csv", collapse = '', sep = ''), sep=",", row.names=FALSE, col.names = TRUE)


# Percent and total reproductive
# percent reproductive, return 0 if no 
prep <- aggregate(flower~AsMi_plot_id+year+AsMi_site_id +fence,
                  data = asmi.raw[asmi.raw$length > 0 & !is.na(asmi.raw$length),],
                  function(x){
                    if(length(x)>0){
                      sum(x,na.rm = TRUE)/length(x)
                    } else {
                        0
                      }
                  })
tbl1b.1 <- summarySE(prep, measurevar="flower", groupvars=c("AsMi_site_id","year"))

# Years when there were no reproductive individuals  
# Episodic fruit production paragraph
prep[prep$flower==0,]
annual_SBC <- aggregate(flower~year, data=prep[prep$AsMi_site_id>3,], sum)
zero_annual <- data.frame(num = nrow(annual_SBC[annual_SBC$flower == 0,]),
                          percent = nrow(annual_SBC[annual_SBC$flower == 0,])/nrow(annual_SBC))


do.call(rbind,zero_annual)

annual_site <- aggregate(flower~AsMi_site_id+year, data=prep, sum)
zero_site <- lapply(split(annual_site, annual_site$AsMi_site_id), function(x){
  numberof <- nrow(x[x$flower == 0,])
  percent <- nrow(x[x$flower == 0,])/nrow(x)
  data.frame(numberof,percent)
})
zero_all <- do.call(rbind,zero_site)
mean(zero_all$numberof[3:6]) # average number of years with no reproduction

```


```{r}
#sites above
#percent reproductive 
tbl1.3 <- lapply(sites, function(x){
  paste(round(tbl1b.1[tbl1b.1$AsMi_site_id == x,"flower"],3)*100,"% (",
        round(tbl1b.1[tbl1b.1$AsMi_site_id == x,"se"],3)*100, "%)", sep="")
})

tbl1.3[[3]]

#total reproductive
totrep <- aggregate(flower ~ AsMi_plot_id +year + AsMi_site_id  + fence,
                    data = asmi.raw[asmi.raw$length > 0 & !is.na(asmi.raw$length),], 
                    function(x) sum(x, na.rm = TRUE))


tbl1b.2 <- summarySE(totrep, measurevar="flower",groupvars=c("AsMi_site_id","year"))

tbl1.4 <- lapply(sites, function(x){
  paste(round(tbl1b.2[tbl1b.2$AsMi_site_id == x,"flower"],2)," (",
        round(tbl1b.2[tbl1b.2$AsMi_site_id == x,"se"],2), ")", sep="")
})

tbl1b <- lapply(1:6, function(x){
  data.frame(tbl1.3[[x]], tbl1.4[[x]])
  })

Table1b <- data.frame(tbl1b[[3]],tbl1b[[4]],tbl1b[[5]],tbl1b[[6]])
names(Table1b) <- c("Site 05 (5 plots)"," ","Site 15 (4 plots)"," ",
                   "Site 19 (5 plots)"," ","Site 26 (5 plots)"," ")

write.table(Table1b, file=paste(savepath,"Table1b_SouthBeaverCreek.csv", sep=""), sep=",", row.names=FALSE, col.names = TRUE)

Table1b_Cebolla <- data.frame(tbl1b[[1]],tbl1b[[2]])
names(Table1b_Cebolla) <- c("Site 1 (5 plots)"," ","Site 2 (6 plots)"," ")

write.table(Table1b_Cebolla, file=paste(savepath,"Table1b_CebollaCreek.csv", sep=""), sep=",", row.names=FALSE, col.names = TRUE)
```


# Cebolla Creek Count  
```{r}
length(2014:currentyr)
```



#Correlated biotic factors

Table 3: Biotic factors correlated among the percent browsed individuals in the current year, density of reproductive individuals in the current year, fruit production in the current year, and the percent of reproductive individuals and above ground growth (AGG) in the current and previous year of Astragalus microcymbus per year (1995-2014) within the South Beaver Creek drainage ....Significant PCC are indicated with an asterisk (p-value < 0.05).  

Plot Summary (weather data is prev. Aug through currrent Jul)   
Total.Plants are AGG and dormant    
Total.Alive is AGG   
X..Flowered must be percent flowered and    
X..Flowered.1 is number flowered

#Save new annual data in folder titled "<current year>_asmi" and name the file "PlotSummary_<current year>"  pre-Teams
# Save new annual data in folder "~\Denver Botanic Gardens\Conservation - General\AllProjectsBySpecies\Astragalus microcymbus\Astragalus-microcymbus_Data\" and title them:     
     "<current year>_Astragalus-microcymbus_PlotSummary.csv"   
     "<current year>_Astragalus-microcymbus_RawData.csv"
```{r}
plotdatapath <- paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/",
        currentyr,"_Astragalus-microcymbus_PlotSummary.csv",
                      collapse = '', sep = '')
ps.asmi <- read.csv(plotdatapath)
# Don't need the climate data from database, will download from PRISM
ps.asmi <- ps.asmi %>%
  dplyr::select(Year:Fence) ##ps.asmi[,1:11] # old climate data that isn't updated in the database

# Have data for all years but were only in place in the listed years
ps.asmi$Year[ps.asmi$Plot == 89] # 2014-2019
ps.asmi$Year[ps.asmi$Plot == 598] # 2004-currentyr
ps.asmi$Year[ps.asmi$Plot == 300] # 1996-currentyr

# remove rows with summaries of non-existent plots like 89 after 2019
ps.asmi <- ps.asmi[!(ps.asmi$Plot == 89 & ps.asmi$Year > 2019),]
ps.asmi <- ps.asmi[!(ps.asmi$Site < 3 & ps.asmi$Year < 2014),]
ps.asmi <- ps.asmi[!(ps.asmi$Plot == 598 & ps.asmi$Year < 2004),]
ps.asmi <- ps.asmi[!(ps.asmi$Plot == 300 & ps.asmi$Year < 1996),]
ps.asmi <- ps.asmi[!(ps.asmi$Plot == 238 & ps.asmi$Year < 1996),]


## What was the total population size in plots that eventually are fenced?
ps.asmi %>%
  filter(Site == 5) %>%
  group_by(Fence, Year) %>%
  dplyr::summarise(TotalPlant = sum(Total.Plants), 
                   AGG = sum(Total.Alive), .groups = "keep") %>%
  print(n=56)
# aggregate(Total.Plants ~ Fence + Year, data = ps.asmi[ps.asmi$Site == 5,], sum)

# remove the moniker of 'y' from fenced plots before they are fenced.
ps.asmi$Fence[ps.asmi$Year<2006] <- 'n'

ps.asmi$Creek <- "SouthBeaver"
ps.asmi$Creek[ps.asmi$Site < 3] <- "Cebolla" 
ps.asmi$Creek <- as.factor(ps.asmi$Creek)

## Number of individuals alive in current year compared to start of Cebolla Creek == 2014
# ps.asmi %>%
#   filter(Site < 3) %>%
#   group_by(Fence, Site, Year) %>%
#   dplyr::summarise(sum(Total.Plants))
lapply(split(ps.asmi[ps.asmi$Site < 3,], list(ps.asmi$Fence[ps.asmi$Site < 3],  
                                                   ps.asmi$Site[ps.asmi$Site < 3]), drop=TRUE), 
       function(x){
         aggregate(Total.Plants ~ Year, data = x, sum)/sum(x$Total.Plants[x$Year == 2014])*100
         }) 

lapply(split(ps.asmi[ps.asmi$Site < 3,], list(ps.asmi$Fence[ps.asmi$Site < 3],  
                                                   ps.asmi$Site[ps.asmi$Site < 3]), drop=TRUE), 
       function(x){
         aggregate(Total.Alive ~ Year, data = x, sum)/sum(x$Total.Plants[x$Year == 2014])*100
         }) 


aggregate(Total.Alive ~ Fence + Year + Site, data = ps.asmi[ps.asmi$Site < 3,], sum)

```




#AIC  Information Criteria   
Table 2: linear regression model performance 
AIC = -2L + 2k   
  L is loglikelihood   
  k is number of parameters     
Compare all models at the same time, instead of stepping through pairwise comparisons of tests. 
Flawed still, too many factors/parameters, not enough data. 

Just look at differences separating site and not, separate plot or not. 
Can look at these and then work forward to test predictive on new data (like the BLM or sites we visit this year)

# Table 3 Differences by site, fencing, and within site among plots?
Survival instead of AGG 
```{r}
## use scaled numbers!
asmi.merged <- asmi.raw %>%
  group_by(AsMi_tag_id, AsMi_plot_id, AsMi_site_id, fence) %>%
  left_join(asmi.raw, by = c("AsMi_tag_id", "AsMi_plot_id", "AsMi_site_id", "fence")) %>%  ## not working "fence", "year.x" == ("year.y" + 1)
  dplyr::select(AsMi_tag_id:status.x, AsMi_plot_id:fence, year.y:status.y) %>%
  filter(year.x == year.y-1) %>% # .x is year t, .y is year t+1
  filter(length.x > 0) %>%
  filter(!is.na(length.x)) %>%
  left_join(asmi.season.wide,  by = c("AsMi_plot_id" = "Plot",
                                      "year.y" = "Prev12")) %>%
  mutate(surv = case_when(length.y > 0 & !is.na(length.y) ~ 1,
                          length.y == 0 | is.na(length.y) ~ 0)) %>%
  mutate(Creek = case_when(AsMi_site_id < 3 ~ "Cebolla",
                           AsMi_site_id > 3 ~ "South Beaver"))

## Survival changing linearly over time
asmi.merged %>%
  mutate(Creek = case_when(AsMi_site_id < 3 ~ "Cebolla",
                           AsMi_site_id > 3 ~ "South Beaver")) %>%
ggplot(  aes(year.y, surv, color = site))+
  geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE)+
  geom_jitter(shape = "|", height=0)+
  facet_wrap(~Creek, scales = "free_x")+
  theme_light()+
  xlab("Year")+
  ylab("Survival")

Fig4asurvCreekBr <- asmi.merged %>%
  filter(!is.na(browsing.x)) %>%
  ## Merge seedling and vegetative
  mutate(status.x = as.character(status.x)) %>%
  mutate(status.x = case_when(status.x == "seedling" ~ "vegetative",
                              TRUE ~ status.x)) %>%
ggplot( aes(length.x, surv, color = as.factor(browsing.x)))+
  geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE)+
  geom_point(shape = "|")+
  theme_light()+
  xlab("Length of longest stem (cm)")+
  facet_grid(status.x ~ Creek )+
  scale_color_discrete("Browsing")+
  ylab("Survival")+
  ggtitle("a)")

Fig4asurvCreek <- asmi.merged %>%
  ## Merge seedling and vegetative
  mutate(status.x = as.character(status.x)) %>%
  mutate(status.x = case_when(status.x == "seedling" ~ "vegetative",
                              TRUE ~ status.x)) %>%
ggplot( aes(length.x, surv, color = site))+
  geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE)+
  geom_point(shape = "|")+
  theme_light()+
  xlab("Length of longest stem (cm)")+
  facet_grid(status.x ~ Creek )+
  ylab("Survival")

Fig4asurvSite <- asmi.merged %>%
  ## Merge seedling and vegetative
  mutate(status.x = as.character(status.x)) %>%
  mutate(status.x = case_when(status.x == "seedling" ~ "vegetative",
                              TRUE ~ status.x)) %>%
ggplot( aes(year.x, surv, color = site))+
  geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE)+
  geom_point(shape = "|")+
  theme_light()+
  xlab("Length of longest stem (cm)")+
  ylab("Survival")

asmi.merged %>%
ggplot( aes(year.y, surv, color = fence))+
  geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE)+
  geom_point(shape = "|")+
  theme_light()+
  xlab("Year")+
  facet_wrap(~Creek, scales = "free_x")+
  ylab("Survival")


glm1 <- glm(surv ~ year.x, family = binomial, data = asmi.merged)
glm2 <- glm(surv ~ year.x*as.factor(site), family = binomial, data = asmi.merged)
glm3 <- glm(surv ~ year.x*Creek, family = binomial, data = asmi.merged) 
glm4 <- glm(surv ~ year.x*fence, family = binomial, data = asmi.merged)
glm5 <- glm(surv ~ 1, family = binomial, data = asmi.merged)
glm6 <- glm(surv ~ as.factor(site), family = binomial, data = asmi.merged)
glm7 <- glm(surv ~ Creek, family = binomial, data = asmi.merged) 
glm8 <- glm(surv ~ fence, family = binomial, data = asmi.merged)

glm.list <- list(glm1,glm2,glm3,glm4,glm5,glm6,glm7,glm8)
glm.names <- as.character(unlist(lapply(glm.list,formula)))
(glm.results <- aictab(glm.list, modnames=glm.names))

#evidence ratio 
for(i in 2:length(glm.list)){
  print(exp(0.5*glm.results$Delta_AICc[i]))
}

```
Year and site differ for the total allive with AGG. 

# Climate factors  
```{r}

ggplot(asmi.merged, aes(length.x, length.y, color = site))+
  geom_point()+
  stat_smooth(method="glm")

asmi.merged %>%
  filter(!(status.x %in% c("dead","dormant"))) %>%
  mutate(status.x = case_when(status.x == "seedling" ~ "vegetative",
                              TRUE ~ status.x)) %>%
  mutate(status.x = factor(status.x, levels = c("vegetative","reproductive"))) %>%
ggplot(  aes(status.x, length.x, color = Creek ))+
  geom_boxplot(position = position_dodge(width = 0.1)) +
  geom_point(position = position_dodge(width = 0.1))+
  theme_bw()

## I guess so, we could see fruit and flowers when it was browsed to very small
asmi.merged %>%
  filter(status.x == "reproductive" & length.x < 8)

asmi.merged %>%
  ## Merge seedling and vegetative
  mutate(status.x = as.character(status.x)) %>%
  mutate(status.x = case_when(status.x == "seedling" ~ "vegetative",
                              TRUE ~ status.x)) %>%
  ggplot(   aes(length.x, surv))+ #, color = site))+
    geom_point(pch="|")+
    facet_grid(Creek~status.x)+
    theme_bw()+
    ylab("survival")+
    xlab("Length of longest stem (cm)")+
    scale_color_discrete("")+
    geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE)

ggsave(paste(savepath, "FigureAGGsurv.jpg", sep = ""),

       asmi.merged %>%
         mutate(status.x = case_when(status.x == "seedling" ~ "vegetative",
                                     TRUE ~ status.x)) %>%
         mutate(status.x = factor(status.x, levels = c("vegetative","reproductive"))) %>%
ggplot( aes(length.x, surv))+ #, color = site))+
  geom_point(pch="|")+
  facet_grid(Creek~status.x)+
  theme_bw()+
  ylab("survival")+
  xlab("Length of longest stem (cm)")+
  scale_color_discrete("")+
  geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE)
  , width=200, height=150,units='mm', dpi=300)

```


AIC for survival by individual
```{r}
glm1 <- glm(surv ~ ppt_winter*site, family = binomial, data = asmi.merged)
glm2 <- glm(surv ~ tmax_springSummer*ppt_winter*site, family = binomial, data = asmi.merged)
glm3 <- glm(surv ~ tmin_winter*ppt_winter*site, family = binomial, data = asmi.merged) 
glm4 <- glm(surv ~ ppt_fall*site, family = binomial, data = asmi.merged)
glm5 <- glm(surv ~ 1*site, family = binomial, data = asmi.merged)
glm6 <- glm(surv ~ ppt_springSummer*site, family = binomial, data = asmi.merged)
glm7 <- glm(surv ~ tmax_springSummer*site, family = binomial, data = asmi.merged) 
glm8 <- glm(surv ~ tmin_winter*site, family = binomial, data = asmi.merged)
glm.list <- list(glm1,glm2,glm3,glm4,glm5,glm6,glm7,glm8)
glm.names <- as.character(unlist(lapply(glm.list,formula)))
(glm.results <- aictab(glm.list, modnames=glm.names))
for(i in 2:length(glm.list)){
  print(exp(0.5*glm.results$Delta_AICc[i]))
}
```

```{r}

labels4bins <- asmi.merged %>%
  ungroup() %>% ## but it's not grouped, maybe was taking as each row is a group without this call?
  dplyr::mutate(across(ppt_fall:tmin_winter, .fns = scale)) %>% 
  dplyr::mutate(ppt_winter_bin = cut(ppt_winter, breaks = 3)) %>%
  dplyr::select(ppt_winter_bin) %>%
  distinct(ppt_winter_bin) %>%
  arrange(ppt_winter_bin)
  
## This is only b, where's the rest? 

Fig4Survabiotic <- asmi.merged %>%
  ungroup() %>% ## but it's not grouped, maybe was taking as each row is a group without this call?
  dplyr::mutate(across(ppt_fall:tmin_winter, .fns = scale)) %>% 
  dplyr::mutate(ppt_winter_bin = cut(ppt_winter, breaks = 3)) %>%
ggplot(  aes(tmax_springSummer,surv,color = site))+
  geom_point()+
  theme_bw()+
  facet_grid(~ppt_winter_bin, scales = "free", 
             labeller = labeller(ppt_winter_bin =
                                   c("(-1.92,-0.423]" = "low winter precipitation",
                                     "(-0.423,1.07]"  = "mid winter precipitation",
                                     "(1.07,2.57]"  = "high winter precipitation"))
             )+
  xlab("Summer maximum temperature")+
  ylab("Survival")+
  geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE)+
  ggtitle("b)")
```



Table 3e
#AIC for reproduction per plot   
ps.asmi.reduced are plot summaries
```{r}

ps.asmi.reduced <- ps.asmi[!is.na(ps.asmi$Total.Alive),]


## Fruit and reproduction by above ground growth - correlated
ps.asmi.reduced %>%
  mutate(FlYN = case_when(Total.Fruit >0 ~ 1, Total.Fruit == 0 ~ 0)) %>%
ggplot(  aes(Total.Alive, FlYN))+
  geom_point()+
  facet_wrap(~Site, scales = "free_x")+
  xlab("AGG")+
  ylab("Fruit")+
  theme_bw()+
  geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE)

asmi.reproductive <- 
  ps.asmi.reduced %>%
  mutate(site = case_when(Site == 1 ~ "Cebolla Mid",
                          Site == 2 ~ "Cebolla North",
                          Site == 5 ~ "Site 5",
                          Site == 15 ~ "Site 15",
                          Site == 19 ~ "Site 19",
                          Site == 26 ~ "Site 26")) %>%
  left_join(asmi.season.wide,  by = c("site" = "site",
                                      "Plot" = "Plot",
                                      "Year" = "Prev12")) %>%
  mutate(FlYN = case_when(Total.Fruit > 0 ~ 1, Total.Fruit == 0 ~ 0)) %>%
  ungroup() %>% ## but it's not grouped, maybe was taking as each row is a group without this call?
  dplyr::mutate(across(ppt_fall:tmin_winter, .fns = scale)) 

#Candidate models  
glm1 <- glm(FlYN ~ ppt_winter*site, family = binomial, data = asmi.reproductive)
glm2 <- glm(FlYN ~ tmax_springSummer*ppt_winter*site, family = binomial, data = asmi.reproductive)
glm3 <- glm(FlYN ~ tmin_winter*ppt_winter*site, family = binomial, data = asmi.reproductive) 
glm4 <- glm(FlYN ~ ppt_fall*site, family = binomial, data = asmi.reproductive)
glm5 <- glm(FlYN ~ 1*site, family = binomial, data = asmi.reproductive)
glm6 <- glm(FlYN ~ ppt_springSummer*site, family = binomial, data = asmi.reproductive)
glm7 <- glm(FlYN ~ tmax_springSummer*site, family = binomial, data = asmi.reproductive) 
glm8 <- glm(FlYN ~ tmin_winter*site, family = binomial, data = asmi.reproductive)
glm.list <- list(glm1,glm2,glm3,glm4,glm5,glm6,glm7,glm8)
glm.names <- as.character(unlist(lapply(glm.list,formula)))
(glm.results <- aictab(glm.list, modnames=glm.names))
for(i in 2:length(glm.list)){
  print(exp(0.5*glm.results$Delta_AICc[i]))
}
```

```{r}
asmi.reproductive %>%
  ungroup() %>%
  dplyr::mutate(across(ppt_fall:tmin_winter, .fns = scale)) %>% 
  dplyr::mutate(ppt_winter_bin = cut(ppt_winter, breaks = 3))  %>%
  dplyr::select(ppt_winter_bin) %>%
  distinct(ppt_winter_bin) %>%
  arrange(ppt_winter_bin) 
  

## Figure 4b reproduction or none
Fig4bReprodYN <- asmi.reproductive %>%
  dplyr::mutate(ppt_winter_bin = cut(ppt_winter, breaks = 3)) %>%
  filter(!(Plot == 52 & Year == 2024)) %>%
ggplot(  aes(tmax_springSummer,FlYN))+
  geom_point()+
  theme_bw()+
  facet_grid(~ppt_winter_bin, scales = "free", 
              labeller = labeller(ppt_winter_bin =
                                    c("(-1.91,-0.332]" = "low winter precipitation",
                                      "(-0.332,1.24]"  = "mid winter precipitation",
                                      "(1.24,2.83]"  = "high winter precipitation"))
              )+
  xlab("Summer maximum temperature")+
  ylab("Fruit production by plot")+
  geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE)

Fig4bReprodYN_site <- asmi.reproductive %>%
  dplyr::mutate(ppt_winter_bin = cut(ppt_winter, breaks = 3)) %>%
  filter(!(Plot == 52 & Year == 2024)) %>%
ggplot(  aes(tmax_springSummer,FlYN, colour=site))+
  geom_point()+
  theme_bw()+
  facet_grid(~ppt_winter_bin, scales = "free", 
              labeller = labeller(ppt_winter_bin =
                                   c("(-1.91,-0.332]" = "low winter precipitation",
                                      "(-0.332,1.24]"  = "mid winter precipitation",
                                      "(1.24,2.83]"  = "high winter precipitation"))
              )+
  xlab("Summer maximum temperature")+
  ylab("Fruit production by plot")+
  geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE, alpha = 0.1)+
  ggtitle("c)")

```

# AIC for fruit   
first binomial for fruit or not, then poisson with those that produce fruit
```{r}
## pull out when no reproduction, that was the binomial parts, just do the amount when there is reproduction
asmi.fruit <- asmi.reproductive %>%
  filter(Total.Fruit > 0)

glm1 <- glm(Total.Fruit ~ ppt_winter*site, family = poisson(link = 'log'), data = asmi.fruit)
glm2 <- glm(Total.Fruit ~ tmax_springSummer*ppt_winter*site, family = poisson(link = 'log'), data = asmi.fruit)
glm3 <- glm(Total.Fruit ~ tmin_winter*ppt_winter*site, family = poisson(link = 'log'), data = asmi.fruit) 
glm4 <- glm(Total.Fruit ~ ppt_fall*site, family = poisson(link = 'log'), data = asmi.fruit)
glm5 <- glm(Total.Fruit ~ 1*site, family = poisson(link = 'log'), data = asmi.fruit)
glm6 <- glm(Total.Fruit ~ ppt_springSummer*site, family = poisson(link = 'log'), data = asmi.fruit)
glm7 <- glm(Total.Fruit ~ tmax_springSummer*site, family = poisson(link = 'log'), data = asmi.fruit) 
glm8 <- glm(Total.Fruit ~ tmin_winter*site, family = poisson(link = 'log'), data = asmi.fruit)
glm.list <- list(glm1,glm2,glm3,glm4,glm5,glm6,glm7,glm8)
glm.names <- as.character(unlist(lapply(glm.list,formula)))
(glm.results <- aictab(glm.list, modnames=glm.names))
for(i in 2:length(glm.list)){
  print(exp(0.5*glm.results$Delta_AICc[i]))
}
```

```{r}
labels4bins

asmi.fruit %>%
  ungroup() %>% 
  dplyr::mutate(across(ppt_fall:tmin_winter, .fns = scale)) %>% 
  dplyr::mutate(ppt_winter_bin = cut(ppt_winter, breaks = 3)) %>%
  dplyr::select(ppt_winter_bin) %>%
  distinct(ppt_winter_bin) %>%
  arrange(ppt_winter_bin)

asmi.fruit %>%
  ungroup() %>% 
  dplyr::mutate(across(ppt_fall:tmin_winter, .fns = scale)) %>% 
  dplyr::mutate(tmax_springSummer_bin = cut(tmax_springSummer, breaks = 3)) %>%
  dplyr::select(tmax_springSummer_bin) %>%
  distinct(tmax_springSummer_bin) %>%
  arrange(tmax_springSummer_bin)


Fig4Fruit <- asmi.fruit %>%
  dplyr::mutate(ppt_winter_bin = cut(ppt_winter, breaks = 3)) %>%
  dplyr::mutate(tmax_springSummer_bin = cut(tmax_springSummer, breaks = 3)) %>%
  filter(!(Plot == 52 & Year == 2024)) %>%
ggplot(  aes(tmax_springSummer_bin,log(Total.Fruit), color = site))+
  theme_bw()+
  geom_boxplot(position = position_dodge(width = 0.9))+
  geom_point(position = position_dodge(width = 0.9))+
  facet_grid(~ppt_winter_bin, scales = "free", 
               labeller = labeller(ppt_winter_bin =
                                     c("(-1.3,0.0784]" = "low winter precipitation",
                                       "(0.0784,1.45]"  = "mid winter precipitation",
                                       "(1.45,2.82]"  = "high winter precipitation")))+
  xlab("low, mid, and high summer maximum temperature")+
  ylab("log(Total fruit production)")+
  scale_color_discrete("Site")+
  # ggtitle("d) low, mid, and high winter precipitation")+
  ggtitle("d)")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) # rotate labels
```

 
#AIC for reproductive
Table 3c and d
probability of reproduction per individual
```{r, eval=FALSE}

asmi.raw$Creek <- "SouthBeaver"
asmi.raw$Creek[asmi.raw$AsMi_site_id < 3] <- "Cebolla" 
asmi.raw$Creek <- as.factor(asmi.raw$Creek)

# asmi.raw$flower is yes/no for reproduction
m1 <- glm(flower ~ year, family=binomial(link=logit), data = asmi.raw)
summary(m1)

#Candidate models  
m2 <- glm(flower ~ year*as.factor(AsMi_site_id), family = binomial(link = 'logit'), data = asmi.raw)
m3 <- glm(flower ~ year*Creek, family = binomial(link = 'logit'), data = asmi.raw) #Need add creek!
m4 <- glm(flower ~ year*fence, family = binomial(link = 'logit'), data = asmi.raw)
m5 <- glm(flower ~ 1, family = binomial(link = 'logit'), data = asmi.raw)
m6 <- glm(flower ~ as.factor(AsMi_site_id), family = binomial(link = 'logit'), data = asmi.raw)
m7 <- glm(flower ~ Creek, family = binomial(link = 'logit'), data = asmi.raw) 
m8 <- glm(flower ~ fence, family = binomial(link = 'logit'), data = asmi.raw)

m.list <- list(m1,m2,m3,m4,m5,m6,m7,m8)
m.names <- as.character(unlist(lapply(m.list,formula)))
(m.results <- aictab(m.list, modnames=m.names))

#evidence ratio 
for(i in 2:length(m.list)){
  print(exp(0.5*m.results$Delta_AICc[i]))
}
```



Table 5: Average Astragalus microcymbus fruit per plot within the South Beaver Creek Drainage near Gunnison, CO and Cebolla Creek drainage. Site 1 is Cebolla Creek Mid and site 2 is Cebolla Creek North. Standard errors are given in parentheses. 
```{r}
fruit <- aggregate(fruit ~ AsMi_plot_id + year + AsMi_site_id + fence, 
                  data = asmi.raw, function(x) sum(x,na.rm = TRUE))
head(fruit)


tbl3.1 <- summarySE(fruit, measurevar="fruit",groupvars=c("AsMi_site_id","year"))

sites <- unique(tbl3.1$AsMi_site_id)
tbl3 <- lapply(sites, function(x){
  paste(round(tbl3.1[tbl3.1$AsMi_site_id == x,"fruit"],2)," (",
        round(tbl3.1[tbl3.1$AsMi_site_id == x,"se"],1), ")", sep="")
})

#Cebolla Creek
write.csv(data.frame(tbl3[[1]],tbl3[[2]]), file=paste(savepath,"Table5_Cebolla.csv", sep = ""), row.names=TRUE)
#South Beaver Creek
write.csv(data.frame(tbl3[[3]],tbl3[[4]],tbl3[[5]],tbl3[[6]]), file=paste(savepath,"Table5_SouthBeaver.csv", sep=""), row.names=TRUE)

```


################### Stage-based PVA start ##############################
#Table 6: Growth rate (Î») and standard deviation within treatment (fenced or open plots) of Astragalus microcymbus individuals within the South Beaver Creek drainage near Gunnison, CO. Plot 598 in site 26, added in 2004, is excluded.   

### But if I add individuals not as seedlings (even though I know they aren't seedlings this year) then they aren't given credit for reproducing.. # could add a New2me category that is clearly not a seedling but a delayed/missed one. Then should add a seedling to the previous year as a stop gap? So count up number of seedlings and number of seedlings in the next year that are reproductive and subtract them from the current seedling number!
```{r}
table(asmi.raw$year,asmi.raw$AsMi_plot_id)
# 1995-currentyr: 8,480,512,513,514,515,578,581,598,606,607,608,609,610,611,614,799
# 1996-currentyr: 238,300
# 2004-currentyr: 598
# 2014-currentyr: 1,16,22,32,42,52,58,90,98
# 2014-2019: 89

cebolla <- asmi.raw[asmi.raw$AsMi_site_id %in% c(1,2),]
table(cebolla$AsMi_plot_id,cebolla$year)
# 89 lost in 2020

sbc <- asmi.raw[asmi.raw$AsMi_site_id %in% c(5,15,19,26),]
table(sbc$AsMi_plot_id,sbc$year)

#remove plot 598 from SBC, it was added late; Plot 598 was added in 2004, remove for this. .. do all plots on their own so not a change in the space counted as a site. 
# 238 and 300 added in 1996

# KEY TO OBJECTS
# After commenting out the removed year and the added plots... then asmi.1 is SBC, cebolla is Cebolla and asmi.all is both
asmi.1 <- sbc[order(sbc$AsMi_site_id, sbc$AsMi_tag_id, sbc$year),]
cebolla <- cebolla[order(cebolla$AsMi_site_id, cebolla$AsMi_tag_id, cebolla$year),]

asmi.1$status <- factor(asmi.1$status)
table(asmi.1$status)

cebolla$status <- factor(cebolla$status)
table(cebolla$status)

#just keep all together go by plot
asmi.all <- asmi.raw[order(asmi.raw$AsMi_site_id, 
                           asmi.raw$AsMi_tag_id, asmi.raw$year),]
table(asmi.all$status)

```


## Stage-based PVA prep and running

Set order of classes
```{r}
# Later work in seeds
# stages <- c("seed", "seedling", "vegetative", "reproductive", "dormant","dead") 

stages <- c("seedling", "vegetative", "reproductive", "dormant","dead") 

# SBC
# Cebolla
asmi.1$status <- ordered(asmi.1$status, levels = stages)
cebolla$status <- ordered(cebolla$status, levels = stages)

# Both
asmi.all$status <- ordered(asmi.all$status, levels = stages)

```

check errors
```{r}

# should all be reproductive (status 4 in DBG phpMyAdmin)
asmi.1[asmi.1$flower == 1 & asmi.1$status == "vegetative",]
cebolla[cebolla$flower == 1 & cebolla$status == "vegetative",]
asmi.all[asmi.all$flower == 1 & asmi.all$status == "vegetative",]

# made all NA lengths 0
# table(asmi.1$status[is.na(asmi.1$length)])

asmi.1$browsed[asmi.1$browsing==0]<-FALSE  	
asmi.1$browsed[asmi.1$browsing==1]<-TRUE
table(asmi.1$browsed)
table(asmi.1$browsing)

# Same for cebolla plots
cebolla$browsed[cebolla$browsing==0]<-FALSE    
cebolla$browsed[cebolla$browsing==1]<-TRUE
table(cebolla$browsed)
table(cebolla$browsing)


asmi.all$browsed[asmi.all$browsing==0]<-FALSE  	
asmi.all$browsed[asmi.all$browsing==1]<-TRUE
table(asmi.all$browsed)
table(asmi.all$browsing)

## Fencing only in years it was up
asmi.all <- asmi.all %>%
  dplyr::mutate(fence = as.character(fence)) %>%
  dplyr::mutate(fence = case_when(year < 2006 ~ "n",
                                  year > 2015 ~ "n",
                                  year < 2007 & AsMi_site_id == 19 ~ "n",
                                  TRUE ~ fence))

table(asmi.all$fence, asmi.all$year)

save(asmi.all, file = paste("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/asmi.all", currentyr,".Rdata", sep=""))

```


### Make 'seedlings' that are reprodutive 'reproductive' before binding stage - fate  
Merge year to year, year.x is year t, year.y is year t+1   
remove dead from stages, just fate    
At this point, just get asmi.all1 to work, if can deal with addition of plots, then can put the two together    
      1. two stage PVA counts all new tags as recruitment (in year t+2) from those that transitions (or remain) in reproductive stage at t+1 (fate)    
      2. Then changes all 'seedlings' to 'vegetative' 
```{r}

### Fine but doesn't matter, in 3 stage MPM turns all seedlings to vegetative
asmi.all$status[asmi.all$status == "seedling" & asmi.all$flower == 1] <- "reproductive"
hist(asmi.all$length[asmi.all$status == "seedling"])

asmi.all %>%
  filter(!(status %in% c("dead","dormant"))) %>%
    ggplot( aes(length, fill = status))+
      # geom_violin(scale = "width")
      geom_density(alpha = 0.5)+
      theme_bw()

asmi.all1 <- subset(merge(asmi.all, asmi.all, by = "AsMi_tag_id", sort = FALSE), year.x == year.y - 1)  

```


    
Want    
Narrow down to      
[1] "AsMi_site_id.x" "AsMi_tag_id"    "year.x"             
[4] "length.x"       "fruit.x"        "browsed.x"           
[7] "fence.x"        "status.x"       "status.y"     
```{r}
cols <- c("AsMi_site_id.x","AsMi_tag_id","year.x","length.x",
          "fruit.x","browsed.x","fence.x","status.x","status.y","AsMi_plot_id.x", "length.y")
asmi.all2 <- asmi.all1[, names(asmi.all1) %in% unique(grep(paste(cols,collapse="|"),
                                                  names(asmi.all1), value = TRUE))] # T/F so in the order of data frame
colnames(asmi.all2) <- c( "tag","year","length","fruits","stage","plot",
                       "site","fenced","browse","length1","fate")

## re-number
rownames(asmi.all2) <- 1:nrow(asmi.all2)

# Get rid of stage 'dead' because nothing starts as dead!
asmi.all2$stage <- ordered(asmi.all2$stage, levels = stages[-length(stages)])

# check transitions
#fate down and stage across the top; These are the raw numbers combined for all years 
table(Fate = asmi.all2$fate, Stage = asmi.all2$stage) #Nope, cannot have 2 seedlings stay seedlings! And Dormant never go dead!
## Now have one vegetative that goes to seedling! 
asmi.all2 %>%
  filter(stage == "vegetative" & fate == "seedling")


asmi.all2[asmi.all2$fate == "seedling" & asmi.all2$stage == "seedling",] # tag 3571 and 3946
# asmi.raw[asmi.raw$AsMi_tag_id %in% c(3571,3946),]

asmi.all2[asmi.all2$stage == "dormant" & asmi.all2$fate == "dead",]

save(asmi.all2, file = paste("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/stage-fate", currentyr,".Rdata", sep=""))

```

bootstrap distributions of population growth rates (lambda), stage vectors, and projection matrix elements by randomly sampling with replacement from a stage-fate data frame of observed transitions   

Doesn't make sense... shouldn't be so high... Because 26 had additional plots added in 1996?    
There are seedlings that go from 'seedling' to 'dead' that have values for $seedling   
something is off.    
Made some fixes to raw data where fruit were counted but confusion led to putting 0 for flower column    
Will change all seedling with fruit to reproductive

```{r}
asmi.boot <- asmi.all2
asmi.boot$fruits[is.na(asmi.boot$fruits)] <- 0
## Initialize the first of two stages, vegetative, column as zero
asmi.boot$vegetative <- 0

# table(asmi.boot$year, asmi.boot$site) # from 1995 transitions stage -> fate up to currentyr-1 stage->fate 
# add 'seedling' column as the number of new tags in t+2 (stage = t, fate = t+1)
# plot <- split(asmi.boot, asmi.boot$plot)[[1]]
# asmi.boot$seedling <- unlist(lapply(split(asmi.boot, asmi.boot$plot), function(plot){
for(j in unique(asmi.boot$plot)){
  years <- unique(asmi.boot$year[asmi.boot$plot == j])    
  reproYN <- sapply(years, function(yr) sum(asmi.boot$fruits[asmi.boot$year == yr & asmi.boot$plot == j]))
  YearsNoRep <- years[which(reproYN == 0)]
  YearsYesRep <- years[which(reproYN != 0)]
  if(any(which(reproYN == 0) %in% c(1))) years <- years[-1]
  
  for(i in years[-length(years)]){
    ## No reproduction, assign nothing
    if(i %in% YearsNoRep){
      asmi.boot$vegetative[asmi.boot$year == i & asmi.boot$plot == j] <- 0
    } else {
      ## Is there reproduction in year t+1? Then all recruitment in t+2 go to t+1, else t+2 and t+3 go to t+1
      if(i %in% YearsYesRep & !(i+1 %in% YearsNoRep)){
        newtags <- match(unique(asmi.boot$tag[asmi.boot$year == i+1 & asmi.boot$plot == j]),
                         unique(asmi.boot$tag[asmi.boot$year == i & asmi.boot$plot == j]))
        seedlings <- length(newtags[is.na(newtags)])
        # The number of fruit produced per individual divided by all fruit produced * seedlings in the next year
        asmi.boot$vegetative[asmi.boot$year == i & asmi.boot$plot == j] <- 
          (asmi.boot$fruits[asmi.boot$year==i & 
                              asmi.boot$plot == j]/sum(asmi.boot$fruits[asmi.boot$year==i & 
                                                                          asmi.boot$plot == j],na.rm = TRUE)) * seedlings
      } else {
        newtags1 <- match(unique(asmi.boot$tag[asmi.boot$year == i+1]), unique(asmi.boot$tag[asmi.boot$year == i]))
        newtags2 <- match(unique(asmi.boot$tag[asmi.boot$year == i+2]), unique(asmi.boot$tag[asmi.boot$year == i+1]))
        seedlings <- length(newtags1[is.na(newtags1)]) + length(newtags2[is.na(newtags2)])
        # The number of fruit produced per individual divided by all fruit produced * seedlings in the next year
        asmi.boot$vegetative[asmi.boot$year == i & asmi.boot$plot == j] <- 
          (asmi.boot$fruits[asmi.boot$year==i &
                              asmi.boot$plot == j]/sum(asmi.boot$fruits[asmi.boot$year==i &
                                                                          asmi.boot$plot == j],na.rm = TRUE)) * seedlings
      }
      } # when there are reproductive individuals
  } # years
}


## Uncertainty about seedling vs vegetative so change all to vegetative
asmi.boot <- asmi.boot %>%
  mutate(stage = as.character(stage),
         fate = as.character(fate)) %>%
  mutate(stage = if_else(stage == "seedling", "vegetative", stage)) %>%
  mutate(stage = factor(stage, levels = c("vegetative", "reproductive", "dormant")),
         fate = factor(fate, levels = c("vegetative", "reproductive", "dormant"))) %>%
  mutate(stage = ordered(stage, levels = c("vegetative", "reproductive", "dormant")),
         fate = ordered(fate, levels = c("vegetative", "reproductive", "dormant"))) %>%
  mutate(tag = as.factor(tag),
         plot = as.factor(plot),
         site = as.factor(site))

# asmi.boot$stage <- ordered(asmi.boot$stage, 
#                            levels = c("seedling", "vegetative", "reproductive", "dormant"))
# asmi.boot$fate <- ordered(asmi.boot$fate, 
#                            levels = c("seedling", "vegetative", "reproductive", "dormant"))

boottrans <- lapply(split(asmi.boot, asmi.boot$plot), function(x){
  data.frame(Plot = unique(x$plot),
             Site = unique(x$site),
             Boot = boot.transitions(x,1000,fertility = "fruits")$lambda)
  })


boottransyr <- lapply(split(asmi.boot, asmi.boot$year), function(x){
  data.frame(Year = unique(x$year),
             Boot = boot.transitions(x,1000,fertility = "fruits")$lambda)
  })

bt <- do.call(rbind, boottrans)
btyr <- do.call(rbind, boottransyr)

ggplot(bt, aes(as.factor(Plot), Boot, colour = as.factor(Plot)))+
  geom_boxplot()+
  facet_wrap(~Site, ncol=3, scales = "free")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

bt %>%
  group_by(Plot, Site) %>%
  summarise(lowerLambda = hdi(Boot)[1],
            upperLambda = hdi(Boot)[2]) 

ggplot(btyr, aes(Year, Boot, group = Year))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))+
  ylab(expression(lambda)) +
  geom_hline(yintercept = 1, linetype = "dotted")

ggplot(btyr, aes(Year, log(Boot), group = Year))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))+
  ylab(expression(log~lambda)) +
  geom_hline(yintercept = 0, linetype = "dotted")

bt %>%
  group_by(Plot, Site) %>%
  summarise(lowerLambda = hdi(Boot)[1],
            upperLambda = hdi(Boot)[2]) 

lambdaHDI <- do.call(rbind, lapply(unique(bt$Plot), function(x){
  out <- hdi(log(bt$Boot[bt$Plot == x]))
  data.frame(Plot = x, estimate = mean(log(bt$Boot[bt$Plot == x])), lower = out[1], upper = out[2])
}))

SitePlot <- bt %>%
  distinct(Site,Plot)


bootplot <- lambdaHDI %>%
  left_join(SitePlot) %>%
  # pivot_longer(lower:upper) %>%
  ggplot( aes(as.factor(Plot), estimate))+
    geom_point()+
    theme_bw()+
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2)+
    geom_hline(yintercept = 0, linetype = "dotted")+
    facet_wrap(~Site, scales = "free_x")+
  ylab(expression(log~lambda))+
  xlab("Plot")
  
ggsave(paste(savepath, "FigBootLambda.jpg", sep=""), bootplot,
       units = "mm", dpi = 300, height = 100, width = 150)

lambdaHDI %>%
  left_join(SitePlot) %>%
  save(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/bootlambda.Rdata")


SBCbootplot <- lambdaHDI %>%
  left_join(SitePlot) %>%
  filter(Site %in% c(5,15,19,26)) %>%
  # pivot_longer(lower:upper) %>%
  ggplot( aes(as.factor(Plot), estimate))+
    geom_point()+
    theme_bw()+
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2)+
    geom_hline(yintercept = 0, linetype = "dotted")+
    facet_wrap(~Site, scales = "free_x")+
  ylab(expression(log~lambda))+
  xlab("Plot")

ggsave(paste(savepath, "FigBootLambdaSBC.jpg", sep=""), SBCbootplot,
       units = "mm", dpi = 300, height = 100, width = 100)



bt %>%
  ggplot( aes(log(Boot), fill = as.factor(Plot)))+
    geom_density(alpha=0.5)+
    facet_wrap(~Site)+
    theme_bw()+
    geom_vline(xintercept = 0)+
    guides(fill = 'none')+
    xlab(expression("log("~lambda~")"))

## By year across sites
bootyear <- lapply(split(asmi.boot, asmi.boot$year), function(x){
  data.frame(Year = unique(x$year),
             Boot = boot.transitions(x,1000,fertility = "fruits")$lambda)
  })

btyear <- do.call(rbind, bootyear)

ggplot(btyear, aes(as.factor(Year), Boot))+
  # geom_jitter(col="blue", pch = 16)+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

bt %>%
  group_by(Plot, Site) %>%
  summarise(lowerLambda = hdi(Boot)[1],
            upperLambda = hdi(Boot)[2]) 



lambdaHDI <- do.call(rbind, lapply(unique(bt$Plot), function(x){
  out <- hdi(log(bt$Boot[bt$Plot == x]))
  data.frame(Plot = x, lower = out[1], upper = out[2])
}))

bt %>%
  ggplot( aes(log(Boot), fill = as.factor(Plot)))+
    geom_density(alpha=0.5)+
    facet_wrap(~Site)+
    theme_bw()+
    geom_vline(xintercept = 0)+
    guides(fill = 'none')+
    xlab(expression("log("~lambda~")"))

bt %>%
  ggplot( aes(as.factor(Plot), log(Boot), fill = as.factor(Plot)))+
    geom_violin(alpha=0.5)+
    facet_wrap(~Site, scales = "free_x")+
    theme_bw()+
    geom_hline(yintercept = 0, color = "grey30", linetype = "dotted")+
    guides(fill = 'none')+
    ylab(expression("log("~lambda~")"))+
  xlab("Plot")



```



# Stage-based PVA
# From previous versions
cebolla <- asmi.raw[asmi.raw$AsMi_site_id %in% c(1,2),]
sbc <- asmi.raw[asmi.raw$AsMi_site_id %in% c(5,15,19,26),]

asmi.1 <- sbc[order(sbc$AsMi_site_id, sbc$AsMi_tag_id, sbc$year),]
cebolla <- cebolla[order(cebolla$AsMi_site_id, cebolla$AsMi_tag_id, cebolla$year),]

asmi.2 <- subset(merge(asmi.1, asmi.1, by = "AsMi_tag_id", sort = FALSE), year.x == year.y - 1)   
cebolla1 <- subset(merge(cebolla, cebolla, by = "AsMi_tag_id", sort = FALSE), year.x == year.y - 1)  

# Because it adds a slot for 1995 - currentYr
Why are there 25 slots for Site PVA? and all but the last four are empty - last 4 have the 4 SBC populations
notfenced has 21 blank (each year)

Dormancy can be set to 0-1  

## in 2021 to do: use the intra-annual visits to create model of climate and probability of stage when dormant in July 

```{r}
all.pva <- StagePVA(asmi.all2, TF = FALSE)

save(all.pva, file = paste(savepath, "allpva", Sys.Date(), ".Rdata", sep = ""))

```

Get the mean matrix per site, then get demographic parameters
```{r}
# Define function
lifeTimeRepEvents <- function(matU, matF, startLife = 1) {
  
  uDim = dim(matU)[1]
  surv = colSums(matU)
  repLifeStages = colSums(matF)
  
  repLifeStages[which(repLifeStages>0)] <- 1
  
  if(missing(matF) | missing(matU)) {stop('matU or matF missing')}
  if(sum(matF, na.rm=T)==0) {stop('matF contains only 0 values')}
  
  # Probability of survival to first reprod event
  Uprime <- matU
  Uprime[, which(repLifeStages==1)] <- 0
  Mprime = matrix(0,2,uDim)
  for (p in 1:uDim[1]) {
    if (repLifeStages[p]==1) {Mprime[2,p] = 1} else {
      Mprime[1,p] = 1-surv[p]
    }
  }
  Bprime = Mprime%*%(ginv(diag(uDim)-Uprime))
  pRep = Bprime[2,startLife]
  
  out = data.frame(pRep = pRep)
  
  # Age at first reproduction (La; Caswell 2001, p 124) AGE OF REPRODUCTIVE MATURITY
  D = diag(c(Bprime[2,]))
  Uprimecond = D%*%Uprime%*%ginv(D)
  expTimeReprod = colSums(ginv(diag(uDim)-Uprimecond))
  La = expTimeReprod[startLife]
  
  out$La = La
  
  # Mean life expectancy conditional on 
  # entering the life cycle in the first reproductive stage ## longevity after being reproductive given that you made it to be reprodutive, if you died before then this would be negative
  firstRepLifeStage = min(which(repLifeStages==1))
  N = solve(diag(uDim[1])-matU) ## solve finds the inverse (so you can multiply to do division basically)
  meanRepLifeExpectancy = colSums(N)[firstRepLifeStage]
  
  out$meanRepLifeExpectancy = meanRepLifeExpectancy
  
  # Life expectancy from mean maturity
  remainingMatureLifeExpectancy = colSums(N)[startLife]-La
  
  out$remainingMatureLifeExpectancy = remainingMatureLifeExpectancy
  
  return(out)
}

names(all.pva)

## Three stage matrix (V,R,D) names them twice, is so nice. Need to fix eventually
A_site1 <- mean(do.call(c,list(all.pva$Plot1, all.pva$Plot22, all.pva$Plot32, all.pva$Plot42, all.pva$Plot52)))
A_site2 <- mean(do.call(c,list(all.pva$Plot16, all.pva$Plot58, all.pva$Plot89, 
                               all.pva$Plot90, all.pva$Plot96, all.pva$Plot98)))
A_site5 <- mean(do.call(c,list(all.pva$Plot606, all.pva$Plot607, 
                               all.pva$Plot608, all.pva$Plot609, all.pva$Plot610)))
A_site15 <- mean(do.call(c,list(all.pva$Plot8, all.pva$Plot578, all.pva$Plot581, all.pva$Plot799)))
A_site19 <- mean(do.call(c,list(all.pva$Plot300, all.pva$Plot512, all.pva$Plot513, all.pva$Plot514, all.pva$Plot515)))
A_site26 <- mean(do.call(c,list(all.pva$Plot238, all.pva$Plot480, all.pva$Plot598, all.pva$Plot611, all.pva$Plot614)))

lapply(list(A_site1,A_site2,A_site5,A_site15,A_site19,A_site26), function(x) lambda(x))
lapply(list(A_site1,A_site2,A_site5,A_site15,A_site19,A_site26), function(x) elasticity(x))

## Summed elasticities by stage
# Table 6: elasticities
do.call(rbind,lapply(list(A_site1,A_site2,A_site5,A_site15,A_site19,A_site26), function(x) colSums(elasticity(x))))

mpm_all_split <- StagePVA(asmi.all2, TF = TRUE)

## pRep = prob of survival to first reproductive event, La = age at first reproduction, 
## meanRepLifeExpectancy = how long live after age of first reproduction,
## remainingMatureLifeExpectancy = how long live after age of first reproduction (most don't make it when negative)
lifeestimates <- do.call(rbind,lapply(mpm_all_split, function(x){ 
  mm <- rowMeans(sapply(x, '[[', 1))
  print(mm)
  mU <- matrix(mm, nrow = 3)
  mf <- rowMeans(sapply(x, '[[', 2))
  mF <- matrix(mf, nrow = 3)
  out <- lifeTimeRepEvents(matU = mU, matF = mF, startLife = 1) 
  out
  }))

lapply(list(A_site1,A_site2,A_site5,A_site15,A_site19,A_site26), function(x) { 
  matU <- x
  matU[1,2] <- 0 ## This is reproduction but also retrogression
  Rage::longevity(matU, start = 1, lx_crit = 0.01)
  })

```


# Matrix Models     
## Table 5: Growth rate    
Pre, post, and all functions
```{r}
# all.pva is the list of plots which each is a list of years from StagePVA_single
# plots is a vector of plots to use

# Which sites/plots were fenced when
PlotSiteYrFence <- asmi.all2 %>%
  distinct(year,plot,site,fenced)

PlotSiteYrFence %>%
  filter(site %in% c(5,19,26)) %>%
  filter(fenced == "y")

## The question should be, does the distribution of growth rates differ by fencing status
GrowthRateMeanSD <- function(all.pva = all.pva, dataset = asmi.all2){ #, PreFence = FALSE, PostFence = FALSE){
  plots <- dataset %>%
    distinct(plot)
  PlotSiteYrFence <- asmi.all2 %>%
    distinct(plot,site,fenced)
  
  Lambdadf <- do.call(rbind,lapply(plots$plot, function(i){
    oneplot <- all.pva[grepl(paste("Plot",i,"$", sep=""), names(all.pva))][[1]]
    lambdas <- do.call(c,lapply(oneplot, function(x) popbio::lambda(x)))
    ldf <- data.frame(plot = i, Year = names(oneplot), Lambda = lambdas)
    out <- ldf %>%
      mutate(Year = gsub("Year","",Year)) %>%
      arrange(Year) %>%
      inner_join(PlotSiteYrFence)
    out
  }))
  Lambdadf
}

  
  # Table 5: Growth rate (lambda) and standard deviations Fenced Pre-fencing
  # data.frame(mean(plotsout), sd(plotsout))

# GrowthRateMeanSD(all.pva, plots = openSBCplots)

```

Table 5: Average growth rate ($\lambda$) and standard deviation ...   
```{r}

# South Beaver Creek
# SBCplots <- unique(asmi.raw$AsMi_plot_id[asmi.raw$AsMi_site_id > 4])
# GrowthRateMeanSD(all.pva, SBCplots, PreFence = TRUE)
Growthrates <- GrowthRateMeanSD(all.pva = all.pva, dataset = asmi.all2)

Growthrates %>%
  mutate(Lambda = log(Lambda)) %>%
  filter(!is.na(Lambda)) %>%
  filter(!is.infinite(Lambda)) %>%
  filter(Lambda > 0) %>%
  filter(site %in% c(5,19,26)) %>%
ggplot(  aes(fenced, log(Lambda)))+
  geom_boxplot()+
  geom_jitter(height = 0)+
  theme_bw() +
  facet_wrap(~site)+
  ylab(expression(log~lambda))+
  geom_hline(yintercept = 0, linetype = "dotted")

## Table 5: By fencing
Growthrates %>%
  mutate(Lambda = log(Lambda)) %>%
  filter(!is.na(Lambda)) %>%
  filter(!is.infinite(Lambda)) %>%
  group_by(site,fenced)%>%
  dplyr::summarise(geomean = mean(Lambda),
                   sdLam = sd(Lambda),
                   varLam = var(Lambda)) %>%
  mutate(expLambda = exp(geomean))
  
## Table 5: all
Growthrates %>%
  mutate(Lambda = log(Lambda)) %>%
  filter(!is.na(Lambda)) %>%
  filter(!is.infinite(Lambda)) %>%
  group_by(site)%>%
  dplyr::summarise(geomean = mean(Lambda),
                   sdLam = sd(Lambda),
                   varLam = var(Lambda)) %>%
  mutate(expLambda = exp(geomean))

## Table 5: by creek
Growthrates %>%
  mutate(Lambda = log(Lambda)) %>%
  filter(!is.na(Lambda)) %>%
  filter(!is.infinite(Lambda)) %>%
  filter(site %in% c(1,2))%>%
  dplyr::summarise(geomean = mean(Lambda),
                   sdLam = sd(Lambda),
                   varLam = var(Lambda)) %>%
  mutate(expLambda = exp(geomean))

Growthrates %>%
  mutate(Lambda = log(Lambda)) %>%
  filter(!is.na(Lambda)) %>%
  filter(!is.infinite(Lambda)) %>%
  filter(site %in% c(5,15,19,26))%>%
  dplyr::summarise(geomean = mean(Lambda),
                   sdLam = sd(Lambda),
                   varLam = var(Lambda)) %>%
  mutate(expLambda = exp(geomean))

Growthrates %>%
  mutate(Lambda = log(Lambda)) %>%
  filter(!is.na(Lambda)) %>%
  filter(!is.infinite(Lambda)) %>%
  filter(site %in% c(5,15,19,26
                     ))%>%
  group_by(fenced) %>%
  dplyr::summarise(geomean = mean(Lambda),
                   sdLam = sd(Lambda),
                   varLam = var(Lambda)) %>%
  mutate(expLambda = exp(geomean))

```

# Figure 4: Life cycle diagram of Astragalus microcymbus   
```{r}
# remove a level of list of lists with recursive = FALSE
(A <- mean(unlist(all.pva, recursive = FALSE)))
eigen.analysis(A)
```


Evenness of elasticities  
```{r}
## To compare using the average across sites and years

CC.split <- StagePVA(asmi.all2[asmi.all2$site %in% c(1,2),], TF = TRUE)
BC.split <- StagePVA(asmi.all2[asmi.all2$site %in% c(5,15,19,26),], TF = TRUE)
all.pva.split <- StagePVA(asmi.all2, TF = TRUE)

CCmatU <- mean(do.call(c, lapply(CC.split, function(x) lapply(x, function(y) y$T))))
BCmatU <- mean(do.call(c, lapply(BC.split, function(x) lapply(x, function(y) y$T))))
matU <- mean(do.call(c, lapply(all.pva.split, function(x) lapply(x, function(y) y$T))))

CCmatF <- mean(do.call(c, lapply(CC.split, function(x) lapply(x, function(y) y$F))))
BCmatF <- mean(do.call(c, lapply(BC.split, function(x) lapply(x, function(y) y$F))))
matF <- mean(do.call(c, lapply(all.pva.split, function(x) lapply(x, function(y) y$F))))  

log(lambda(matU + matF))
lambda(matU + matF)
colSums(sensitivity(matU + matF))
el <- elasticity(matU + matF)
mx <- mpm_to_mx(matU, matF, lx_crit = 0.01)   # age from stage, age specific reproduction
lx <- mpm_to_lx(matU, lx_crit = 0.01) ## age from stage, age-specific survivorship
convShape <- shape_rep(mx)
convDegreeItero <- entropy_d(lx, mx) ## these are sensitive to length of vectors, and partial survivorship and fecundity - better to use shape_rep
gen_time(matU, matF, method = "R0")

## Cebolla Creek
log(lambda(CCmatU + CCmatF))
lambda(CCmatU + CCmatF)
colSums(sensitivity(CCmatU + CCmatF))
CCel <- elasticity(CCmatU + CCmatF)
CCmx <- mpm_to_mx(CCmatU, CCmatF, lx_crit = 0.01)   # age from stage, age specific reproduction
CClx <- mpm_to_lx(CCmatU, lx_crit = 0.01) ## age from stage, age-specific survivorship
convShape <- shape_rep(CCmx)
convDegreeItero <- entropy_d(CClx, CCmx) ## these are sensitive to length of vectors, and partial survivorship and fecundity - better to use shape_rep
gen_time(CCmatU, CCmatF, method = "R0")

## Beaver Creek
log(lambda(BCmatU + BCmatF))
lambda(BCmatU + BCmatF)
colSums(sensitivity(BCmatU + BCmatF))
BCel <- elasticity(BCmatU + BCmatF)
BCmx <- mpm_to_mx(BCmatU, BCmatF, lx_crit = 0.01)   # age from stage, age specific reproduction
BClx <- mpm_to_lx(BCmatU, lx_crit = 0.01) ## age from stage, age-specific survivorship
convShape <- shape_rep(BCmx)
convDegreeItero <- entropy_d(BClx, BCmx) ## these are sensitive to length of vectors, and partial survivorship and fecundity - better to use shape_rep
gen_time(BCmatU, BCmatF, method = "R0")


## Vital rates are non-zero elements of A, elasticities
Adf <- data.frame(vr = as.vector(el), logvr = log2(as.vector(el)))
Adf <- Adf %>%
  mutate(plnp = vr*logvr)
Hprime <- -sum(Adf$plnp)
Hprimemax <- log2(nrow(Adf))
(EE <- Hprime/Hprimemax)


# Cebolla
CCAdf <- data.frame(vr = as.vector(CCel), logvr = log2(as.vector(CCel)))
CCAdf <- CCAdf %>%
  mutate(plnp = vr*logvr)
Hprime <- -sum(CCAdf$plnp)
Hprimemax <- log2(nrow(CCAdf))
(CCEE <- Hprime/Hprimemax)

# Beaver
BCAdf <- data.frame(vr = as.vector(BCel), logvr = log2(as.vector(BCel)))
BCAdf <- BCAdf %>%
  mutate(plnp = vr*logvr)
Hprime <- -sum(BCAdf$plnp)
Hprimemax <- log2(nrow(BCAdf))
(BCEE <- Hprime/Hprimemax)

x <- unique(asmi.all$AsMi_site_id)[1]
## By Site
pva.split.bysite <- lapply(unique(asmi.all$AsMi_site_id), function(x){
  sitesplit <- StagePVA(asmi.all2[asmi.all2$site == x,], TF = TRUE)
  SitematU <- mean(do.call(c, lapply(sitesplit, function(s) lapply(s, function(q) q$T))))
  SitematF <- mean(do.call(c, lapply(sitesplit, function(s) lapply(s, function(q) q$F))))
  el <- elasticity(SitematU + SitematF)
  ## Vital rates are non-zero elements of A, elasticities
  Adf <- data.frame(vr = as.vector(el), logvr = log2(as.vector(el)))
  Adf <- Adf %>%
    mutate(plnp = vr*logvr)
  Hprime <- -sum(Adf$plnp)
  Hprimemax <- log2(nrow(Adf))
  EE <- Hprime/Hprimemax
  gt <- gen_time(SitematU, SitematF, method = "R0")
  data.frame(Site = x, EE = EE, gentime = gt)
})

```


```{r}
grViz("digraph integrated_pop {
      
      # digraph = directed, graph = undirected, graphID
      graph [compound = true, color = blue, rankdir = LR]
      
      # node definitions with substituted label text
      node [shape = circle, fontname = Helvetica]
      # Demographic monitoring
      # a [label = '@@1-1'] # seedling
      b [label = '@@1-2'] # veg
      c [label = '@@1-3'] # rep
      d [label = '@@1-4'] # dormant
      
      # name must start with 'cluster_'
      subgraph cluster_demography {
        graph [style = dashed, color = Sienna]
      # {rank = min; b}
      # {rank = same; a;c}
      # {rank = min; b}
      {rank = max; d}
      # {rank = max; a;b;c}
        # a -> b [label = '@@2-2']
        # a -> c [label = '@@2-3']
        # a -> d [label = '@@2-4']
        b -> b [label = '@@3-2']
        b -> c [label = '@@3-3']
        b -> d [label = '@@3-4']
        c -> d [label = '@@4-4']
        # c -> a [style = dashed, color = LimeGreen, label = '@@4-1']
        c -> b [style = dashed, color = LimeGreen, label = '@@4-1']
        c -> b [color = red, label = '@@4-2']
        c -> c [label = '@@4-3']
        d -> b [color = blue, label = '@@5-2']
        d -> c [color = blue, label = '@@5-3']
        d -> d [label = '@@5-4']
        
        label = 'Demography'
      }
      
      }
      
      [1]: c('Seedling','Vegetative','Reproductive','Dormant')
      # [2]: round(A[,1],2) # seedling to
      [3]: round(A[,1],2) # veg to
      [4]: round(A[,2],2) # reprod to
      [5]: round(A[,3],2) # dormant to
      ")

## Export to save as impage 
```




# Table 5: Growth rate (lambda) and standard deviation
pattern is:          

All pre-fence  1996-2004        |All post-fence 2005-currentyr-2 |Open plots 1996-currentyr-2   
--------------------------------|--------------------------------|----------------------    
asmi.pva$pro.matrix             |                                |  
asmi.pva$fenced.pro.matrix      | asmi.pva$fenced.pro.matrix     |           
asmi.pva$notfenced.pro.matrix   | asmi.pva$notfenced.pro.matrix  | asmi.pva$notfenced         
      
      
Sites 5,19,26,  1996-2004       
(which is through 2005 but starting transition of 2004)   

1996-2005               |   2005-2014            |   1996-2014
------------------------|------------------------|---------------------          
asmi.pva$Site$"5"       |                        |       
asmi.pva$fenced$"5"     | asmi.pva$fenced$"5"    |                
asmi.pva$notfenced$"5"  | asmi.pva$notfenced$"5" |  asmi.pva$notfenced$"5"             

Site 15
`asmi.pva$Site$"15"` ...        

[[1]]:All; [[2]]:fenced; [[3]]:open

# Pradel 
```{r}

```

Multi-stage mark-recapture
```{r}
MPM.plots <- StagePVA(asmi.all2)

SitePlot <- asmi.all2 %>%
  distinct(plot,site) %>%
  mutate(plot = as.factor(plot))%>%
  mutate(site = as.factor(site))

MPMlam <- data.frame(Lambda = do.call(c,lapply(MPM.plots, function(x) do.call(c, lapply(x, function(y) lambda(y))))))
MPMlamdf <- MPMlam %>%
  mutate(PlotYear = row.names(MPMlam)) %>%
  separate(PlotYear, into = c("Plot","Year"))%>%
  mutate(Year = gsub("Year","",Year)) %>%
  mutate(Plot = gsub("Plot","",Plot)) %>%
  filter(!(Plot == 89 & Year > 2018)) %>%
  filter(!(Plot == 52 & Year %in% c(2023,2024))) %>%
  dplyr::mutate(Plot = as.factor(Plot)) %>%
  dplyr::left_join(SitePlot, by = c("Plot" = "plot")) %>%
  filter(!is.na(Lambda)) %>%
  arrange(site,Plot,Year)

## Need to remove all past 2020, So can't have 2019 which needs 2019 to 2020
MPMlamdf %>%
  filter(Plot == 89)
MPMlamdf %>%
  filter(Plot == 1)
## Correct, missing plot 52 in 2024
MPMlamdf %>%
  filter(Plot == 52)

## Troubleshoot site 5 and the two plots at 15 that are all but gone
MPMlamdf %>%
  # filter(site %in% c(5,15,19,26)) %>%
  filter(Lambda != 0) %>%
  group_by(Plot) %>%
  mutate(logLambda = log(Lambda)) %>%
  dplyr::summarize(meanLambda = mean(logLambda),
                   sdLambda = sd(logLambda),
                   varLambda = var(logLambda),
                   lcl = meanLambda - sdLambda,
                   ucl = meanLambda + sdLambda,
                   site = unique(site))%>%
  # filter(site == 5) %>%
  print(n=100)


MPMlamdf %>%
  # filter(site %in% c(5,15,19,26)) %>%
  group_by(Plot) %>%
  mutate(logLambda = log(Lambda)) %>%
  filter(Lambda != 0) %>%
  dplyr::summarize(meanLambda = mean(logLambda, na.rm = TRUE),
                   sdLambda = sd(logLambda),
                   varLambda = var(logLambda),
                   lcl = meanLambda - varLambda,
                   ucl = meanLambda + varLambda,
                   site = unique(site)) %>%
ggplot(  aes(Plot, meanLambda))+
  geom_point(position = position_dodge(width = 1))+
  geom_errorbar(aes(ymin = lcl, ymax = ucl),position = position_dodge(width = 1), width = 0.2)+
  # geom_boxplot()+
  # geom_jitter(height = 0)+
  theme_bw()+
  ylab(expression(log(lambda)))+
  geom_hline(yintercept = 0, linetype = "dotted")+
  facet_wrap(~site, scales = "free_x")

MPMlamdf %>%
  mutate(Creek = case_when(site %in% c("5","15","19","26") ~ "SouthBeaver",
                           site %in% c("1","2") ~ "Cebolla")) %>%
  group_by(Plot) %>%
  mutate(logLambda = log(Lambda)) %>%
  filter(Lambda != 0) %>%
  dplyr::summarize(meanLambda = mean(logLambda, na.rm = TRUE),
                   sdLambda = sd(logLambda),
                   varLambda = var(logLambda),
                   lcl = meanLambda - varLambda,
                   ucl = meanLambda + varLambda,
                   site = unique(site)) 

MPMlamdf %>%
  mutate(Creek = case_when(site %in% c("5","15","19","26") ~ "SouthBeaver",
                           site %in% c("1","2") ~ "Cebolla")) %>%
  group_by(Creek) %>%
  # mutate(logLambda = log(Lambda)) %>%
  filter(Lambda != 0) %>%
  dplyr::summarize(meanLambda = mean(Lambda, na.rm = TRUE),
                   sdLambda = sd(Lambda),
                   varLambda = var(Lambda),
                   lcl = meanLambda - varLambda,
                   ucl = meanLambda + varLambda) 

MPMlamdf %>%
  mutate(Creek = case_when(site %in% c("5","15","19","26") ~ "SouthBeaver",
                           site %in% c("1","2") ~ "Cebolla")) %>%
  group_by(site) %>%
  # mutate(logLambda = log(Lambda)) %>%
  filter(Lambda != 0) %>%
  dplyr::summarize(meanLambda = mean(Lambda, na.rm = TRUE),
                   sdLambda = sd(Lambda),
                   varLambda = var(Lambda),
                   lcl = meanLambda - varLambda,
                   ucl = meanLambda + varLambda) 


```

```{r}
### Tuljapukar's log stochastic lambda by year across plots in a site , need to change 
  # V <- Conj(solve(W, tol = 1e-300))  add tolerance to make it work 

MPMlamdf[which(MPMlamdf$Lambda == 0),]

# plt <- MPM.plots[[6]]
stochLambda <- lapply(MPM.plots, function(plt){
  lambdas <- do.call(c, lapply(plt, function(x) lambda(x)))
  ## Remove the zero growth rate ones first!! 
  isIrr <- do.call(c, lapply(plt, function(x) isIrreducible(x)))
  print(plt[which(lambdas != 0 & isIrr)])
  if(length(plt[which(lambdas != 0 & isIrr)]) > 0){
  stoch.growth.rate(plt[which(lambdas != 0 & isIrr)], maxt = 100000)
    }
  })

stoch.log.lam <- do.call(rbind,lapply(stochLambda, function(x){
  data.frame(Approx = x$approx, Sim = x$sim, lcl = x$sim.CI[1], ucl = x$sim.CI[2])
}))

nrow(stoch.log.lam[is.na(stoch.log.lam$Sim),])

## Just report the CI of the plots within the sites 
stoch.log.lam %>%
  mutate(plot = row.names(.)) %>%
  mutate(plot = gsub("Plot","",plot)) %>%
  left_join(SitePlot) %>%
  # filter(site %in% c(5,15,19,26)) %>%
ggplot(  aes(plot, Sim))+
  geom_point(position = position_dodge(width = 1))+
  geom_errorbar(aes(ymin = lcl, ymax = ucl),position = position_dodge(width = 1), width = 0.2)+
  theme_bw()+
  ylab(expression(log(lambda)))+
  geom_hline(yintercept = 0, linetype = "dotted")+
  facet_wrap(~site, scales = "free")

stoch.log.lam_plot <- stoch.log.lam %>%
  mutate(plot = row.names(.)) %>%
  mutate(plot = gsub("Plot","",plot)) %>%
  left_join(SitePlot) 

stochLambda <- do.call(rbind,lapply(MPM.plots, function(plt){
  lambdas <- do.call(c, lapply(plt, function(x) lambda(x)))
  data.frame(meanLogLambda = mean(log(lambdas), na.rm = TRUE),
             varLogLambda = var(log(lambdas), na.rm = TRUE))
  }))


plotFence <- asmi.raw %>%
  distinct(AsMi_plot_id, fence) %>%
  mutate(plot = as.factor(AsMi_plot_id)) %>%
  dplyr::select(plot, fence)

MPMplot <- stochLambda %>%
  mutate(plot = row.names(.)) %>%
  mutate(plot = as.factor(plot)) %>%
  mutate(plot = gsub("Plot","",plot)) %>%
  mutate(plot = as.factor(plot)) %>%
  left_join(SitePlot) %>%
  left_join(plotFence) %>%
  # filter(site %in% c(5,15,19,26)) %>%
  filter(!is.infinite(meanLogLambda)) %>%
ggplot(  aes(plot, meanLogLambda, color= fence ))+
  geom_point(position = position_dodge(width = 1))+
  geom_errorbar(aes(ymin = meanLogLambda - varLogLambda, 
                    ymax = meanLogLambda + varLogLambda),
                position = position_dodge(width = 1), width = 0.3)+
  theme_bw()+
  ylab(expression(lambda))+
  geom_hline(yintercept = 0, linetype = "dotted")+
  facet_wrap(~site, scales = "free_x",
             nrow = 3)

ggsave(MPMplot, filename = paste(savepath, currentyr, "lMPMloglambda.jpg", collapse = '', sep = ''),
         width=75, height=100,units='mm', dpi=300 )



```

To run on DBG0077
```{r, eval = FALSE}
save(asmi.raw, file = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/asmi-raw2024.rdata")

load("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/asmi-raw2024.rdata")

```



Multi-state model   
```{r}
load("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/asmi.all2.Rdata") 


CJS_asmi <- asmi.raw %>%
  filter(!is.na(year)) %>%  
  dplyr::select(c(AsMi_tag_id:status,AsMi_plot_id:fence,Creek)) %>%
  group_by(AsMi_tag_id) %>%
  filter(any(length > 0)) %>%
  mutate(first.cap.stage = status[which.min(year[length>0])]) %>%
  ungroup() %>%
  mutate(Obs = case_when(status %in% c("seedling","vegetative") ~ "V",
                         status == "reproductive" ~ "R",
                         status %in% c("dormant","dead") ~ "0")) %>%
  arrange(year) %>%
  mutate(Obs = as.character(Obs)) %>%
  pivot_wider(names_from = year, values_from = Obs, values_fill = "0", names_prefix = "Year", 
              id_cols = c(AsMi_tag_id,AsMi_site_id,AsMi_plot_id, fence,first.cap.stage, Creek)) %>%
  ### UPDATE TO CURRENT YEAR ######
  unite(ch, Year1995:Year2024, sep ="") %>%
  mutate(Tag = as.factor(AsMi_tag_id),
         Site = as.factor(AsMi_site_id),
         Plot = as.factor(AsMi_plot_id),
         Creek = as.factor(Creek)) %>%
  relocate(Creek, .after = Plot) %>%
  filter((grepl("R",ch) | grepl("V",ch)))


# Any factor is a group variable, any numeric can be a covariate
plotSiteCreek <- CJS_asmi %>%
  distinct(Plot,Site,Creek)
dmPlot <- model.matrix(~ -1 + Plot, CJS_asmi)
dmSite <- model.matrix(~ -1 + Site, CJS_asmi)
dmCreek <- model.matrix(~ -1 + Creek, CJS_asmi)
dimnames(dmCreek)[[2]][length(dimnames(dmCreek)[[2]])] ## CreekSouthBeaver

# CJS_asmi %>%
#   dplyr::select(ch) %>%
#   bind_cols(dmPlot) %>%
#   bind_cols(dmSite) %>%
#   bind_cols(dmCreek) %>%
#   mutate(CreekSouthBeaver = paste(CreekSouthBeaver, ";", sep = "")) %>%
#   write.table(file = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/Multi_asmi_markPSC.inp",
#               sep = " ",
#               col.names = FALSE, row.names = FALSE)
# 
# ## Plot Site Creek
# asmiMultiPSC <- convert.inp("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/Multi_asmi_markPSC.inp", 
#                             group.df = plotSiteCreek,
#                             covariates = NULL,
#                             use.comments = FALSE)

## Need to split by plot because different time frames and different times having fencing
plotdf <- CJS_asmi %>%
  distinct(Plot)
dmPlot <- model.matrix(~ -1 + Plot, CJS_asmi)
dimnames(dmPlot)[[2]][length(dimnames(dmPlot)[[2]])]

CJS_asmi %>%
  dplyr::select(ch) %>%
  bind_cols(dmPlot) %>%
  mutate(Plot799 = paste(Plot799, ";", sep = "")) %>%
   ### FOR DBG0077
  write.table(file = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/Multi_asmi_mark.inp",sep = " ",
  # write.table(file = paste(savepath, "Multi_asmi_mark.inp", sep = ""), sep = " ",
              col.names = FALSE, row.names = FALSE)

asmiMulti <- convert.inp(
  "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/Multi_asmi_mark.inp",
  # paste(savepath, "Multi_asmi_mark.inp", sep = ""),
                        group.df = plotdf,
                        covariates = NULL,
                        use.comments = FALSE)

## By plot, needed since plots have different lengths 
asmiMulti.proc <- process.data(asmiMulti, begin.time = 1995, model = "Multistrata", groups = "Plot")
asmiMulti.ddl <- make.design.data(asmiMulti.proc)
```


Don't have to do this 
```{r}
# Add groups
asmiMulti.ddl$S <- asmiMulti.ddl$S %>%
  mutate(Site = case_when(Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 1] ~ 1,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 2] ~ 2,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 5] ~ 5,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 15] ~ 15,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 19] ~ 19,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 26] ~ 26)) %>%
  mutate(Site = as.factor(Site)) %>%
  mutate(Creek = case_when(Plot %in% plotSiteCreek$Plot[plotSiteCreek$Creek == "SouthBeaver"] ~ "SouthBeaver",
                           Plot %in% plotSiteCreek$Plot[plotSiteCreek$Creek == "Cebolla"] ~ "Cebolla")) %>%
  mutate(Creek = as.factor(Creek))

asmiMulti.ddl$p <- asmiMulti.ddl$p %>%
  mutate(Site = case_when(Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 1] ~ 1,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 2] ~ 2,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 5] ~ 5,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 15] ~ 15,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 19] ~ 19,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 26] ~ 26)) %>%
  mutate(Site = as.factor(Site)) %>%
  mutate(Creek = case_when(Plot %in% plotSiteCreek$Plot[plotSiteCreek$Creek == "SouthBeaver"] ~ "SouthBeaver",
                           Plot %in% plotSiteCreek$Plot[plotSiteCreek$Creek == "Cebolla"] ~ "Cebolla")) %>%
  mutate(Creek = as.factor(Creek))
asmiMulti.ddl$Psi <- asmiMulti.ddl$Psi %>%
  mutate(Site = case_when(Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 1] ~ 1,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 2] ~ 2,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 5] ~ 5,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 15] ~ 15,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 19] ~ 19,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 26] ~ 26)) %>%
  mutate(Site = as.factor(Site)) %>%
  mutate(Creek = case_when(Plot %in% plotSiteCreek$Plot[plotSiteCreek$Creek == "SouthBeaver"] ~ "SouthBeaver",
                           Plot %in% plotSiteCreek$Plot[plotSiteCreek$Creek == "Cebolla"] ~ "Cebolla")) %>%
  mutate(Creek = as.factor(Creek))

```
    
```{r}
# Which sites/plots were fenced when; when Open == 1, when fenced == 0; switched back, that didn't fix it
PlotSiteYrFence <- asmi.all2 %>%
  distinct(year,plot,site,fenced)
### Use PlotSiteYrFence to specify years when a plot was fenced
PlotSiteYrFence %>%
  filter(fenced == "y")
## Time varying fencing; as a dummy variable, not a factor
asmiMulti.ddl$S$fence <- ifelse(asmiMulti.ddl$S$time %in% PlotSiteYrFence$year[PlotSiteYrFence$fenced == "y"] &
                                  asmiMulti.ddl$S$Plot %in% PlotSiteYrFence$plot[PlotSiteYrFence$fenced == "y"],1,0)
asmiMulti.ddl$S$fence <- as.factor(asmiMulti.ddl$S$fence) ## Should be numeric, and it is.

asmiMulti.ddl$Psi$fence <- ifelse(asmiMulti.ddl$Psi$time %in% PlotSiteYrFence$year[PlotSiteYrFence$fenced == "y"] &
                                  asmiMulti.ddl$Psi$Plot %in% PlotSiteYrFence$plot[PlotSiteYrFence$fenced == "y"],1,0)
asmiMulti.ddl$Psi$fence <- as.factor(asmiMulti.ddl$Psi$fence)

asmiMulti.ddl$p$fence <- ifelse(asmiMulti.ddl$p$time %in% PlotSiteYrFence$year[PlotSiteYrFence$fenced == "y"] &
                                  asmiMulti.ddl$p$Plot %in% PlotSiteYrFence$plot[PlotSiteYrFence$fenced == "y"],1,0)
asmiMulti.ddl$p$fence <- as.factor(asmiMulti.ddl$p$fence)


### Need to note, no surveys for some plots 1995, before 2004, before 2014, and after 2019
# i.e. fix indices as detection == 0 on occasions where there were no observations

# ps.asmi <- ps.asmi[!(ps.asmi$Plot == 89 & ps.asmi$Year > 2019),]
# ps.asmi <- ps.asmi[!(ps.asmi$Site < 3 & ps.asmi$Year < 2014),]
# ps.asmi <- ps.asmi[!(ps.asmi$Plot == 598 & ps.asmi$Year < 2004),]
# ps.asmi <- ps.asmi[!(ps.asmi$Plot == 300 & ps.asmi$Year < 1996),]
# ps.asmi <- ps.asmi[!(ps.asmi$Plot == 238 & ps.asmi$Year < 1996),]

## Should this have been time?! not cohort?? No, cohort and time 
plotsSite <- CJS_asmi %>%
  distinct(Plot,Site)
pindex <- asmiMulti.ddl$p 
p.idAddedlater <- pindex %>%
  mutate(cohort = as.numeric(as.character(cohort))) %>%
  mutate(group = as.numeric(as.character(group))) %>%
  ## Added in 2004 %in% c(598), added in 1996 %in% c(300,238)
  filter((group %in% c(598) & cohort < 2004))
p.idAdded1996 <- pindex %>%
  mutate(cohort = as.numeric(as.character(cohort))) %>%
  mutate(group = as.numeric(as.character(group))) %>%
  ## Added in 2004 %in% c(598), added in 1996 %in% c(300,238)
  filter((group %in% c(300,238) & cohort < 1996))  
p.Cebolla <- pindex %>%
  mutate(cohort = as.numeric(as.character(cohort))) %>%
  mutate(group = as.numeric(as.character(group))) %>%
  filter((group %in% c(1,22,32,42,52,16,58,89,90,96,98) & 
            cohort < 2013))
## Need to stop at '2018'to 2019 because no 2020
p.Cebolla89 <- pindex %>%
  mutate(cohort = as.numeric(as.character(cohort))) %>%
  mutate(group = as.numeric(as.character(group))) %>%
  filter((group %in% c(89) & 
            cohort >= 2019))
## None of them will be 2024 because it's going into 2024, need to be the 2023? And get rid of the '2024' to 2025
p.Cebolla.missing2024 <- pindex %>%
  mutate(cohort = as.numeric(as.character(cohort))) %>%
  mutate(group = as.numeric(as.character(group))) %>%
  filter((group %in% c("52") &
            cohort %in% c(2024)))
p.Cebolla.missing2024_time <- pindex %>%
  mutate(cohort = as.numeric(as.character(cohort))) %>%
  mutate(group = as.numeric(as.character(group))) %>%
  filter((group %in% c(52) & time %in% c("2024")))
  
## Fixed indices
p.indices <- 
  unique(c(p.idAdded1996$par.index, p.idAddedlater$par.index,
               p.Cebolla$par.index, p.Cebolla89$par.index,
               p.Cebolla.missing2024$par.index,p.Cebolla.missing2024_time$par.index))
p.values <- rep(0, length(p.indices))
## 10 repeats
length(p.indices) -
length(unique(p.indices))

## All the plot 52 in 2024 times! Oh, from the ones where the cohort was 1995:2012 (which is through year 2013)
## Added unique above to fix
pindex %>%
  filter(par.index %in% p.indices[which(duplicated(p.indices))])

# nest tostratum within stratum and fence within tostratum
## Make a function to compare multiple models

## First check best model for detection 
multi.asmi <- function(){
  S.dot = list(formula = ~1)
  # S.time = list(formula = ~ time)
  # S.fence = list(formula = ~ fence)
  # S.creek = list(formula = ~ Creek)
  # S.creektime = list(formula = ~ Creek + time)
  # S.fence = list(formula = fence + time)
  # S.fenceCreek = list(formula = ~ fence + Creek)
  
  p.dot = list(formula = ~1,
               fixed = list(index = p.indices, value = p.values))
  p.time = list(formula = ~ time,
               fixed = list(index = p.indices, value = p.values))
  p.fence = list(formula = ~ -1 + fence,
               fixed = list(index = p.indices, value = p.values))
  p.creek = list(formula = ~ -1 + Creek,
               fixed = list(index = p.indices, value = p.values))
  p.creektime = list(formula = ~ -1 + Creek + time,
               fixed = list(index = p.indices, value = p.values))
  p.fence = list(formula = -1 + fence + time,
               fixed = list(index = p.indices, value = p.values))
  # p.fenceCreek = list(formula = ~ fence + Creek,
  #              fixed = list(index = p.indices, value = p.values))
  p.strata = list(formula = ~ -1 + stratum,
               fixed = list(index = p.indices, value = p.values))
  p.stratafence = list(formula = ~ -1 + stratum:fence,
               fixed = list(index = p.indices, value = p.values))
  p.stratafenceCreek = list(formula = ~ -1 + stratum:fence:Creek,
               fixed = list(index = p.indices, value = p.values))
  
  Psi.dot = liPsit(formula = ~1)
  # Psi.time = liPsit(formula = ~ time)
  # Psi.fence = liPsit(formula = ~ fence)
  # Psi.creek = liPsit(formula = ~ Creek)
  # Psi.creektime = liPsit(formula = ~ Creek + time)
  # Psi.fence = liPsit(formula = fence + time)
  # Psi.fenceCreek = liPsit(formula = ~ fence + Creek)
  
  asmi.model.list <- create.model.list("Multistrata")
  asmi.results <- mark.wrapper(asmi.model.list, 
                               data = asmiMulti.proc, 
                               ddl = asmiMulti.ddl)
  
  return(asmi.results)
}

asmi.modelsMulti <- multi.asmi()

save(asmi.modelsMulti, file = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/multimarkDetection2024.rdata")


###### Need fencing in all and stratum in all. Detection of reproductive will be different than vegetative
multi.mark2 <- mark(asmiMulti.proc, asmiMulti.ddl, begin.time = 1995, model = "Multistrata",
                   model.parameters = list(S = list(formula = ~ -1 + stratum:fence),
                                           p = list(formula = ~ -1 + stratum:fence,
                                                    fixed = list(index = p.indices, value = p.values)),
                                           Psi = list(formula = ~ -1 + stratum:tostratum:fence)))

save(multi.mark2, file = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/multimarkStratumFence2024.rdata")

multi.mark.nofence <- mark(asmiMulti.proc, asmiMulti.ddl, begin.time = 1995, model = "Multistrata",
                   model.parameters = list(S = list(formula = ~ 1),
                                           p = list(formula = ~ 1,
                                                    fixed = list(index = p.indices, value = p.values)),
                                           Psi = list(formula = ~ -1 + stratum:tostratum)))

## To save from DBG0077
save(multi.mark.nofence, file = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/multimarkNoFence2024.rdata")


## Look at Fletcher c-hat in section 5.8 Chapter 5
## c-hat greater than 1 means overdispersion, variation from age or stage that isn't in the model
```

```{r}

## Would need time for year when the climate was and can add climate variables
foo <- asmiMulti.ddl
foo$p <- merge_design.covariates(foo$p, plotSiteCreek)

load("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/multimarkNoFence2024.rdata")
multi.mark.nofence$results$beta


## multi.mark
load("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/multimarkFence2024.rdata")
multi.mark$results$real %>%
  distinct()

```



## If do site all together, need to split out into sites with similar length surveys
```{r}
sitedf <- CJS_asmi %>%
  distinct(Site)
dmSite <- model.matrix(~ -1 + Site, CJS_asmi)
dimnames(dmSite)[[2]][length(dimnames(dmSite)[[2]])]

CJS_asmi %>%
  dplyr::select(ch) %>%
  bind_cols(dmSite) %>%
  mutate(Site26 = paste(Site26, ";", sep = "")) %>%
  write.table(file = paste(savepath, "Multi_asmi_mark_site.inp", sep = ""), sep = " ", 
              col.names = FALSE, row.names = FALSE)

asmiMultisite <- convert.inp(paste(savepath, "Multi_asmi_mark_site.inp", sep = ""), 
                        group.df = sitedf,
                        covariates = NULL,
                        use.comments = FALSE)


asmiMultisite


```



Seasons    
Winter: December-March (12-3)    
Spring/summer: April-July (4-7)    
Fall: August-November (8-11)   


###########################################################################################################
Figure 3: Astragalus microcymbus individuals by fenced (open circle, y)
 Figure 8    
AGG and Dormant: Total.Plants 
South Beaver Creek    
+
  geom_rect(aes(xmin=2005.75,xmax=2015.5,ymin=0,ymax=75),
                    fill="gray80", alpha=0.01) 
```{r}
head(ps.asmi.reduced)
# need not the first or last year of any plot
# Test
df <- split(ps.asmi.reduced, ps.asmi.reduced$Plot)[[1]]
ps.asmi.dormant <- do.call(rbind, lapply(split(ps.asmi.reduced, ps.asmi.reduced$Plot), function(df){
  df[-c(1,nrow(df)),]
  }))


# Total.Plants>0 should only have plots that have some plants per year so no plots from earlier than they were started
p2SBC <- ggplot(ps.asmi.dormant[ps.asmi.dormant$Creek == "SouthBeaver",], 
       aes(Year, Total.Plants, shape = Fence, colour = Fence))+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean,
               geom = "line")+
  theme_bw() +
  ylab("AGG and dormant")+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  geom_vline(xintercept = 2005.75, lty =3)+      # Fencing put in, removed after 2015 census
  geom_vline(xintercept = 2006.75, lty = 4)+
  geom_vline(xintercept = 2015.5, lty =3) +
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.justification.inside = c(0,0),
        legend.position = "inside",
    # legend.justification=c(0,0), legend.position=c(0,0),  #bottom left
        legend.background = element_rect(fill=alpha('white', 0.1)))


  
```

Cebolla AGG and Dormant = Total.Plants 
```{r}


p2CC <- ggplot(ps.asmi.dormant[ps.asmi.dormant$Creek == "Cebolla",], 
       aes(Year, Total.Plants, shape = as.factor(Site), colour = as.factor(Site)))+
  stat_summary(fun = mean, position=position_dodge(width=0.05),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun = mean, position=position_dodge(width=0.05),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean,
               geom = "line")+
  theme_bw() +
  ylab("AGG and dormant")+
  ggtitle("f)") +
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual("Site",
                     values=c("#000000","#7e7e7e"),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_shape_manual("Site",
                     values=c(1,2),
                     labels = c("Cebolla Mid","Cebolla North"))+
  theme(legend.position = "inside",legend.justification.inside = c(1,1), legend.position.inside = c(0.95,0.99),
        legend.background = element_rect(fill=alpha('white', 0.1))) 

```


South Beaver
Figure 3
AGG
```{r}


p1SBC <- ggplot(ps.asmi.reduced[ps.asmi.reduced$Site > 3,], 
       aes(Year, Total.Alive, shape = Fence, colour = Fence))+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean,
               geom = "line")+
  theme_bw() +
  ylab("Above Ground Growth")+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0),
        legend.background = element_rect(fill='transparent'))+
  geom_vline(xintercept = 2005.75, lty =3)+      # Fencing put in, removed after 2015 census
  geom_vline(xintercept = 2006.75, lty = 4)+
  geom_vline(xintercept = 2015.5, lty =3) +
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.position = "inside",legend.justification.inside =c(1,1), legend.position.inside =c(0.35,1),
        legend.background = element_rect(fill=alpha('white', 0.1))) 


```

Cebolla    
AGG   Total.Alive     
AGG + Dormant   Total.Plants
```{r}

p1CC <- ggplot(ps.asmi.reduced[ps.asmi.reduced$Site < 3,], 
       aes(Year, Total.Alive, shape = as.factor(Site), colour = as.factor(Site)))+
  stat_summary(fun = mean, position=position_dodge(width=0.15),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun = mean, position=position_dodge(width=0.15),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean, position=position_dodge(width=0.15),
               geom = "line")+
  theme_bw() +
  ylab("Above Ground Growth")+
  ggtitle("e)") +
  theme(plot.title=element_text(hjust=0),
        legend.background = element_rect(fill='transparent'))+
  scale_color_manual("Site",
                     values=c("#000000","#7e7e7e"),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_shape_manual("Site",
                     values=c(1,2),
                     labels = c("Cebolla Mid","Cebolla North"))+
  # scale_x_continuous(breaks = c(2014:currentyr))+
  theme(legend.position = "inside",legend.justification.inside =c(1,1), legend.position.inside=c(1,1),
        legend.background = element_rect(fill=alpha('white', 0.1))) 


```



Fruit   
South Beaver Creek
```{r}


p3SBC <- 
  ps.asmi.reduced %>%
  filter(Site > 3) %>%
  mutate(Total.Fruit = log(Total.Fruit)) %>%
  ggplot(  
       aes(Year, Total.Fruit, shape = Fence, colour = Fence))+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean,position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ylab("log(Total Fruit)")+
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0),
        legend.background = element_rect(fill='transparent'))+
  geom_vline(xintercept = 2005.75, lty =3)+      # Fencing put in, removed after 2015 census
  geom_vline(xintercept = 2006.75, lty = 4)+
  geom_vline(xintercept = 2015.5, lty =3) +
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.position = "inside",legend.justification.inside=c(0.15,1), legend.position.inside=c(0.15,1),
        legend.background = element_rect(fill=alpha('white', 0.1))) #upper right

```


Cebolla
```{r}

aggregate(Total.Fruit~Site+Year,data=ps.asmi.reduced[ps.asmi.reduced$Site < 3,], mean)

aggregate(Total.Fruit~Site+Year,data=ps.asmi.reduced[ps.asmi.reduced$Site<3,],
          std.error)


p3CC <- 
  ps.asmi.reduced %>%
  filter(Site < 3) %>%
  mutate(Total.Fruit = log(Total.Fruit)) %>%
  ggplot( 
       aes(Year, Total.Fruit, shape = as.factor(Site), colour = as.factor(Site)))+
  stat_summary(fun = mean, position=position_dodge(width=0.15),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun = mean, position=position_dodge(width=0.15),
               geom = "point")+
  stat_summary(fun = mean,position=position_dodge(width=0.15),
               geom = "line")+
  theme_bw() +
  ylab("log(Total Fruit)")+
  ggtitle("g)") +
  theme(plot.title=element_text(hjust=0),
        legend.background = element_rect(fill='transparent'))+
  scale_color_manual("Site", 
                     values=c("#000000","#7e7e7e"),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_shape_manual("Site", 
                     values=c(1,2),
                     labels = c("Cebolla Mid","Cebolla North"))+
  theme(legend.position = "inside", legend.justification.inside =c(0,1), legend.position.inside =c(0,1),
        legend.background = element_rect(fill=alpha('white', 0.1)))
  # scale_x_continuous(breaks = c(2014:currentyr))

```
  
  
X..Flowered - Percent Reproductive
```{r}


p4SBC <- ggplot(ps.asmi.reduced[ps.asmi.reduced$Creek == "SouthBeaver",], 
       aes(Year, X..Flowered, shape = Fence, colour = Fence))+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean,position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ylab("% Reproductive")+
  ggtitle("d)") +
  theme(plot.title=element_text(hjust=0),
        legend.background = element_rect(fill='transparent'))+
  geom_vline(xintercept = 2005.75, lty =3)+      # Fencing put in, removed after 2015 census
  geom_vline(xintercept = 2006.75, lty = 4)+
  geom_vline(xintercept = 2015.5, lty =3) +
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Open","Fenced"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Open","Fenced"))+
  theme(legend.position = "inside", legend.justification.inside =c(1,1), legend.position.inside =c(1,1),  #bottom left
        legend.background = element_rect(fill=alpha('white', 0.1))) #upper right

```

Cebolla
```{r}

p4CC <- ggplot(ps.asmi.reduced[ps.asmi.reduced$Site<3,], 
       aes(Year, X..Flowered, shape = as.factor(Site), colour = as.factor(Site)))+
  stat_summary(fun = mean, position=position_dodge(width=0.15),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
  stat_summary(fun = mean, position=position_dodge(width=0.15),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean,position=position_dodge(width=0.15),
               geom = "line")+
  theme_bw() +
  ylab("% Reproductive")+
  ggtitle("h)") +
  theme(plot.title=element_text(hjust=0),
        legend.background = element_rect(fill='transparent'))+
  scale_color_manual("Site",
                     values=c("#000000","#7e7e7e"),
                     labels = c("Cebolla Mid","Cebolla North"))+
  scale_shape_manual("Site",
                     values=c(1,2),
                     labels = c("Cebolla Mid","Cebolla North"))+
  # scale_x_continuous(breaks = c(2014:currentyr))+
  theme(legend.position = "inside", legend.justification.inside =c(1,1), legend.position.inside =c(1,1),
        legend.background = element_rect(fill=alpha('white', 0.1))) #upper right

```


Figure 3
```{r}
ggsave(paste(savepath, "Fig3a-d.jpg", sep=""),
       # Down each column
       p1SBC + p2SBC + p3SBC + p4SBC + plot_layout(ncol = 2), units = "mm", 
    dpi = 300, height = 200, width = 200)

ggsave(paste(savepath, "Fig3e-h.jpg", sep=""),
       # Down each column
       p1CC +  p2CC +p3CC + p4CC + plot_layout(ncol=2), units = "mm", dpi = 300, height = 200, width = 200)

```


# Results: Herbivory
Dormancy    
repeat lengths   
```{r}
# how many individuals are dormant at some point
ind_dorm <- do.call(rbind,lapply(split(asmi.raw,asmi.raw$AsMi_tag_id), function(x){
  if(length(grep("dormant",x$status))>0){
    data.frame(Site = unique(x$AsMi_site_id), 
               Fence = unique(x$fence), 
               Plot = unique(x$AsMi_plot_id), 
               Dorm = 1)
  } else {
    data.frame(Site = unique(x$AsMi_site_id), 
               Fence = unique(x$fence), 
               Plot = unique(x$AsMi_plot_id), 
               Dorm = 0)
    }
  }))

# is dormancy independent of fencing?
fencing_ind_dorm <- do.call(rbind,lapply(split(asmi.raw[asmi.raw$year > 2005 & asmi.raw$year < 2016 & asmi.raw$AsMi_site_id > 3,],
                                               asmi.raw$AsMi_tag_id[asmi.raw$year > 2005 & asmi.raw$year < 2016 & asmi.raw$AsMi_site_id > 3]), function(x){
  if(length(grep("dormant",x$status))>0){
    data.frame(Site = unique(x$AsMi_site_id), 
               Fence = unique(x$fence), 
               Plot = unique(x$AsMi_plot_id), 
               Dorm = 1)
  } else {
    data.frame(Site = unique(x$AsMi_site_id), 
               Fence = unique(x$fence), 
               Plot = unique(x$AsMi_plot_id), 
               Dorm = 0)
    }
  }))
chisq.test(table(fencing_ind_dorm$Dorm, fencing_ind_dorm$Fence))
# p = 0.008 so fencing likely influences dormancy 

```


AIC for annual fruit production: none or a mast year
#Episodic fruit production paragraph   
```{r}
# noreproductiveyears <- aggregate(flower~AsMi_site_id+year, data=asmi.raw,
#                                  function(x) if(sum(x)>0){
#                                    1
#                                  } else {
#                                    0
#                                  })
noreproductiveyears <- asmi.raw %>%
  filter(!(AsMi_plot_id == 52 & year == 2024)) %>%
  group_by(AsMi_site_id, year) %>%
  dplyr::summarise(flower = if_else(sum(flower) > 0, 1,0))


noreproductiveyears %>%
  mutate(site = case_when(AsMi_site_id == 1 ~ "Cebolla Mid",
                          AsMi_site_id == 2 ~ "Cebolla North",
                          AsMi_site_id == 5 ~ "Site 5",
                          AsMi_site_id == 15 ~ "Site 15",
                          AsMi_site_id == 19 ~ "Site 19",
                          AsMi_site_id == 26 ~ "Site 26")) %>%
  left_join(asmi.season.wide, by = c("site" = "site","year" = "Prev12")) %>%
  ungroup() %>% 
  dplyr::mutate(across(ppt_fall:tmin_winter, .fns = scale)) %>%
  # filter(AsMi_site_id %in% c(5,15,19,26)) %>%
ggplot(  aes(ppt_winter,flower,colour=as.factor(AsMi_site_id)))+
  geom_point()+
  geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE)+
  facet_grid(~AsMi_site_id) +
  scale_colour_discrete(guide = "none")


noreproductiveyears %>%
  mutate(site = case_when(AsMi_site_id == 1 ~ "Cebolla Mid",
                          AsMi_site_id == 2 ~ "Cebolla North",
                          AsMi_site_id == 5 ~ "Site 5",
                          AsMi_site_id == 15 ~ "Site 15",
                          AsMi_site_id == 19 ~ "Site 19",
                          AsMi_site_id == 26 ~ "Site 26")) %>%
  # filter(AsMi_site_id > 3) %>% ## as of 2022, no years with no reproduction
  left_join(asmi.season.wide, by = c("site" = "site","year" = "Prev12")) %>%
  ungroup() %>% 
  dplyr::mutate(across(ppt_fall:tmin_winter, .fns = scale)) %>%
ggplot(  aes(tmax_springSummer,flower))+#,colour=as.factor(AsMi_site_id)))+
  geom_point()+
  xlab("Summer maximum temperature")+
  geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE)+
  theme_bw()
  # facet_grid(~Creek, scales = "free")

## exclude Cebolla creek that has never had a year without seeding
mastseeding <- noreproductiveyears %>%
  mutate(site = case_when(AsMi_site_id == 1 ~ "Cebolla Mid",
                          AsMi_site_id == 2 ~ "Cebolla North",
                          AsMi_site_id == 5 ~ "Site 5",
                          AsMi_site_id == 15 ~ "Site 15",
                          AsMi_site_id == 19 ~ "Site 19",
                          AsMi_site_id == 26 ~ "Site 26")) %>%
  mutate(Creek = case_when(AsMi_site_id < 3 ~ "Cebolla",
                           AsMi_site_id > 3 ~ "South Beaver")) %>%
  left_join(asmi.season.wide, by = c("site" = "site","year" = "Prev12"))%>%
  ungroup() %>% 
  dplyr::mutate(across(ppt_fall:tmin_winter, .fns = scale)) # %>%
  # filter(AsMi_site_id > 3) ## as of 2024, no years with no reproduction

table(mastseeding$flower, mastseeding$Creek)  

glm1 <- glm(flower ~ ppt_winter*site, family = binomial, data = mastseeding)
glm2 <- glm(flower ~ tmax_springSummer*ppt_winter*site, family = binomial, data = mastseeding)
# glm3 <- glm(flower ~ tmin_winter*ppt_winter*site, family = binomial, data = mastseeding) 
glm4 <- glm(flower ~ ppt_fall*site, family = binomial, data = mastseeding)
glm5 <- glm(flower ~ 1*site, family = binomial, data = mastseeding)
glm6 <- glm(flower ~ ppt_springSummer*site, family = binomial, data = mastseeding)
glm7 <- glm(flower ~ tmax_springSummer*site, family = binomial, data = mastseeding) 
glm8 <- glm(flower ~ tmin_winter*site, family = binomial, data = mastseeding)
glm.list <- list(glm1,glm2,glm3,glm4,glm5,glm6,glm7,glm8)
glm.names <- as.character(unlist(lapply(glm.list,formula)))
(glm.results <- aictab(glm.list, modnames=glm.names))
for(i in 2:length(glm.list)){
  print(exp(0.5*glm.results$Delta_AICc[i]))
}

```

## AIC figures for figure 4 of AIC results
```{r}
## Don't exclude Cebolla Creek
noreproductiveyears %>%
  mutate(site = case_when(AsMi_site_id == 1 ~ "Cebolla Mid",
                          AsMi_site_id == 2 ~ "Cebolla North",
                          AsMi_site_id == 5 ~ "Site 5",
                          AsMi_site_id == 15 ~ "Site 15",
                          AsMi_site_id == 19 ~ "Site 19",
                          AsMi_site_id == 26 ~ "Site 26")) %>%
  left_join(asmi.season.wide, by = c("site" = "site","year" = "Prev12")) %>%
  ungroup() %>% 
  dplyr::mutate(across(ppt_fall:tmin_winter, .fns = scale)) %>% 
  dplyr::mutate(ppt_winter_bin = cut(ppt_winter, breaks = 3)) %>%
  dplyr::select(ppt_winter_bin) %>%
  distinct(ppt_winter_bin) %>%
  arrange(ppt_winter_bin)

Fig4emastseed <- noreproductiveyears %>%
  mutate(site = case_when(AsMi_site_id == 1 ~ "Cebolla Mid",
                          AsMi_site_id == 2 ~ "Cebolla North",
                          AsMi_site_id == 5 ~ "Site 5",
                          AsMi_site_id == 15 ~ "Site 15",
                          AsMi_site_id == 19 ~ "Site 19",
                          AsMi_site_id == 26 ~ "Site 26")) %>%
  left_join(asmi.season.wide, by = c("site" = "site","year" = "Prev12")) %>%
  filter(AsMi_site_id > 3) %>%
  ungroup() %>% 
  dplyr::mutate(across(ppt_fall:tmin_winter, .fns = scale)) %>%
  dplyr::mutate(ppt_winter_bin = cut(ppt_winter, breaks = 3)) %>%
  # filter(AsMi_site_id > 3) %>%
ggplot(  aes(tmax_springSummer,flower, colour=site))+
  geom_point()+
  theme_bw()+
  # facet_grid(~ppt_winter_bin, scales = "free")+
  facet_grid(~ppt_winter_bin, scales = "free",
             labeller = labeller(ppt_winter_bin =
                                   c("(-1.92,-0.331]" = "low winter precipitation",
                                     "(-0.331,1.25]" = "mid winter precipitation",
                                     "(1.25,2.84]" = "high winter precipitation"))
             )+
  # labeller = labeller(.cols = label_both))+
  xlab("Summer maximum temperature")+
  ylab("Fruit production by year")+
  ggtitle("e)")+
  geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE, alpha = 0.4)#+
  # facet_grid(~Creek, scales = "free")  ## for later years if Cebolla reproduction fails

###############################################################################################
## Full figure 4 AIC results
ggsave(paste(savepath, "Fig4AICresultsa-b.jpg", sep = ""),
       # a)
 (Fig4asurvCreekBr + Fig4asurvCreek)/
   # b) 
 Fig4Survabiotic +
   plot_layout(heights = c(1, 1))
, width=250, height=200,units='mm', dpi=300)

ggsave(paste(savepath, "Fig4AICresultsc-e.jpg", sep = ""),
   # c)1 and 2
       Fig4bReprodYN_site/Fig4bReprodYN/
       # d)
   Fig4Fruit/
   # e)
   Fig4emastseed
, width=250, height=350,units='mm', dpi=300)


#how many years are there no reproductive individuals per site
1-aggregate(flower~AsMi_site_id, data=noreproductiveyears,
          function(x) sum(x)/length(x))

#On average, no reproductive individuals how many years?  in 2016
mean(c(1-aggregate(flower~AsMi_site_id,
                   data=noreproductiveyears[noreproductiveyears$year<2017,],
          function(x) sum(x)/length(x))[-(1:2),2]))*(length(1995:(currentyr-1)))

#On average, no reproductive individuals how many years?  in current year
mean(c(1-aggregate(flower~AsMi_site_id, data=noreproductiveyears,
          function(x) sum(x)/length(x))[-(1:2),2]))*(length(1995:currentyr))

#Number of years of no reproductive for South Beaver Creek (not correct for Cebolla) order is 1,2,5,15,19,26
length(1995:currentyr)-aggregate(flower~AsMi_site_id, data=noreproductiveyears,sum)


```


# Indivdiuals, density at Cebolla from demography compared to point-in-time counts   
```{r}

ps.asmi %>%
  mutate(PDens = Total.Plants/(pi*(3^2))) %>%
  group_by(Creek, Site) %>%
  dplyr::summarise(avgDens = mean(PDens))

circleplots <- pi*(3^2)

pit1.north <- 441
pit2.north <- 987

densepit1.north <- 68/pit1.north
densepit2.north <- 114/pit2.north

mean(densepit1.north,densepit2.north) # 0.154 indv/sq meter

densecebolla <- 40/circleplots

AGG.CC <- aggregate(Total.Alive ~ Site + Year, ps.asmi[ps.asmi$Site<3 & ps.asmi$Year>2013,],
                    function(x) mean(x))
averageAGG <- aggregate(Total.Alive ~ Site, AGG.CC, function(x) mean(x))
averageAGG$Total.Alive/circleplots

aggregate(Total.Alive~Creek+Year, ps.asmi, function(x) sum(x))


ps.asmi %>%
  mutate(PDens = Total.Plants/(pi*(3^2))) %>%
  group_by(Creek) %>%
  dplyr::summarise(avgDens = mean(PDens))
```



Results: Fruit
```{r}
reproductive <- aggregate(X..Flowered.1 ~ Site + Year, ps.asmi, function(x) sum(x, na.rm=TRUE))

reproductive[reproductive$X..Flowered.1==0,]
rowSums(table(reproductive$Site, reproductive$Year))
length(1995:currentyr)

# Years with no reproduction
length(1995:currentyr)-rowSums(table(reproductive$Site, reproductive$Year))[3:6]
mean(length(1995:currentyr)-rowSums(table(reproductive$Site, reproductive$Year))[3:6])

length(2014:currentyr)-rowSums(table(reproductive$Site, reproductive$Year))[1:2]
mean(length(2014:currentyr)-rowSums(table(reproductive$Site, reproductive$Year))[1:2])

# Percent of years that are reproductive
mean(rowSums(table(reproductive$Site, reproductive$Year))[3:6]/length(1995:currentyr))
```

Results: herbivory
```{r}
asmi.raw.fenced <- asmi.raw[asmi.raw$year > 2005 & asmi.raw$year < 2016 & 
                              asmi.raw$Creek == "SouthBeaver",]

table(asmi.raw$Browsing...Status)[-5]/sum(table(asmi.raw$Browsing...Status)[-5])

table(asmi.raw.fenced$Browsing...Status,asmi.raw.fenced$fence)[-5,]/colSums(table(asmi.raw.fenced$Browsing...Status,asmi.raw.fenced$fence)[-5,])

# Herbivory by insects (removing Unknown)
sum(table(asmi.raw$Browsing...Status)[c(1,3)])/sum(table(asmi.raw$Browsing...Status)[-5])


## No more fencing, not needing to continue
colSums(table(asmi.raw.fenced$Browsing...Status,asmi.raw.fenced$fence)[c(1,3),])/colSums(table(asmi.raw.fenced$Browsing...Status,asmi.raw.fenced$fence)[-5,])

# Herbivory by mammals (removing Unknown)
sum(table(asmi.raw$Browsing...Status)[c(2,3)])/sum(table(asmi.raw$Browsing...Status)[-5])
colSums(table(asmi.raw.fenced$Browsing...Status,asmi.raw.fenced$fence)[c(2,3),])/colSums(table(asmi.raw.fenced$Browsing...Status,asmi.raw.fenced$fence)[-5,])

# is level of browsing independent of the fencing treatment?
chisq.test(table(asmi.raw.fenced$Browsing...Status,asmi.raw.fenced$fence)[-c(4:5),]) # remove no browsing and unknown
# p-value = 0.003 unlikely that fencing is independent of amounts of types of browsing, fencing changes the amount of browsing by type (insect, mammal, both), type of browsing is not likely independent of fencing

chisq.test(table(asmi.raw.fenced$Browsing...Status,asmi.raw.fenced$fence)[-c(5),]) # remove no browsing and unknown
# p-value < 0.001 means it is unlikely independent of fencing by different types of browsing

# browsing or no browsing
chisq.test(table(asmi.raw.fenced$browsing,asmi.raw.fenced$fence))
# during the time fencing was installed, it seems the probability of being browsed in a plot depends on the plot being fenced

```

Discussion: percent of dormant individuals
```{r}

ps.asmi$PercentDorm <- ps.asmi$X..Dormant/sum(ps.asmi$Total.Alive,ps.asmi$Total.Plants, na.rm=TRUE)  
aggregate(PercentDorm~Year, ps.asmi, function(x) mean(x, na.rm=TRUE))  
```



## Consecutive years of reproduction
Reproductive lengths - South Beaver Creek only  

```{r}

cebolla <- asmi.raw[asmi.raw$AsMi_site_id %in% c(1,2),]
sbc <- asmi.raw[asmi.raw$AsMi_site_id %in% c(5,15,19,26),]

asmi.1 <- sbc[order(sbc$AsMi_site_id, sbc$AsMi_tag_id, sbc$year),]
cebolla <- cebolla[order(cebolla$AsMi_site_id, cebolla$AsMi_tag_id, cebolla$year),]

levels(asmi.1$status)
# [1] "seedling"     "vegetative"   "reproductive" "dormant"      "dead"

repros <- do.call(rbind, lapply(split(asmi.1, asmi.1$AsMi_tag_id), function(tag){
  reprolns <- rle(as.numeric(tag$status))$lengths[rle(as.numeric(tag$status))$values==3]
  out <- data.frame(Tag=rep(unique(tag$AsMi_tag_id), length(reprolns)), 
                    Site=rep(unique(tag$AsMi_site_id), length(reprolns)),
                    Plot=rep(unique(tag$AsMi_plot_id), length(reprolns)),
                    repros=reprolns)
  out
}))

# Consecutive years of reproduction 
# max(repros$reproslength)
max(repros$repros) # 8
repros[repros$repros == max(repros$repros),]
hdi(repros$repros)
median(repros$repros)

## Cebolla Creek
CCrepros <- do.call(rbind, lapply(split(cebolla, cebolla$AsMi_tag_id), function(tag){
  reprolns <- rle(as.numeric(tag$status))$lengths[rle(as.numeric(tag$status))$values==3]
  out <- data.frame(Tag=rep(unique(tag$AsMi_tag_id), length(reprolns)), 
                    Site=rep(unique(tag$AsMi_site_id), length(reprolns)),
                    Plot=rep(unique(tag$AsMi_plot_id), length(reprolns)),
                    repros=reprolns)
  out
}))

# Consecutive years of reproduction 
# max(repros$reproslength)
max(CCrepros$repros) 
CCrepros[CCrepros$repros == max(CCrepros$repros),]
hdi(CCrepros$repros)
median(CCrepros$repros)



repros[repros$repros == max(repros$repros)-4,]

plotrepros <- data.frame(table(repros$Tag, repros$repros)) #Var1 is tag, Var2 is reprolenth, Freq times
mean(plotrepros$Freq[plotrepros$Var2==1])

ggplot(plotrepros, aes(x=Var2, y=Freq ))+
  geom_boxplot()+ 
  theme(legend.position="none")

```

```{r, eval=FALSE}}
#is survival associated with a continuous classifying variable?
surv.asmi <- asmi.all2  # asmi.2
surv.asmi$surv <- 1
surv.asmi$surv[surv.asmi$fate=="dead"] <- 0
table(surv.asmi$surv)

str(surv.asmi)

#stages are L, Q, and C? linear, quadractic, cubic - because of the ordinal factor, just factor it
summary(glm(surv~ as.factor(as.numeric(stage)) +as.factor(site), family=binomial(link = "logit"), surv.asmi))
# overall survival is 23% SE 6.6% more for vegetative, more for reproductive but misleading for dormant because we can't observe them dying. less for site 19, more for site 5

surv.asmi$stage <- factor(surv.asmi$stage, levels=levels(surv.asmi$stage), ordered=FALSE)
str(surv.asmi)
summary(glm(surv~ stage +as.factor(site), family=binomial(link = "logit"), surv.asmi))


#survival as a cox proportional hazards regression model
library(survival)

# interval data, the starting time for the interval (so the year is the stage year and survival is based on fate, next year); "right censoring" means date of death is unknown, which it is actually! 
#Survival curve is probability that time of death is greater than some specified time
survObj <- Surv(time = surv.asmi$year, event=as.logical(surv.asmi$surv))
model <- coxph(survObj ~ strata(factor(site)), data=surv.asmi)
model <- coxph(survObj ~ as.factor(site), data=surv.asmi)
summary(model)

model_fence <- coxph(survObj ~ fenced, data=surv.asmi)
summary(model_fence)

model_fence_site <- coxph(survObj ~ fenced*site, data=surv.asmi)
summary(model_fence_site)

model_stage <- coxph(survObj ~ stage, data=surv.asmi)
summary(model_stage)
levels(surv.asmi$stage)

```


https://rpubs.com/daspringate/survival    
https://datascience.stackexchange.com/questions/8162/r-plotsurv-newdata-draws-same-lines-many-times-why    


```{r, eval=FALSE}}
#plot survival of a given year by size
for(i in sort(unique(surv.asmi$year))){
  plot(surv.asmi$length[surv.asmi$year==i], 
       surv.asmi$surv[surv.asmi$year==i], main= paste(i), xlab="length",ylab="Probability of survival")
  g<- glm(surv~length, family=binomial,surv.asmi[surv.asmi$year==i,])
  curve(predict(g,data.frame(length=x),type="resp"), col="green4",add=TRUE)
  #points(surv.asmi$length[surv.asmi$year==i],fitted(g), pch=20)
}

plot(surv.asmi$length, 
       surv.asmi$surv, main= "1996 - 2022", xlab="length",ylab="Probability of survival")
  g<- glm(surv~length, family=binomial,surv.asmi)
  curve(predict(g,data.frame(length=x),type="resp"), col="green4",add=TRUE)

# Plot survivial per year by fruit
for(i in sort(unique(surv.asmi$year))){
  plot(surv.asmi$fruits[surv.asmi$year==i], 
       surv.asmi$surv[surv.asmi$year==i], main= paste(i), xlab="fruits",ylab="Probability of survival")
  g<- glm(surv~fruits, family=binomial,surv.asmi[surv.asmi$year==i,])
  curve(predict(g,data.frame(fruits=x),type="resp"), col="green4",add=TRUE)
  #points(surv.asmi$length[surv.asmi$year==i],fitted(g), pch=20)
}
  
  
plot(surv.asmi$fruits, 
       surv.asmi$surv, main= "1996 - 2017", xlab="fruits",ylab="Probability of survival")
  g<- glm(surv~fruits, family=binomial,surv.asmi)
  curve(predict(g,data.frame(fruits=x),type="resp"), col="green4",add=TRUE)
  

surv.asmi$frYN <- 0
surv.asmi$frYN[surv.asmi$fruits>0] <- 1

# Probability of being reproductive given length
for(i in sort(unique(surv.asmi$year))){
  plot(surv.asmi$length[surv.asmi$year==i], 
       surv.asmi$frYN[surv.asmi$year==i], main= paste(i), xlab="length",ylab="Probability of reproductive")
  g<- glm(frYN~length, family=binomial,surv.asmi[surv.asmi$year==i,])
  curve(predict(g,data.frame(length=x),type="resp"), col="green4",add=TRUE)
}
    
plot(surv.asmi$length, 
       surv.asmi$frYN, main= "1996 - 2019", xlab="length",ylab="Probability of reproductive")
  g<- glm(frYN~length, family=binomial,surv.asmi)
  curve(predict(g,data.frame(length=x),type="resp"), col="green4",add=TRUE)  
  
```


Does this not only want the max YrsAlive per tag? Yes I think so 
# Another way to look at survival curves
```{r, eval=FALSE}}
fit <- survfit(Surv(length, surv) ~ fenced, 
               data = surv.asmi[surv.asmi$length>0 & surv.asmi$year>2005,]) 

# jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
#               currentyr,"_asmi/Fig9_Surv_fence_size.jpg", sep = ""),
#          units = "mm", res = 300, height = 100, width = 150)

ggsurvplot(fit, data=surv.asmi[surv.asmi$length>0 & surv.asmi$year>2005,], 
           risk.table = FALSE, xlab = "length", conf.int = TRUE)

# dev.off()
```

# Fit these with dampening survival estimates? based on what are likely to be seen in the rest of the year but dormant in July? 


```{r, eval=FALSE}}
fit <- survfit(Surv(length, surv) ~ site, 
               data = surv.asmi[surv.asmi$length>0 & surv.asmi$year>2005,]) 

ggsurvplot(fit, data=surv.asmi[surv.asmi$length>0& surv.asmi$year>2005,], risk.table = FALSE, xlab = "length")

```



############################# 

```{r, eval=FALSE}}

asmi.raw.1 <- asmi.raw[with(asmi.raw, order(AsMi_site_id,AsMi_plot_id,AsMi_tag_id,year)),]

asmi.raw.1[asmi.raw.1$AsMi_tag_id==10,]
asmi.1[asmi.1$AsMi_tag_id==10,] # Alive in 1995, not detected again until 2004 when big and flowering
asmi.1[asmi.1$AsMi_tag_id==3,] # in 1996, maybe these were seen in 1995 but dead by 1996?
asmi.1[asmi.1$AsMi_tag_id==11,] # Some tag made in error I guess

#Probability of being reproductive given years alive
levels(asmi.raw.1$status) # 3 is reproductive; 1 is dead
# Should add at least 1 year to the years alive if reproductive 
# test
x <- split(asmi.raw.1, asmi.raw.1$AsMi_tag_id)[[100]]

## not quite appropriate for survival analysis. Example is from a set time, diagnosis of cancer, to how long after is survival and then right censoring to say measured up until a time but don't know after that if still alove vs. measured through to this time and died then 'status = 0 if stopped measuring and 1 if dead at that time. 

notdeadyet <- do.call(rbind,lapply(split(asmi.raw.1, asmi.raw.1$AsMi_tag_id), function(x){
  if(nrow(x[x$status!="dead",])>0){
    if(x$status[1] == "reproductive"){ # if the first year was reproductive then it wasn't a seedling for sure
      addyear <- 1
    } else {
      addyear <- 0
    }
    StageLength <- nrow(x[x$status!="dead",])
    data.frame(Tag=x$AsMi_tag_id[x$status!="dead"],
               year = x$year[x$status!="dead"],
               YrsAlive=(1+addyear):(StageLength+addyear))
    }
  }))

surv.asmi.1 <- merge(asmi.raw, notdeadyet, by.x = c("AsMi_tag_id","year"), by.y = c("Tag","year"))
surv.asmi.1[surv.asmi.1$AsMi_tag_id==10,]
surv.asmi.1[surv.asmi.1$status=="reproductive"&surv.asmi.1$YrsAlive<3,]

surv.asmi.1$frYN <- 0
surv.asmi.1$frYN[surv.asmi.1$fruit>0] <- 1

# Probability of being reproductive given length alive

plot(surv.asmi.1$YrsAlive, 
       surv.asmi.1$frYN, main= "1995 - 2018", xlab="Years alive",ylab="Probability of reproductive")
  g<- glm(frYN~YrsAlive, family=binomial,surv.asmi.1)
  curve(predict(g,data.frame(YrsAlive=x),type="resp"), col="green4",add=TRUE)  
  

```

Does this not only want the max YrsAlive per tag?
```{r, eval=FALSE}}
surv.asmi.2 <- merge(surv.asmi, notdeadyet, by.x=c("tag","year"), by.y=c("Tag","year"))

fit <- survfit(Surv(YrsAlive, surv) ~ site, 
               data = surv.asmi.2[surv.asmi.2$length>0,]) 

ggsurvplot(fit, data=surv.asmi.2[surv.asmi.2$length>0,], risk.table = FALSE, xlab = "Age", ylab="Probability of Reproductive")

```

```{r, eval=FALSE}}
plot(10,10, type="n")
matplot(contr.poly(15)[,1:4], type="b") 
```



# Integral Projection Models    
Janeiro et al. 2017 Towards robust evolutionary...
Rees et al. 2014 Constructing IPMs when more than one census is available (Appendix S4) and others and the main paper, Building integral projeciton models: a user's guide

# Mark-recapture
<http://www.montana.edu/rotella/documents/502/lab07RMark.html>    
Laake and Rexstad 2008
Alexander et al. 2009 Detection, survival rates...
Chen et al. 2009 Factors affecting detection...
MacKenzie et al. 2009 Modeling species occurrence dynamics...
Kellner and Swihart 2014 Accounting for Imperfect detection...
Chandler et al. 2018 Estimating recruitment from capture-recapture data...
Mark-recapture   
```{r, eval=FALSE}

library(RMark)

# Convert dataset into capture histories  
head(asmi.raw)
table(asmi.raw$AsMi_tag_id[asmi.raw$length>0],asmi.raw$year[asmi.raw$length>0])


```

Autoregressive and moveing average modeling method   (Liu and Guo 2019)   
     find the order p and q of the ARMA(p,q) from the autocorrelation and parial correlation coefficient 
     Can find the time domain and frequency domain of data
     Should be able to figure out the current priodic mast seeding and then model if it increases or decreases, the impact on future growth of AsMi    
     tailing means that either ACF or PACF
does not approach to 0 at each lag order, and truncation on
order p and q means ACF and PACF   
Fruit is episodic, mast seeding, would make sense to add a sin and/or cos wave to the fit    
```{r, eval=FALSE}
library(astsa)

head(asmi.raw)
ps.ts <- aggregate(Total.Fruitlogtransformed.x~Year.x, data=ps.cor, sum)
asmi.raw.ts <- aggregate(fruit~year+AsMi_site_id, data=asmi.raw, sum)

co2 <- ts(ps.ts$Total.Fruitlogtransformed.x, frequency = 1, start = c(1995,1))
plot(co2, xlab="Year", ylab = "Fruit")

co25 <- ts(asmi.raw.ts$fruit[asmi.raw.ts$AsMi_site_id==5], frequency=1, start=c(1995,1))
plot(co25, xlab="Year", ylab = "Fruit")

co215 <- ts(asmi.raw.ts$fruit[asmi.raw.ts$AsMi_site_id==15], frequency=1, start=c(1995,1))
plot(co215, xlab="Year", ylab = "Fruit")


co219 <- ts(asmi.raw.ts$fruit[asmi.raw.ts$AsMi_site_id==19], frequency=1, start=c(1995,1))
plot(co219, xlab="Year", ylab = "Fruit")

co226 <- ts(asmi.raw.ts$fruit[asmi.raw.ts$AsMi_site_id==26], frequency=1, start=c(1995,1))
plot(co226, xlab="Year", ylab = "Fruit")

co21 <- ts(asmi.raw.ts$fruit[asmi.raw.ts$AsMi_site_id==1], frequency=1, start=c(2014,1))
co2_2 <- ts(asmi.raw.ts$fruit[asmi.raw.ts$AsMi_site_id==2], frequency=1, start=c(2014,1))


plot(co25, xlab="Year", ylab = "Fruit", ylim=c(0,15050))
lines(co215, col="red")
lines(co219, col="cyan")
lines(co226, col="blue")
lines(co21, col="orange")
lines(co2_2, col="green")

```

Steps for model order selection   
     1. residual vaiogram   
     2. order determination using F test   
     3. order estimation with AIC and BIC   
     4. Parameter estimations with moment estimation and least square and maximum likelihood estimation    
      
      
Low order moment estimation can be solved directly, high order obtained using linear iterative or Newton-Raphson method. 

Autoregressive AR(p)
Moving average MA(q)
ARMA(p,q)      
arima() estimates underlying mean of time series unless d?0
x_t = mu + rho(x_t-1 - mu) + white noise  

Simulate stationary processes  
```{r, eval=FALSE}
## ARMA(2,2) description for arim.sim()
ARMA22 <- list(order=c(2,0,2), ar=c(-0.7,0.2), ma=c(0.7,0.2))
## mean of process
mu <- 5
## simulated process (+ mean) , big sample size
ARMA.sim <- arima.sim(n=10000, model=ARMA22) + mu
## estimate parameters
arima(x=ARMA.sim, order=c(2,0,2))
```

<https://nwfsc-timeseries.github.io/atsa-labs/chap-tslab.html#data-and-packages-1> 
```{r}
# library(devtools)
# devtools::install_github("nwfsc-timeseries/atsalibrary")

```

<https://www.itl.nist.gov/div898/handbook/pmc/section4/pmc44a.htm>    
```{r, eval=FALSE}
# R commands and output:

## Read the data and save as a time series object.
table = read.table("G_SERIES.DAT", skip=25)
vec = ts(table)

## Load the necessary libraries.
library(stats)
library(lawstat)

## Plot the data print summary statistics.
par(mfrow=c(1,1), cex=1.2)
plot(1:length(vec),vec, type="o", pch=18, col="blue",
     xlab = "Observation", ylab="Series G")
print(summary(vec))

## Take natural log of original series and plot the results.
lvec = log(vec)
par(mfrow=c(1,1), cex=1.2)
plot(1:length(vec),lvec, type="o", pch=18, col="red",
	xlab = "Observation", ylab="ln(Series G)")

## Take first differences of transformed series to remove trend 
## and plot the transformed and differenced data.
fd = diff(lvec)
par(mfrow=c(1,1), cex=1.2)
plot(fd, type="o", pch=18,  col="darkblue",
	xlab = "Observation", ylab="Differenced ln(Series G)")

## Compute the autocorrelation of the transformed and differenced series.
ac <- acf(fd, type = c("correlation"), lag.max=36, main="Autocorrelation of Series G")

## Print ACF for first 36 lags.
round(c(ac$acf),4)

##>  [1]  1.0000  0.1998 -0.1201 -0.1508 -0.3221 -0.0840  0.0258 -0.1110 -0.3367
##> [10] -0.1156 -0.1093  0.2059  0.8414  0.2151 -0.1396 -0.1160 -0.2789 -0.0517
##> [19]  0.0125 -0.1144 -0.3372 -0.1074 -0.0752  0.1995  0.7369  0.1973 -0.1239
##> [28] -0.1027 -0.2110 -0.0654  0.0157 -0.1154 -0.2893 -0.1269 -0.0407  0.1474
##> [37]  0.6574

## Plot the ACF with 95 % confidence limits.
par(mfrow=c(1,1), cex=1.2)
plot(ac, ci=.95, ci.type="ma", main="ACF with 95 % Confidence Limits",
     ylim=c(-1,1))

##  Take seasonal differences of the transformed and differenced series.
sfd = diff(fd, lag=12)

## Plot final time series.
par(mfrow=c(1,1), cex=1.2)
plot(sfd, type="o", pch=18,  col="red", xlab = "Observation", 
     ylab="Seasonal and First Differenced ln(Series G)")

## Compute autocorrelation of final series.
sac = acf(sfd, type = c("correlation"), lag.max=36, 
           main="Autocorrelation of Series G")

## Plot the ACF of differenced series with 95 % confidence limits.
par(mfrow=c(1,1), cex=1.2)
plot(sac, ci=.95, ci.type="ma", main="ACF with 95 % Confidence Limits",
     ylim = c(-1,1))

## Fit a MA model to original series.  The arima function will 
## perform the necessary differences.
ma = arima(log(vec), order = c(0, 1, 1), 
            seasonal=list(order=c(0,1,1), period=12))
ma

##> Call:
##> arima(x = log(vec), order = c(0, 1, 1), seasonal = list(order = c(0, 1, 1), 
##>     period = 12))

##> Coefficients:
##>           ma1     sma1
##>       -0.4018  -0.5569
##> s.e.   0.0896   0.0731

##> sigma^2 estimated as 0.001348:  log likelihood = 244.7,  aic = -483.4

## Use the Box-Ljung test to determine if the residuals are 
## random up to 30 lags.
BT = Box.test(ma$residuals, lag=30, type = "Ljung-Box", fitdf=2)
BT

##>         Box-Ljung test
##> 
##> data:  ma$residuals 
##> X-squared = 29.4935, df = 30, p-value = 0.3878

## Although the output indicates that the degrees of freedom for 
## the test are 30, the p-value is based on df-fitdf = 30-2 = 28.
1-pchisq(29.4935,28)

##> [1] 0.3878282

## Determine critical region.
qchisq(0.95,28)

##> [1] 41.33714

## Generate predictions of 12 future values.
p = predict(ma,12)

## Compute 90% confidence intervals for each prediction
## and convert back to original units.
L90 = exp(p$pred - 1.645*p$se)
U90 = exp(p$pred + 1.645*p$se)

## Generate forecasts in original units.  To avoid under-predicting,
## the forecasts are adjusted to account for log transformation.
Forecast = exp(p$pred + ma$sigma2/2)

## Print the forecast results.
Period = c((length(vec)+1):(length(vec)+12))
df = data.frame(Period,L90,Forecast,U90)
print(df,row.names=FALSE)

##>   Period      L90 Forecast      U90
##>      145 424.0234 450.7261 478.4649
##>      146 396.7861 426.0042 456.7577
##>      147 442.5731 479.3298 518.4399
##>      148 451.3902 492.7365 537.1454
##>      149 463.3034 509.3982 559.3245
##>      150 527.3754 583.7383 645.2544
##>      151 601.9371 670.4625 745.7830
##>      152 595.7602 667.5274 746.9323
##>      153 495.7137 558.5657 628.5389
##>      154 439.1900 497.5430 562.8899
##>      155 377.7598 430.1618 489.1730
##>      156 417.3149 477.5643 545.7760

## Plot last 36 observations and the predictions with confidence limits.
par(mfrow=c(1,1), cex=1.2)
plot(c(108:144),table[108:144],xlim=c(108,160),ylim=c(300,800), type="o",
     ylab="Series G", xlab="Observation", col="black",
     main="12 Forecasts and 90% Confidence Intervals")
points(Forecast, pch=16, col="blue")
lines(c(145:156), L90, col="red")
lines(c(145:156), U90, col="red")

```



Going to skip this after 2016 since know that plants aren't below ground the whole season, not as much a question of using this to figure out how much dormancy - dormancy = not AGG in July   
Need to change from set amount of time dormant to find the most likely length of dormancy given that 25-50 percent are actually veg, seedlings, or reproductive when not detected in July

### Years alive    
```{r, eval=FALSE}
dormyrs <- currentyr-1995

path <- paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,
              "_asmi/", collapse = '', sep = '')

#If a plant is still alive in the current year, there is no years alive calculated
yrsalive <- lapply(1:(dormyrs-1), function(x){ 
  path2 <- paste(path, "YrsAlive_dormant", x, ".csv", sep = "")
  ysal <- read.csv(path.expand(path2), na.strings="na")
  ysal <- cbind(ysal, YrsD = x)
  ysal[complete.cases(ysal),]
  })

head(yrsalive[[4]])

```




#SKIP!




#autocorrelations   
https://campus.datacamp.com/courses/introduction-to-time-series-analysis/correlation-analysis-and-the-autocorrelation-function?ex=9#next    
alive.site$length are the number of indiviudals with length>0 and that aren't na per site per year (and per fenced or not plots)
```{r, eval=FALSE}
# Not sure what trying to do? Take away the first row each time?
# length_tmin1 <- split(alive.site$length[-1],alive.site$AsMi_site_id)
length_tmin1 <- split(alive.site$length,alive.site$AsMi_site_id)
length_tmin1.removed <- lapply(length_tmin1, function(x) x[-1])

# length_t <- split(alive.site$length[-nrow(alive.site)],
#                         alive.site$AsMi_site_id)

length_t.removed <- lapply(length_tmin1, function(x) x[-length(x)])
length_tmin1.removed
length_t.removed

autocor <- mapply(cbind,length_t.removed,length_tmin1.removed)
```

```{r, eval=FALSE}
plot(autocor[[1]], xlim=c(0,325), ylim=c(0,350), pch=20)
for(i in 2:6){
  points(autocor[[i]], col=i, pch=20)
}
```

```{r, eval=FALSE}
autocor1 <- do.call(rbind,autocor)
# sample covariance in acf is scaled with 1/(n-1) instead of 1/n
cor(autocor1[,1],autocor1[,2])*(nrow(autocor1)/(nrow(autocor1)+1))

#but to combine all sites time series, need to keep steps separate by site
lapply(split(alive.site$length,alive.site$AsMi_site_id), function(x){
  acf(x, lag.max=15, plot=TRUE)
})

#Blue is the 95% CI around zero, different from zero correlation
```


# 2017 June 2 for NCAR
```{r, eval=FALSE}

uniqclim <- unique(asmi.c[,c("Year","tmin","tmax","ppt")])
clim_agg <- merge(uniqclim, ps.asmi, by = "Year")


library(reshape2)
clim_agg_long <- melt(clim_agg[,c(1:6,8)], measure.vars = c("tmin","tmax","ppt","Total.Alive"))
levels(clim_agg_long$variable) <- c("Minimum temperature","Maximum temperature",
                                    "Precipitation (mm)","Individuals per plot")

ggplot(clim_agg_long[clim_agg_long$variable%in% c("Precipitation (mm)","Individuals per plot") & clim_agg_long$Site>3,], 
       aes(Year, value))+
#  geom_point()+
  stat_smooth(alpha=0.5)+
  facet_wrap(~variable, scales="free", ncol=1)+
  theme_bw()

asmi.c


ggplot(asmi.c, aes(Year, ppt))+
  geom_line()+
  facet_wrap(~Month+Site)
```

```{r, eval=FALSE}
ggplot(clim_agg_long[clim_agg_long$variable%in% c("Minimum temperature","Individuals per plot") & clim_agg_long$Site>3,], 
       aes(Year, value))+
#  geom_point()+
  stat_smooth(alpha=0.5)+
  facet_wrap(~variable, scales="free", ncol=1)+
  theme_bw()
```

```{r, eval=FALSE}
ggplot(clim_agg_long[clim_agg_long$Site>3,], 
       aes(as.factor(Year), value))+
#  geom_point()+
  stat_smooth(alpha=0.5)+
  geom_boxplot()+
  facet_wrap(~variable, scales="free", ncol=1)+
  theme_bw()
```




Figure 3: Was: Average life span of Astragalus microcymbus (with one standard error from the mean) given consecutive assumptions on length of possible whole plant dormancy. (b) Distribution of consecutive years of dormancy when dormancy is not limited.  
```{r, eval=FALSE}
ggplot(smya, aes(YrsD, Yearsalive))+
#  stat_smooth()+
  geom_errorbar(aes(ymin=Yearsalive-se, ymax=Yearsalive+se), 
                width=1) +
  theme_bw()+
  xlab("Maximum years dormant")+
  ylab("Life length")+
  scale_y_continuous(breaks = seq(2, 4, .5), limits = c(2.3, 3.8)) 

```

```{r, eval=FALSE}
sumYrsAlive <- lapply(yrsalive, function(x){
  summarySE(x[complete.cases(x),], measurevar="Yearsalive",groupvars="YrsD")
})

smya <- do.call(rbind, sumYrsAlive)

ggplot(smya, aes(YrsD, Yearsalive))+
  geom_line()

yrsaliveall <- do.call(rbind, yrsalive)

ggplot(yrsaliveall, aes(as.factor(YrsD), Yearsalive))+
  geom_violin()

# , colour= as.factor(AsMi_site_id)   
# Cebolla Creek not long enough to get at life length
ggplot(yrsaliveall[yrsaliveall$AsMi_site_id > 3,], aes(as.factor(YrsD), Yearsalive))+
  # geom_boxplot()+
  geom_violin()+
  theme_bw()

jpeg(paste("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/Asmi_Excel/Yearly Summaries/",
              currentyr,"_asmi/Fig4b.jpg", sep = ""),
         units = "mm", res = 300, height = 100, width = 130)

ggplot(yrsaliveall[yrsaliveall$AsMi_site_id > 3,], aes(YrsD, Yearsalive, colour= as.factor(AsMi_site_id)))+
  # geom_jitter()+
  stat_smooth()+
  theme_bw()+
  scale_color_discrete(name = "Site")+
  xlab("Consecutive years dormant")+
  ylab("Life Length")

dev.off()
```





################################################################################################################
#########################   Run once per year!! ################################################################
# Download climate data  
###Environmental Data from PRISM:   
<http://prism.oregonstate.edu/explorer/>  
<https://github.com/ropensci/prism>

Process takes a while   
Can go back to folder and delete old provisional data to replace with more current   
```{r, eval = FALSE}
# Set wd for prism
prism_set_dl_dir("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/PRISM_asmiclimate")

#Precipitation total, rain and snow
get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)

#Maximum temperature (average)
get_prism_monthlys(type="tmax", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)

#Minimum temperature (average)
get_prism_monthlys(type="tmin", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)

```

Error, didn't download
```{r, eval=FALSE}
get_prism_monthlys(type="ppt", mon = 9, keepZip = FALSE, years = 1996)
get_prism_monthlys(type="ppt", mon = 6, keepZip = FALSE, years = 1999)
get_prism_monthlys(type="ppt", mon = 8, keepZip = FALSE, years = 1999)
```



#########################################################################################################################
### Takes forever, just load and move on after first time
# Want Site, Year, Month, ppt, tmin, tmax
```{r, eval = FALSE}

m.ppt <- lapply(prism_archive_subset("ppt", "monthly", years = 1986:currentyr), function(x){
  x_rast <- pd_to_file(x)
  rastertemps <- raster(x_rast)
  data.frame(data = raster::extract(rastertemps, asmiLL[,c("coords.x1","coords.x2")]),
             date = x, Plot = asmiLL$asmilatlong.Tag__, site = asmiLL$asmilatlong.Tag_Commen)
})
m.tmax <- lapply(prism_archive_subset("tmax","monthly",years = 1986:currentyr), function(x){
  x_rast <- pd_to_file(x)
  rastertemps <- raster(x_rast)
  data.frame(data = raster::extract(rastertemps, asmiLL[,c("coords.x1","coords.x2")]),
             date = x, Plot = asmiLL$asmilatlong.Tag__, site = asmiLL$asmilatlong.Tag_Commen)
})
m.tmin <- lapply(prism_archive_subset("tmin","monthly",years = 1986:currentyr), function(x){
  x_rast <- pd_to_file(x)
  rastertemps <- raster(x_rast)
  data.frame(data = raster::extract(rastertemps, asmiLL[,c("coords.x1","coords.x2")]),
             date = x, Plot = asmiLL$asmilatlong.Tag__, site = asmiLL$asmilatlong.Tag_Commen)
})

mins.avg <- do.call(rbind, m.tmin)
maxs.avg <- do.call(rbind, m.tmax)
ppt.avg <- do.call(rbind, m.ppt)

asmi.climate <- rbind(do.call(rbind, m.tmin), 
                    do.call(rbind, m.tmax),
                    do.call(rbind, m.ppt))

## Get rid of provisional data of the previous year
asmi.climate2 <- asmi.climate %>%
  filter(!(grepl("provisional", date) & grepl(paste(currentyr-1), date)))


asmi.climate.monthly <- asmi.climate2 %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to May survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1,2,3,12) ~ "winter",
                            Month>3 & Month<8 ~ "springSummer",
                            Month>7 & Month<12 ~ "fall"))

asmi.c <- asmi.climate.monthly %>%
  pivot_wider(names_from = Variable, values_from = data)

## Sum monthly ppt across the previous 12 months
asmi.climate.season.ppt <- asmi.climate.monthly %>%
  filter(Variable == "ppt") %>%
  group_by(Variable, site, Plot, season, Prev12) %>%
  dplyr::summarise(Value = sum(data), .groups = "keep") 
  
## Average the min and max temperatures by season and previous 12 months
asmi.climate.season.temp <- asmi.climate.monthly %>%
  filter(Variable != "ppt") %>%
  group_by(Variable, Plot, site, season, Prev12) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep")
  
asmi.season <- bind_rows(list(asmi.climate.season.ppt, asmi.climate.season.temp))
asmi.season.wide <- asmi.season %>%
  pivot_wider(names_from = c(Variable,season), values_from = Value)

## Sum over seasons of the previous 12 months for PPT
asmi.annual.ppt <- asmi.climate.monthly %>%
  filter(Variable == "ppt") %>%
  group_by(Variable, Plot, site,Prev12) %>%
  dplyr::summarise(Value = sum(data), .groups = "keep")
  
## Average over seasons for the previous 12 months
asmi.annual.temp <- asmi.climate.monthly %>%
  filter(Variable != "ppt") %>%
  group_by(Variable, Plot, site, Prev12) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep")

asmi.annual <- do.call(rbind, list(as.data.frame(asmi.annual.ppt),
                                   as.data.frame(asmi.annual.temp)))

```

```{r}

save(asmi.climate, file = paste("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/asmi.climate", currentyr,".Rdata", sep=""))
save(asmi.annual, file = paste("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/asmi.annual", currentyr,".Rdata", sep=""))
save(asmi.season, file = paste("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/asmi.season", currentyr,".Rdata", sep=""))
save(asmi.season.wide, file = paste("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/asmi.season.wide", currentyr,".Rdata", sep=""))

```
#########################################################################################################################
#################################### only once per year #################################################################





<https://blogs.oracle.com/datascience/introduction-to-forecasting-with-arima-in-r> 

<https://www.analyticsvidhya.com/blog/2015/12/complete-tutorial-time-series-modeling/>

How to pick the values of p, q, and d
<https://stats.stackexchange.com/questions/10750/arma-modeling-in-r>

ARIMA <https://machinelearningmastery.com/gentle-introduction-box-jenkins-method-time-series-forecasting/> forecasting time series data    

Powerpoint for ARIMA <http://www.ghahramani.ca/uploads/1/7/0/4/17042208/box-jenkins-r-seminar.pdf> 
<https://ncss-wpengine.netdna-ssl.com/wp-content/themes/ncss/pdf/Procedures/NCSS/The_Box-Jenkins_Method.pdf>

<https://datascienceplus.com/time-series-analysis-using-arima-model-in-r/> 

