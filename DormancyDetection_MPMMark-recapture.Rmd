---
title: "DormancyDetection_MPMMark-Recapture"
author: "Michelle DePrenger-Levin"
date: "2023-11-22"
output: html_document
---

Chapter 3

Raw demographic data 1995:2023   
RMark
```{r}
rm(list=ls())


# devtools::install_github("karthik/wesanderson")
library(wesanderson)

library(dplyr)
library(tidyr)
library(RMark)
library(boot)
library(ggplot2)

## capture histories 2013-2015, secondary capture occasions within in closed periods
load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Observations3years.Rdata")

currentyr <- 2023

userpath <- "C:/Users/DePrengm/"
# currentyr <- 2022

rawdatapath <- paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/", currentyr, "_Astragalus-microcymbus_RawData.csv", collapse = '', sep = '')

asmi.raw <- read.csv(rawdatapath, na.strings = "na")

# need to remove all plot 89, site 1 in 2020 and beyond
asmi.raw <- asmi.raw[!(asmi.raw$AsMi_plot_id == 89 & asmi.raw$year > 2019),]


## Raw data but kept dormancy to 3 or fewer years, then given a new tag number
asmi.raw3 <- read.csv("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter AsMi/Dormant3yrmax_rawdata2022.csv")

## Load climate data up to 2023
load( paste("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/asmi.climate", currentyr,".Rdata", sep=""))
load(paste("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/asmi.annual", currentyr,".Rdata", sep=""))
load(paste("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/asmi.season", currentyr,".Rdata", sep=""))
load(paste("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/asmi.season.wide", currentyr,".Rdata", sep=""))

## Get 2 stage pva to make MPMs
source_url("https://raw.githubusercontent.com/DenverBotanicGardens/PVA/master/StagePVA2stages_dormancyoptional.R")

```

MPM   
```{r}
load("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/stage-fate2023.Rdata")

## StagePVA2stages_dormancyoptional.R but dormancy isn't optional yet :)
MPM.plots <- StagePVA(asmi.all2)

SitePlot <- asmi.all2 %>%
  distinct(plot,site) %>%
  mutate(plot = as.factor(plot))%>%
  mutate(site = as.factor(site))

MPMlam <- data.frame(Lambda = do.call(c,lapply(MPM.plots, function(x) do.call(c, lapply(x, function(y) lambda(y))))))
MPMlamdf <- MPMlam %>%
  mutate(PlotYear = row.names(MPMlam)) %>%
  separate(PlotYear, into = c("Plot","Year"))%>%
  dplyr::mutate(Plot = as.factor(Plot)) %>%
  dplyr::left_join(SitePlot, by = c("Plot" = "plot")) %>%
  filter(!is.na(Lambda)) %>%
  arrange(site,Plot,Year)

### Tuljapukar's log stochastic lambda by year across plots in a site , need to change 
  # V <- Conj(solve(W, tol = 1e-300))  add tolerance to make it work 
# For Pradel comparison, exclude sites 1 and 2, and three plots that are added 1996 and 2004
site1.mpm <- do.call(list,list(MPM.plots$"1", MPM.plots$"22", MPM.plots$"32", MPM.plots$"42", MPM.plots$"52"))
site1year <- lapply(2015:2022, function(yr){
  mpmyr <- lapply(site1.mpm, function(m) {
    m[grepl(as.character(yr), names(m))]
    })
  stoch.growth.rate(lapply(mpmyr, '[[', 1))
})

site2.mpm <- list(MPM.plots$"16", MPM.plots$"58", MPM.plots$"89", MPM.plots$"90", MPM.plots$"96", MPM.plots$"98")  ## 89 removed in 2020
site2year <- lapply(2015:2022, function(yr){
  mpmyr <- lapply(site2.mpm, function(m) {
    m[grepl(as.character(yr), names(m))]
    })
  stoch.growth.rate(lapply(mpmyr, '[[', 1))
})

## So few, might not be able to get anything really
site5.mpm <- list(MPM.plots$"606", MPM.plots$"607", MPM.plots$"608", MPM.plots$"609", MPM.plots$"610")  
site5year <- lapply(1995:2021, function(yr){
  mpmyr <- lapply(site5.mpm, function(m) {
    m[grepl(as.character(yr), names(m))]
    })
  stoch.growth.rate(lapply(mpmyr, '[[', 1))
})

site15.mpm <- list(MPM.plots$"8", MPM.plots$"578", MPM.plots$"581", MPM.plots$"799")  
site15year <- lapply(1995:2022, function(yr){
  mpmyr <- lapply(site15.mpm, function(m) {
    m[grepl(as.character(yr), names(m))]
    })
  stoch.growth.rate(lapply(mpmyr, '[[', 1))
})

site19.mpm <- list(MPM.plots$"512", MPM.plots$"513", MPM.plots$"514", MPM.plots$"515")  
site19year <- lapply(1995:2022, function(yr){
  mpmyr <- lapply(site19.mpm, function(m) {
    m[grepl(as.character(yr), names(m))]
    })
  stoch.growth.rate(lapply(mpmyr, '[[', 1))
})

site26.mpm <- list(MPM.plots$"480", MPM.plots$"611", MPM.plots$"614")  
site26year <- lapply(1995:2022, function(yr){
  mpmyr <- lapply(site26.mpm, function(m) {
    m[grepl(as.character(yr), names(m))]
    })
  stoch.growth.rate(lapply(mpmyr, '[[', 1))
})

sgr.st.yr <- do.call(c, list(site5year, site15year, site19year, site26year))
stoch.log.lam <- do.call(rbind,lapply(sgr.st.yr, function(x){
  data.frame(Approx = x$approx, Sim = x$sim, lcl = x$sim.CI[1], ucl = x$sim.CI[2])
}))

stoch.log.lam$Site = c(rep(5, length(site5year)),rep(15, length(site15year)), 
             rep(19, length(site19year)), rep(26, length(site26year)))
stoch.log.lam$Year = c(1995:2021, rep(1995:2022, 3))

stoch.log.lam %>%
  filter(Year < 2022) %>%
  mutate(Sim = if_else(is.nan(Sim), Approx, Sim),
         lcl = if_else(is.nan(lcl), Approx, lcl),
         ucl = if_else(is.nan(ucl), Approx, ucl)) %>%
ggplot(  aes(Year, Approx, color = as.factor(Site)))+
  geom_point(position = position_dodge(width = 1))+
  geom_errorbar(aes(ymin = lcl, ymax = ucl),position = position_dodge(width = 1))+
  theme_bw()+
  ylab(expression(lambda))


```



Format data of all years
```{r}
asmi.raw <- asmi.raw3

## Just add "." for all the ones that we're measured
# assign group at first encounter, age 0 if 'seedling' or vegetative, older if reproductive. 
CJS_asmi <- asmi.raw %>%
  filter(!(AsMi_tag_id %in% c(1177,1171,2746,3903))) %>%
  filter(!is.na(year)) %>%  
  dplyr::select(c(AsMi_tag_id:status,AsMi_plot_id:fence)) %>%
  group_by(AsMi_tag_id) %>%
  filter(any(length > 0)) %>%
  mutate(first.cap.stage = status[which.min(year[length>0])]) %>%
  ungroup() %>%
  mutate(Obs = case_when(length > 0 ~ 1, 
                         length == 0 ~ 0,
                         is.na(length) ~ 0)) %>%
  arrange(year) %>%
  mutate(Obs = as.character(Obs)) %>%
  pivot_wider(names_from = year, values_from = Obs, values_fill = "0", names_prefix = "Year", 
              id_cols = c(AsMi_tag_id,AsMi_site_id,AsMi_plot_id, fence,first.cap.stage)) %>%
  mutate(Year1995 = case_when((AsMi_plot_id %in% c(300,238,598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1995),
         Year1996 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1996),
         Year1997 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1997),
         Year1998 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1998),
         Year1999 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1999),
         Year2000 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year2000),
         Year2001 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year2001),
         Year2002 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year2002),
         Year2003 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year2003),
         Year2004 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2004),
         Year2005 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2005),
         Year2006 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2006),
         Year2007 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2007),
         Year2008 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2008),
         Year2009 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2009),
         Year2010 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2010),
         Year2011 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2011),
         Year2012 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2012),
         Year2013 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2013)) %>%
  unite(ch, Year1995:Year2022, sep ="") %>%
  mutate(Tag = as.factor(AsMi_tag_id),
         Site = as.factor(AsMi_site_id),
         Plot = as.factor(AsMi_plot_id))

dmPlot <- model.matrix(~ -1 + Plot, CJS_asmi)  
dmSite <- model.matrix(~ -1 + Site, CJS_asmi)
finalplot <- dimnames(dmPlot)[[2]][length(dimnames(dmPlot)[[2]])]

## By Plot
CJS_asmi %>%
  dplyr::select(ch) %>%
  bind_cols(dmPlot) %>%
  mutate(Plot799 = paste(Plot799, ";", sep = "")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/CJS_asmi_mark.inp", sep = " ", 
              col.names = FALSE, row.names = FALSE)

## By Site
CJS_asmi %>%
  dplyr::select(ch) %>%
  bind_cols(dmSite) %>%
  mutate(Site26 = paste(Site26, ";", sep = "")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/CJS_asmi_mark_site.inp", sep = " ", 
              col.names = FALSE, row.names = FALSE)

fields <- CJS_asmi %>%
  dplyr::select(ch) %>%
  bind_cols(dmSite) %>%
  bind_cols(dmPlot) %>%
  colnames()

plotdf <- CJS_asmi %>%
  distinct(Site,Plot)

sitedf <- CJS_asmi %>%
  distinct(Site)

```



Mark-recapture by plot    
```{r}

## Convert for MARK  
asmi.inp <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/CJS_asmi_mark.inp", 
                        group.df = plotdf,
                        covariates = NULL,
                        use.comments = FALSE)

asmiSite.inp <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/CJS_asmi_mark_site.inp", 
                        group.df = sitedf,
                        covariates = NULL,
                        use.comments = FALSE)
```

CJS
```{r}
asmi.proc <- process.data(asmi.inp, model = "CJS", groups = "Plot")
asmi.ddl <- make.design.data(asmi.proc)

run.asmi <- function(){
  Phi.dot = list(formula =  ~ 1)
  Phi.time = list(formula =  ~ time)
  Phi.Plot = list(formula =  ~ Plot)  ## so each plot is offset
  Phi.timePlot = list(formula =  ~ time + Plot)
  
  p.dot = list(formula =  ~ 1)
  p.time = list(formula = ~ time)
  p.Plot = list(formula = ~ Plot)
  p.timePlot = list(formula = ~ time + Plot)

  asmi.model.list <- create.model.list("CJS")
  
  asmi.results <- mark.wrapper(asmi.model.list, data = asmi.proc, ddl = asmi.ddl)
  
  return(asmi.results)
}

asmi.models <- run.asmi()
asmi.models$Phi.timePlot.p.timePlot$results$real

```

Multi-state model   
```{r}
CJS_asmi <- asmi.raw %>%
  filter(!(AsMi_tag_id %in% c(1177,1171,2746,3903))) %>%
  filter(!is.na(year)) %>%  
  dplyr::select(c(AsMi_tag_id:status,AsMi_plot_id:fence)) %>%
  group_by(AsMi_tag_id) %>%
  filter(any(length > 0)) %>%
  mutate(first.cap.stage = status[which.min(year[length>0])]) %>%
  ungroup() %>%
  mutate(Obs = case_when(status %in% c("seedling","vegetative") ~ "V",
                         status == "reproductive" ~ "R",
                         status %in% c("dormant","dead") ~ "0")) %>%
  arrange(year) %>%
  mutate(Obs = as.character(Obs)) %>%
  pivot_wider(names_from = year, values_from = Obs, values_fill = "0", names_prefix = "Year", 
              id_cols = c(AsMi_tag_id,AsMi_site_id,AsMi_plot_id, fence,first.cap.stage)) %>%
  mutate(Year1995 = case_when((AsMi_plot_id %in% c(300,238,598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1995),
         Year1996 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1996),
         Year1997 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1997),
         Year1998 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1998),
         Year1999 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1999),
         Year2000 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year2000),
         Year2001 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year2001),
         Year2002 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year2002),
         Year2003 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year2003),
         Year2004 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2004),
         Year2005 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2005),
         Year2006 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2006),
         Year2007 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2007),
         Year2008 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2008),
         Year2009 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2009),
         Year2010 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2010),
         Year2011 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2011),
         Year2012 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2012),
         Year2013 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2013)) %>%
  unite(ch, Year1995:Year2022, sep ="") %>%
  mutate(Tag = as.factor(AsMi_tag_id),
         Site = as.factor(AsMi_site_id),
         Plot = as.factor(AsMi_plot_id))

plotdf <- CJS_asmi %>%
  distinct(Plot)
dmPlot <- model.matrix(~ -1 + Plot, CJS_asmi)
finalplot <- dimnames(dmPlot)[[2]][length(dimnames(dmPlot)[[2]])]

CJS_asmi %>%
  dplyr::select(ch) %>%
  bind_cols(dmPlot) %>%
  mutate(Plot799 = paste(Plot799, ";", sep = "")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Multi_asmi_mark.inp", sep = " ", 
              col.names = FALSE, row.names = FALSE)

asmiMulti <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Multi_asmi_mark.inp", 
                        group.df = plotdf,
                        covariates = NULL,
                        use.comments = FALSE)

multi.proc.ms <- process.data(asmiMulti, begin.time = 1995, model = "Multistrata", groups = "Plot")
multi.ddl.ms <- make.design.data(multi.proc.ms)
multi.mark <- mark(multi.proc.ms, multi.ddl.ms, begin.time = 1995, model = "Multistrata",
                              model.parameters = list(S = list(formula = ~ 1),
                                                p = list(formula = ~ 1),
                                                Psi = list(formula = ~ 1)))


multi.mark.interaction <- mark(multi.proc.ms, multi.ddl.ms, begin.time = 1995, model = "Multistrata",
                               model.parameters = list(S = list(formula = ~ 1),
                                                       p = list(formula = ~ 1),
                                                       Psi = list(formula = ~ -1 + stratum:tostratum))) 
# Psi = list(formula = ~ -1 + stratum:tostratum:time)  ## fit model with time varying transitions 
### transition that is computed by subtraction can be changed -- to set which stratum is computed by substraction
# mstrata.ddl=make.design.data(mstrata.processed,parameters=
#                                list(Psi=list(subtract.stratum=c("A","B","C"))))
## If need to set some transitions to zero, like PsiAA = PsiBB = PsiCC = 0
# mstrata.ddl=make.design.data(mstrata.processed,parameters=
#                                list(Psi=list(subtract.stratum=c("B","A","A"))))
# mstrata.ddl$Psi=mstrata.ddl$Psi[!(mstrata.ddl$Psi$stratum==
#                                     "A"&mstrata.ddl$Psi$tostratum=="A"),]
# mstrata.ddl$Psi=mstrata.ddl$Psi[!(mstrata.ddl$Psi$stratum==
#                                     "B"&mstrata.ddl$Psi$tostratum=="B"),]
# mstrata.ddl$Psi=mstrata.ddl$Psi[!(mstrata.ddl$Psi$stratum==
#                                     "C"&mstrata.ddl$Psi$tostratum=="C"),]
# mymodel=mark(mstrata.processed,mstrata.ddl)
# summary(mymodel,show.fixed=T)

run.asmi.ms <- function(){
  S.dot = list(formula =  ~ 1)
  S.time = list(formula =  ~ time)
  S.Plot = list(formula =  ~ Plot)  ## so each plot is offset
  S.timePlot = list(formula =  ~ time + Plot)
  
  p.dot = list(formula =  ~ 1)
  
  Psi.dot = list(formula =  ~ 1)
  Psi.time = list(formula = ~ time)
  Psi.Plot = list(formula = ~ Plot)
  Psi.timePlot = list(formula = ~ time + Plot)
  
  asmi.model.list <- create.model.list("Multistrata")
  
  asmi.results <- mark.wrapper(asmi.model.list, data = multi.proc.ms, ddl = asmiddl)
  
  return(asmi.results)
}

asmi.models.ms <- run.asmi.ms()

multi.mark$results$real
toMPM <- multi.mark$results$real %>%
  mutate(Parms = row.names(.)) %>%
  mutate(Parms = sub(" to", "to", Parms)) %>%
  separate(Parms, into = c("parameter","strata","group","year", "age", "occa","time"))%>%
  mutate(year = as.numeric(sub("c","",year)))
  
ggplot(toMPM, aes(year, ))  

```

## Plot
Pradel model for lambda (population growth rate) and recruitment (phi) and detection (p)    
```{r}
Pradel_asmi <- asmi.raw %>%
  filter(!(AsMi_tag_id %in% c(1177,1171,2746,3903))) %>%
  filter(!is.na(year)) %>%  
  filter(AsMi_site_id %in% c(5,15,19,26)) %>% ## exclude Cebolla Creek that was added 2014
  filter(AsMi_plot_id != 598) %>% ## exclude the one plot added in 2004
  filter(!(AsMi_plot_id %in% c(300,238))) %>% ## Since two plots, 300, 238 were added in 1996
  dplyr::select(c(AsMi_tag_id:status,AsMi_plot_id:fence)) %>%
  group_by(AsMi_tag_id) %>%
  filter(any(length > 0)) %>%
  mutate(first.cap.stage = status[which.min(year[length>0])]) %>%
  ungroup() %>%
  mutate(Obs = case_when(length > 0 ~ 1, 
                         length == 0 ~ 0,
                         is.na(length) ~ 0)) %>%
  arrange(year) %>%
  mutate(Obs = as.character(Obs)) %>%
  pivot_wider(names_from = year, values_from = Obs, values_fill = "0", names_prefix = "Year", 
              id_cols = c(AsMi_tag_id,AsMi_site_id,AsMi_plot_id, fence,first.cap.stage)) %>%
  unite(ch, Year1995:Year2022, sep ="") %>%
  mutate(Tag = as.factor(AsMi_tag_id),
         Site = as.factor(AsMi_site_id),
         Plot = as.factor(AsMi_plot_id))

dmPlot <- model.matrix(~ -1 + Plot, Pradel_asmi)
finalplot <- dimnames(dmPlot)[[2]][length(dimnames(dmPlot)[[2]])]
plotPradeldf <- Pradel_asmi %>%
  distinct(Plot)


Pradel_asmi %>%
  dplyr::select(ch) %>%
  bind_cols(dmPlot) %>%
  mutate(Plot799 = paste(Plot799, ";", sep = "")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Pradel_asmi_mark.inp", sep = " ", 
              col.names = FALSE, row.names = FALSE)


asmiPradel.inp <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Pradel_asmi_mark.inp", 
                        group.df = plotPradeldf,
                        covariates = NULL,
                        use.comments = FALSE)

asmiproc <- process.data(asmiPradel.inp, model = "Pradrec", groups = "Plot", begin.time = 1995)
asmiddl <- make.design.data(asmiproc)

asmiproc$group.covariates

run.asmi <- function(){
  Phi.dot = list(formula =  ~ 1)
  Phi.time = list(formula =  ~ time)
  Phi.Plot = list(formula =  ~ Plot)  ## so each plot is offset
  Phi.timePlot = list(formula =  ~ time + Plot)
  
  p.dot = list(formula =  ~ 1)
  # p.time = list(formula = ~ time)
  # p.Plot = list(formula = ~ -1 + Plot)
  # p.timePlot = list(formula = ~ time + Plot)
  
  f.dot = list(formula =  ~ 1)
  f.time = list(formula = ~ time)
  f.Plot = list(formula = ~ Plot)
  f.timePlot = list(formula = ~ time + Plot)
  
  asmi.model.list <- create.model.list("Pradrec")
  
  asmi.results <- mark.wrapper(asmi.model.list, data = asmiproc, ddl = asmiddl)
  
  return(asmi.results)
}

asmi.models <- run.asmi()
save(asmi.models, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Pradel.Rdata")

### LAMBDA
nrow(asmi.models$Phi.timePlot.p.dot.f.timePlot$results$derived$`Lambda Population Change`)
paramsAll <- row.names(asmi.models$Phi.timePlot.p.dot.f.timePlot$design.matrix)
params <- paramsAll[!grepl("f ", paramsAll)]
length(params[-length(params)])

lmdas <- asmi.models$Phi.timePlot.p.dot.f.timePlot$results$derived$`Lambda Population Change` %>%
  bind_cols(Params = params[-length(params)]) %>%
  separate(Params, into = c("parameter","plot","age","time")) %>%
  mutate(time = as.character(time)) %>%
  mutate(time = gsub("t", "",time)) %>%
  mutate(time = as.numeric(time))

allL <- allLambdas %>%
  mutate(lcl = Lambda, ucl = Lambda) %>%
  dplyr::rename(estimate = Lambda) %>%
  mutate(Method = "MPM") %>%
  relocate(lcl, .after = estimate) %>%
  relocate(ucl, .after = lcl) %>%
  mutate(Year = as.numeric(Year)) %>%
  filter(plot %in% c("606","607","608","609","610",
                     "8","578","581","799",
                     "512","513","514","515",
                     "480","611","614")) %>%
  mutate(plot = as.factor(plot))

## From ConfInt_MPM_Astragalus-microcymbus
PradelMPMplot <- lmdas %>%
  dplyr::select(c(estimate, lcl:ucl, plot, time)) %>%
  mutate(plot = gsub("g","", plot)) %>%
  mutate(plot = as.factor(plot)) %>%
  dplyr::rename(Year = time) %>%
  mutate(Method = "Pradel") %>%
  bind_rows(allL) %>%
  # mutate(plot = as.numeric(plot)) %>%
  dplyr::left_join(SitePlot) %>%
  # mutate(plot = as.factor(plot)) %>%
ggplot(  aes(Year, estimate, color = plot, shape = Method)) +
  geom_point(position = position_dodge(width = 1))+
  geom_errorbar(aes(ymin = lcl, ymax = ucl),position = position_dodge(width = 1))+
  theme_bw()+
  ylab(expression(lambda))+
  xlab("Year")+
  # scale_color_grey(guide = 'none')+
  # scale_color_manual(guide = 'none', values = rainbow(16))+
  geom_hline(yintercept = 1)+
  scale_shape_manual(values = c(1,16))+
  facet_wrap(~site)
  
  
ggsave(PradelMPMplot, filename = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter AsMi/Images/lambdasPradelMPM.jpg",
         width=450, height=125,units='mm', dpi=300 )


#############################################################################################################

## Geometric mean growth rate on real scale 
## Variance from random effects, variance components approach
lmdas %>%
  group_by(time) %>%
  summarise(lamhats = exp(mean(log(estimate)))) %>%
  print(n=30)

asmi.models$Phi.timePlot.p.dot.f.timePlot$results$derived$`log(Lambda) Population Change` %>%
  bind_cols(Params = params[-length(params)]) %>%
  separate(Params, into = c("parameter","plot","age","time")) %>%
  mutate(time = as.character(time)) %>%
  mutate(time = gsub("t", "",time)) %>%
  mutate(time = as.numeric(time)) %>%
  group_by(time) %>%
  summarise(lamhats = exp(mean(estimate)))

realasmi <- get.real(asmi.models$Phi.timePlot.p.dot.f.timePlot, "Phi", vcv=TRUE)
rasmi <- realasmi$estimates$estimate  ## One less than time length? or time length?
vcv <- realasmi$vcv.real
varc <- var.components(rasmi, design = matrix(rep(1,length(rasmi)), ncol=1), vcv)
df <- asmi.models$Phi.timePlot.p.dot.f.timePlot$design.data$Phi
shrinkest <- data.frame(time = 1:27, value = varc$betarand$estimate)
df <- merge(df, shrinkest, by="time")
md <- mark(asmiPradel.inp, model="Pradrec", 
           model.parameters = list(Phi = list(formula = ~ time + Plot,
                                              fixed=list(index=df$par.index,value=df$value)),
                                   f = list(formula = ~ time + Plot)),
           adjust=FALSE,delete=TRUE)

## Recruitment
recruit <- asmi.models$Phi.timePlot.p.dot.f.timePlot$results$real %>%
  bind_cols(Params = paramsAll)%>%
  separate(Params, into = c("parameter","plot","age","time")) %>%
  mutate(time = as.character(time)) %>%
  mutate(time = gsub("t", "",time)) %>%
  mutate(time = as.numeric(time))


## Recruitment is the number of added individuals C times the survival of adults is the change between time t+1 and t+2
recruit %>%
  filter(parameter == "f") %>%
  ggplot(    aes(time, estimate, color = plot)) +
  geom_point(position = position_dodge(width = 0.9))+
  geom_errorbar(aes(ymin = lcl, ymax = ucl),position = position_dodge(width = 0.9))+
  theme_bw()+
  ylab(expression(f[0]))+
  scale_color_discrete(guide = "none")

```

## Site
Pradel model for lambda (population growth rate) and recruitment (phi) and detection (p)    
```{r}
Pradel_asmi <- asmi.raw %>%
  filter(!(AsMi_tag_id %in% c(1177,1171,2746,3903))) %>%
  filter(!is.na(year)) %>%  
  filter(AsMi_site_id %in% c(5,15,19,26)) %>% ## exclude Cebolla Creek that was added 2014
  filter(AsMi_plot_id != 598) %>% ## exclude the one plot added in 2004
  filter(!(AsMi_plot_id %in% c(300,238))) %>% ## Since two plots, 300, 238 were added in 1996
  dplyr::select(c(AsMi_tag_id:status,AsMi_plot_id:fence)) %>%
  group_by(AsMi_tag_id) %>%
  filter(any(length > 0)) %>%
  mutate(first.cap.stage = status[which.min(year[length>0])]) %>%
  ungroup() %>%
  mutate(Obs = case_when(length > 0 ~ 1, 
                         length == 0 ~ 0,
                         is.na(length) ~ 0)) %>%
  arrange(year) %>%
  mutate(Obs = as.character(Obs)) %>%
  pivot_wider(names_from = year, values_from = Obs, values_fill = "0", names_prefix = "Year", 
              id_cols = c(AsMi_tag_id,AsMi_site_id,AsMi_plot_id, fence,first.cap.stage)) %>%
  unite(ch, Year1995:Year2022, sep ="") %>%
  mutate(Tag = as.factor(AsMi_tag_id),
         Site = as.factor(AsMi_site_id),
         Plot = as.factor(AsMi_plot_id))

dmSite <- model.matrix(~ -1 + Site, Pradel_asmi)
finalSite <- dimnames(dmSite)[[2]][length(dimnames(dmSite)[[2]])]
sitePradeldf <- Pradel_asmi %>%
  distinct(Site)


Pradel_asmi %>%
  dplyr::select(ch) %>%
  bind_cols(dmSite) %>%
  mutate(Site26 = paste(Site26, ";", sep = "")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Pradel_asmi_mark_site.inp", sep = " ", 
              col.names = FALSE, row.names = FALSE)


asmiPradel.inp <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Pradel_asmi_mark_site.inp", 
                        group.df = sitePradeldf,
                        covariates = NULL,
                        use.comments = FALSE)

asmiproc <- process.data(asmiPradel.inp, model = "Pradrec", groups = "Site", begin.time = 1995)
asmiddl <- make.design.data(asmiproc)

asmiproc$group.covariates

run.asmi <- function(){
  Phi.dot = list(formula =  ~ 1)
  Phi.time = list(formula =  ~ time)
  Phi.Plot = list(formula =  ~ Site)  ## so each plot is offset
  Phi.timePlot = list(formula =  ~ time + Site)
  
  p.dot = list(formula =  ~ 1)
  
  f.dot = list(formula =  ~ 1)
  f.time = list(formula = ~ time)
  f.Plot = list(formula = ~ Site)
  f.timePlot = list(formula = ~ time + Site)
  
  asmi.model.list <- create.model.list("Pradrec")
  
  asmi.results <- mark.wrapper(asmi.model.list, data = asmiproc, ddl = asmiddl)
  
  return(asmi.results)
}

# asmi.models.site <- run.asmi()
# save(asmi.models.site, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/PradelSite.Rdata")

load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/PradelSite.Rdata")


### LAMBDA  ## Note that now Plot == Site
nrow(asmi.models.site$Phi.timePlot.p.dot.f.timePlot$results$derived$`Lambda Population Change`)
paramsAll <- row.names(asmi.models.site$Phi.timePlot.p.dot.f.timePlot$design.matrix)
params <- paramsAll[!grepl("f ", paramsAll)]
length(params[-length(params)])

lmdas <- asmi.models.site$Phi.timePlot.p.dot.f.timePlot$results$derived$`log(Lambda) Population Change` %>%
  bind_cols(Params = params[-length(params)]) %>%
  separate(Params, into = c("parameter","site","age","time")) %>%
  mutate(time = as.character(time)) %>%
  mutate(time = gsub("t", "",time)) %>%
  mutate(time = as.numeric(time))

allL <- stoch.log.lam %>%
  mutate(Sim = if_else(is.nan(Sim), Approx, Sim),
         lcl = if_else(is.nan(lcl), Approx, lcl),
         ucl = if_else(is.nan(ucl), Approx, ucl)) %>%
  dplyr::rename(estimate = Sim) %>%
  mutate(Method = "MPM") %>%
  mutate(Year = as.numeric(Year)) %>%
  dplyr::select(c(estimate:Method)) %>%
  filter(Year < 2022)

PradelMPMsite <- lmdas %>%
  dplyr::select(c(estimate, lcl:ucl, site, time)) %>%
  dplyr::rename(Site = site) %>%
  mutate(Site = gsub("g","", Site)) %>%
  mutate(Site = as.numeric(Site)) %>%
  dplyr::rename(Year = time) %>%
  mutate(Method = "Pradel") %>%
  bind_rows(allL) %>%
ggplot(  aes(Year, estimate, color = as.factor(Site), shape = Method)) +
  geom_point(position = position_dodge(width = .8))+
  geom_errorbar(aes(ymin = lcl, ymax = ucl),position = position_dodge(width = .8), width = 1)+
  theme_bw()+
  ylab(expression("log"~lambda))+
  xlab("Year")+
  scale_color_manual("Site", values = wes_palette("Darjeeling1"))+
  # scale_color_manual("Method", values = c("black","grey50","grey30","grey80"))+
  geom_hline(yintercept = 0, linetype = "dotted", color = "grey60")+
  scale_shape_manual(values = c(4,16))+
  # facet_wrap(~Site, nrow = 4)+
  theme(legend.position="bottom")
  
  
ggsave(PradelMPMsite, filename = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter AsMi/Images/lambdasPradelMPMSite.jpg",
         width=300, height=125,units='mm', dpi=300 )


#############################################################################################################


lambda.ftimePlot <- asmi.models.site$Phi.dot.p.dot.f.timePlot$results$derived$`log(Lambda) Population Change`%>%
  bind_cols(Params = params[-length(params)]) %>%
  separate(Params, into = c("parameter","site","age","time")) %>%
  mutate(time = as.character(time)) %>%
  mutate(time = gsub("t", "",time)) %>%
  mutate(time = as.numeric(time))

lambda.ftimePlot %>%
  dplyr::select(c(estimate, lcl:ucl, site, time)) %>%
  dplyr::rename(Site = site) %>%
  mutate(Site = gsub("g","", Site)) %>%
  mutate(Site = as.numeric(Site)) %>%
  dplyr::rename(Year = time) %>%
  mutate(Method = "Pradel") %>%
  bind_rows(allL) %>%
ggplot(  aes(Year, estimate, color = as.factor(Site), shape = Method)) +
  geom_point(position = position_dodge(width = .3))+
  geom_errorbar(aes(ymin = lcl, ymax = ucl),position = position_dodge(width = .3))+
  theme_bw()+
  ylab(expression("log"~lambda))+
  xlab("Year")+
  scale_color_manual("Site", values = wes_palette("Darjeeling1"))+
  geom_hline(yintercept = 0, linetype = "dotted", color = "grey60")+
  scale_shape_manual(values = c(3,16))+
  # facet_wrap(~Site, nrow = 4)+
  theme(legend.position="bottom")

## Recruitment
recruit <- asmi.models.site$Phi.timePlot.p.dot.f.timePlot$results$real %>%
  bind_cols(Params = paramsAll)%>%
  separate(Params, into = c("parameter","site","age","time")) %>%
  mutate(time = as.character(time)) %>%
  mutate(time = gsub("t", "",time)) %>%
  mutate(time = as.numeric(time))


## Recruitment is the number of added individuals C times the survival of adults is the change between time t+1 and t+2
recruitplot <- recruit %>%
  filter(parameter == "f") %>%
  ggplot(    aes(time, estimate, color = site)) +
  geom_point(position = position_dodge(width = 0.9))+
  geom_errorbar(aes(ymin = lcl, ymax = ucl),position = position_dodge(width = 0.9))+
  theme_bw()+
  ylab(expression(f[0]))+
  xlab("Year")+
  scale_color_manual("Site", values = wes_palette("Darjeeling1"))+
  theme(legend.position="bottom")


ggsave(recruitplot, filename = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter AsMi/Images/recruitmentPradelMPMSite.jpg",
         width=300, height=125,units='mm', dpi=300 )

fandphi <- recruit %>%
  filter(parameter != "p") %>%
  ggplot(    aes(time, estimate, color = site, shape = parameter)) +
  geom_point(position = position_dodge(width = 0.9))+
  geom_errorbar(aes(ymin = lcl, ymax = ucl),position = position_dodge(width = 0.9))+
  theme_bw()+
  ylab("")+
  xlab("Year")+
  scale_color_manual("Site", values = wes_palette("Darjeeling1"))+
  scale_shape_manual("Parameter", labels = c(expression(f[0]), expression(Phi)), values = c(4,16))+
  theme(legend.position="bottom")+
  geom_hline(yintercept = recruit$estimate[recruit$parameter == "p"], color = "grey60", linetype = "dotted")+
  geom_hline(yintercept = recruit$lcl[recruit$parameter == "p"], color = "grey60", linetype = "longdash")+
  geom_hline(yintercept = recruit$ucl[recruit$parameter == "p"], color = "grey60", linetype = "longdash")

ggsave(fandphi, filename = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter AsMi/Images/recruitmentPhiPradelSite.jpg",
         width=300, height=125,units='mm', dpi=300 )
  
```

Pradel model "Pradlambda" with Phi, p, and Lambda   
When Lambda is part of the likelihood, then need to use a CLogit to make sure survival is less than or equal to Lambda
```{r, eval = FALSE}

asmiprocL <- process.data(asmiPradel.inp, model = "Pradlambda", groups = "Plot")
asmiddlL <- make.design.data(asmiprocL)


run.asmi <- function(){
  Phi.dot = list(formula =  ~ 1)
  Phi.time = list(formula =  ~ time)
  Phi.Plot = list(formula =  ~ Plot)  ## so each plot is offset
  Phi.timePlot = list(formula =  ~ time + Plot)
  
  p.dot = list(Lambdaormula =  ~ 1)
  
  Lambda.dot = list(formula =  ~ 1)
  Lambda.time = list(formula = ~ time)
  Lambda.Plot = list(formula = ~ Plot)
  Lambda.timePlot = list(formula = ~ time + Plot)
  
  asmi.model.list <- create.model.list("Pradlambda")
  
  asmi.results <- mark.wrapper(asmi.model.list, data = asmiprocL, ddl = asmiddlL)
  
  return(asmi.results)
}

asmi.models.lambda <- run.asmi()

asmi.models.lambda
resultsplot <- asmi.models.lambda$Phi.timePlot.Lambda.timePlot$results$real
paramsAll <- row.names(asmi.models.lambda$Phi.timePlot.Lambda.timePlot$design.matrix)

SurvLambda <- asmi.models.lambda$Phi.timePlot.Lambda.timePlot$results$real %>%
  bind_cols(Params = paramsAll) %>%
  separate(Params, into = c("parameter","plot","age","time")) %>%
  mutate(time = as.character(time)) %>%
  mutate(time = gsub("t", "",time)) %>%
  mutate(time = as.numeric(time))

## Lambda is less than survival in several years
ggplot(SurvLambda, aes(time, estimate, color = parameter, group = plot))+
  geom_point(position = position_dodge(width = 0.9))+
  geom_errorbar(aes(ymin = lcl, ymax = ucl),position = position_dodge(width = 0.9))+
  theme_bw()

SurvLambda %>%
  group_by(plot,time) %>%
  dplyr::summarise(PhiLamDiff = estimate[parameter == "Lambda"]-estimate[parameter == "Phi"]) %>%
ggplot(  aes(time, PhiLamDiff, color = plot))+
  geom_point(position = position_dodge(width = 0.9))+
  # geom_errorbar(aes(ymin = lcl, ymax = ucl),position = position_dodge(width = 0.9))+
  theme_bw()+
  geom_hline(yintercept = 0)+
  scale_color_discrete(guide = "none")
  


```

