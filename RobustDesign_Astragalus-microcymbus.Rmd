---
title: "Robust Design AsMi"
author: "Michelle DePrenger-Levin"
date: "2023-11-30"
output: ''
---

Libraries and data
```{r}
rm(list=ls())
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMark)

load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3years.Rdata")

load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/plotdf.Rdata")
load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/sitedf.Rdata")

```



## Robust example - not multi-state   
inp created in CJS_SeedlingSurvival.Rmd, poor name, changed focus
```{r}


asmiRDPlot.inp <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsPlot.inp",
                          group.df = plotdf,
                          covariates = NULL,
                          use.comments = FALSE)

asmiRDSite.inp <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsSite.inp",
                          group.df = sitedf,
                          covariates = NULL,
                          use.comments = FALSE)


```


Format data of all years
```{r}
asmi.raw <- asmi.raw3

## Just add "." for all the ones that we're measured
# assign group at first encounter, age 0 if 'seedling' or vegetative, older if reproductive. 
CJS_asmi <- asmi.raw %>%
  filter(!(AsMi_tag_id %in% c(1177,1171,2746,3903))) %>%
  filter(!is.na(year)) %>%  
  dplyr::select(c(AsMi_tag_id:status,AsMi_plot_id:fence)) %>%
  group_by(AsMi_tag_id) %>%
  filter(any(length > 0)) %>%
  mutate(first.cap.stage = status[which.min(year[length>0])]) %>%
  ungroup() %>%
  mutate(Obs = case_when(length > 0 ~ 1, 
                         length == 0 ~ 0,
                         is.na(length) ~ 0)) %>%
  arrange(year) %>%
  mutate(Obs = as.character(Obs)) %>%
  pivot_wider(names_from = year, values_from = Obs, values_fill = "0", names_prefix = "Year", 
              id_cols = c(AsMi_tag_id,AsMi_site_id,AsMi_plot_id, fence,first.cap.stage)) %>%
  mutate(Year1995 = case_when((AsMi_plot_id %in% c(300,238,598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1995),
         Year1996 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1996),
         Year1997 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1997),
         Year1998 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1998),
         Year1999 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year1999),
         Year2000 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year2000),
         Year2001 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year2001),
         Year2002 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year2002),
         Year2003 = case_when((AsMi_plot_id %in% c(598) | AsMi_site_id %in% c(1,2)) ~ ".",
                              TRUE ~ Year2003),
         Year2004 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2004),
         Year2005 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2005),
         Year2006 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2006),
         Year2007 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2007),
         Year2008 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2008),
         Year2009 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2009),
         Year2010 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2010),
         Year2011 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2011),
         Year2012 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2012),
         Year2013 = case_when(AsMi_site_id %in% c(1,2) ~ ".",
                              TRUE ~ Year2013)) %>%
  unite(ch, Year1995:Year2022, sep ="") %>%
  mutate(Tag = as.factor(AsMi_tag_id),
         Site = as.factor(AsMi_site_id),
         Plot = as.factor(AsMi_plot_id))

dmPlot <- model.matrix(~ -1 + Plot, CJS_asmi)  
dmSite <- model.matrix(~ -1 + Site, CJS_asmi)
finalplot <- dimnames(dmPlot)[[2]][length(dimnames(dmPlot)[[2]])]

## By Plot
CJS_asmi %>%
  dplyr::select(ch) %>%
  bind_cols(dmPlot) %>%
  mutate(Plot799 = paste(Plot799, ";", sep = "")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/CJS_asmi_mark.inp", sep = " ", 
              col.names = FALSE, row.names = FALSE)

## By Site
CJS_asmi %>%
  dplyr::select(ch) %>%
  bind_cols(dmSite) %>%
  mutate(Site26 = paste(Site26, ";", sep = "")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/CJS_asmi_mark_site.inp", sep = " ", 
              col.names = FALSE, row.names = FALSE)

fields <- CJS_asmi %>%
  dplyr::select(ch) %>%
  bind_cols(dmSite) %>%
  bind_cols(dmPlot) %>%
  colnames()

plotdf <- CJS_asmi %>%
  distinct(Site,Plot)

sitedf <- CJS_asmi %>%
  distinct(Site)

```

# instead of dot notation (robust models and pradel won't accept "." for missing surveys even though Cooch and Laake say they do!!), fix the probabilities of detection to zero for those periods in the ddls. fix p=0 for that occasion
```{r}

## dataCJS
load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/dataCJS3yrs.Rdata")

## Repeated for the three years
obsmodel <- dataCJS %>%
  ungroup()%>%
  distinct(Day,Year,Plot,Site,Tag,encounter, .keep_all = TRUE) %>%
  dplyr::select(c(Site:Tag, encounter, Obs, Year)) %>%
  ## Fill in all tags within a Plot and Site across all years
  mutate(Obs = as.character(Obs)) %>%
  tidyr::complete(nesting(Site,Plot,Tag),Year, encounter, fill = list(Obs = "0")) %>%
  arrange(encounter) %>%
  pivot_wider(names_from = encounter, values_from = Obs, values_fill = "0", names_prefix = "Occ")

plotssurveyed <- table(dataCJS$Plot, dataCJS$encounter, dataCJS$Year)  

## In the design data lists after processing data, set these to zero detection (p)


asmiRD <- obsmodel %>%
  dplyr::mutate(across(Occ1:Occ10, ~ ifelse(.x > 0, 1, .x))) %>%
  tidyr::unite(ch, Occ1:Occ10, sep="") %>%
  dplyr::group_by(Site,Plot,Tag) %>%
  dplyr::mutate(Plot = as.factor(Plot)) %>%
  dplyr::mutate(Site = as.factor(Site)) %>%
  dplyr::summarise(ch = paste0(ch, collapse = "")) %>%
  ungroup()

dmPlot <- model.matrix(~ -1 + Plot, asmiRD)
dmSite <- model.matrix(~ -1 + Site, asmiRD)
dimnames(dmPlot)[[2]][length(dimnames(dmPlot)[[2]])]
dimnames(dmSite)[[2]][length(dimnames(dmSite)[[2]])]

## By Plot
asmiRD %>%
  ungroup() %>%
  dplyr::select(c(ch)) %>%
  bind_cols(dmPlot) %>%
  mutate(Plot614 = paste(Plot614, ";", sep ="")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsPlot.inp", 
              sep = " ", col.names = FALSE, row.names = FALSE)

## By Site
asmiRD %>%
  ungroup() %>%
  dplyr::select(c(ch)) %>%
  bind_cols(dmSite) %>%
  mutate(Site26 = paste(Site26, ";", sep ="")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsSite.inp", 
              sep = " ", col.names = FALSE, row.names = FALSE)


plotdf <- asmiRD %>%
  ungroup()%>%
  dplyr::distinct(Plot)

sitedf <- asmiRD %>%
  ungroup() %>%
  dplyr::distinct(Site)

save(plotdf, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/plotdf.Rdata")
save(sitedf, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/sitedf.Rdata")

```



Mark-recapture by plot  
Mark-recpature by site
```{r}

## Convert for MARK  
asmiRDPlot.inp <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsPlot.inp", 
                        group.df = plotdf,
                        covariates = NULL,
                        use.comments = FALSE)

asmiRDSite.inp <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsSite.inp", 
                        group.df = sitedf,
                        covariates = NULL,
                        use.comments = FALSE)
```


In the dll PIMs set p to zero for all times not surveyed
```{r}


time.intervals <- c(0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0)

RDproc <- process.data(asmiRDPlot.inp, model = "Robust", begin.time = 2013, groups = "Plot",
                       time.intervals = time.intervals)
RDddl <- make.design.data(RDproc)

## Now add zero for detection p, at all times when not visited; session = Year, time = secondary occasion 1:10, Plot = Plot
plotssurveyed
pindex <- RDddl$p
## Missed entire survey period
p2013.indices <- pindex$par.index[pindex$session == 2013 & pindex$time %in% c(1,2,4,5,7,9)]
## Missed these plots [Plot, Survey, Year]
p2013.ind3 <- pindex %>%
  filter(session == 2013 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,1])[which(plotssurveyed[,3,1] == 0)])) %>%
  select(par.index)
p2013.ind6 <- pindex %>%
  filter(session == 2013 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,1])[which(plotssurveyed[,6,1] == 0)])) %>%
  select(par.index)
p2013.ind8 <- pindex %>%
  filter(session == 2013 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,1])[which(plotssurveyed[,8,1] == 0)])) %>%
  select(par.index)
p2013.ind10 <- pindex %>%
  filter(session == 2013 & time == 10 & Plot %in% as.numeric(names(plotssurveyed[,10,1])[which(plotssurveyed[,10,1] == 0)])) %>%
  select(par.index)
p2013.inds <- c(p2013.indices, p2013.ind3$par.index, p2013.ind6$par.index, p2013.ind8$par.index, p2013.ind10$par.index)

## Missed in 2014
p2014.indices <- pindex %>%
  filter(session == 2014 & time == 4)
p2014.ind1 <- pindex %>%
  filter(session == 2014 & time == 1 & Plot %in% as.numeric(names(plotssurveyed[,1,2])[which(plotssurveyed[,1,2] == 0)])) %>%
  select(par.index)
p2014.ind2 <- pindex %>%
  filter(session == 2014 & time == 2 & Plot %in% as.numeric(names(plotssurveyed[,2,2])[which(plotssurveyed[,2,2] == 0)])) %>%
  select(par.index)
p2014.ind3 <- pindex %>%
  filter(session == 2014 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,2])[which(plotssurveyed[,3,2] == 0)])) %>%
  select(par.index)
p2014.ind5 <- pindex %>%
  filter(session == 2014 & time == 5 & Plot %in% as.numeric(names(plotssurveyed[,5,2])[which(plotssurveyed[,5,2] == 0)])) %>%
  select(par.index)
p2014.ind6 <- pindex %>%
  filter(session == 2014 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,2])[which(plotssurveyed[,6,2] == 0)])) %>%
  select(par.index)
p2014.ind7 <- pindex %>%
  filter(session == 2014 & time == 7 & Plot %in% as.numeric(names(plotssurveyed[,7,2])[which(plotssurveyed[,7,2] == 0)])) %>%
  select(par.index)
p2014.ind8 <- pindex %>%
  filter(session == 2014 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,2])[which(plotssurveyed[,8,2] == 0)])) %>%
  select(par.index)
p2014.ind9 <- pindex %>%
  filter(session == 2014 & time == 9 & Plot %in% as.numeric(names(plotssurveyed[,9,2])[which(plotssurveyed[,9,2] == 0)])) %>%
  select(par.index)
p2014.ind10 <- pindex %>%
  filter(session == 2014 & time == 10 & Plot %in% as.numeric(names(plotssurveyed[,10,2])[which(plotssurveyed[,10,2] == 0)])) %>%
  select(par.index)
p2014.inds <- c(p2014.indices$par.index, p2014.ind1$par.index, p2014.ind2$par.index, p2014.ind3$par.index, p2014.ind5$par.index,
                p2014.ind6$par.index, p2014.ind7$par.index, p2014.ind8$par.index, p2014.ind9$par.index, p2014.ind10$par.index)


## Missed in 2015
p2015.indices <- pindex %>%
  filter(session == 2015 & time == 10)
p2015.ind1 <- pindex %>%
  filter(session == 2015 & time == 1 & Plot %in% as.numeric(names(plotssurveyed[,1,3])[which(plotssurveyed[,1,3] == 0)])) %>%
  select(par.index)
p2015.ind2 <- pindex %>%
  filter(session == 2015 & time == 2 & Plot %in% as.numeric(names(plotssurveyed[,2,3])[which(plotssurveyed[,2,3] == 0)])) %>%
  select(par.index)
p2015.ind3 <- pindex %>%
  filter(session == 2015 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,3])[which(plotssurveyed[,3,3] == 0)])) %>%
  select(par.index)
p2015.ind4 <- pindex %>%
  filter(session == 2015 & time == 4 & Plot %in% as.numeric(names(plotssurveyed[,4,3])[which(plotssurveyed[,4,3] == 0)])) %>%
  select(par.index)
p2015.ind5 <- pindex %>%
  filter(session == 2015 & time == 5 & Plot %in% as.numeric(names(plotssurveyed[,5,3])[which(plotssurveyed[,5,3] == 0)])) %>%
  select(par.index)
p2015.ind6 <- pindex %>%
  filter(session == 2015 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,3])[which(plotssurveyed[,6,3] == 0)])) %>%
  select(par.index)
p2015.ind7 <- pindex %>%
  filter(session == 2015 & time == 7 & Plot %in% as.numeric(names(plotssurveyed[,7,3])[which(plotssurveyed[,7,3] == 0)])) %>%
  select(par.index)
p2015.ind8 <- pindex %>%
  filter(session == 2015 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,3])[which(plotssurveyed[,8,3] == 0)])) %>%
  select(par.index)
p2015.ind9 <- pindex %>%
  filter(session == 2015 & time == 9 & Plot %in% as.numeric(names(plotssurveyed[,9,3])[which(plotssurveyed[,9,3] == 0)])) %>%
  select(par.index)

p2015.inds <- c(p2015.indices$par.index, p2015.ind1$par.index, p2015.ind2$par.index, p2015.ind3$par.index, p2015.ind4$par.index,
                p2015.ind5$par.index, p2015.ind6$par.index, p2015.ind7$par.index, p2015.ind8$par.index, p2015.ind9$par.index)


## Final for all missed ones that need to be zero
p.indices <- c(p2013.inds,p2014.inds, p2015.inds)
p.values <- rep(0, length(p.indices))


RDddl$p$fix <- ifelse(RDddl$p$par.index %in% p.indices, 0, NA)
## This will take another set like above
RDddl$c$fix <- ifelse(RDddl$c$par.index)
```



model = "RDHuggins" for Huggins Random emigration, p=c varies by time and session; S by time
```{r}




run.robust <- function(){
  ## 3 primary sessions with secondary sessions all of length 10 ("." for missing surveys)
  time.intervals <- c(0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0)
  
  ## Random emigration - sure, well,... p=c varies by time and session
  S.time=list(formula=~time)
  p.time.session=list(formula=~-1+session:time, # share=TRUE,  ## TRUE means c and p share same columns of design matrix, can't have fixed and share == TRUE
                      fixed = list(index = p.indices,
                      value = p.values))
  GammaDoublePrime.random=list(formula=~time,share=TRUE)   ## return rate - not available for detection
  model.1=mark(data = RDproc, ddl = RDddl, model = "Robust", 
               time.intervals=time.intervals,
               model.parameters=list(S=S.time,
                                     GammaDoublePrime=GammaDoublePrime.random,
                                     p=p.time.session))
  
  ## I assume RDHet is for p != c
  # pi.dot=list(formula=~1)
  # p.session.mixture=list(formula=~session+mixture, # share=TRUE, 
  #                     fixed = list(index = p.indices,
  #                     value = p.values))
  # model.2.b=mark(data = RDproc, ddl = RDddl, model = "RDHet", 
  #             time.intervals=time.intervals,
  #             model.parameters=list(S=S.time,
  #                                   GammaDoublePrime=GammaDoublePrime.random,
  #                                   p=p.session.mixture,
  #             pi=pi.dot))
  
  
  
  return(collect.models())
}

RDresults <- run.robust()
RDresults

model.1$results$real

```

<https://cran.r-project.org/web/packages/RMark/RMark.pdf> 
```{r, eval=FALSE}
# robust with strata  
process.data(data, model = "CRDMS", time.interval = t.int, strata.labels = c("V","R")
## Shange Psi parameters that are obtained by subtraction
    # something like:
asmi.ddl <- make.design.data(asmi.proc, parameters = list(Psi = list(subtract.stratum = c("V","V"))))
  # create grouping index for unobserved p and c (always zero)
asmi.ddl$p$fix = ifelse(asmi.ddl$p$stratum == "U",0,NA)  ## if one state is unobservable
asmi.ddl$c$fix = ifelse(asmi.ddl$p$stratum == "U",0,NA)  ## if one state is unobservable


```
