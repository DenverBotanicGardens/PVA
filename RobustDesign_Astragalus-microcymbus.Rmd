---
title: "Robust Design AsMi"
author: "Michelle DePrenger-Levin"
date: "2023-11-30"
output: ''
---

compare multi-state mark-recapture to MPM estimates of survival, transitions


Libraries and data
```{r}
rm(list=ls())
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMark)
library(popbio)
library(RCurl)
library(devtools)
library(HDInterval)
library(Rage)

load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3years.Rdata")

load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/plotdf.Rdata")
load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/sitedf.Rdata")
load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/dataCJS3yrs4socc.Rdata")

```


## Compare to 3 stage for just the years 2013-2015 and grouping by site  
```{r}
## Get 2 stage pva to make MPMs
source_url("https://raw.githubusercontent.com/DenverBotanicGardens/PVA/master/StagePVA2stages_dormancyoptional.R")

load("C:/Users/DePrengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/stage-fate2023.Rdata")

asmi.allSite <- asmi.all2 %>%
  filter(site %in% c(5,15,19,26)) %>%
  filter(year > 2012 & year < 2016) %>%
  mutate(plot = site)

table(asmi.allSite$plot, asmi.allSite$site)

## StagePVA2stages_dormancyoptional.R but dormancy isn't optional yet :)
MPM.plots <- StagePVA(asmi.allSite,TF = FALSE)
MPM.plotsSplit <- StagePVA(asmi.allSite,TF = TRUE)

### variance over the four sites
asmi.3yrs <- asmi.all2 %>%
  filter(site %in% c(5,15,19,26)) %>%
  filter(year > 2012 & year < 2016) %>%
  StagePVA(TF = TRUE)

as.vector(asmi.3yrs[[1]][[1]])

asmi.3yrsmu <- as.vector(mean(do.call(c,lapply(asmi.3yrs, function(x) lapply(x, function(y) y$T)))))
as.vector(mean(do.call(c,lapply(asmi.3yrs, function(x) lapply(x, function(y) y$F)))))


asmi.3yrsFmu <- apply(do.call(cbind,do.call(c,lapply(asmi.3yrs, function(x) lapply(x, function(y) as.vector(y$F))))), 1, mean)
asmi.3yrsFsd <- apply(do.call(cbind,do.call(c,lapply(asmi.3yrs, function(x) lapply(x, function(y) as.vector(y$F))))), 1, sd)

# as.vector(mean(do.call(c, asmi.3yrs)))
## each column stacked on top of each other, then column bind, so 
# 1 [1,1] = veg to veg
# 2 [2,1] = veg to rep
# 3 [3,1] = veg to dorm
# 4 [1,2] = rep to veg + f
# 5 [2,2] = rep to rep
# 6 [3,2] = rep to dorm
# 7 [1,3] = dorm to veg
# 8 [2,2] = dorm to rep
# 9 [3,3] = dorm to dorm
asmi.3yrshdi <- apply( do.call(cbind, do.call(c,lapply(asmi.3yrs,
                                             function(x) lapply(x, function(y) as.vector(y$T))))), 1, hdi)
### variance of binomial distribution, variance of Poisson is equal to the mean
asmi.3yrsvar <- do.call(c,lapply(asmi.3yrsmu, function(x) x*(1-x) ))
asmi.3yrssd <- apply( do.call(cbind, lapply(asmi.3yrs, function(x) as.vector(x[[1]]$T))), 1, sd) ## nope, need 

plotMPM <- data.frame(estimate = c(asmi.3yrsmu, asmi.3yrsFmu[4]), sd = c(asmi.3yrssd,asmi.3yrsFsd[4]), 
                      var = c(asmi.3yrsvar, asmi.3yrsFmu[4]),
                      Parameter = c("Stasis","Growth","Dormancy",
                                    "Retro", "Stasis", "Dormancy",
                                    "Growth", "Growth", "Stasis", "f"),
                      Stage = c("Veg","Veg","Veg",
                                "Rep", "Rep", "Rep",
                                "Dorm" , "Dorm", "Dorm", "Rep"))
ggplot(plotMPM, aes(estimate, Parameter, color = Stage))+
  geom_point(position = position_dodge(width = 0.4))+
  geom_errorbar(aes(xmin = estimate - var, xmax = estimate + var),position = position_dodge(width = 0.4))+
  theme_bw()

```



instead of dot notation (robust models and pradel won't accept "." for missing surveys even though Cooch and Laake say they do!!), fix the probabilities of detection to zero for those periods in the ddls. fix p=0 for that occasion
```{r}

## dataCJS
load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/dataCJS3yrs.Rdata")

## Can only be one strata within a primary session - need to assign V if never reproductive, R if eventually reproductive  
##### Could condense to spring and fall, then have V early and some R late
## Repeated for the three years
obsmodel <- dataCJS %>%
  filter(Site %in% c(5,15,19,26)) %>%
  group_by(Year, Plot, Site, Tag) %>%
  ## Make the multistate options
  dplyr::mutate(MSObs = case_when(Ln == 0 ~ "0",
                                  (Ln > 0 & Fl == 0) ~ "V",
                                  any((Ln > 0 & Fl == 1)) ~ "R")) %>%
  # dplyr::mutate(MSObs = case_when(any(MSObs == "R") ~ replace(MSObs, MSObs == "V", "R"),
  #                                 TRUE ~ MSObs)) %>%
  ungroup()%>%
  distinct(Day,Year,Plot,Site,Tag,encounter, .keep_all = TRUE) %>%
  # dplyr::select(c(Site:Tag, encounter, Obs, Year)) %>%
  dplyr::select(c(Site:Tag, encounter, MSObs, Year)) %>%
  ## Fill in all tags within a Plot and Site across all years
  tidyr::complete(nesting(Site,Plot,Tag),Year, encounter, fill = list(MSObs = "0")) %>%
  arrange(encounter) %>%
  pivot_wider(names_from = encounter, values_from = MSObs, values_fill = "0", names_prefix = "Occ") 

obsmodel %>%
  filter(if_any(.cols = everything(), ~ grepl("V", .))) %>%
  print(n=100)

dataCJS <- dataCJS %>% filter(Site %in% c(5,15,19,26))
plotssurveyed <- table(dataCJS$Plot, dataCJS$encounter, dataCJS$Year)  

## In the design data lists after processing data, set these to zero detection (p)


asmiRD <- obsmodel %>%
  ## unite within each year
  tidyr::unite(ch, Occ1:Occ10, sep="") %>%
  ## Change all to R if any within a year
  dplyr::mutate(ch = if_else(grepl("R",ch), gsub("V","R",ch), ch)) %>%
  dplyr::group_by(Site,Plot,Tag) %>%
  dplyr::mutate(Plot = as.factor(Plot)) %>%
  dplyr::mutate(Site = as.factor(Site)) %>%
  ## paste across years
  dplyr::summarise(ch = paste0(ch, collapse = "")) %>%
  ungroup() %>%
  filter((grepl("V", ch) | grepl("R",ch)))

asmiRD %>%
  filter(grepl("R",ch))

dmPlot <- model.matrix(~ -1 + Plot, asmiRD)
dmSite <- model.matrix(~ -1 + Site, asmiRD)
dimnames(dmPlot)[[2]][length(dimnames(dmPlot)[[2]])]
dimnames(dmSite)[[2]][length(dimnames(dmSite)[[2]])]

## By Plot
asmiRD %>%
  ungroup() %>%
  dplyr::select(c(ch)) %>%
  bind_cols(dmPlot) %>%
  mutate(Plot614 = paste(Plot614, ";", sep ="")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsPlot.inp", 
              sep = " ", col.names = FALSE, row.names = FALSE)

## By Site
asmiRD %>%
  ungroup() %>%
  dplyr::select(c(ch)) %>%
  bind_cols(dmSite) %>%
  mutate(Site26 = paste(Site26, ";", sep ="")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsSite.inp", 
              sep = " ", col.names = FALSE, row.names = FALSE)


plotdf <- asmiRD %>%
  ungroup()%>%
  dplyr::distinct(Plot)

sitedf <- asmiRD %>%
  ungroup() %>%
  dplyr::distinct(Site)

# save(plotdf, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/plotdf.Rdata")
# save(sitedf, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/sitedf.Rdata")

```



Mark-recapture by plot  
Mark-recpature by site
```{r}

## Convert for MARK  
asmiRDPlot.inp <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsPlot.inp", 
                        group.df = plotdf,
                        covariates = NULL,
                        use.comments = FALSE)

asmiRDSite.inp <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsSite.inp", 
                        group.df = sitedf,
                        covariates = NULL,
                        use.comments = FALSE)
```


In the dll PIMs set p to zero for all times not surveyed   
Need a 'dead' state that is never observed, fix detection to the dead state as zero  
Set the transition from dead to alive to zero
Set dead to dead to 1    

```{r}

plotssurveyed <- table(dataCJS$Plot, dataCJS$encounter, dataCJS$Year) 
time.intervals <- c(0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0)

RDproc <- process.data(asmiRDPlot.inp, model = "ORDMSState", begin.time = 2013, groups = "Plot",
                       time.intervals = time.intervals)
RDddl <- make.design.data(RDproc) #, parameters = list(Psi = list(subtract.stratum = c("R","R"))))

# RDddl$Psi$stratum <- factor(RDddl$Psi$stratum, levels = c("V","R"))
# RDddl$S$stratum <- factor(RDddl$S$stratum, levels = c("V","R"))
# RDddl$Omega$stratum <- factor(RDddl$Omega$stratum, levels = c("V","R"))
# RDddl$pent$stratum <- factor(RDddl$pent$stratum, levels = c("V","R"))
# RDddl$p$stratum <- factor(RDddl$p$stratum, levels = c("V","R"))

## Try to relevel to R first?
RDddl$Psi$stratum <- factor(RDddl$Psi$stratum, levels = c("R","V"))
RDddl$S$stratum <- factor(RDddl$S$stratum, levels = c("R","V"))
RDddl$Omega$stratum <- factor(RDddl$Omega$stratum, levels = c("R","V"))
RDddl$pent$stratum <- factor(RDddl$pent$stratum, levels = c("R","V"))
RDddl$p$stratum <- factor(RDddl$p$stratum, levels = c("R","V"))

table(RDddl$Psi[,c("stratum","tostratum")]) ## R to V computed by subtraction

## Now add zero for detection p, at all times when not visited; session = Year, time = secondary occasion 1:10, Plot = Plot
pindex <- RDddl$p
## Missed entire survey period
p2013.indices <- pindex %>%
  filter(session == 2013 & time %in% c(1,2,4,5,7,9))
## Missed these plots [Plot, Survey, Year]
p2013.ind3 <- pindex %>%
  filter(session == 2013 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,1])[which(plotssurveyed[,3,1] == 0)]))
p2013.ind6 <- pindex %>%
  filter(session == 2013 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,1])[which(plotssurveyed[,6,1] == 0)])) 
p2013.ind8 <- pindex %>%
  filter(session == 2013 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,1])[which(plotssurveyed[,8,1] == 0)])) 
p2013.ind10 <- pindex %>%
  filter(session == 2013 & time == 10 & Plot %in% as.numeric(names(plotssurveyed[,10,1])[which(plotssurveyed[,10,1] == 0)])) 
p2013.inds <- c(p2013.indices$par.index, p2013.ind3$par.index, p2013.ind6$par.index, p2013.ind8$par.index, p2013.ind10$par.index)

## Missed in 2014
p2014.indices <- pindex %>%
  filter(session == 2014 & time == 4)
p2014.ind1 <- pindex %>%
  filter(session == 2014 & time == 1 & Plot %in% as.numeric(names(plotssurveyed[,1,2])[which(plotssurveyed[,1,2] == 0)])) 
p2014.ind2 <- pindex %>%
  filter(session == 2014 & time == 2 & Plot %in% as.numeric(names(plotssurveyed[,2,2])[which(plotssurveyed[,2,2] == 0)])) 
p2014.ind3 <- pindex %>%
  filter(session == 2014 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,2])[which(plotssurveyed[,3,2] == 0)])) 
p2014.ind5 <- pindex %>%
  filter(session == 2014 & time == 5 & Plot %in% as.numeric(names(plotssurveyed[,5,2])[which(plotssurveyed[,5,2] == 0)]))
p2014.ind6 <- pindex %>%
  filter(session == 2014 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,2])[which(plotssurveyed[,6,2] == 0)])) 
p2014.ind7 <- pindex %>%
  filter(session == 2014 & time == 7 & Plot %in% as.numeric(names(plotssurveyed[,7,2])[which(plotssurveyed[,7,2] == 0)])) 
p2014.ind8 <- pindex %>%
  filter(session == 2014 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,2])[which(plotssurveyed[,8,2] == 0)])) 
p2014.ind9 <- pindex %>%
  filter(session == 2014 & time == 9 & Plot %in% as.numeric(names(plotssurveyed[,9,2])[which(plotssurveyed[,9,2] == 0)])) 
p2014.ind10 <- pindex %>%
  filter(session == 2014 & time == 10 & Plot %in% as.numeric(names(plotssurveyed[,10,2])[which(plotssurveyed[,10,2] == 0)])) 
p2014.inds <- c(p2014.indices$par.index, p2014.ind1$par.index, p2014.ind2$par.index, p2014.ind3$par.index, p2014.ind5$par.index,
                p2014.ind6$par.index, p2014.ind7$par.index, p2014.ind8$par.index, p2014.ind9$par.index, p2014.ind10$par.index)


## Missed in 2015
p2015.indices <- pindex %>%
  filter(session == 2015 & time == 10) 
p2015.ind1 <- pindex %>%
  filter(session == 2015 & time == 1 & Plot %in% as.numeric(names(plotssurveyed[,1,3])[which(plotssurveyed[,1,3] == 0)])) 
p2015.ind2 <- pindex %>%
  filter(session == 2015 & time == 2 & Plot %in% as.numeric(names(plotssurveyed[,2,3])[which(plotssurveyed[,2,3] == 0)])) 
p2015.ind3 <- pindex %>%
  filter(session == 2015 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,3])[which(plotssurveyed[,3,3] == 0)]))
p2015.ind4 <- pindex %>%
  filter(session == 2015 & time == 4 & Plot %in% as.numeric(names(plotssurveyed[,4,3])[which(plotssurveyed[,4,3] == 0)]))
p2015.ind5 <- pindex %>%
  filter(session == 2015 & time == 5 & Plot %in% as.numeric(names(plotssurveyed[,5,3])[which(plotssurveyed[,5,3] == 0)])) 
p2015.ind6 <- pindex %>%
  filter(session == 2015 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,3])[which(plotssurveyed[,6,3] == 0)])) 
p2015.ind7 <- pindex %>%
  filter(session == 2015 & time == 7 & Plot %in% as.numeric(names(plotssurveyed[,7,3])[which(plotssurveyed[,7,3] == 0)])) 
p2015.ind8 <- pindex %>%
  filter(session == 2015 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,3])[which(plotssurveyed[,8,3] == 0)])) 
p2015.ind9 <- pindex %>%
  filter(session == 2015 & time == 9 & Plot %in% as.numeric(names(plotssurveyed[,9,3])[which(plotssurveyed[,9,3] == 0)])) 

p2015.inds <- c(p2015.indices$par.index, p2015.ind1$par.index, p2015.ind2$par.index, p2015.ind3$par.index, p2015.ind4$par.index,
                p2015.ind5$par.index, p2015.ind6$par.index, p2015.ind7$par.index, p2015.ind8$par.index, p2015.ind9$par.index)


## Final for all missed ones that need to be zero
p.indices <- c(p2013.inds,p2014.inds, p2015.inds)
p.values <- rep(0, length(p.indices))


```


## Just use the four occassions when I sampled across all three years  
```{r}

## dataCJS4socc

## Repeated for the three years
obsmodel <- dataCJS4socc %>%
  ungroup()%>%
  distinct(Day,Year,Plot,Site,Tag,encounter, .keep_all = TRUE) %>%
  dplyr::select(c(Site:Tag, encounter, Obs, Year)) %>%
  ## Fill in all tags within a Plot and Site across all years
  mutate(Obs = as.character(Obs)) %>%
  tidyr::complete(nesting(Site,Plot,Tag),Year, encounter, fill = list(Obs = "0")) %>%
  arrange(encounter) %>%
  pivot_wider(names_from = encounter, values_from = Obs, values_fill = "0", names_prefix = "Occ")

plotssurveyed <- table(dataCJS$Plot, dataCJS$encounter, dataCJS$Year)  

## In the design data lists after processing data, set these to zero detection (p)
asmiRD <- obsmodel %>%
  dplyr::mutate(across(Occ1:Occ4, ~ ifelse(.x > 0, 1, .x))) %>%
  tidyr::unite(ch, Occ1:Occ4, sep="") %>%
  dplyr::group_by(Site,Plot,Tag) %>%
  dplyr::mutate(Plot = as.factor(Plot)) %>%
  dplyr::mutate(Site = as.factor(Site)) %>%
  dplyr::summarise(ch = paste0(ch, collapse = "")) %>%
  ungroup()

dmPlot <- model.matrix(~ -1 + Plot, asmiRD)
dmSite <- model.matrix(~ -1 + Site, asmiRD)
dimnames(dmPlot)[[2]][length(dimnames(dmPlot)[[2]])]
dimnames(dmSite)[[2]][length(dimnames(dmSite)[[2]])]

## By Plot
asmiRD %>%
  ungroup() %>%
  dplyr::select(c(ch)) %>%
  bind_cols(dmPlot) %>%
  mutate(Plot614 = paste(Plot614, ";", sep ="")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsPlot4socc.inp", 
              sep = " ", col.names = FALSE, row.names = FALSE)

## By Site
asmiRD %>%
  ungroup() %>%
  dplyr::select(c(ch)) %>%
  bind_cols(dmSite) %>%
  mutate(Site26 = paste(Site26, ";", sep ="")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsSite4socc.inp", 
              sep = " ", col.names = FALSE, row.names = FALSE)


plotdf <- asmiRD %>%
  ungroup()%>%
  dplyr::distinct(Plot)

sitedf <- asmiRD %>%
  ungroup() %>%
  dplyr::distinct(Site)


## 3 primary with 4 secondary each
time.intervals <- c(0,0,0,1,0,0,0,1,0,0,0)

RDproc <- process.data(asmiRDPlot.inp, model = "Robust", begin.time = 2013, groups = "Plot",
                       time.intervals = time.intervals)
RDddl <- make.design.data(RDproc)

plotssurveyed <- table(dataCJS4socc$Plot, dataCJS4socc$encounter, dataCJS4socc$Year)  
pindex <- RDddl$p
cindex <- RDddl$c

p2013.ind3 <- pindex %>%
  filter(session == 2013 & time == 1 & Plot %in% as.numeric(names(plotssurveyed[,1,1])[which(plotssurveyed[,1,1] == 0)])) %>%
  select(par.index)
p2013.ind6 <- pindex %>%
  filter(session == 2013 & time == 2 & Plot %in% as.numeric(names(plotssurveyed[,2,1])[which(plotssurveyed[,2,1] == 0)])) %>%
  select(par.index)
p2013.ind8 <- pindex %>%
  filter(session == 2013 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,1])[which(plotssurveyed[,3,1] == 0)])) %>%
  select(par.index)
p2013.ind10 <- pindex %>%
  filter(session == 2013 & time == 4 & Plot %in% as.numeric(names(plotssurveyed[,4,1])[which(plotssurveyed[,4,1] == 0)])) %>%
  select(par.index)
p2013.inds <- c(p2013.ind3$par.index, p2013.ind6$par.index, p2013.ind8$par.index, p2013.ind10$par.index)


```


# Open Robust Design multi-state with State probabilities   
Assumptions : does not change state during primary session   

model = "ORDMSState"
S(s): survival rate between primary occasions for state s            
Psi(r,s): transitions between states between primary periods from r to state s              
Omega: probability of being in each of the states          
pent(s,t): probability of entry onto study area of state s at time t, prob of entering just prior to last secondary occasion obtained by subtraction. sum(pent) <= 1 using MLogit link function             
Phi(s,t): probability of remaining on the study area of state s at time t (can fix to 1, plants can't move)    
p(s,t): capture probability of animal on study area of state s and time t       

derived parameters: population size for each state and primary session, 2 sets of residence times (not needed for plants when can't do dormancy)    
```{r}
RDopenMSmodeldot <- mark(data = RDproc, ddl = RDddl, model = "ORDMSState",
                      time.intervals = time.intervals,
                      model.parameters = list(S = list(formula = ~ stratum ),
                                              Psi = list(formula = ~ stratum),
                                              Omega = list(formula = ~ stratum),
                                              pent = list(formula = ~ 1),
                                              Phi = list(formula = ~1, fixed = 1),
                                              p = list(formula = ~ stratum, fixed = list(index = p.indices, value = p.values))))

head(summary(RDopenMSmodeldot, show.fixed = TRUE))
RDopenMSmodeldot$results$real

Psilist <- get.real(RDopenMSmodeldot, "Psi", vcv = TRUE)
Psivalues <- Psilist$estimates
Psivalues$stratum <- factor(Psivalues$stratum, levels = c("V","R"))
Psivalues$tostratum <- factor(Psivalues$tostratum, levels = c("V","R"))


## split by plot
## shows the rate from year to year that living plants transition from row to column (rows always sum to 1)
transMats <- lapply(plotdf$Plot, function(x){
  TransitionMatrix(Psivalues[Psivalues$time == 2013 & Psivalues$group == x,], vcv.real = Psilist$vcv.real)
})

rowSums(transMats[[1]]$TransitionMat)
## VtoV, RtoV, VtoR, RtoR
sapply(transMats, "[[", 1)
sapply(transMats, "[[", 2)

 
      
RDopenMSmodeldot$results$real %>%
  mutate(ParmsGroupsTime = row.names(RDopenMSmodeldot$results$real )) %>%
  filter(grepl("Psi", ParmsGroupsTime )) %>%
  separate(ParmsGroupsTime, into = c("Parm", "strata", "tostrata", "group", "cohort", "age", "year")) %>%
  # distinct(estimate, se, lcl, ucl) %>%
ggplot( aes(strata, estimate, color = tostrata)) +
  geom_point() +
  geom_errorbar(aes(ymin = lcl, ymax = ucl))+
  theme_bw()+
  scale_color_manual("Transition", values = c("black","grey60"))

RDopenMSmodeldot$results$real %>%
  mutate(ParmsGroupsTime = row.names(RDopenMSmodeldot$results$real )) %>%
  filter(grepl("Omega", ParmsGroupsTime )) %>%
  # separate(ParmsGroupsTime, into = c("Parm", "strata", "group", "age", "year")) %>%
  distinct(estimate,lcl,ucl)
 

RDopenMSmodeldot$results$real %>%
  mutate(ParmsGroupsTime = row.names(RDopenMSmodeldot$results$real )) %>%
  filter(grepl("p", ParmsGroupsTime )) %>%
  filter(!grepl("pent", ParmsGroupsTime)) 

RDopenMSmodeldot$results$real %>%
  distinct(estimate,lcl,ucl)


RDopenMSmodeldot$results$derived$`N Population Size` ## of the 29 plots, each year (3), for Veg and Rep

```


would use stratum:time for both, but over three years, don't let vary over time

```{r}

RDopenMSmodeltime <- mark(data = RDproc, ddl = RDddl, model = "ORDMSState",
                      time.intervals = time.intervals,
                      model.parameters = list(S = list(formula = ~ stratum),
                                              Psi = list(formula = ~ stratum),
                                              Omega = list(formula = ~ stratum),
                                              pent = list(formula = ~ stratum),
                                              Phi = list(formula = ~ 1, fixed = 1),
                                              p = list(formula = ~ stratum, fixed = list(index = p.indices, value = p.values))))

Psilisttime <- get.real(RDopenMSmodeltime, "Psi", vcv = TRUE)
Psivaluestime <- Psilisttime$estimates

head(summary(RDopenMSmodeltime))

p1 <- RDopenMSmodeltime$results$real %>%
  # distinct(estimate,lcl,ucl) %>%
  mutate(dats = row.names(.)) %>%
  mutate(dats = gsub(" to", "to",dats)) %>%
  separate(dats, into = c("Parameter", "stage")) %>%
  filter(estimate != 0) %>%
  filter(Parameter != "Phi") %>%
  ggplot(  aes(estimate, Parameter, color = stage))+
  geom_point() +
  geom_errorbar(aes(xmin = lcl, xmax = ucl, width = 0.2))+
  theme_bw()+
  ylab("")+
  scale_color_manual("Stage", values = c("black","black","grey70","grey70"), 
                     labels = c("Reproductive", "R to V", "Vegetative", "V to R"))

  ggsave(p1, filename = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter AsMi/Images/ORDMSStateresults.jpg",
         width=200, height=100,units='mm', dpi=300 )

  
RDopenMSmodeltime$results$real %>%
  distinct(estimate,se,lcl,ucl)

```




# Huggins Closed Robust Design Multi-state with State Probabilities  
"CRDMSOHug"


We used a Robust design with a Huggins’ estimator in Program MARK (accessed through RMark ) to estimate survival and a Pradel Robust Model with survival and Lambda with Huggins’ closed capture estimator in Program MARK to estimate the population growth rate (Pollock, 1982; White et al., 2001). 


S(s): survival rate between primary occasions for state s 
Psi(r,s): transition between states between primary periods from r to state s
Omega: probability of being in each of the states
p(s,t): apparent detection
c(s,t): true detection   
```{r}

time.intervals <- c(0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0) 

RDproc <- process.data(asmiRDPlot.inp, model = "CRDMSOHug", begin.time = 2013, groups = "Plot",
                       time.intervals = time.intervals)
RDddl <- make.design.data(RDproc) #, parameters = list(Psi = list(subtract.stratum = c("R","R"))))

RDddl$Psi$stratum <- factor(RDddl$Psi$stratum, levels = c("R","V"))
RDddl$S$stratum <- factor(RDddl$S$stratum, levels = c("R","V"))
RDddl$Omega$stratum <- factor(RDddl$Omega$stratum, levels = c("R","V"))
RDddl$p$stratum <- factor(RDddl$p$stratum, levels = c("R","V"))
RDddl$c$stratum <- factor(RDddl$c$stratum, levels = c("R","V"))

table(RDddl$Psi[,c("stratum","tostratum")]) ## R to R and V to V computed by subtraction
## Now add zero for detection p, at all times when not visited; session = Year, time = secondary occasion 1:10, Plot = Plot
pindex <- RDddl$p
## Missed entire survey period
p2013.indices <- pindex %>%
  filter(session == 2013 & time %in% c(1,2,4,5,7,9))
## Missed these plots [Plot, Survey, Year]
p2013.ind3 <- pindex %>%
  filter(session == 2013 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,1])[which(plotssurveyed[,3,1] == 0)]))
p2013.ind6 <- pindex %>%
  filter(session == 2013 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,1])[which(plotssurveyed[,6,1] == 0)])) 
p2013.ind8 <- pindex %>%
  filter(session == 2013 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,1])[which(plotssurveyed[,8,1] == 0)])) 
p2013.ind10 <- pindex %>%
  filter(session == 2013 & time == 10 & Plot %in% as.numeric(names(plotssurveyed[,10,1])[which(plotssurveyed[,10,1] == 0)])) 
p2013.inds <- c(p2013.indices$par.index, p2013.ind3$par.index, p2013.ind6$par.index, p2013.ind8$par.index, p2013.ind10$par.index)

## Missed in 2014
p2014.indices <- pindex %>%
  filter(session == 2014 & time == 4)
p2014.ind1 <- pindex %>%
  filter(session == 2014 & time == 1 & Plot %in% as.numeric(names(plotssurveyed[,1,2])[which(plotssurveyed[,1,2] == 0)])) 
p2014.ind2 <- pindex %>%
  filter(session == 2014 & time == 2 & Plot %in% as.numeric(names(plotssurveyed[,2,2])[which(plotssurveyed[,2,2] == 0)])) 
p2014.ind3 <- pindex %>%
  filter(session == 2014 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,2])[which(plotssurveyed[,3,2] == 0)])) 
p2014.ind5 <- pindex %>%
  filter(session == 2014 & time == 5 & Plot %in% as.numeric(names(plotssurveyed[,5,2])[which(plotssurveyed[,5,2] == 0)]))
p2014.ind6 <- pindex %>%
  filter(session == 2014 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,2])[which(plotssurveyed[,6,2] == 0)])) 
p2014.ind7 <- pindex %>%
  filter(session == 2014 & time == 7 & Plot %in% as.numeric(names(plotssurveyed[,7,2])[which(plotssurveyed[,7,2] == 0)])) 
p2014.ind8 <- pindex %>%
  filter(session == 2014 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,2])[which(plotssurveyed[,8,2] == 0)])) 
p2014.ind9 <- pindex %>%
  filter(session == 2014 & time == 9 & Plot %in% as.numeric(names(plotssurveyed[,9,2])[which(plotssurveyed[,9,2] == 0)])) 
p2014.ind10 <- pindex %>%
  filter(session == 2014 & time == 10 & Plot %in% as.numeric(names(plotssurveyed[,10,2])[which(plotssurveyed[,10,2] == 0)])) 
p2014.inds <- c(p2014.indices$par.index, p2014.ind1$par.index, p2014.ind2$par.index, p2014.ind3$par.index, p2014.ind5$par.index,
                p2014.ind6$par.index, p2014.ind7$par.index, p2014.ind8$par.index, p2014.ind9$par.index, p2014.ind10$par.index)

## Missed in 2015
p2015.indices <- pindex %>%
  filter(session == 2015 & time == 10) 
p2015.ind1 <- pindex %>%
  filter(session == 2015 & time == 1 & Plot %in% as.numeric(names(plotssurveyed[,1,3])[which(plotssurveyed[,1,3] == 0)])) 
p2015.ind2 <- pindex %>%
  filter(session == 2015 & time == 2 & Plot %in% as.numeric(names(plotssurveyed[,2,3])[which(plotssurveyed[,2,3] == 0)])) 
p2015.ind3 <- pindex %>%
  filter(session == 2015 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,3])[which(plotssurveyed[,3,3] == 0)]))
p2015.ind4 <- pindex %>%
  filter(session == 2015 & time == 4 & Plot %in% as.numeric(names(plotssurveyed[,4,3])[which(plotssurveyed[,4,3] == 0)]))
p2015.ind5 <- pindex %>%
  filter(session == 2015 & time == 5 & Plot %in% as.numeric(names(plotssurveyed[,5,3])[which(plotssurveyed[,5,3] == 0)])) 
p2015.ind6 <- pindex %>%
  filter(session == 2015 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,3])[which(plotssurveyed[,6,3] == 0)])) 
p2015.ind7 <- pindex %>%
  filter(session == 2015 & time == 7 & Plot %in% as.numeric(names(plotssurveyed[,7,3])[which(plotssurveyed[,7,3] == 0)])) 
p2015.ind8 <- pindex %>%
  filter(session == 2015 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,3])[which(plotssurveyed[,8,3] == 0)])) 
p2015.ind9 <- pindex %>%
  filter(session == 2015 & time == 9 & Plot %in% as.numeric(names(plotssurveyed[,9,3])[which(plotssurveyed[,9,3] == 0)])) 

p2015.inds <- c(p2015.indices$par.index, p2015.ind1$par.index, p2015.ind2$par.index, p2015.ind3$par.index, p2015.ind4$par.index,
                p2015.ind5$par.index, p2015.ind6$par.index, p2015.ind7$par.index, p2015.ind8$par.index, p2015.ind9$par.index)


## Final for all missed ones that need to be zero
p.indices <- c(p2013.inds,p2014.inds, p2015.inds)
p.values <- rep(0, length(p.indices))

############################### c indeces
cindex <- RDddl$c
## Missed entire survey period
c2013.indices <- cindex %>%
  filter(session == 2013 & time %in% c(1,2,4,5,7,9))
## Missed these plots [Plot, Survey, Year]
c2013.ind3 <- cindex %>%
  filter(session == 2013 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,1])[which(plotssurveyed[,3,1] == 0)]))
c2013.ind6 <- cindex %>%
  filter(session == 2013 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,1])[which(plotssurveyed[,6,1] == 0)])) 
c2013.ind8 <- cindex %>%
  filter(session == 2013 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,1])[which(plotssurveyed[,8,1] == 0)])) 
c2013.ind10 <- cindex %>%
  filter(session == 2013 & time == 10 & Plot %in% as.numeric(names(plotssurveyed[,10,1])[which(plotssurveyed[,10,1] == 0)])) 
c2013.inds <- c(c2013.indices$par.index, c2013.ind3$par.index, c2013.ind6$par.index, c2013.ind8$par.index, c2013.ind10$par.index)

## Missed in 2014
c2014.indices <- cindex %>%
  filter(session == 2014 & time == 4)
c2014.ind1 <- cindex %>%
  filter(session == 2014 & time == 1 & Plot %in% as.numeric(names(plotssurveyed[,1,2])[which(plotssurveyed[,1,2] == 0)])) 
c2014.ind2 <- cindex %>%
  filter(session == 2014 & time == 2 & Plot %in% as.numeric(names(plotssurveyed[,2,2])[which(plotssurveyed[,2,2] == 0)])) 
c2014.ind3 <- cindex %>%
  filter(session == 2014 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,2])[which(plotssurveyed[,3,2] == 0)])) 
c2014.ind5 <- cindex %>%
  filter(session == 2014 & time == 5 & Plot %in% as.numeric(names(plotssurveyed[,5,2])[which(plotssurveyed[,5,2] == 0)]))
c2014.ind6 <- cindex %>%
  filter(session == 2014 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,2])[which(plotssurveyed[,6,2] == 0)])) 
c2014.ind7 <- cindex %>%
  filter(session == 2014 & time == 7 & Plot %in% as.numeric(names(plotssurveyed[,7,2])[which(plotssurveyed[,7,2] == 0)])) 
c2014.ind8 <- cindex %>%
  filter(session == 2014 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,2])[which(plotssurveyed[,8,2] == 0)])) 
c2014.ind9 <- cindex %>%
  filter(session == 2014 & time == 9 & Plot %in% as.numeric(names(plotssurveyed[,9,2])[which(plotssurveyed[,9,2] == 0)])) 
c2014.ind10 <- cindex %>%
  filter(session == 2014 & time == 10 & Plot %in% as.numeric(names(plotssurveyed[,10,2])[which(plotssurveyed[,10,2] == 0)])) 
c2014.inds <- c(c2014.indices$par.index, c2014.ind1$par.index, c2014.ind2$par.index, c2014.ind3$par.index, c2014.ind5$par.index,
                c2014.ind6$par.index, c2014.ind7$par.index, c2014.ind8$par.index, c2014.ind9$par.index, c2014.ind10$par.index)


## Missed in 2015
c2015.indices <- cindex %>%
  filter(session == 2015 & time == 10) 
c2015.ind1 <- cindex %>%
  filter(session == 2015 & time == 1 & Plot %in% as.numeric(names(plotssurveyed[,1,3])[which(plotssurveyed[,1,3] == 0)])) 
c2015.ind2 <- cindex %>%
  filter(session == 2015 & time == 2 & Plot %in% as.numeric(names(plotssurveyed[,2,3])[which(plotssurveyed[,2,3] == 0)])) 
c2015.ind3 <- cindex %>%
  filter(session == 2015 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,3])[which(plotssurveyed[,3,3] == 0)]))
c2015.ind4 <- cindex %>%
  filter(session == 2015 & time == 4 & Plot %in% as.numeric(names(plotssurveyed[,4,3])[which(plotssurveyed[,4,3] == 0)]))
c2015.ind5 <- cindex %>%
  filter(session == 2015 & time == 5 & Plot %in% as.numeric(names(plotssurveyed[,5,3])[which(plotssurveyed[,5,3] == 0)])) 
c2015.ind6 <- cindex %>%
  filter(session == 2015 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,3])[which(plotssurveyed[,6,3] == 0)])) 
c2015.ind7 <- cindex %>%
  filter(session == 2015 & time == 7 & Plot %in% as.numeric(names(plotssurveyed[,7,3])[which(plotssurveyed[,7,3] == 0)])) 
c2015.ind8 <- cindex %>%
  filter(session == 2015 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,3])[which(plotssurveyed[,8,3] == 0)])) 
c2015.ind9 <- cindex %>%
  filter(session == 2015 & time == 9 & Plot %in% as.numeric(names(plotssurveyed[,9,3])[which(plotssurveyed[,9,3] == 0)])) 

c2015.inds <- c(c2015.indices$par.index, c2015.ind1$par.index, c2015.ind2$par.index, c2015.ind3$par.index, c2015.ind4$par.index,
                c2015.ind5$par.index, c2015.ind6$par.index, c2015.ind7$par.index, c2015.ind8$par.index, c2015.ind9$par.index)
## Final for all missed ones that need to be zero
c.indices <- c(c2013.inds,c2014.inds, c2015.inds)
c.values <- rep(0, length(c.indices))

Huggins <- mark(data = RDproc, ddl = RDddl, model = "CRDMSOHug",
                      time.intervals = time.intervals, begin.time = 2013)

Huggins$results$real %>%
  distinct(estimate, se, lcl, ucl)

HugginsRDclosedMSmodeldot <- mark(data = RDproc, ddl = RDddl, model = "CRDMSOHug",
                      time.intervals = time.intervals,
                      model.parameters = list(
                                              # S = list(formula = ~ stratum + Plot),
                                              # Psi = list(formula = ~ stratum + Plot),
                                              # Omega = list(formula = ~ stratum + Plot),
                                              S = list(formula = ~ stratum ),
                                              Psi = list(formula = ~ stratum ),
                                              Omega = list(formula = ~ stratum ),
                                              p = list(formula = ~ stratum, fixed = list(index = p.indices, value = p.values)),
                                              c = list(formula = ~ stratum, fixed = list(index = c.indices, value = c.values)))
                      )

head(summary(HugginsRDclosedMSmodeldot, show.fixed = TRUE))
HugginsRDclosedMSmodeldot$results$real %>%
  distinct(estimate, se, lcl, ucl)

plotSite <- obsmodel %>%
  distinct(Plot, Site) %>%
  dplyr::rename(plot = Plot) %>%
  mutate(plot = as.character(plot))

## Fixed to zero for times when not viewed
HugginsRDclosedMSmodeldot$results$real %>%
  mutate(dats = row.names(.)) %>%
  mutate(dats = gsub(" to", "to",dats)) %>%
  separate(dats, into = c("Parameter", "stage","plot")) %>%
  # mutate(plot = gsub("g","",plot)) %>%
  # mutate(plot = as.character(plot)) %>%
  # left_join(plotSite) %>%
  mutate(Parameter = as.factor(Parameter)) %>%
  # mutate(Parameter = factor(Parameter, levels = c("S","Phi","Omega","p","c"))) %>%
ggplot(  aes( estimate, Parameter,color = stage))+
  geom_point(position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(xmin = lcl, xmax = ucl, width = 0.2),position = position_dodge(width = 0.4))+
  # geom_errorbar(aes(ymin = lcl, ymax = ucl, width = 0.1),position = position_dodge(width = 0.4))+
  theme_bw()+
  ylab("")+
  scale_color_manual("Stage", values = c("black","black","blue","blue"), 
                     labels = c("Reproductive", "R to V", "Vegetative", "V to R")) 
  # facet_wrap(~ Site)

Hugginstime <- mark(data = RDproc, ddl = RDddl, model = "CRDMSOHug",
                      time.intervals = time.intervals,
                      model.parameters = list(S = list(formula = ~ Plot),
                                              Psi = list(formula = ~ Plot),
                                              Omega = list(formula = ~ stratum),
                                              p = list(formula = ~ stratum, fixed = list(index = p.indices, value = p.values)),
                                              c = list(formula = ~ stratum, fixed = list(index = c.indices, value = c.values)))
                      )

head(summary(HugginsRDclosedMSmodeldot, show.fixed = TRUE))
HugginsRDclosedMSmodeldot$results$real %>%
  distinct(estimate, se, lcl, ucl)

## Ratio of juvenile to adult
0.5204678/0.8434238
  

HugginsRDclosedMSmodeldot$results$derived
```


```{r}

## To compare
## Average across two years
# matU <- mean(list(MPM.all$Plot1$Year2013$T,MPM.all$Plot1$Year2014$T))
# matF <- mean(list(MPM.all$Plot1$Year2013$F,MPM.all$Plot1$Year2014$F))
## To compare using the average across sites and years
matU <- mean(do.call(c, lapply(asmi.3yrs, function(x) lapply(x, function(y) y$T))))
matF <- mean(do.call(c, lapply(asmi.3yrs, function(x) lapply(x, function(y) y$F))))

log(lambda(matU + matF))
lambda(matU + matF)
colSums(sensitivity(matU + matF))
el <- elasticity(matU + matF)
mx <- mpm_to_mx(matU, matF, lx_crit = 0.01)   # age from stage, age specific reproduction
lx <- mpm_to_lx(matU, lx_crit = 0.01) ## age from stage, age-specific survivorship
convShape <- shape_rep(mx)
convDegreeItero <- entropy_d(lx, mx) ## these are sensitive to length of vectors, and partial survivorship and fecundity - better to use shape_rep
gen_time(matU, matF, method = "R0")

## Vital rates are non-zero elements of A, elasticities
Adf <- data.frame(vr = as.vector(el), logvr = log2(as.vector(el)))
Adf <- Adf %>%
  mutate(plnp = vr*logvr)
Hprime <- -sum(Adf$plnp)
Hprimemax <- log2(nrow(Adf))
(EE <- Hprime/Hprimemax)

CH <- HugginsRDclosedMSmodeldot$results$real %>%
  distinct(estimate, se, lcl, ucl) %>%
  mutate(dats = row.names(.)) %>%
  mutate(dats = gsub(" to", "to",dats)) %>%
  mutate(dats = gsub(" a0", "", dats)) %>%
  mutate(dats = gsub(" a1", "", dats)) %>%
  mutate(dats = gsub(" a2", "", dats)) %>%
  separate(dats, into = c("Parameter", "stage")) %>% #, "plot", "year")) %>%
  mutate(stage = gsub("s", "",stage)) %>%
  mutate(ParameterStage = paste(Parameter, stage, sep = " ")) %>%
  filter(estimate != 0)

SV <- CH$estimate[CH$ParameterStage == "S V"]
GVR <- CH$estimate[CH$ParameterStage == "Psi VtoR"] 
SR <- CH$estimate[CH$ParameterStage == "S R"]
GRV <- CH$estimate[CH$ParameterStage == "Psi RtoV"]

## f from Pradel
load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/PradelSBC.Rdata")

f <- asmi.models$Phi.dot.p.dot.f.dot$results$real$estimate[3]

matUMRC <- matrix(c(SV * (1-GVR), SV * GVR, (SR * GRV) + f, SR * (1-GRV) ),
                     nrow = 2)
lambda(matUMRC)
elasticity(matUMRC)
colSums(sensitivity(matUMRC))

colSums(matUMRC)
colSums(matU)

matU.MR <- matrix(c(SV * (1-GVR), SV * GVR, (SR * GRV), SR * (1-GRV) ),
                     nrow = 2)
matF.MR <- matrix(c(0, 0, f, 0 ),
                     nrow = 2)

lambda(matU.MR + matF.MR)
el.mr <- elasticity(matU.MR + matF.MR)
mx.mr <- mpm_to_mx(matU.MR, matF.MR, lx_crit = 0.01)   # age from stage, age specific reproduction
lx.mr <- mpm_to_lx(matU.MR, lx_crit = 0.01) ## age from stage, age-specific survivorship
convShape.mr <- shape_rep(mx.mr)
convDegreeItero <- entropy_d(lx.mr, mx.mr) ## these are sensitive to length of vectors, and partial survivorship and fecundity - better to use shape_rep
gen_time(matU.MR, matF.MR, method = "R0")

## Vital rates are non-zero elements of A, elasticities
Adf.mr <- data.frame(vr = as.vector(el.mr), logvr = log2(as.vector(el.mr)))
Adf.mr <- Adf.mr %>%
  mutate(plnp = vr*logvr)
Hprime.mr <- -sum(Adf.mr$plnp)
Hprimemax.mr <- log2(nrow(Adf.mr))
(EE <- Hprime.mr/Hprimemax.mr)

## survival is column sums. Transitions are the cell/survival
MPMparameters2 <- data.frame(estimate = c(colSums(matU)[1], colSums(matU)[2],
                                          matU[2,1]/colSums(matU)[1], matU[1,2]/colSums(matU)[2], 
                                         colSums(matU)[3], 
                                         matU[3,1]/colSums(matU)[1], matU[3,2]/colSums(matU)[2],  
                                         matU[1,3]/colSums(matU)[3], matU[2,3]/colSums(matU)[3]),
                            se = NA, lcl = NA, ucl = NA, 
                            Parameter = c("S","S",    "Psi","Psi",     "S", "Psi", "Psi", "Psi", "Psi"), 
                            stage =     c("V","R",  "VtoR","RtoV", "D", "VtoD", "RtoD", "DtoV", "DtoR"),
                            ParameterStage = c("S V", "S R", "Psi VtoR", "Psi RtoV", "S D", 
                                               "Psi VtoD", "Psi RtoD", "Psi DtoV", "Psi DtoR"),
                            Model = "MPM")
                            

p2 <- HugginsRDclosedMSmodeldot$results$real %>%
  distinct(estimate, se, lcl, ucl) %>%
  mutate(dats = row.names(.)) %>%
  mutate(dats = gsub(" to", "to",dats)) %>%
  mutate(dats = gsub(" a0", "", dats)) %>%
  mutate(dats = gsub(" a1", "", dats)) %>%
  mutate(dats = gsub(" a2", "", dats)) %>%
  separate(dats, into = c("Parameter", "stage")) %>% #, "plot", "year")) %>%
  mutate(stage = gsub("s", "",stage)) %>%
  mutate(ParameterStage = paste(Parameter, stage, sep = " ")) %>%
  filter(estimate != 0) %>%
  filter(Parameter != "Omega") %>%
  dplyr::select(c(estimate:ucl,Parameter:ParameterStage)) %>%
  mutate(Model = "CRDMSOHug") %>%
  bind_rows(MPMparameters2) %>%
  mutate(ParameterStage = factor(ParameterStage, levels = c("Psi RtoD","c R", "p R",
                                                            "Psi VtoD","c V","p V",
                                                            "Psi DtoR", "Psi DtoV", "Psi RtoV",
                                                            "Psi VtoR","S D", "S R", "S V"))) %>%
 ggplot(  aes(estimate, ParameterStage, color = stage, #fill = stage, 
              shape = Model))+
  geom_point(position = position_dodge(width = 0.4), size = 2, stroke = 1.5) +
  geom_errorbar(aes(xmin = lcl, xmax = ucl, width = 0.5),position = position_dodge(width = 0.4))+
  theme_bw()+
  ylab("")+
  scale_color_manual("Stage", values = c("red","red","red",  "darkmagenta","darkmagenta","darkmagenta",
                                         "darkseagreen","darkseagreen","darkseagreen"),
                     labels = c("Dormant","D to R","D to V","Reproductive", "R to D","R to V", "Vegetative", "V to D", "V to R"))+
  # scale_fill_manual("Stage", values = c("red","darkmagenta","darkseagreen",  "darkmagenta","red","darkseagreen",
  #                                        "darkseagreen","red","darkmagenta"),
  #                    labels = c("Dormant","D to R","D to V","Reproductive", "R to D","R to V", "Vegetative", "V to D", "V to R"))+
  # scale_color_manual("Stage", values = c("black","black","grey60","grey60"), 
  #                    labels = c("Reproductive", "R to V", "Vegetative", "V to R"))+
  scale_shape_manual(values = c(20,4)) 

p2
  
ggsave(p2, filename = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter AsMi/Images/CRDMSOHugresultsWdormant.jpg",
         width=140, height=110,units='mm', dpi=300 )
  

  

MPMparameters <- data.frame(estimate = c(colSums(matU)[1], colSums(matU)[2], matU[2,1], matU[1,2]),
                            se = NA, lcl = NA, ucl = NA, 
                            Parameter = c("S","S",    "Psi","Psi"), 
                            stage =     c("sV","sR",  "sVtoR","sRtoV"),
                            Model = "MPM")
                            

p1 <- HugginsRDclosedMSmodeldot$results$real %>%
  # distinct(estimate,lcl,ucl) %>%
  mutate(dats = row.names(.)) %>%
  mutate(dats = gsub(" to", "to",dats)) %>%
  separate(dats, into = c("Parameter", "stage")) %>%
  filter(estimate != 0) %>%
  filter(Parameter != "Omega") %>%
  dplyr::select(c(estimate:ucl,Parameter:stage)) %>%
  mutate(Model = "CRDMSOHug") %>%
  bind_rows(MPMparameters) %>%
 ggplot(  aes(estimate, Parameter, color = stage, shape = Model))+
  geom_point(position = position_dodge(width = 0.4), size = 1.5, stroke = 1.5) +
  geom_errorbar(aes(xmin = lcl, xmax = ucl, width = 0.5),position = position_dodge(width = 0.4))+
  theme_bw()+
  ylab("")+
  scale_color_manual("Stage", values = c("darkmagenta","darkmagenta",
                                         "darkseagreen","darkseagreen"),
                     labels = c("Reproductive", "R to V", "Vegetative", "V to R"))+
  scale_shape_manual(values = c(20,4))

  ggsave(p1, filename = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter AsMi/Images/CRDMSOHugresults.jpg",
         width=140, height=90,units='mm', dpi=300 )
    
p1TimePlot <- Hugginstime$results$real %>%
  # distinct(estimate,lcl,ucl) %>%
  mutate(dats = row.names(.)) %>%
  mutate(dats = gsub(" to", "to",dats)) %>%
  separate(dats, into = c("Parameter", "stage", "group")) %>%
  mutate(group = gsub("g","",group)) %>%
  filter(estimate != 0) %>%
ggplot(  aes(estimate, Parameter, color = stage))+
  geom_point(position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(xmin = lcl, xmax = ucl, width = 0.2),position = position_dodge(width = 0.4))+
  theme_bw()+
  ylab("")+
  scale_color_manual("Stage", values = c("black","black","grey40","grey40"), 
                     labels = c("Reproductive", "R to V", "Vegetative", "V to R"))+
  facet_wrap(~group)


```




Model: Robust Design Pradel Lambda Closed Population Estimation  "RDPdlClosed"

```{r}

```


