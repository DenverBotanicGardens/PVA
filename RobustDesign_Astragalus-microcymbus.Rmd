---
title: "Robust Design AsMi"
author: "Michelle DePrenger-Levin"
date: "2023-11-30"
output: ''
---

Libraries and data
```{r}
rm(list=ls())
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMark)

load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3years.Rdata")

load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/plotdf.Rdata")
load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/sitedf.Rdata")
load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/dataCJS3yrs4socc.Rdata")

```



## Robust example - not multi-state   
inp created in CJS_SeedlingSurvival.Rmd, poor name, changed focus
```{r}


asmiRDPlot.inp <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsPlot.inp",
                          group.df = plotdf,
                          covariates = NULL,
                          use.comments = FALSE)

asmiRDSite.inp <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsSite.inp",
                          group.df = sitedf,
                          covariates = NULL,
                          use.comments = FALSE)


```


# instead of dot notation (robust models and pradel won't accept "." for missing surveys even though Cooch and Laake say they do!!), fix the probabilities of detection to zero for those periods in the ddls. fix p=0 for that occasion
```{r}

## dataCJS
load("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/dataCJS3yrs.Rdata")

## Can only be one strata within a primary session - need to assign V if never reproductive, R if eventually reproductive  
##### Could condense to spring and fall, then have V early and some R late
## Repeated for the three years
obsmodel <- dataCJS %>%
  group_by(Year, Plot, Site, Tag) %>%
  ## Make the multistate options
  dplyr::mutate(MSObs = case_when(Ln == 0 ~ "0",
                                  (Ln > 0 & Fl == 0) ~ "V",
                                  any((Ln > 0 & Fl == 1)) ~ "R")) %>%
  # dplyr::mutate(MSObs = case_when(any(MSObs == "R") ~ replace(MSObs, MSObs == "V", "R"),
  #                                 TRUE ~ MSObs)) %>%
  ungroup()%>%
  distinct(Day,Year,Plot,Site,Tag,encounter, .keep_all = TRUE) %>%
  # dplyr::select(c(Site:Tag, encounter, Obs, Year)) %>%
  dplyr::select(c(Site:Tag, encounter, MSObs, Year)) %>%
  ## Fill in all tags within a Plot and Site across all years
  tidyr::complete(nesting(Site,Plot,Tag),Year, encounter, fill = list(MSObs = "0")) %>%
  arrange(encounter) %>%
  pivot_wider(names_from = encounter, values_from = MSObs, values_fill = "0", names_prefix = "Occ") %>%
  filter(Site %in% c(5,15,19,26))

obsmodel %>%
  filter(if_any(.cols = everything(), ~ grepl("V", .))) %>%
  print(n=100)

plotssurveyed <- table(dataCJS$Plot, dataCJS$encounter, dataCJS$Year)  

## In the design data lists after processing data, set these to zero detection (p)


asmiRD <- obsmodel %>%
  ## unite within each year
  tidyr::unite(ch, Occ1:Occ10, sep="") %>%
  ## Change all to R if any within a year
  dplyr::mutate(ch = if_else(grepl("R",ch), gsub("V","R",ch), ch)) %>%
  dplyr::group_by(Site,Plot,Tag) %>%
  dplyr::mutate(Plot = as.factor(Plot)) %>%
  dplyr::mutate(Site = as.factor(Site)) %>%
  ## paste across years
  dplyr::summarise(ch = paste0(ch, collapse = "")) %>%
  ungroup() %>%
  filter((grepl("V", ch) | grepl("R",ch)))

asmiRD %>%
  filter(grepl("R",ch))

dmPlot <- model.matrix(~ -1 + Plot, asmiRD)
dmSite <- model.matrix(~ -1 + Site, asmiRD)
dimnames(dmPlot)[[2]][length(dimnames(dmPlot)[[2]])]
dimnames(dmSite)[[2]][length(dimnames(dmSite)[[2]])]

## By Plot
asmiRD %>%
  ungroup() %>%
  dplyr::select(c(ch)) %>%
  bind_cols(dmPlot) %>%
  mutate(Plot614 = paste(Plot614, ";", sep ="")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsPlot.inp", 
              sep = " ", col.names = FALSE, row.names = FALSE)

## By Site
asmiRD %>%
  ungroup() %>%
  dplyr::select(c(ch)) %>%
  bind_cols(dmSite) %>%
  mutate(Site26 = paste(Site26, ";", sep ="")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsSite.inp", 
              sep = " ", col.names = FALSE, row.names = FALSE)


plotdf <- asmiRD %>%
  ungroup()%>%
  dplyr::distinct(Plot)

sitedf <- asmiRD %>%
  ungroup() %>%
  dplyr::distinct(Site)

# save(plotdf, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/plotdf.Rdata")
# save(sitedf, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/sitedf.Rdata")

```



Mark-recapture by plot  
Mark-recpature by site
```{r}

## Convert for MARK  
asmiRDPlot.inp <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsPlot.inp", 
                        group.df = plotdf,
                        covariates = NULL,
                        use.comments = FALSE)

asmiRDSite.inp <- convert.inp("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsSite.inp", 
                        group.df = sitedf,
                        covariates = NULL,
                        use.comments = FALSE)
```


In the dll PIMs set p to zero for all times not surveyed   
Need a 'dead' state that is never observed, fix detection to the dead state as zero  
Set the transition from dead to alive to zero
Set dead to dead to 1    

```{r}

plotssurveyed <- table(dataCJS$Plot, dataCJS$encounter, dataCJS$Year) 
time.intervals <- c(0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0)

RDproc <- process.data(asmiRDPlot.inp, model = "ORDMSState", begin.time = 2013, groups = "Plot",
                       time.intervals = time.intervals)
RDddl <- make.design.data(RDproc) #, parameters = list(Psi = list(subtract.stratum = c("R","R"))))

RDddl$Psi$stratum <- factor(RDddl$Psi$stratum, levels = c("V","R"))
RDddl$S$stratum <- factor(RDddl$S$stratum, levels = c("V","R"))
RDddl$Omega$stratum <- factor(RDddl$Omega$stratum, levels = c("V","R"))
RDddl$pent$stratum <- factor(RDddl$pent$stratum, levels = c("V","R"))
RDddl$p$stratum <- factor(RDddl$p$stratum, levels = c("V","R"))

table(RDddl$Psi[,c("stratum","tostratum")]) ## R to V computed by subtraction

## Now add zero for detection p, at all times when not visited; session = Year, time = secondary occasion 1:10, Plot = Plot
pindex <- RDddl$p
## Missed entire survey period
p2013.indices <- pindex %>%
  filter(session == 2013 & time %in% c(1,2,4,5,7,9))
## Missed these plots [Plot, Survey, Year]
p2013.ind3 <- pindex %>%
  filter(session == 2013 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,1])[which(plotssurveyed[,3,1] == 0)]))
p2013.ind6 <- pindex %>%
  filter(session == 2013 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,1])[which(plotssurveyed[,6,1] == 0)])) 
p2013.ind8 <- pindex %>%
  filter(session == 2013 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,1])[which(plotssurveyed[,8,1] == 0)])) 
p2013.ind10 <- pindex %>%
  filter(session == 2013 & time == 10 & Plot %in% as.numeric(names(plotssurveyed[,10,1])[which(plotssurveyed[,10,1] == 0)])) 
p2013.inds <- c(p2013.indices$par.index, p2013.ind3$par.index, p2013.ind6$par.index, p2013.ind8$par.index, p2013.ind10$par.index)

## Missed in 2014
p2014.indices <- pindex %>%
  filter(session == 2014 & time == 4)
p2014.ind1 <- pindex %>%
  filter(session == 2014 & time == 1 & Plot %in% as.numeric(names(plotssurveyed[,1,2])[which(plotssurveyed[,1,2] == 0)])) 
p2014.ind2 <- pindex %>%
  filter(session == 2014 & time == 2 & Plot %in% as.numeric(names(plotssurveyed[,2,2])[which(plotssurveyed[,2,2] == 0)])) 
p2014.ind3 <- pindex %>%
  filter(session == 2014 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,2])[which(plotssurveyed[,3,2] == 0)])) 
p2014.ind5 <- pindex %>%
  filter(session == 2014 & time == 5 & Plot %in% as.numeric(names(plotssurveyed[,5,2])[which(plotssurveyed[,5,2] == 0)]))
p2014.ind6 <- pindex %>%
  filter(session == 2014 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,2])[which(plotssurveyed[,6,2] == 0)])) 
p2014.ind7 <- pindex %>%
  filter(session == 2014 & time == 7 & Plot %in% as.numeric(names(plotssurveyed[,7,2])[which(plotssurveyed[,7,2] == 0)])) 
p2014.ind8 <- pindex %>%
  filter(session == 2014 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,2])[which(plotssurveyed[,8,2] == 0)])) 
p2014.ind9 <- pindex %>%
  filter(session == 2014 & time == 9 & Plot %in% as.numeric(names(plotssurveyed[,9,2])[which(plotssurveyed[,9,2] == 0)])) 
p2014.ind10 <- pindex %>%
  filter(session == 2014 & time == 10 & Plot %in% as.numeric(names(plotssurveyed[,10,2])[which(plotssurveyed[,10,2] == 0)])) 
p2014.inds <- c(p2014.indices$par.index, p2014.ind1$par.index, p2014.ind2$par.index, p2014.ind3$par.index, p2014.ind5$par.index,
                p2014.ind6$par.index, p2014.ind7$par.index, p2014.ind8$par.index, p2014.ind9$par.index, p2014.ind10$par.index)


## Missed in 2015
p2015.indices <- pindex %>%
  filter(session == 2015 & time == 10) 
p2015.ind1 <- pindex %>%
  filter(session == 2015 & time == 1 & Plot %in% as.numeric(names(plotssurveyed[,1,3])[which(plotssurveyed[,1,3] == 0)])) 
p2015.ind2 <- pindex %>%
  filter(session == 2015 & time == 2 & Plot %in% as.numeric(names(plotssurveyed[,2,3])[which(plotssurveyed[,2,3] == 0)])) 
p2015.ind3 <- pindex %>%
  filter(session == 2015 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,3])[which(plotssurveyed[,3,3] == 0)]))
p2015.ind4 <- pindex %>%
  filter(session == 2015 & time == 4 & Plot %in% as.numeric(names(plotssurveyed[,4,3])[which(plotssurveyed[,4,3] == 0)]))
p2015.ind5 <- pindex %>%
  filter(session == 2015 & time == 5 & Plot %in% as.numeric(names(plotssurveyed[,5,3])[which(plotssurveyed[,5,3] == 0)])) 
p2015.ind6 <- pindex %>%
  filter(session == 2015 & time == 6 & Plot %in% as.numeric(names(plotssurveyed[,6,3])[which(plotssurveyed[,6,3] == 0)])) 
p2015.ind7 <- pindex %>%
  filter(session == 2015 & time == 7 & Plot %in% as.numeric(names(plotssurveyed[,7,3])[which(plotssurveyed[,7,3] == 0)])) 
p2015.ind8 <- pindex %>%
  filter(session == 2015 & time == 8 & Plot %in% as.numeric(names(plotssurveyed[,8,3])[which(plotssurveyed[,8,3] == 0)])) 
p2015.ind9 <- pindex %>%
  filter(session == 2015 & time == 9 & Plot %in% as.numeric(names(plotssurveyed[,9,3])[which(plotssurveyed[,9,3] == 0)])) 

p2015.inds <- c(p2015.indices$par.index, p2015.ind1$par.index, p2015.ind2$par.index, p2015.ind3$par.index, p2015.ind4$par.index,
                p2015.ind5$par.index, p2015.ind6$par.index, p2015.ind7$par.index, p2015.ind8$par.index, p2015.ind9$par.index)


## Final for all missed ones that need to be zero
p.indices <- c(p2013.inds,p2014.inds, p2015.inds)
p.values <- rep(0, length(p.indices))


```


## Just use the four occassions when I sampled across all three years  
```{r}

## dataCJS4socc

## Repeated for the three years
obsmodel <- dataCJS4socc %>%
  ungroup()%>%
  distinct(Day,Year,Plot,Site,Tag,encounter, .keep_all = TRUE) %>%
  dplyr::select(c(Site:Tag, encounter, Obs, Year)) %>%
  ## Fill in all tags within a Plot and Site across all years
  mutate(Obs = as.character(Obs)) %>%
  tidyr::complete(nesting(Site,Plot,Tag),Year, encounter, fill = list(Obs = "0")) %>%
  arrange(encounter) %>%
  pivot_wider(names_from = encounter, values_from = Obs, values_fill = "0", names_prefix = "Occ")

plotssurveyed <- table(dataCJS$Plot, dataCJS$encounter, dataCJS$Year)  

## In the design data lists after processing data, set these to zero detection (p)
asmiRD <- obsmodel %>%
  dplyr::mutate(across(Occ1:Occ4, ~ ifelse(.x > 0, 1, .x))) %>%
  tidyr::unite(ch, Occ1:Occ4, sep="") %>%
  dplyr::group_by(Site,Plot,Tag) %>%
  dplyr::mutate(Plot = as.factor(Plot)) %>%
  dplyr::mutate(Site = as.factor(Site)) %>%
  dplyr::summarise(ch = paste0(ch, collapse = "")) %>%
  ungroup()

dmPlot <- model.matrix(~ -1 + Plot, asmiRD)
dmSite <- model.matrix(~ -1 + Site, asmiRD)
dimnames(dmPlot)[[2]][length(dimnames(dmPlot)[[2]])]
dimnames(dmSite)[[2]][length(dimnames(dmSite)[[2]])]

## By Plot
asmiRD %>%
  ungroup() %>%
  dplyr::select(c(ch)) %>%
  bind_cols(dmPlot) %>%
  mutate(Plot614 = paste(Plot614, ";", sep ="")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsPlot4socc.inp", 
              sep = " ", col.names = FALSE, row.names = FALSE)

## By Site
asmiRD %>%
  ungroup() %>%
  dplyr::select(c(ch)) %>%
  bind_cols(dmSite) %>%
  mutate(Site26 = paste(Site26, ";", sep ="")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsSite4socc.inp", 
              sep = " ", col.names = FALSE, row.names = FALSE)


plotdf <- asmiRD %>%
  ungroup()%>%
  dplyr::distinct(Plot)

sitedf <- asmiRD %>%
  ungroup() %>%
  dplyr::distinct(Site)


## 3 primary with 4 secondary each
time.intervals <- c(0,0,0,1,0,0,0,1,0,0,0)

RDproc <- process.data(asmiRDPlot.inp, model = "Robust", begin.time = 2013, groups = "Plot",
                       time.intervals = time.intervals)
RDddl <- make.design.data(RDproc)

plotssurveyed <- table(dataCJS4socc$Plot, dataCJS4socc$encounter, dataCJS4socc$Year)  
pindex <- RDddl$p
cindex <- RDddl$c

p2013.ind3 <- pindex %>%
  filter(session == 2013 & time == 1 & Plot %in% as.numeric(names(plotssurveyed[,1,1])[which(plotssurveyed[,1,1] == 0)])) %>%
  select(par.index)
p2013.ind6 <- pindex %>%
  filter(session == 2013 & time == 2 & Plot %in% as.numeric(names(plotssurveyed[,2,1])[which(plotssurveyed[,2,1] == 0)])) %>%
  select(par.index)
p2013.ind8 <- pindex %>%
  filter(session == 2013 & time == 3 & Plot %in% as.numeric(names(plotssurveyed[,3,1])[which(plotssurveyed[,3,1] == 0)])) %>%
  select(par.index)
p2013.ind10 <- pindex %>%
  filter(session == 2013 & time == 4 & Plot %in% as.numeric(names(plotssurveyed[,4,1])[which(plotssurveyed[,4,1] == 0)])) %>%
  select(par.index)
p2013.inds <- c(p2013.ind3$par.index, p2013.ind6$par.index, p2013.ind8$par.index, p2013.ind10$par.index)


```


# Open Robust Design multi-state with State probabilities   
Assumptions : does not change state during primary session   

model = "ORDMSState"
S(s): survival rate between primary occasions for state s            
Psi(r,s): transitions between states between primary periods from r to state s              
Omega: probability of being in each of the states          
pent(s,t): probability of entry onto study area of state s at time t, prob of entering just prior to last secondary occasion obtained by subtraction. sum(pent) <= 1 using MLogit link function             
Phi(s,t): probability of remaining on the study area of state s at time t (can fix to 1, plants can't move)    
p(s,t): capture probability of animal on study area of state s and time t       

derived parameters: population size for each state and primary session, 2 sets of residence times (not needed for plants when can't do dormancy)    
```{r}



RDopenMSmodeldot <- mark(data = RDproc, ddl = RDddl, model = "ORDMSState",
                      time.intervals = time.intervals,
                      model.parameters = list(S = list(formula = ~ stratum),
                                              Psi = list(formula = ~ stratum),
                                              Omega = list(formula = ~ stratum),
                                              pent = list(formula = ~ 1),
                                              Phi = list(formula = ~1, fixed = 1),
                                              p = list(formula = ~ stratum, fixed = list(index = p.indices, value = p.values))))

head(summary(RDopenMSmodeldot, show.fixed = TRUE))
RDopenMSmodeldot$results$real

Psilist <- get.real(RDopenMSmodeldot, "Psi", vcv = TRUE)
Psivalues <- Psilist$estimates
Psivalues$stratum <- factor(Psivalues$stratum, levels = c("V","R"))
Psivalues$tostratum <- factor(Psivalues$tostratum, levels = c("V","R"))


## split by plot
## shows the rate from year to year that living plants transition from row to column (rows always sum to 1)
transMats <- lapply(plotdf$Plot, function(x){
  TransitionMatrix(Psivalues[Psivalues$time == 2013 & Psivalues$group == x,], vcv.real = Psilist$vcv.real)
})

rowSums(transMats[[1]]$TransitionMat)
## VtoV, RtoV, VtoR, RtoR
sapply(transMats, "[[", 1)
sapply(transMats, "[[", 2)

 
      
RDopenMSmodeldot$results$real %>%
  mutate(ParmsGroupsTime = row.names(RDopenMSmodeldot$results$real )) %>%
  filter(grepl("Psi", ParmsGroupsTime )) %>%
  separate(ParmsGroupsTime, into = c("Parm", "strata", "tostrata", "group", "cohort", "age", "year")) %>%
  # distinct(estimate, se, lcl, ucl) %>%
ggplot( aes(strata, estimate, color = tostrata)) +
  geom_point() +
  geom_errorbar(aes(ymin = lcl, ymax = ucl))+
  theme_bw()+
  scale_color_manual("Transition", values = c("black","grey60"))

RDopenMSmodeldot$results$real %>%
  mutate(ParmsGroupsTime = row.names(RDopenMSmodeldot$results$real )) %>%
  filter(grepl("Omega", ParmsGroupsTime )) %>%
  # separate(ParmsGroupsTime, into = c("Parm", "strata", "group", "age", "year")) %>%
  distinct(estimate,lcl,ucl)
 

RDopenMSmodeldot$results$real %>%
  mutate(ParmsGroupsTime = row.names(RDopenMSmodeldot$results$real )) %>%
  filter(grepl("p", ParmsGroupsTime )) %>%
  filter(!grepl("pent", ParmsGroupsTime)) 

RDopenMSmodeldot$results$real %>%
  distinct(estimate,lcl,ucl)


RDopenMSmodeldot$results$derived$`N Population Size` ## of the 29 plots, each year (3), for Veg and Rep

```


stratum:time for both, but over three years, don't let vary over time

```{r}

RDopenMSmodeltime <- mark(data = RDproc, ddl = RDddl, model = "ORDMSState",
                      time.intervals = time.intervals,
                      model.parameters = list(S = list(formula = ~ stratum),
                                              Psi = list(formula = ~ stratum),
                                              Omega = list(formula = ~ stratum),
                                              pent = list(formula = ~ stratum),
                                              Phi = list(formula = ~ 1, fixed = 1),
                                              p = list(formula = ~ stratum, fixed = list(index = p.indices, value = p.values))))

Psilisttime <- get.real(RDopenMSmodeltime, "Psi", vcv = TRUE)
Psivaluestime <- Psilisttime$estimates

head(summary(RDopenMSmodeltime))

p1 <- RDopenMSmodeltime$results$real %>%
  # distinct(estimate,lcl,ucl) %>%
  mutate(dats = row.names(.)) %>%
  mutate(dats = gsub(" to", "to",dats)) %>%
  separate(dats, into = c("Parameter", "stage")) %>%
  filter(estimate != 0) %>%
  filter(Parameter != "Phi") %>%
  ggplot(  aes(estimate, Parameter, color = stage))+
  geom_point() +
  geom_errorbar(aes(xmin = lcl, xmax = ucl, width = 0.2))+
  theme_bw()+
  ylab("")+
  scale_color_manual("Stage", values = c("black","black","grey70","grey70"), 
                     labels = c("Reproductive", "R to V", "Vegetative", "V to R"))

  ggsave(p1, filename = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter AsMi/Images/ORDMSStateresults.jpg",
         width=200, height=100,units='mm', dpi=300 )

  
RDopenMSmodeltime$results$real %>%
  distinct(estimate,se,lcl,ucl)

```


Model: Robust Design Pradel Lambda Closed Population Estimation  "RDPdlClosed"

```{r}

```




model = "RDHuggins" for Huggins Random emigration, p=c varies by time and session; S by time
```{r}

# run.robust <- function(){
  ## 3 primary sessions with secondary sessions all of length 10 ("." for missing surveys)
  
  ## Random emigration - sure, well,... p=c varies by time and session
  S.time=list(formula=~1)
  p.time.session=list(formula=~ 1, # share=TRUE,  ## TRUE means c and p share same columns of design matrix, can't have fixed and share == TRUE
                      fixed = list(index = p.indices,
                      value = p.values))
  ## fix Fidelity to 1 for all
  ## fix gamma to zero
  GammaDoublePrime.random=list(formula=~1,share=TRUE)   ## return rate - not available for detection, dormant
  model.1=mark(data = RDproc, ddl = RDddl, model = "Robust", 
               time.intervals=time.intervals,
               model.parameters=list(S=S.time,
                                     # GammaDoublePrime=GammaDoublePrime.random,
                                     p=p.time.session))
  ## gammaprime: unobservable to unobservable
  ## gammadoubleprime:observable to unobservable; (1-gammadoubleprime) == was above ground last time and above ground this time
  ## gammadoubleprime == temporary emmigration
  
  ## I assume RDHet is for p != c heterogeneity or just that they vary among???
  # pi.dot=list(formula=~1)
  # p.session.mixture=list(formula=~session+mixture, # share=TRUE, 
  #                     fixed = list(index = p.indices,
  #                     value = p.values))
  # model.2.b=mark(data = RDproc, ddl = RDddl, model = "RDHet", 
  #             time.intervals=time.intervals,
  #             model.parameters=list(S=S.time,
  #                                   GammaDoublePrime=GammaDoublePrime.random,
  #                                   p=p.session.mixture,
  #             pi=pi.dot))
  
  
  
#   return(collect.models())
# }

RDresults <- run.robust()
RDresults

model.1$results$real

```

<https://cran.r-project.org/web/packages/RMark/RMark.pdf> 
```{r, eval=FALSE}
# robust with strata  
process.data(data, model = "CRDMS", time.interval = t.int, strata.labels = c("V","R")
## Shange Psi parameters that are obtained by subtraction
    # something like:
asmi.ddl <- make.design.data(asmi.proc, parameters = list(Psi = list(subtract.stratum = c("V","V"))))
  # create grouping index for unobserved p and c (always zero)
asmi.ddl$p$fix = ifelse(asmi.ddl$p$stratum == "U",0,NA)  ## if one state is unobservable
asmi.ddl$c$fix = ifelse(asmi.ddl$p$stratum == "U",0,NA)  ## if one state is unobservable


```
