---
title: "Multistate CJS for annual analysis"
output: html_document
date: "2024-10-28"
---


```{r}
library(RMark)
library(dplyr)
library(tidyr)
library(patchwork)
library(ggplot2)
```


```{r}
currentyr <- as.numeric(format(as.Date(Sys.Date(),format="%Y-%m-%d"), "%Y"))

##To change if someone other than Michelle is running code
userpath <- "C:/Users/DePrengm/"

rawdatapath <- paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/", currentyr, "_Astragalus-microcymbus_RawData.csv", collapse = '', sep = '')

asmi.raw <- read.csv(rawdatapath, na.strings = "na")

# need to remove all plot 89, site 1 in 2020 and beyond
asmi.raw <- asmi.raw[!(asmi.raw$AsMi_plot_id == 89 & asmi.raw$year > 2019),]


# For the path and start of the name of each file
savepath <- paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_AnnualReports/", currentyr, "_Astragalus-microcymbus_AnnualReport/", collapse = '', sep = '')

# Need to change all the seedling in 2014 for sites 1 and 2 to appropriate vegetative or reproductive 
asmi.raw$status[asmi.raw$AsMi_site_id<3 & asmi.raw$year == 2014 & asmi.raw$flower == 0] <- "vegetative"
asmi.raw$status[asmi.raw$AsMi_site_id<3 & asmi.raw$year == 2014 & asmi.raw$flower == 1] <- "reproductive"

# No longer adding climate data to the database
asmi.raw <- asmi.raw[,grep(paste(c("Temp","Rain","Snow","Aug.Jul"),collapse="|"), names(asmi.raw),
                           value = TRUE, invert = TRUE)]

asmi.raw$Browsing...Status[asmi.raw$Browsing...Status == "mammal" ] <- "Mammal"
asmi.raw$status <- factor(asmi.raw$status)
asmi.raw$length[asmi.raw$length == 921] <- 21

# If there are fruit, it flowered and needs to be reproductive, not vegetative
asmi.raw[asmi.raw$status=="vegetative" & asmi.raw$fruit>0,] # 5 times in 2020
wrongAsMidataid <- asmi.raw$AsMi_data_id[asmi.raw$status=="vegetative" & asmi.raw$fruit>0]
asmi.raw$flower[asmi.raw$AsMi_data_id %in% wrongAsMidataid] <- 1
asmi.raw$status[asmi.raw$AsMi_data_id %in% wrongAsMidataid] <- "reproductive"

asmi.raw <- asmi.raw %>%
  mutate(status = as.character(status)) %>%
  dplyr::mutate(status = case_when((AsMi_tag_id == 2551 & year == 2015) ~ "vegetative",
                            TRUE ~ status)) %>%
  mutate(status = as.factor(status))

## Add Creek

asmi.raw$Creek <- "SouthBeaver"
asmi.raw$Creek[asmi.raw$AsMi_site_id < 3] <- "Cebolla" 
asmi.raw$Creek <- as.factor(asmi.raw$Creek)

```



Multi-state model   
```{r}
load("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/asmi.all2.Rdata") 



CJS_asmi <- asmi.raw %>%
  filter(!is.na(year)) %>%  
  dplyr::select(c(AsMi_tag_id:status,AsMi_plot_id:fence,Creek)) %>%
  group_by(AsMi_tag_id) %>%
  filter(any(length > 0)) %>%
  mutate(first.cap.stage = status[which.min(year[length>0])]) %>%
  ungroup() %>%
  mutate(Obs = case_when(status %in% c("seedling","vegetative") ~ "V",
                         status == "reproductive" ~ "R",
                         status %in% c("dormant","dead") ~ "0")) %>%
  arrange(year) %>%
  mutate(Obs = as.character(Obs)) %>%
  pivot_wider(names_from = year, values_from = Obs, values_fill = "0", names_prefix = "Year", 
              id_cols = c(AsMi_tag_id,AsMi_site_id,AsMi_plot_id, fence,first.cap.stage, Creek)) %>%
  ### UPDATE TO CURRENT YEAR ######
  unite(ch, Year1995:Year2024, sep ="") %>%
  mutate(Tag = as.factor(AsMi_tag_id),
         Site = as.factor(AsMi_site_id),
         Plot = as.factor(AsMi_plot_id),
         Creek = as.factor(Creek)) %>%
  relocate(Creek, .after = Plot) %>%
  filter((grepl("R",ch) | grepl("V",ch)))


# Any factor is a group variable, any numeric can be a covariate
plotSiteCreek <- CJS_asmi %>%
  distinct(Plot,Site,Creek)
dmPlot <- model.matrix(~ -1 + Plot, CJS_asmi)
dmSite <- model.matrix(~ -1 + Site, CJS_asmi)
dmCreek <- model.matrix(~ -1 + Creek, CJS_asmi)
dimnames(dmCreek)[[2]][length(dimnames(dmCreek)[[2]])] ## CreekSouthBeaver


## Need to split by plot because different time frames and different times having fencing
plotdf <- CJS_asmi %>%
  distinct(Plot)
dmPlot <- model.matrix(~ -1 + Plot, CJS_asmi)
dimnames(dmPlot)[[2]][length(dimnames(dmPlot)[[2]])]

CJS_asmi %>%
  dplyr::select(ch) %>%
  bind_cols(dmPlot) %>%
  mutate(Plot799 = paste(Plot799, ";", sep = "")) %>%
   ### FOR DBG0077
  write.table(file = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/Multi_asmi_mark.inp",sep = " ",
  # write.table(file = paste(savepath, "Multi_asmi_mark.inp", sep = ""), sep = " ",
              col.names = FALSE, row.names = FALSE)

asmiMulti <- convert.inp(
  "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/Multi_asmi_mark.inp",
  # paste(savepath, "Multi_asmi_mark.inp", sep = ""),
                        group.df = plotdf,
                        covariates = NULL,
                        use.comments = FALSE)

## By plot, needed since plots have different lengths 
asmiMulti.proc <- process.data(asmiMulti, begin.time = 1995, model = "Multistrata", groups = "Plot")
asmiMulti.ddl <- make.design.data(asmiMulti.proc)
```


If want to get estimates by Site or Creek, need to add this
```{r}
# Add groups
asmiMulti.ddl$S <- asmiMulti.ddl$S %>%
  mutate(Site = case_when(Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 1] ~ 1,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 2] ~ 2,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 5] ~ 5,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 15] ~ 15,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 19] ~ 19,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 26] ~ 26)) %>%
  mutate(Site = as.factor(Site)) %>%
  mutate(Creek = case_when(Plot %in% plotSiteCreek$Plot[plotSiteCreek$Creek == "SouthBeaver"] ~ "SouthBeaver",
                           Plot %in% plotSiteCreek$Plot[plotSiteCreek$Creek == "Cebolla"] ~ "Cebolla")) %>%
  mutate(Creek = as.factor(Creek))

asmiMulti.ddl$p <- asmiMulti.ddl$p %>%
  mutate(Site = case_when(Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 1] ~ 1,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 2] ~ 2,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 5] ~ 5,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 15] ~ 15,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 19] ~ 19,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 26] ~ 26)) %>%
  mutate(Site = as.factor(Site)) %>%
  mutate(Creek = case_when(Plot %in% plotSiteCreek$Plot[plotSiteCreek$Creek == "SouthBeaver"] ~ "SouthBeaver",
                           Plot %in% plotSiteCreek$Plot[plotSiteCreek$Creek == "Cebolla"] ~ "Cebolla")) %>%
  mutate(Creek = as.factor(Creek))
asmiMulti.ddl$Psi <- asmiMulti.ddl$Psi %>%
  mutate(Site = case_when(Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 1] ~ 1,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 2] ~ 2,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 5] ~ 5,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 15] ~ 15,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 19] ~ 19,
                          Plot %in% plotSiteCreek$Plot[plotSiteCreek$Site == 26] ~ 26)) %>%
  mutate(Site = as.factor(Site)) %>%
  mutate(Creek = case_when(Plot %in% plotSiteCreek$Plot[plotSiteCreek$Creek == "SouthBeaver"] ~ "SouthBeaver",
                           Plot %in% plotSiteCreek$Plot[plotSiteCreek$Creek == "Cebolla"] ~ "Cebolla")) %>%
  mutate(Creek = as.factor(Creek))

```
    
```{r}
# Which sites/plots were fenced when; when Open == 1, when fenced == 0; switched back, that didn't fix it
PlotSiteYrFence <- asmi.all2 %>%
  distinct(year,plot,site,fenced)
### Use PlotSiteYrFence to specify years when a plot was fenced
PlotSiteYrFence %>%
  filter(fenced == "y")
## Time varying fencing; as a dummy variable, not a factor
asmiMulti.ddl$S$fence <- ifelse(asmiMulti.ddl$S$time %in% PlotSiteYrFence$year[PlotSiteYrFence$fenced == "y"] &
                                  asmiMulti.ddl$S$Plot %in% PlotSiteYrFence$plot[PlotSiteYrFence$fenced == "y"],1,0)
asmiMulti.ddl$S$fence <- as.factor(asmiMulti.ddl$S$fence) ## Should be numeric, and it is.

asmiMulti.ddl$Psi$fence <- ifelse(asmiMulti.ddl$Psi$time %in% PlotSiteYrFence$year[PlotSiteYrFence$fenced == "y"] &
                                  asmiMulti.ddl$Psi$Plot %in% PlotSiteYrFence$plot[PlotSiteYrFence$fenced == "y"],1,0)
asmiMulti.ddl$Psi$fence <- as.factor(asmiMulti.ddl$Psi$fence)

asmiMulti.ddl$p$fence <- ifelse(asmiMulti.ddl$p$time %in% PlotSiteYrFence$year[PlotSiteYrFence$fenced == "y"] &
                                  asmiMulti.ddl$p$Plot %in% PlotSiteYrFence$plot[PlotSiteYrFence$fenced == "y"],1,0)
asmiMulti.ddl$p$fence <- as.factor(asmiMulti.ddl$p$fence)


### Need to note, no surveys for some plots 1995, before 2004, before 2014, and after 2019
# i.e. fix indices as detection == 0 on occasions where there were no observations

# ps.asmi <- ps.asmi[!(ps.asmi$Plot == 89 & ps.asmi$Year > 2019),]
# ps.asmi <- ps.asmi[!(ps.asmi$Site < 3 & ps.asmi$Year < 2014),]
# ps.asmi <- ps.asmi[!(ps.asmi$Plot == 598 & ps.asmi$Year < 2004),]
# ps.asmi <- ps.asmi[!(ps.asmi$Plot == 300 & ps.asmi$Year < 1996),]
# ps.asmi <- ps.asmi[!(ps.asmi$Plot == 238 & ps.asmi$Year < 1996),]

## Should this have been time?! not cohort?? No, cohort and time 
plotsSite <- CJS_asmi %>%
  distinct(Plot,Site)
pindex <- asmiMulti.ddl$p 
p.idAddedlater <- pindex %>%
  mutate(cohort = as.numeric(as.character(cohort))) %>%
  mutate(group = as.numeric(as.character(group))) %>%
  ## Added in 2004 %in% c(598), added in 1996 %in% c(300,238)
  filter((group %in% c(598) & cohort < 2004))
p.idAdded1996 <- pindex %>%
  mutate(cohort = as.numeric(as.character(cohort))) %>%
  mutate(group = as.numeric(as.character(group))) %>%
  ## Added in 2004 %in% c(598), added in 1996 %in% c(300,238)
  filter((group %in% c(300,238) & cohort < 1996))  
p.Cebolla <- pindex %>%
  mutate(cohort = as.numeric(as.character(cohort))) %>%
  mutate(group = as.numeric(as.character(group))) %>%
  filter((group %in% c(1,22,32,42,52,16,58,89,90,96,98) & 
            cohort < 2013))
## Need to stop at '2018'to 2019 because no 2020
p.Cebolla89 <- pindex %>%
  mutate(cohort = as.numeric(as.character(cohort))) %>%
  mutate(group = as.numeric(as.character(group))) %>%
  filter((group %in% c(89) & 
            cohort >= 2019))
## None of them will be 2024 because it's going into 2024, need to be the 2023? And get rid of the '2024' to 2025
p.Cebolla.missing2024 <- pindex %>%
  mutate(cohort = as.numeric(as.character(cohort))) %>%
  mutate(group = as.numeric(as.character(group))) %>%
  filter((group %in% c("52") &
            cohort %in% c(2024)))
p.Cebolla.missing2024_time <- pindex %>%
  mutate(cohort = as.numeric(as.character(cohort))) %>%
  mutate(group = as.numeric(as.character(group))) %>%
  filter((group %in% c(52) & time %in% c("2024")))
  
## Fixed indices
p.indices <- 
  unique(c(p.idAdded1996$par.index, p.idAddedlater$par.index,
               p.Cebolla$par.index, p.Cebolla89$par.index,
               p.Cebolla.missing2024$par.index,p.Cebolla.missing2024_time$par.index))
p.values <- rep(0, length(p.indices))
## 10 repeats
length(p.indices) -
length(unique(p.indices))

## All the plot 52 in 2024 times! Oh, from the ones where the cohort was 1995:2012 (which is through year 2013)
## Added unique above to fix
pindex %>%
  filter(par.index %in% p.indices[which(duplicated(p.indices))])

# nest tostratum within stratum and fence within tostratum
## Make a function to compare multiple models

## First check best model for detection 
multi.asmi <- function(){
  S.dot = list(formula = ~1)
  # S.time = list(formula = ~ time)
  # S.fence = list(formula = ~ fence)
  # S.creek = list(formula = ~ Creek)
  # S.creektime = list(formula = ~ Creek + time)
  # S.fence = list(formula = fence + time)
  # S.fenceCreek = list(formula = ~ fence + Creek)
  
  p.dot = list(formula = ~1,
               fixed = list(index = p.indices, value = p.values))
  p.time = list(formula = ~ time,
               fixed = list(index = p.indices, value = p.values))
  p.fence = list(formula = ~ -1 + fence,
               fixed = list(index = p.indices, value = p.values))
  p.creek = list(formula = ~ -1 + Creek,
               fixed = list(index = p.indices, value = p.values))
  p.creektime = list(formula = ~ -1 + Creek + time,
               fixed = list(index = p.indices, value = p.values))
  ## This one ended up as ~ -1 + fence:time
  p.fence = list(formula = -1 + fence + time,
               fixed = list(index = p.indices, value = p.values))
  # p.fenceCreek = list(formula = ~ fence + Creek,
  #              fixed = list(index = p.indices, value = p.values))
  p.strata = list(formula = ~ -1 + stratum,
               fixed = list(index = p.indices, value = p.values))
  p.stratafence = list(formula = ~ -1 + stratum:fence,
               fixed = list(index = p.indices, value = p.values))
  p.stratafenceCreek = list(formula = ~ -1 + stratum:fence:Creek,
               fixed = list(index = p.indices, value = p.values))
  
  Psi.dot = list(formula = ~1)
  # Psi.time = list(formula = ~ time)
  # Psi.fence = list(formula = ~ fence)
  # Psi.creek = list(formula = ~ Creek)
  # Psi.creektime = list(formula = ~ Creek + time)
  # Psi.fence = list(formula = fence + time)
  # Psi.fenceCreek = list(formula = ~ fence + Creek)
  
  asmi.model.list <- create.model.list("Multistrata")
  asmi.results <- mark.wrapper(asmi.model.list, 
                               data = asmiMulti.proc, 
                               ddl = asmiMulti.ddl)
  
  return(asmi.results)
}

asmi.modelsMulti <- multi.asmi()

save(asmi.modelsMulti, file = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/multimarkDetection2024.rdata")


asmi.modelsMulti$model.table

###### Need fencing in all and stratum in all. Detection of reproductive will be different than vegetative
multi.mark2 <- mark(asmiMulti.proc, asmiMulti.ddl, begin.time = 1995, model = "Multistrata",
                   model.parameters = list(S = list(formula = ~ -1 + stratum:fence),
                                           p = list(formula = ~ -1 + stratum:fence,
                                                    fixed = list(index = p.indices, value = p.values)),
                                           Psi = list(formula = ~ -1 + stratum:tostratum:fence)))

save(multi.mark2, file = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/multimarkStratumFence2024.rdata")

multi.mark.nofence <- mark(asmiMulti.proc, asmiMulti.ddl, begin.time = 1995, model = "Multistrata",
                   model.parameters = list(S = list(formula = ~ 1),
                                           p = list(formula = ~ 1,
                                                    fixed = list(index = p.indices, value = p.values)),
                                           Psi = list(formula = ~ -1 + stratum:tostratum)))

## To save from DBG0077
save(multi.mark.nofence, file = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/multimarkNoFence2024.rdata")


## Look at Fletcher c-hat in section 5.8 Chapter 5
## c-hat greater than 1 means overdispersion, variation from age or stage that isn't in the model
```


x:y means that nests y within x, so for a given x, what is the y. So should probably have time:fence, not the fence first. and stratum:Creek:fence   
Not all plots (or Creek) or year, have fence, so that should be the last one.  
Let's see if it makes a difference   
```{r}
## First check best model for detection 
multi.asmi.v2 <- function(){
  S.dot = list(formula = ~1)
  
  p.dot = list(formula = ~1,
               fixed = list(index = p.indices, value = p.values))
  p.strata = list(formula = ~ -1 + stratum,
               fixed = list(index = p.indices, value = p.values))
  p.time = list(formula = ~ time,
               fixed = list(index = p.indices, value = p.values))
  p.fence = list(formula = ~ -1 + fence,
               fixed = list(index = p.indices, value = p.values))
  p.creek = list(formula = ~ -1 + Creek,
               fixed = list(index = p.indices, value = p.values))
  p.creektime = list(formula = ~ -1 + Creek + time,
               fixed = list(index = p.indices, value = p.values))
  ## This is the one that ended up as -1 + fence:time when written as: -1 + fence + time
  p.fencetime = list(formula = ~ -1 + time:fence,
               fixed = list(index = p.indices, value = p.values))
  p.stratacreek = list(formula = ~ -1 + strata:Creek,
               fixed = list(index = p.indices, value = p.values))
  p.stratatime = list(formula = ~ -1 + strata:time,
               fixed = list(index = p.indices, value = p.values))
  p.stratafencetime = list(formula = ~ -1 + strata:time:fence,
               fixed = list(index = p.indices, value = p.values))
  p.stratafence = list(formula = ~ -1 + stratum:fence,
               fixed = list(index = p.indices, value = p.values))
  p.stratafenceCreek = list(formula = ~ -1 + stratum:Creek:fence,
               fixed = list(index = p.indices, value = p.values))
  
  Psi.dot = list(formula = ~1)
  
  asmi.model.list <- create.model.list("Multistrata")
  asmi.results <- mark.wrapper(asmi.model.list, 
                               data = asmiMulti.proc, 
                               ddl = asmiMulti.ddl)
  
  return(asmi.results)
}

asmi.modelsMulti.v2 <- multi.asmi.v2()

save(asmi.modelsMulti.v2, file = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/multimarkDetection2024.rdata")

```



```{r}

## Would need time for year when the climate was and can add climate variables
foo <- asmiMulti.ddl
foo$p <- merge_design.covariates(foo$p, plotSiteCreek)

load("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/multimarkNoFence2024.rdata")
multi.mark.nofence$results$beta


## multi.mark
load("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/multimarkFence2024.rdata")
multi.mark$results$real %>%
  distinct()

```



## If do site all together, need to split out into sites with similar length surveys
```{r}
sitedf <- CJS_asmi %>%
  distinct(Site)
dmSite <- model.matrix(~ -1 + Site, CJS_asmi)
dimnames(dmSite)[[2]][length(dimnames(dmSite)[[2]])]

CJS_asmi %>%
  dplyr::select(ch) %>%
  bind_cols(dmSite) %>%
  mutate(Site26 = paste(Site26, ";", sep = "")) %>%
  write.table(file = paste(savepath, "Multi_asmi_mark_site.inp", sep = ""), sep = " ", 
              col.names = FALSE, row.names = FALSE)

asmiMultisite <- convert.inp(paste(savepath, "Multi_asmi_mark_site.inp", sep = ""), 
                        group.df = sitedf,
                        covariates = NULL,
                        use.comments = FALSE)


asmiMultisite


```











```{r}
load("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/2024_forDBG0077/multimarkDetection2024.rdata")

asmi.modelsMulti.v2$model.table
# Oy, detection changes with each year, that's not super useful.

```


## Really, detection should depend on observers - but we have so many different people, didn't record well who did what, we semi-changed the strategy of digging around with metal detector or just digging in the dirt to find every tag. As plants died, tags might not mean there is a plant so we switched to looking for plants, then figuring out which tag they are associated with... So maybe time is a good proxy for 'trap' measures.   


