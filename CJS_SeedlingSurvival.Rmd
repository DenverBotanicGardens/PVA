---
title: "CJS seedling survival model"
author: "Michelle DePrenger-Levin"
date: "2023-09-12"
output: html_document
---
```{r}
rm(list=ls())
# library(rjags)
library(dplyr)
library(tidyr)
library(ggplot2)
# library(R2jags) ## jags
# library(R2WinBUGS)

```


#Intraannual visits
### Intraannual visits    
Will want to ignore sites that were not visited - deal with differently than plants that were not seen but are also NA      
### What is the most common stage class of individuals that were dormant for some portion of the growing season? 
2013
```{r}
intra.2013June <- read.csv("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_RawData/2013/AsMiJuly2013.csv")

intra.2013July <- read.csv("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_RawData/2013/AsMiJune2013.csv")

intra.2013Sept <- read.csv("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_RawData/2013/September2013.csv")

intra.2013October <- read.csv("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_RawData/2013/AsMiOctober2013.csv")




```

Reformat multiseason visits to Schaub Kery 2022 pg 163-166
Want date of first 

  # rename_with(.cols = Lngth13:Comments13, .fn = ~ paste0(.x, "_2013-07-14")) %>%
```{r}
## In July visited all four sites, all plots
intra.2013July <- intra.2013July %>%
  mutate(Day = as.POSIXlt(as.Date("2013-07-14"))$yday)

intra.2013July %>%
  tidyr::complete(Day, nesting(Site,Plot,Tag), fill = list(Lngth13 = 0, Fl13 = 0, Fr13 = 0, Br13 = 0)) %>%
  group_by(Site, Plot) %>%
  dplyr::summarise(K.Plot = n_distinct(Day))

## In June, did not visit Site 19, and not plot 598 or 614 (site 26) 
intra.2013June <- intra.2013June %>%
  dplyr::mutate(Day = as.POSIXlt(as.Date("2013-06-03"))$yday)

## Has past years data
intra.2013Sept1 <- intra.2013Sept %>%
  dplyr::select(names(intra.2013July)[-c(1,length(intra.2013July))]) %>%
  dplyr::mutate(Day = as.POSIXlt(as.Date("2013-09-05"))$yday) %>%
  dplyr::mutate(Site = case_when(Plot %in% c(606,607,608,609,610) ~ 5,
                          Plot %in% c(512,513,514,515,300) ~ 19,
                          Plot %in% c(238, 480,611,614,598) ~ 26,
                          Plot %in% c(8,578,581,799) ~ 15)) %>%  ## 578? there is no 568
  relocate(Site, .before = Tag)

## No site 15
intra.2013October <- intra.2013October %>%
  dplyr::mutate(Day = as.POSIXlt(as.Date("2013-10-15"))$yday) 

intra.2013 <- do.call(rbind, list(intra.2013June, intra.2013July, intra.2013Sept1, intra.2013October))
unique(intra.2013$Day)

## Some form of complete to give a zero when a tag was alive sometime that year but not seen in a survey  
## Need to fill in 581 even though no plants ever found except once
intra.2013complete <- intra.2013 %>%
  tidyr::complete(Day, nesting(Site, Plot, Tag), fill = list(Lngth13 = 0, Fl13 = 0, Fr13 = 0, Br13 = 0)) %>%
  filter(!(Plot %in% c(598, 614) & Day == unique(intra.2013$Day)[1])) %>%
  filter(!(Site == 19 & Day == unique(intra.2013$Day)[1])) %>%
  filter(!(Site == 15 & Day == unique(intra.2013$Day)[4]))

intra.2013 %>%
  filter(grepl("coty",Comments13))

rm(intra.2013July); rm(intra.2013June); rm(intra.2013Sept); rm(intra.2013Sept1); rm(intra.2013October)

ggplot(intra.2013, aes(Day, Tag)) +
  geom_point()

```

"NOPE" is probably a cotyledon that wasn't AsMi, could be wasn't included in annual? I don't know, Maybe nope is no cotyledons
```{r}
intra.2014_2015 <- read.csv("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_RawData/2015 datasheets/2014-15_intrayear_asmi_2.csv")

intra.2014_2015 %>%
  filter(Tag == "")

## None are missing
intra.2014_2015 %>%
  filter(tag == "")

## some are NA
intra.2014_2015 %>%
  filter(is.na(tag))

## Assign row number as tag number for those missing a tag
intra.2014_2015$tag[is.na(intra.2014_2015$tag)] <- which(is.na(intra.2014_2015$tag))


intra.2014_2015 <- intra.2014_2015 %>%
  mutate(Site = case_when(Plot.1 %in% c(606,607,608,609,610) ~ 5,
                          Plot.1 %in% c(512,513,514,515,300) ~ 19,
                          Plot.1 %in% c(238, 480,611,614,598) ~ 26,
                          Plot.1 %in% c(8,578,581,799) ~ 15,
                          Plot.1 %in% c(1,22,32,42,52) ~ 1,
                          Plot.1 %in% c(16,58,89,90,96,98) ~ 2)) %>%
  filter(!is.na(Site))

table(intra.2014_2015$Site, useNA = "always")

intraApril2014 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnAprl14:CommentsApr14)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-04-21"))$yday) %>%
  mutate(Year = 2014) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraMay2014 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnMay12:Comments)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-05-12"))$yday) %>%
  mutate(Year = 2014) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraMay2014 %>%
  filter(LnMay12 > 0)

intraJune22014 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnJun14:Comments.1)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-06-02"))$yday) %>%
  mutate(Year = 2014) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraJune252014 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnJun214:Comments.2)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-06-25"))$yday) %>%
  mutate(Year = 2014) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraJul2014 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnJul14:Comments.3)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-07-15"))$yday) %>%
  mutate(Year = 2014) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraAug2014 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnAug14:Comments.4)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-08-05"))$yday) %>%
  mutate(Year = 2014) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraSept2014 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnSep14:Comments.5)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-09-16"))$yday) %>%
  mutate(Year = 2014) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraOct2014 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnOct14:Comments.6)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-10-07"))$yday) %>%
  mutate(Year = 2014) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraOct282014 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnOct2814:Comments.7)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-10-28"))$yday) %>%
  mutate(Year = 2014) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraApril2015 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnApr20_15:Comments.8)) %>%
  mutate(Day = as.POSIXlt(as.Date("2015-04-20"))$yday) %>%
  mutate(Year = 2015) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraMay112015 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnMay11_15:Comments.9)) %>%
  mutate(Day = as.POSIXlt(as.Date("2015-05-11"))$yday) %>%
  mutate(Year = 2015) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraMay262015 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnMay26_15:comments)) %>%
  mutate(Day = as.POSIXlt(as.Date("2015-05-26"))$yday) %>%
  mutate(Year = 2015) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraJune8112015 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnJune8_15:comments.1)) %>%
  mutate(Day = as.POSIXlt(as.Date("2015-06-08"))$yday) %>%
  mutate(Year = 2015) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraJune222015 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnJune22.24:comments.2)) %>%
  mutate(Day = as.POSIXlt(as.Date("2015-06-22"))$yday) %>%
  mutate(Year = 2015) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraJuly2015 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnJuly20.23_15:comments.3)) %>%
  mutate(Day = as.POSIXlt(as.Date("2015-07-22"))$yday) %>%
  mutate(Year = 2015) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraAugust2015 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnAug12.14_15:comments.4)) %>%
  mutate(Day = as.POSIXlt(as.Date("2015-08-12"))$yday) %>%
  mutate(Year = 2015) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraSept2015 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnSept1.3_15:comments.5)) %>%
  mutate(Day = as.POSIXlt(as.Date("2015-09-01"))$yday) %>%
  mutate(Year = 2015) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

intraOct2015 <- intra.2014_2015 %>%
  dplyr::select(c(Site,Plot.1,tag,LnOct6.8_15:comments.6)) %>%
  mutate(Day = as.POSIXlt(as.Date("2015-10-06"))$yday) %>%
  mutate(Year = 2015) %>%
  dplyr::rename(Plot = Plot.1) %>%
  relocate(Site, .before = tag)

surveys <- list(intraApril2014,
                intraMay2014,
                intraJune22014, intraJune252014, intraJul2014, 
                intraAug2014, intraSept2014, intraOct2014, intraOct282014,
                intraApril2015, intraMay112015, intraMay262015, intraJune8112015, intraJune222015, intraJuly2015, 
                intraAugust2015, intraSept2015, intraOct2015)

for(i in 1:length(surveys)){ 
  names(surveys[[i]]) <- c("Plot","Site","Tag","Ln","Fl","Fr","Br","Comments","Day","Year")
}

## intra.2013 is Site, Tag, Plot, Ln, Fl, Fr, Br, Comments, Day

intra20142015 <- do.call(rbind, surveys)
rm(intra.2014_2015);rm(intraApril2014);rm(intraApril2015);rm(intraMay112015);rm(intraMay2014);rm(intraMay262015);
rm(intraJune22014);rm(intraJul2014);rm(intraJuly2015);rm(intraJune222015);rm(intraJune252014);rm(intraJune8112015)
rm(intraAug2014);rm(intraAugust2015);rm(intraSept2014);rm(intraSept2015);rm(intraOct2014);rm(intraOct2015);rm(intraOct282014);


```


Make correct format for CJS and export   
Wants the number of encounter occasions which differ by individual (by plot)
```{r}
intra.2013complete <- intra.2013complete %>%
  mutate(Year = 2013) %>%
  relocate(Year, .after = Day) 

intra20142015 <- intra20142015 %>%
  relocate(Year, .before = Plot) %>%
  relocate(Day, .before = Year) %>%
  filter(!is.na(Ln)) %>%
  relocate(Site, .before = Plot)

intra20142015[is.na(intra20142015$Tag),] ## none have no tag number. 

names(intra.2013complete) <- names(intra20142015)
intra <- do.call(rbind, list(intra.2013complete, intra20142015))

## Get rid of "no cotyledons"
intra$Comments[grep("no coty", intra$Comments)] <- ""
intra$Comments[grep("coty", intra$Comments)]

## Which occasions match year to year??
## split by 10 periods, 
# 2013:     3,    6,  8,  10
# 2014: 1,2,3,  5,6,7,8,9,10
# 2015: 1,2,3,4,5,6,7,8,9

## So few were recorded in May 2014
## When removed May 2014
# 2013:     3,    6,  8,  10
# 2014: 1,  3,  5,6,7,8,9,10
# 2015: 1,2,3,4,5,6,7,8,9


ggplot(intra, aes(Day, as.factor(Plot), color = as.factor(Year), #shape = as.factor(Year), 
                  label = Day)) +
  # geom_jitter(width = 0)+
  geom_point()+
  geom_text(hjust = 0, nudge_x = 0.05, size = 3)+
  geom_vline(xintercept = c(115,135,155,169,187,210,235,260,285))+
  theme_bw() +
  facet_wrap(~Year, nrow = 3)+
  ylab("Plot")+
  scale_color_discrete(guide = 'none')

mean(diff(c(115,135,155,169,187,210,235,260,285))) ## Call them 21 days apart, so time interval is 0 until switch over to year

## Want the time varying covariates to have base = parameter name, suffix = julien day
## Add length at first capture

encounters <- intra %>%
  group_by(Year) %>%
  mutate(encounter = as.numeric(as.factor(Day)))
table(encounters$encounter, encounters$Day)


## Seedling == 2
## Reproductive == 3
## Vegetative == 1
## Not seen == 0
dataCJS <- intra %>%
  group_by(Year) %>%
  mutate(encounter = as.numeric(as.factor(Day))) %>%
  ungroup()%>%
  ## Without May 2014
  # mutate(encounter = case_when(Year == 2013 & encounter == 1 ~ 3,
  #                              Year == 2013 & encounter == 2 ~ 6,
  #                              Year == 2013 & encounter == 3 ~ 8,
  #                              Year == 2013 & encounter == 4 ~ 10,
  #                              Year == 2014 & encounter == 2 ~ 3,
  #                              Year == 2014 & encounter > 2 ~ encounter+2,
  #                              TRUE ~ encounter)) %>%
  ## With May 2014
  # mutate(encounter = case_when(Year == 2013 & encounter == 1 ~ 3,
  #                              Year == 2013 & encounter == 2 ~ 6,
  #                              Year == 2013 & encounter == 3 ~ 8,
  #                              Year == 2013 & encounter == 4 ~ 10,
  #                              Year == 2014 & encounter > 3 ~ encounter+1,
  #                              TRUE ~ encounter)) %>%
  mutate(encounter = case_when(Day %in% c(109,110) ~ 1,
                               Day %in% c(131,130) ~ 2,
                               Day %in% c(153,152,145) ~ 3,
                               Day %in% c(158) ~ 4,
                               Day %in% c(172,175) ~ 5,
                               Day %in% c(194,195,202) ~ 6,
                               Day %in% c(216,223) ~ 7,
                               Day %in% c(247,243,258) ~ 8,
                               Day %in% c(279,278) ~ 9,
                               Day %in% c(287,300) ~ 10,
                               TRUE ~ encounter)) %>%
  filter(!is.na(Site)) %>%
  group_by(Plot, Tag) %>%
  filter(any(Ln > 0)) %>% 
  ungroup() %>%
  mutate(PlotTag = paste0(Plot,Tag)) %>%
  arrange(Year, Plot, Site, Tag, encounter) %>%  
  mutate(Obs = case_when(Ln > 0 ~ 1,
                         Ln == 0 ~ 0,
                         is.na(Ln) ~ 0)) %>%
  # select(c(Year,PlotTag:Obs)) %>%
  mutate(PlotTag = as.numeric(as.factor(PlotTag)) )


table(dataCJS$Day)
table(dataCJS$encounter,dataCJS$Year)
```



```{r}

## Repeated for the three years
# Occ18??
obsmodel <- dataCJS %>%
  distinct(Day,Year,Plot,Site,Tag,encounter, .keep_all = TRUE) %>%
  dplyr::select(c(Site:Tag, encounter, Obs, Year)) %>%
  ## Fill in all tags within a Plot and Site across all years
  mutate(Obs = as.character(Obs)) %>%
  tidyr::complete(nesting(Site,Plot,Tag),Year, encounter, fill = list(Obs = "0")) %>%
  arrange(encounter) %>%
  pivot_wider(names_from = encounter, values_from = Obs, values_fill = "0", names_prefix = "Occ")

plotssurveyed <- table(dataCJS$Plot, dataCJS$encounter, dataCJS$Year)  

## Make Plots not visited "." 
obsmodel <- obsmodel %>%
  mutate(Occ1 = case_when(Year == 2013 ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,1,2])[which(plotssurveyed[,1,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,1,3])[which(plotssurveyed[,1,3] > 0)])) ~ ".",
                          TRUE ~ Occ1),
         Occ2 = case_when(Year == 2013 ~ ".",
                          Year == 2014 ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,2,3])[which(plotssurveyed[,2,3] > 0)])) ~ ".",
                          TRUE ~ Occ2),
         Occ3 = case_when(Year == 2013 & !(Plot %in% c(8,238,480,606,607,608,609,610,611,799)) ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,3,2])[which(plotssurveyed[,3,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,3,3])[which(plotssurveyed[,3,3] > 0)])) ~ ".",
                          TRUE ~ Occ3),
         Occ4 = case_when(Year == 2013 ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,4,2])[which(plotssurveyed[,4,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,4,3])[which(plotssurveyed[,4,3] > 0)])) ~ ".",
                          TRUE ~ Occ4),
         Occ5 = case_when(Year == 2013 ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,5,2])[which(plotssurveyed[,5,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,5,3])[which(plotssurveyed[,5,3] > 0)])) ~ ".",
                          TRUE ~ Occ5),
         Occ6 = case_when(Year == 2013 & !(Plot %in% as.numeric(names(plotssurveyed[,6,1])[which(plotssurveyed[,6,1] > 0)])) ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,6,2])[which(plotssurveyed[,6,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,6,3])[which(plotssurveyed[,6,3] > 0)])) ~ ".",
                          TRUE ~ Occ6),
         Occ7 = case_when(Year == 2013 ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,7,2])[which(plotssurveyed[,7,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,7,3])[which(plotssurveyed[,7,3] > 0)])) ~ ".",
                          TRUE ~ Occ7),
         Occ8 = case_when(Year == 2013 & !(Plot %in% as.numeric(names(plotssurveyed[,8,1])[which(plotssurveyed[,8,1] > 0)])) ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,8,2])[which(plotssurveyed[,8,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,8,3])[which(plotssurveyed[,8,3] > 0)])) ~ ".",
                          TRUE ~ Occ8),
         Occ9 = case_when(Year == 2013 ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,9,2])[which(plotssurveyed[,9,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,9,3])[which(plotssurveyed[,9,3] > 0)])) ~ ".",
                          TRUE ~ Occ9),
         Occ10 = case_when(Year == 2013 & !(Plot %in% as.numeric(names(plotssurveyed[,10,1])[which(plotssurveyed[,10,1] > 0)])) ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,10,2])[which(plotssurveyed[,10,2] > 0)])) ~ ".",
                           Year == 2015 ~ ".",
                          TRUE ~ Occ10))


asmiRD <- obsmodel %>%
  dplyr::mutate(across(Occ1:Occ10, ~ ifelse(.x > 0, 1, .x))) %>%
  tidyr::unite(ch, Occ1:Occ10, sep="") %>%
  dplyr::group_by(Site,Plot,Tag) %>%
  dplyr::mutate(Plot = as.factor(Plot)) %>%
  dplyr::mutate(Site = as.factor(Site)) %>%
  dplyr::summarise(ch = paste0(ch, collapse = "")) %>%
  ungroup()

dmPlot <- model.matrix(~ -1 + Plot, asmiRD)
dmSite <- model.matrix(~ -1 + Site, asmiRD)
dimnames(dmPlot)[[2]][length(dimnames(dmPlot)[[2]])]
dimnames(dmSite)[[2]][length(dimnames(dmSite)[[2]])]

## By Plot
asmiRD %>%
  ungroup() %>%
  dplyr::select(c(ch)) %>%
  bind_cols(dmPlot) %>%
  mutate(Plot614 = paste(Plot614, ";", sep ="")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsPlot.inp", 
              sep = " ", col.names = FALSE, row.names = FALSE)

## By Site
asmiRD %>%
  ungroup() %>%
  dplyr::select(c(ch)) %>%
  bind_cols(dmSite) %>%
  mutate(Site26 = paste(Site26, ";", sep ="")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsSite.inp", 
              sep = " ", col.names = FALSE, row.names = FALSE)


plotdf <- asmiRD %>%
  ungroup()%>%
  dplyr::distinct(Plot)

sitedf <- asmiRD %>%
  ungroup() %>%
  dplyr::distinct(Site)

save(plotdf, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/plotdf.Rdata")
save(sitedf, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/sitedf.Rdata")

```


# instead of dot notation (robust models and pradel won't accept "." for missing surveys even though Cooch and Laake say they do!!), fix the probabilities of detection to zero for those periods in the ddls. fix p=0 for that occasion
```{r}

## Repeated for the three years
obsmodel <- dataCJS %>%
  distinct(Day,Year,Plot,Site,Tag,encounter, .keep_all = TRUE) %>%
  dplyr::select(c(Site:Tag, encounter, Obs, Year)) %>%
  ## Fill in all tags within a Plot and Site across all years
  mutate(Obs = as.character(Obs)) %>%
  tidyr::complete(nesting(Site,Plot,Tag),Year, encounter, fill = list(Obs = "0")) %>%
  arrange(encounter) %>%
  pivot_wider(names_from = encounter, values_from = Obs, values_fill = "0", names_prefix = "Occ")

plotssurveyed <- table(dataCJS$Plot, dataCJS$encounter, dataCJS$Year)  

## Make Plots not visited "." 
obsmodel <- obsmodel %>%
  mutate(Occ1 = case_when(Year == 2013 ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,1,2])[which(plotssurveyed[,1,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,1,3])[which(plotssurveyed[,1,3] > 0)])) ~ ".",
                          TRUE ~ Occ1),
         Occ2 = case_when(Year == 2013 ~ ".",
                          Year == 2014 ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,2,3])[which(plotssurveyed[,2,3] > 0)])) ~ ".",
                          TRUE ~ Occ2),
         Occ3 = case_when(Year == 2013 & !(Plot %in% c(8,238,480,606,607,608,609,610,611,799)) ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,3,2])[which(plotssurveyed[,3,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,3,3])[which(plotssurveyed[,3,3] > 0)])) ~ ".",
                          TRUE ~ Occ3),
         Occ4 = case_when(Year == 2013 ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,4,2])[which(plotssurveyed[,4,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,4,3])[which(plotssurveyed[,4,3] > 0)])) ~ ".",
                          TRUE ~ Occ4),
         Occ5 = case_when(Year == 2013 ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,5,2])[which(plotssurveyed[,5,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,5,3])[which(plotssurveyed[,5,3] > 0)])) ~ ".",
                          TRUE ~ Occ5),
         Occ6 = case_when(Year == 2013 & !(Plot %in% as.numeric(names(plotssurveyed[,6,1])[which(plotssurveyed[,6,1] > 0)])) ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,6,2])[which(plotssurveyed[,6,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,6,3])[which(plotssurveyed[,6,3] > 0)])) ~ ".",
                          TRUE ~ Occ6),
         Occ7 = case_when(Year == 2013 ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,7,2])[which(plotssurveyed[,7,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,7,3])[which(plotssurveyed[,7,3] > 0)])) ~ ".",
                          TRUE ~ Occ7),
         Occ8 = case_when(Year == 2013 & !(Plot %in% as.numeric(names(plotssurveyed[,8,1])[which(plotssurveyed[,8,1] > 0)])) ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,8,2])[which(plotssurveyed[,8,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,8,3])[which(plotssurveyed[,8,3] > 0)])) ~ ".",
                          TRUE ~ Occ8),
         Occ9 = case_when(Year == 2013 ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,9,2])[which(plotssurveyed[,9,2] > 0)])) ~ ".",
                          Year == 2015 & !(Plot %in% as.numeric(names(plotssurveyed[,9,3])[which(plotssurveyed[,9,3] > 0)])) ~ ".",
                          TRUE ~ Occ9),
         Occ10 = case_when(Year == 2013 & !(Plot %in% as.numeric(names(plotssurveyed[,10,1])[which(plotssurveyed[,10,1] > 0)])) ~ ".",
                          Year == 2014 & !(Plot %in% as.numeric(names(plotssurveyed[,10,2])[which(plotssurveyed[,10,2] > 0)])) ~ ".",
                           Year == 2015 ~ ".",
                          TRUE ~ Occ10))


asmiRD <- obsmodel %>%
  dplyr::mutate(across(Occ1:Occ10, ~ ifelse(.x > 0, 1, .x))) %>%
  tidyr::unite(ch, Occ1:Occ10, sep="") %>%
  dplyr::group_by(Site,Plot,Tag) %>%
  dplyr::mutate(Plot = as.factor(Plot)) %>%
  dplyr::mutate(Site = as.factor(Site)) %>%
  dplyr::summarise(ch = paste0(ch, collapse = "")) %>%
  ungroup()

dmPlot <- model.matrix(~ -1 + Plot, asmiRD)
dmSite <- model.matrix(~ -1 + Site, asmiRD)
dimnames(dmPlot)[[2]][length(dimnames(dmPlot)[[2]])]
dimnames(dmSite)[[2]][length(dimnames(dmSite)[[2]])]

## By Plot
asmiRD %>%
  ungroup() %>%
  dplyr::select(c(ch)) %>%
  bind_cols(dmPlot) %>%
  mutate(Plot614 = paste(Plot614, ";", sep ="")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsPlot.inp", 
              sep = " ", col.names = FALSE, row.names = FALSE)

## By Site
asmiRD %>%
  ungroup() %>%
  dplyr::select(c(ch)) %>%
  bind_cols(dmSite) %>%
  mutate(Site26 = paste(Site26, ";", sep ="")) %>%
  write.table(file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/Robust3yearsSite.inp", 
              sep = " ", col.names = FALSE, row.names = FALSE)


plotdf <- asmiRD %>%
  ungroup()%>%
  dplyr::distinct(Plot)

sitedf <- asmiRD %>%
  ungroup() %>%
  dplyr::distinct(Site)

save(plotdf, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/plotdf.Rdata")
save(sitedf, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/sitedf.Rdata")

```


```












############################################################################################################################

How long were dormant periods and when did they happen?   
```{r}
head(intra)


ggplot(intra, aes(Day, Ln, color = as.factor(Tag)))+
  geom_point()+
  geom_line()+
  scale_color_discrete(guide ="none")+
  facet_grid(Year ~ Site)+
  theme_bw()

## Need to exclude Site 15, Sites 1 and 2 could be just from first to second to last in 2015. 
## Count up how many strings of dormant periods are there, how many plants never dormant

intra %>%
  group_by(Year) %>%
  mutate(encounter = as.numeric(as.factor(Day))) %>%
  mutate(eh = if_else(Ln > 0, 1, 0)) %>%
  group_by(Year, Plot, Site, Tag) %>%
  summarise(dormants = diff(encounter[eh == 1])-1) %>% 
  filter(dormants > 0) %>%
  ungroup() %>%
  summarise(meanDorm = mean(dormants), minDorm = min(dormants), maxDorm = max(dormants))


intra[intra$Tag == 16 & intra$Plot == 8,]

history <- intra %>%
  group_by(Year) %>%
  mutate(encounter = as.numeric(as.factor(Day))) %>%
  mutate(eh = if_else(Ln > 0, 1, 0)) 

## One where dormant except for first and last
obsmodel %>%
  rename_with(function(x){paste0("day", x)}, .cols = c('1':'9')) %>%
  filter(Year == 2013) %>%
  filter(day1 == 1 & day4 == 1 & day2 == 0)

obsmodel %>%
  rename_with(function(x){paste0("day", x)}, .cols = c('1':'9')) %>%
  filter(Year == 2014) %>%
  filter(day1 == 1 & day2 == 0 & day9 == 1)

obsmodel %>%
  rename_with(function(x){paste0("day", x)}, .cols = c('1':'9')) %>%
  filter(Year == 2015) %>%
  filter(day1 == 1 & day2 == 0 & day9 == 1)


obsmodel %>%
  rename_with(function(x){paste0("day", x)}, .cols = c('1':'9')) %>%
  filter(Year != 2013) %>%
  filter(day9 == 1)

table(history$Day, history$encounter)
rle(history$eh[history$Tag == 13 & history$Plot == 606])

```





## Use only ones that have surveys all four times  
```{r}
intra.2013complete[intra.2013complete$Plot == 598,]
intra.2013complete[intra.2013complete$Tag == 740 & intra.2013complete$Plot == 614,] ## Should have 2 as first encountered

fourSurvey <- intra.2013complete %>%
  mutate(encounter = as.numeric(as.factor(Day))) %>%
  filter(!is.na(Site)) %>%
  group_by(Plot,Tag) %>%
  filter(any(Lngth13 > 0)) %>%
  filter(n() ==4) %>%
  ungroup() %>%
  group_by(Site, Plot, Tag) %>%
  summarise(LastK = max(encounter),
            e = min(encounter[Lngth13 > 0])) %>%
  arrange(Plot, Site, Tag) 

fourSurvey ## The number of visits per plot K.plot, individuals per plot nx.plot, should be last visit
nrow(fourSurvey) ## 38 plants that have some growth at some point. 

dataCJS <- intra.2013complete %>% 
  mutate(encounter = as.numeric(as.factor(Day))) %>%
  filter(!is.na(Site)) %>%
  group_by(Plot, Tag) %>%
  filter(any(Lngth13 > 0))  %>%
  filter(n() ==4) %>%
  ungroup() %>%
  mutate(PlotTag = paste(Plot,Tag,sep = ".")) %>%
  arrange(Plot, Site, Tag, encounter) %>%
  mutate(K = encounter, Obs = ifelse(Lngth13 > 0, 1, 0)) %>%
  select(PlotTag:Obs) %>%
  mutate(PlotTag = factor(PlotTag, levels = unique(PlotTag))) %>%
  mutate(PlotTag = as.numeric(PlotTag) )%>%  ## As factor as numeric puts in a different order, try just Tag
  as.matrix()


model_data <- list(K = 4,
                   n = length(fourSurvey$e),
                   nx = 4*length(fourSurvey$e),  
                   e = fourSurvey$e, # First encounters
                   data1 = dataCJS[,1],
                   data2 = dataCJS[,2],
                   data3 = dataCJS[,3]) # [,1]: current individual, [,2]: current encounter occasion, [,3]: observation
  
save(model_data, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/model_data.Rdata")

```


## Now give states as 0: undetected, 1: Vegetative, 2: cotyledons, 3: Reproductive  
```{r}
intra.2013complete[intra.2013complete$Plot == 598,]
intra.2013complete[intra.2013complete$Tag == 740 & intra.2013complete$Plot == 614,] ## Should have 2 as first encountered
intra.2013complete$Comments13[grep("coty", intra.2013complete$Comments13)] <- "no c"  ## Because no, not yes coty
intra.2013$Comments13[grep("coty", intra.2013$Comments13)]


fourSurvey <- intra.2013complete %>%
  mutate(encounter = as.numeric(as.factor(Day))) %>%
  filter(!is.na(Site)) %>%
  group_by(Plot,Tag) %>%
  filter(any(Lngth13 > 0)) %>%
  filter(n() ==4) %>%
  ungroup() %>%
  group_by(Site, Plot, Tag) %>%
  summarise(LastK = max(encounter),
            e = min(encounter[Lngth13 > 0])) %>%
  arrange(Plot, Site, Tag) 

fourSurvey ## The number of visits per plot K.plot, individuals per plot nx.plot, should be last visit
nrow(fourSurvey) ## 38 plants that have some growth at some point. 

dataCJS4stage <- intra.2013complete %>% 
  mutate(encounter = as.numeric(as.factor(Day))) %>%
  filter(!is.na(Site)) %>%
  group_by(Plot, Tag) %>%
  filter(any(Lngth13 > 0))  %>%
  filter(n() ==4) %>%
  ungroup() %>%
  mutate(PlotTag = paste(Plot,Tag,sep = ".")) %>%
  arrange(Plot, Site, Tag, encounter) %>%
  mutate(K = encounter, 
         Obs = case_when(Lngth13 > 0 & Fl13 == 0 & !grepl("coty", Comments13) ~ 1,
                         Lngth13 > 0 & Fl13 == 0 & grepl("coty", Comments13) ~ 2,
                         Lngth13 > 0 & Fl13 == 1 ~ 3,
                         Lngth13 == 0 ~ 0)) %>%
  select(PlotTag:Obs) %>%
  mutate(PlotTag = factor(PlotTag, levels = unique(PlotTag))) %>%
  mutate(PlotTag = as.numeric(PlotTag) )%>%  ## As factor as numeric puts in a different order, try just Tag
  as.matrix()


model_data4stage <- list(K = 4,
                   n = length(fourSurvey$e),
                   nx = 4*length(fourSurvey$e),  
                   e = fourSurvey$e, # First encounters
                   data1 = dataCJS4stage[,1],
                   data2 = dataCJS4stage[,2],
                   data3 = dataCJS4stage[,3]) # [,1]: current individual, [,2]: current encounter occasion, [,3]: observation
  
save(model_data4stage, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/model_data-4stage.Rdata")

```


# Find remark from previous year vs. newly marked   
```{r}
##To change if someone other than Michelle is running code
userpath <- "C:/Users/DePrengm/"
currentyr <- 2022

rawdatapath <- paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Astragalus-microcymbus/Astragalus-microcymbus_Data/", currentyr, "_Astragalus-microcymbus_RawData.csv", collapse = '', sep = '')

asmi.raw <- read.csv(rawdatapath, na.strings = "na")

# need to remove all plot 89, site 1 in 2020 and beyond
asmi.raw <- asmi.raw[!(asmi.raw$AsMi_plot_id == 89 & asmi.raw$year > 2019),]

tagsPre2013 <- asmi.raw %>%
  dplyr::select(AsMi_tag_id:fence) %>%
  filter(year < 2013) %>%
  group_by(AsMi_site_id, AsMi_plot_id) %>%
  distinct(AsMi_tag_id)

fenced <- asmi.raw %>%
  mutate(fence = case_when(year < 2006 ~ "n",
                           year < 2007 & AsMi_site_id == 19 ~ "n",
                           year > 2015 ~ "n",
                           TRUE ~ fence)) %>%
  dplyr::select(c(fence, year, AsMi_site_id, AsMi_plot_id)) %>%
  group_by(AsMi_site_id, AsMi_plot_id, year) %>%
  distinct()

# days <- c(130,110,180,90,160)
# as.factor(days)
# as.numeric(as.factor(days))

## Just individuals and plot that were sampled all four times
dataCJS <- intra.2013complete %>%
  mutate(encounter = as.numeric(as.factor(Day))) %>% ## Turns the day within a year into numeric
  filter(!is.na(Site)) %>%
  group_by(Plot, Tag) %>%
  filter(any(Ln > 0)) %>% 
  ungroup() %>%
  mutate(PlotTag = paste0(Plot,Tag)) %>%
  arrange(Year, Plot, Site, Tag, encounter) %>%  
  mutate(K = paste0(Year, encounter), 
         Obs = case_when(Ln > 0 & Fl == 0 ~ 1,
                         Ln > 0 & Fl == 1 ~ 3,
                         Ln == 0 ~ 0)) %>%
  mutate(PlotTag = as.numeric(as.factor(PlotTag)) ) %>%  ## Unique numbered across all years? No. 
  mutate(Obs = ifelse(is.na(Obs), 0, Obs))

dataCJSfence <- merge(dataCJS, fenced, by.x = c("Site","Plot","Year"), 
                      by.y = c("AsMi_site_id","AsMi_plot_id","year"))
  
 
obsmodel <- dataCJSfence %>%
  distinct(Year,Plot,Site,Tag,encounter, .keep_all = TRUE) %>%
  select(c(Site:Year, Tag, PlotTag, encounter, Obs, fence)) %>%
  pivot_wider(names_from = encounter, values_from = Obs, values_fill = 0) 

CJS_AsMi_fence13 <- obsmodel %>%
  group_by(Year, Tag, Site, Plot) %>%
  mutate(state = ifelse(any(c_across('1':'4') == 3), "Reproductive", "Vegetative")) %>%
  mutate(begin.time = min(which(c_across('1':'4')>0))) %>%
  filter(!is.infinite(begin.time)) %>%  ## There were a few cases with no observations in 2014
  mutate(across('1':'4', ~ ifelse(.x > 0, 1, 0))) %>%
  unite(ch, '1':'4', sep = "") %>%
  mutate(state = as.factor(state))

CJS_AsMi_fence13 %>%
  filter(state == "Reproductive")


#### Now 2014 and 2015
dataCJS1415 <- intra20142015 %>%
  group_by(Year) %>%
  mutate(encounter = as.numeric(as.factor(Day))) %>% ## Turns the day within a year into numeric
  filter(!is.na(Site)) %>%
  group_by(Plot, Tag) %>%
  filter(any(Ln > 0)) %>% 
  ungroup() %>%
  mutate(PlotTag = paste0(Plot,Tag)) %>%
  arrange(Year, Plot, Site, Tag, encounter) %>%  
  mutate(K = paste0(Year, encounter), 
         Obs = case_when(Ln > 0 & Fl == 0 ~ 1,
                         Ln > 0 & Fl == 1 ~ 3,
                         Ln == 0 ~ 0)) %>%
  mutate(PlotTag = as.numeric(as.factor(PlotTag)) ) %>%  ## Unique numbered across all years? No. 
  mutate(Obs = ifelse(is.na(Obs), 0, Obs))

dataCJSfence1415 <- merge(dataCJS1415, fenced, by.x = c("Site","Plot","Year"), 
                      by.y = c("AsMi_site_id","AsMi_plot_id","year"))
  
 
obsmodel1415 <- dataCJSfence1415 %>%
  group_by(Year) %>%
  distinct(Year,Plot,Site,Tag,PlotTag,encounter, .keep_all = TRUE) %>%
  select(c(Site:Year, Tag, PlotTag, encounter, Obs, fence)) %>%
  arrange(Year, encounter) %>% 
  pivot_wider(names_from = encounter, values_from = Obs, values_fill = 0) 

CJS_AsMi_fence1415 <- obsmodel1415 %>%
  group_by(Year, Tag, Site, Plot, PlotTag, fence) %>%
  mutate(state = ifelse(any(c_across('1':'9') == 3), "Reproductive", "Vegetative")) %>%
  mutate(begin.time = min(which(c_across('1':'9')>0))) %>%
  filter(!is.infinite(begin.time)) %>%  ## There were a few cases with no observations in 2014
  mutate(across('1':'9', ~ ifelse(.x > 0, 1, 0))) %>%
  unite(ch, '1':'9', sep = "") %>%
  mutate(state = as.factor(state))

CJS_AsMi_fence1415 %>%
  filter(Year == 2015)

save(CJS_AsMi_fence13, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/CJS_2013.Rdata")

save(CJS_AsMi_fence1415, file = "C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/GitPVA/datasets/CJS_201415.Rdata")


```

















```{r}
library(IPMbook)
library(jagsUI)

data(wryneck)

fail <- which(wryneck$x==0)
y <- matrix(NA, nrow=length(wryneck$f), ncol=max(wryneck$k))
for (i in 1:length(wryneck$f)){
  y[i,wryneck$f[i]] <- 1
  y[i,wryneck$j[i]] <- 1
}
for (i in 1:length(fail)){
  y[fail[i],wryneck$k[fail[i]]] <- 0
}

jags.data <- with(wryneck, list(y=y, f=f, k=k, n.nest=nrow(y), T=21, age=age))

cat(file="model13.txt", "
model {
  # Priors and linear models
  for (i in 1:n.nest){
    for (t in f[i]:(k[i]-1)){
      phi[i,t] <- phia[age[i] + t - f[i]]
    } #t
  } #i
  for (a in 1:T){
    phia[a] <- ilogit(alpha + beta * a)
  }
  alpha ~ dnorm(0, 0.001)
  beta ~ dnorm(0, 0.001)
  # Likelihood
  for (i in 1:n.nest){
    for (t in (f[i]+1):k[i]){
      y[i,t] ~ dbern(phi[i,t-1] * y[i,t-1])
    } #t
  } #i
  # Derived parameter: nest success
  nu <- prod(phia[1:T])
}
")
# Initial values
inits <- function(){list(alpha=runif(1, 4, 5), beta=runif(1, 0, 0.1))}
# Parameters monitored
parameters <- c("phia", "nu", "alpha", "beta")
# MCMC settings
ni <- 3000; nb <- 1000; nc <- 3; nt <- 1; na <- 1000
# Call JAGS from R (ART 1 min) and check convergence
out16 <- jags(jags.data, inits, parameters, "model13.txt", n.iter=ni, n.burnin=nb, n.chains=nc,
              n.thin=nt, n.adapt=na, parallel=TRUE)
```


```{r}
## Need to add zeros to times visited but not seen
aboveground <- intra.2014_2015 %>%
  mutate(Tag.ID = row_number()) %>%
  filter_at(vars(starts_with("Ln")), any_vars(!is.na(.))) %>%
  mutate(TagID = as.numeric(Tag.ID), Tag = as.numeric(Tag))



## Did not visit Site 15
April2014 <- aboveground %>%
  select(c(Tag.ID:Tag, Plot.1, LnAprl14:CommentsApr14)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-04-21"))$yday) %>%
  mutate(Site = case_when(Plot.1 %in% c(606,607,608,609,610) ~ 5,
                          Plot.1 %in% c(512,513,514,515,300) ~ 19,
                          Plot.1 %in% c(238, 480,611,614,598) ~ 26,
                          Plot.1 %in% c(8,578,581,799) ~ 15,
                          Plot.1 %in% c(1,22,32,42,52) ~ 1,
                          Plot.1 %in% c(16,58,89,90,96,98) ~ 2)) %>%
  relocate(Site, .before = Tag) %>%
  filter(Site != 15) %>%
  'colnames<-'(c("TagID","Site","Tag","Plot","Length","FlYN","FrNum","BrYN","Comments","SurveyDay"))%>%
  mutate(Length = case_when(is.na(Length) ~ 0,
                            !is.na(Length) ~ Length))
  

table(April2014$Site, April2014$Plot)

## Only visited site 5
May2014 <- aboveground %>%
  select(c(Tag.ID:Tag, Plot.1, LnMay12:Comments)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-05-13"))$yday) %>%
  mutate(Site = case_when(Plot.1 %in% c(606,607,608,609,610) ~ 5,
                          Plot.1 %in% c(512,513,514,515,300) ~ 19,
                          Plot.1 %in% c(238, 480,611,614,598) ~ 26,
                          Plot.1 %in% c(8,578,581,799) ~ 15,
                          Plot.1 %in% c(1,22,32,42,52) ~ 1,
                          Plot.1 %in% c(16,58,89,90,96,98) ~ 2)) %>%
  relocate(Site, .before = Tag) %>%
  filter(Site == 5) %>%
  'colnames<-'(names(April2014)) %>%
  filter(!is.na(Length)) %>%
  mutate(Length = case_when(is.na(Length) ~ 0,
                            !is.na(Length) ~ Length))
  
table(May2014$Site, May2014$Plot)

aboveground[aboveground$Plot == "Plot",]

## All four and Cebolla mid, only 22  2014-06-03
June2014_1 <- aboveground %>%
  select(c(Tag.ID:Tag, Plot.1, LnJun14:Comments.1)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-06-03"))$yday) %>%
  mutate(Site = case_when(Plot.1 %in% c(606,607,608,609,610) ~ 5,
                          Plot.1 %in% c(512,513,514,515,300) ~ 19,
                          Plot.1 %in% c(238, 480,611,614,598) ~ 26,
                          Plot.1 %in% c(8,578,581,799) ~ 15,
                          Plot.1 %in% c(1,22,32,42,52) ~ 1,
                          Plot.1 %in% c(16,58,89,90,96,98) ~ 2)) %>%
  relocate(Site, .before = Tag) %>%
  filter(!(Plot.1 %in% c(1,32,42,52))) %>%
  'colnames<-'(names(April2014)) %>%
  mutate(Length = case_when(is.na(Length) ~ 0,
                            !is.na(Length) ~ Length))

table(June2014_1$Site, June2014_1$Plot)

## All four and Cebolla mid ## Cebolla mid == 1  2014-06-25
June2014_2 <- aboveground %>%
  select(c(Tag.ID:Tag, Plot.1, LnJun214:Comments.2)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-06-25"))$yday) %>%
  mutate(Site = case_when(Plot.1 %in% c(606,607,608,609,610) ~ 5,
                          Plot.1 %in% c(512,513,514,515,300) ~ 19,
                          Plot.1 %in% c(238, 480,611,614,598) ~ 26,
                          Plot.1 %in% c(8,578,581,799) ~ 15,
                          Plot.1 %in% c(1,22,32,42,52) ~ 1,
                          Plot.1 %in% c(16,58,89,90,96,98) ~ 2)) %>%
  relocate(Site, .before = Tag) %>%
  'colnames<-'(names(April2014)) %>%
  mutate(Length = case_when(is.na(Length) ~ 0,
                            !is.na(Length) ~ Length))

table(June2014_2$Site, June2014_2$Plot)

## All four and Cebolla mid == 1 and north == 2 2014-07-15
July2014_1 <- aboveground %>%
  select(c(Tag.ID:Tag, Plot.1, LnJul14:Comments.3)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-07-15"))$yday) %>%
  mutate(Site = case_when(Plot.1 %in% c(606,607,608,609,610) ~ 5,
                          Plot.1 %in% c(512,513,514,515,300) ~ 19,
                          Plot.1 %in% c(238, 480,611,614,598) ~ 26,
                          Plot.1 %in% c(8,578,581,799) ~ 15,
                          Plot.1 %in% c(1,22,32,42,52) ~ 1,
                          Plot.1 %in% c(16,58,89,90,96,98) ~ 2)) %>%
  relocate(Site, .before = Tag) %>%
  'colnames<-'(names(April2014)) %>%
  mutate(Length = case_when(is.na(Length) ~ 0,
                            !is.na(Length) ~ Length))

table(July2014_1$Site, July2014_1$Plot)

## Need to pull from annual 2014 data

## All 6 2014-08-5
August2014 <- aboveground %>%
  select(c(Tag.ID:Tag, Plot.1, LnAug14:Comments.4)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-08-5"))$yday) %>%
  mutate(Site = case_when(Plot.1 %in% c(606,607,608,609,610) ~ 5,
                          Plot.1 %in% c(512,513,514,515,300) ~ 19,
                          Plot.1 %in% c(238, 480,611,614,598) ~ 26,
                          Plot.1 %in% c(8,578,581,799) ~ 15,
                          Plot.1 %in% c(1,22,32,42,52) ~ 1,
                          Plot.1 %in% c(16,58,89,90,96,98) ~ 2)) %>%
  relocate(Site, .before = Tag) %>%
  'colnames<-'(names(April2014)) %>%
  mutate(Length = case_when(is.na(Length) ~ 0,
                            !is.na(Length) ~ Length))

table(August2014$Site, August2014$Plot)

## all 6 2014-09-18
September2014 <- aboveground %>%
  select(c(Tag.ID:Tag, Plot.1, LnSep14:Comments.5)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-09-18"))$yday) %>%
  mutate(Site = case_when(Plot.1 %in% c(606,607,608,609,610) ~ 5,
                          Plot.1 %in% c(512,513,514,515,300) ~ 19,
                          Plot.1 %in% c(238, 480,611,614,598) ~ 26,
                          Plot.1 %in% c(8,578,581,799) ~ 15,
                          Plot.1 %in% c(1,22,32,42,52) ~ 1,
                          Plot.1 %in% c(16,58,89,90,96,98) ~ 2)) %>%
  relocate(Site, .before = Tag) %>%
  'colnames<-'(names(April2014)) %>%
  mutate(Length = case_when(is.na(Length) ~ 0,
                            !is.na(Length) ~ Length))

table(September2014$Site, September2014$Plot)

## all 6 2014-10-14
October2014 <- aboveground %>%
  select(c(Tag.ID:Tag, Plot.1, LnOct14:Comments.6)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-10-14"))$yday) %>%
  mutate(Site = case_when(Plot.1 %in% c(606,607,608,609,610) ~ 5,
                          Plot.1 %in% c(512,513,514,515,300) ~ 19,
                          Plot.1 %in% c(238, 480,611,614,598) ~ 26,
                          Plot.1 %in% c(8,578,581,799) ~ 15,
                          Plot.1 %in% c(1,22,32,42,52) ~ 1,
                          Plot.1 %in% c(16,58,89,90,96,98) ~ 2)) %>%
  relocate(Site, .before = Tag) %>%
  'colnames<-'(names(April2014))%>%
  mutate(Length = case_when(is.na(Length) ~ 0,
                            !is.na(Length) ~ Length))

table(October2014$Site, October2014$Plot)

## all 6 2014-10-29
October2014_2 <- aboveground %>%
  select(c(Tag.ID:Tag, Plot.1, LnOct2814:Comments.7)) %>%
  mutate(Day = as.POSIXlt(as.Date("2014-10-29"))$yday) %>%
  mutate(Site = case_when(Plot.1 %in% c(606,607,608,609,610) ~ 5,
                          Plot.1 %in% c(512,513,514,515,300) ~ 19,
                          Plot.1 %in% c(238, 480,611,614,598) ~ 26,
                          Plot.1 %in% c(8,578,581,799) ~ 15,
                          Plot.1 %in% c(1,22,32,42,52) ~ 1,
                          Plot.1 %in% c(16,58,89,90,96,98) ~ 2)) %>%
  relocate(Site, .before = Tag) %>%
  'colnames<-'(names(April2014)) %>%
  mutate(Length = case_when(is.na(Length) ~ 0,
                            !is.na(Length) ~ Length))

table(October2014$Site, October2014$Plot)

## 2015

RepeatSurvey2014 <- do.call(rbind, list(April2014, May2014, June2014_1, June2014_2, July2014_1, 
                                        August2014, September2014, October2014, October2014_2))


## f = first detected; j = last day alive, k = last visit, x_i == 0 or 1 during last visit, size
asmiSurvival <- RepeatSurvey2014 %>%
  group_by(Site, Plot, TagID, Tag) %>%
  filter(!all(Length == 0)) %>%
  summarise(f = min(SurveyDay[Length > 0]) - (min(SurveyDay)-1), # if detected first visit then detected on day 1
            j = max(SurveyDay[Length > 0])- (min(SurveyDay)-1), ## all conditioned on first day detection was possible
            k = max(SurveyDay) - (min(SurveyDay)-1),
            x = ifelse(Length[SurveyDay == max(SurveyDay)] > 0, 1, 0),
            size = max(Length)) 


asmiSurvival %>%
  filter(Site == 5) %>%
  print(n=100)

RepeatSurvey2014 %>%
  filter(Tag == "206" & Plot == 1) %>%
  print()

asmiSurvival %>%
  filter(x == 0) %>%
  print(n=100)
```

Try for seedlings
```{r}
## Call seedlings anything with max(Length) < 10
asmiSeedlings <- asmiSurvival %>%
  filter(size < 10)

fail <- which(asmiSeedlings$x==0)
y <- matrix(NA, nrow=length(asmiSeedlings$f), ncol=max(asmiSeedlings$k))
for (i in 1:length(wryneck$f)){
  y[i,asmiSeedlings$f[i]] <- 1
  y[i,asmiSeedlings$j[i]] <- 1
}
for (i in 1:length(fail)){
  y[fail[i],asmiSeedlings$k[fail[i]]] <- 0
}

jags.data <- with(asmiSeedlings, list(y=y, f=f, k=k, n.nest=nrow(y), T=max(asmiSeedlings$k), size=size))

cat(file="model13.txt", "
model {
  # Priors and linear models
  for (i in 1:n.nest){
    for (t in f[i]:(k[i]-1)){
      # phi[i,t] <- phia[size[i] + t - f[i]]  ## This is getting at the age, not analogous to size
      phi[i,t] <- phia[size[i] + t]
    } #t
  } #i
  for (a in 1:T){
    phia[a] <- ilogit(alpha + beta * a)
  }
  alpha ~ dnorm(0, 0.001)
  beta ~ dnorm(0, 0.001)
  # Likelihood
  for (i in 1:n.nest){
    for (t in (f[i]+1):k[i]){
      y[i,t] ~ dbern(phi[i,t-1] * y[i,t-1])
    } #t
  } #i
  # Derived parameter: nest success
  nu <- prod(phia[1:T])
}
")
# Initial values
inits <- function(){list(alpha=runif(1, 4, 5), beta=runif(1, 0, 0.1))}
# Parameters monitored
parameters <- c("phia", "nu", "alpha", "beta")
# MCMC settings
ni <- 3000; nb <- 1000; nc <- 3; nt <- 1; na <- 1000
# Call JAGS from R (ART 1 min) and check convergence
out16 <- jags(jags.data, inits, parameters, "model13.txt", n.iter=ni, n.burnin=nb, n.chains=nc,
              n.thin=nt, n.adapt=na, parallel=TRUE)


```



dm$Date[dm$Survey== "LnApr20_15"] <- as.Date("2015-04-20") # "Apr2_2015"
dm$Date[dm$Survey=="LnMay11_15"] <- as.Date("2015-05-11") # May11_2015
dm$Date[dm$Survey=="LnMay26_15"] <- as.Date("2015-05-26") # May2_2015
dm$Date[dm$Survey=="LnJune8_15"] <- as.Date("2015-06-08") # June_2015
dm$Date[dm$Survey=="LnJune22.24"] <- as.Date("2015-06-22") # June2_2015
dm$Date[dm$Survey=="LnJuly20.23_15"] <- as.Date("2015-07-22") # July_2015
dm$Date[dm$Survey== "LnAug12.14_15"] <- as.Date("2015-08-11") # "Aug1_2015"
dm$Date[dm$Survey=="LnSept1.3_15"] <- as.Date("2015-09-01") # Sept_2015
dm$Date[dm$Survey=="LnOct6.8_15"] <- as.Date("2015-10-06") # Oct6_2015
table(dm$Date)


Simulate a State-space formulation of the Cormack-Jolly-Seber model
```{r}
# Choose values for data simulation
nmarked <- 10 # Number of marked individuals at each occasion
nyears <- 11 # Number of years
phi <- 0.8 # Constant apparent survival probability
p <- 0.4 # Constant recapture probability

# An individual first caught on the last year of the study has no opportunity of being recaptured during the study. Hence,
# such individuals do not carry any information about survival and can be discarded from the analysis. So in our simulation,
# we choose first-capture occasions only up to the penultimate year.
# Determine occasion when an individual first captured and marked
f <- rep(1:(nyears-1), each=nmarked)
nind <- length(f) # Total number of marked individuals
# State or ecological process
z <- array(NA, dim=c(nind, nyears)) # Empty alive/dead matrix
# Initial conditions: all individuals alive at f(i)
for (i in 1:nind){
  z[i,f[i]] <- 1
}
set.seed(1) # Initialize the RNGs in R
# Propagate alive/dead process forwards via transition rule:
# Alive individuals survive with probability phi
for (i in 1:nind){
  for (t in (f[i]+1):nyears){
    z[i,t] <- rbinom(1, 1, z[i,t-1] * phi)
  } #t
} #i
head(z); tail(z)

# Observation process: simulate observations
y <- array(0, dim=c(nind, nyears))
for (i in 1:nind){
  y[i,f[i]] <- 1
  for(t in (f[i]+1):nyears){
    y[i,t] <- rbinom(1, 1, z[i,t] * p)
  } #t
} #i

for (i in 1:10){ # Look at true and observed states of first 10 individuals
  print(rbind("True state (z)" = z[i,], "Observed state (y)" = y[i,]))
}


# the capture-recapture data matrix, its dimensions and the vector f that indicates the marking occasion for each
# individual.
# Data bundle
jags.data <- list(y=y, f=f, nind=nind, nyears=ncol(y))

# Write JAGS model file
cat(file="model14.txt", "
model {
# Priors and linear models
phi.const ~ dunif(0, 1) # Vague prior for constant phi
p.const ~ dunif(0, 1) # Vague prior for constant p
for (i in 1:nind){ # Loop over individuals
for (t in f[i]:(nyears-1)){ # Loop over time intervals/occasions
phi[i,t] <- phi.const # Here we model pattern in phi ...
p[i,t] <- p.const # ... and p
} #t
} #i
# Likelihood
for (i in 1:nind){
# Define latent state at first capture
z[i,f[i]] <- 1
for (t in (f[i]+1):nyears){
# State process
z[i,t] ~ dbern(z[i,t-1] * phi[i,t-1])
# Observation process
y[i,t] ~ dbern(z[i,t] * p[i,t-1])
} #t
} #i
}
")

# Initial values
inits <- function(){list(z=zInit(y))}
# Finally, we define the list with the parameters we like to estimate, choose the MCMC settings and launch the model.
# Parameters monitored
parameters <- c("phi.const", "p.const") # Could also add "z"
# MCMC settings
ni <- 3000; nb <- 1000; nc <- 3; nt <- 1; na <- 1000
# Call JAGS from R (ART < 1 min) and check convergence
out17 <- jags(jags.data, inits, parameters, "model14.txt", n.iter=ni, n.burnin=nb, n.chains=nc,
              n.thin=nt, n.adapt=na, parallel=TRUE)
print(out17,3)
```

